/**
 * vizabi - Vizabi Framework, Interactive charts and visualization tools animated through time
 * @version v0.13.3-3
 * @build timestampWed Mar 16 2016 23:58:42 GMT+0100 (CET)
 * @link http://vizabi.org
 * @license BSD-3-Clause
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Vizabi=e()}(this,function(){"use strict";function t(t){return t instanceof Date||t instanceof RegExp}function e(t){if(t instanceof Date)return new Date(t.getTime());if(t instanceof RegExp)return new RegExp(t);throw new Error("Unexpected situation")}function i(a){var n=[];return lt(a,function(a,s){"object"==typeof a&&null!==a?W(a)?n[s]=i(a):t(a)?n[s]=e(a):n[s]=ct({},a):n[s]=a}),n}function a(t,e){function i(){!oe&&this.init&&this.init.apply(this,arguments)}e=1===arguments.length?t:e;var n=this.prototype;oe=!0;var s=new this;return oe=!1,lt(e,function(t,i){"function"==typeof e[i]&&"function"==typeof n[i]&&ce.test(e[i])?s[i]=function(t,e){return function(){var i=this._super;this._super=n[t];var a=e.apply(this,arguments);return this._super=i,a}}(i,e[i]):s[i]=t}),i.prototype=s,i.prototype.constructor=i,i.extend=a,i._collection={},i.register=function(t,e){"undefined"!=typeof this._collection[t]&&kt('"'+t+'" is already registered. Overwriting...'),this._collection[t]=e},i.unregister=function(t){this._collection[t]=void 0},i.getCollection=function(){return this._collection},i.define=function(t,e){this.prototype[t]=e},i.get=function(t,e){return this._collection.hasOwnProperty(t)?this._collection[t]:(e||kt('"'+t+'" was not found.'),!1)},arguments.length>1&&this.register&&this.register(t,i),i}function s(t){return this instanceof s?(this.status="pending",this.value,this.reason,this._resolves=[],this._rejects=[],h(t)&&t(this.resolve.bind(this),this.reject.bind(this)),this):new s(t)}function r(t,e){return e===t&&t.reject(new Error("TypeError")),e instanceof s?l(t,e):u(e)?o(t,e):t.resolve(e)}function l(t,e){var i=e.status;return"pending"===i&&e.then(t.resolve.bind(t),t.reject.bind(t)),"resolved"===i&&t.resolve(e.value),"rejected"===i&&t.reject(e.reason),promise}function o(t,e){var i,a=m(function(e){i||(r(t,e),i=!0)}),n=m(function(e){i||(t.reject(e),i=!0)});try{e.then.call(e,a,n)}catch(s){if(!i)throw s;t.reject(s)}return t}function c(t){for(var e,i,a=t.status,n=t["resolved"===a?"_resolves":"_rejects"],s=t["resolved"===a?"value":"reason"];e=n.shift();)i=e.call(t,s),i&&r(t._next,i);return t}function h(t){return"function"===d(t)}function d(t){var e={};return e.toString.call(t).replace(/\[object (\w+)\]/,"$1").toLowerCase()}function u(t){return t&&t.then&&h(t.then)}function m(t){var e,i;return function(){return e?i:(e=!0,i=t.apply(this,arguments))}}function g(t){me=!0,t&&(W(t)||(t=[t]),lt(t,function(t){pe[t]=!0}))}function p(){me=!1,pe={};for(var t=Object.keys(ge),e=0;e<t.length;e++){var i=ge[t[e]];i&&i.unfreeze()}ge={}}function f(t,e){return t&&(t.hasOwnProperty("_data")||e&&t.hasOwnProperty("_val"))}function v(t){for(var e in t._data)Object.defineProperty(t,e,{configurable:!0,get:function(e){return function(){return t.get(e)}}(e),set:function(e){return function(i){return t.set(e,i)}}(e)})}function b(t,e,i){function a(t,e){i._ready&&(e=i._name+"."+e,i.trigger(t,e))}function n(t,e){i.trigger(t,e)}function s(t,e){i.setReady(!1),i.trigger(t,e)}function r(t,e){i.trigger(t,e)}function l(t,e){i.setReady(!1),Ut(function(){i.setReady()})}var o;if(!tt(e)||W(e)){var c={change:a};o=new _e(t,e,i,c)}else{var c={change:a,hook_change:n,load_start:s,load_error:r,ready:l};if(f(e,!0))o=e,o.on(c);else{var h=t.split("_")[0],d=Me.get(h,!0)||He[h]||Me;o=new d(t,e,i,c)}}return o}function y(t){return t._intervals?t._intervals:t._parent?y(t._parent):new ye}function x(t,e){var i=_(t,e);return i?i:t._parent?x(t._parent,e):void 0}function _(t,e){for(var i in t._data)if(i===e&&f(t._data[i]))return t._data[i]}function M(t){return W(t.space)?t.space:t._parent?M(t._parent):void Tt('ERROR: space not found.\n You must specify the objects this hook will use under the "space" attribute in the state.\n Example:\n space: ["entities", "time"]')}function z(){var t=function(t){return e(t)+"w"+i(t)};t.parse=function(t){var e=t.match(/^(\d{4})w(\d{2})$/);return e?a(e[1],e[2]):null};var e=function(t){var e=+t;return new Date(e+864e5*(4-(t.getUTCDay()||7))).getUTCFullYear()},i=function(t){var e=+t,i=new Date(e+864e5*(4-(t.getUTCDay()||7))),a=Math.ceil(((i.getTime()-i.setUTCMonth(0,1))/864e5+1)/7);return 10>a?"0"+a:a},a=function(t,e){var i=parseInt(e),a=t,n=new Date;n.setUTCFullYear(a),n.setUTCMonth(0),n.setUTCDate(4);var s=n.getUTCDay()||7,r=1,l=7*i+r-(s+4),o=ze.year.parse(a);return o=new Date(o.getTime()+24*l*60*60*1e3)};return t}function w(){var t=function(t){return ze.year(t)+"q"+e(t)};t.parse=function(t){var e=t.match(/^(\d{4})q(\d)$/);return e?i(e[1],e[2]):null};var e=function(t){return(t.getUTCMonth()/3|0)+1},i=function(t,e){var i=parseInt(e),a=3*i-2,n=t;return ze.month.parse([n,(9>a?"0":"")+a].join(""))};return t}function k(t){var e=new s,i=[];lt(t.components,function(t){i.push(k(t))});var a=i.length?s.all(i):new s.resolve;return a.then(function(){t.preload(e)},function(t){Tt("Error preloading data:",t)}),e.then(function(){return t.afterPreload(),!0})}function S(t,e){var i=function(e){return t.replace(/<%=([^\%]*)%>/g,function(t){var i=t.match(/t\s*\(([^)]+)\)/g);return i.length?i=e.t(i[0].match(/\"([^"]+)\"/g)[0].split('"').join("")):(i=t.match(/([a-z\-A-Z]+([a-z\-A-Z0-9]?[a-zA-Z0-9]?)?)/g)[0],i=e[i]||i),i})},a=/<[a-z][\s\S]*>/i.test(t)?i:Ve[t]=Ve[t]||S(document.getElementById(t).innerHTML);return e?a(e):a}function E(){this._container&&this.setSize()}function T(t,e){function i(){var n=JSON.stringify(t.getPlainObject()),s=arguments[0]||0;this._readyOnce?e():e(this);var r=JSON.stringify(t.getPlainObject());s>=a?Tt("Max validation loop."):n!==r&&i.call(this,[s+=1])}var a=10;return i}function L(t,e){for(var i,a,n,s,r=Object.keys(e),l=r.length,o=0;l>o;o+=1)i=r[o],"_defs_"!==i&&(a=e[i],n=t[i],s=typeof a,"object"===s&&(s=tt(a)&&a._defs_?"object":W(a)?"array":"model"),"undefined"==typeof n&&("object"!==s&&"model"!==s?t[i]=a:t[i]=L({},a)),n=t[i],"number"===s&&isNaN(n)?t[i]=0:"string"===s&&"string"!=typeof n?t[i]="":"array"!==s||W(n)?"model"===s?(Q(n)||(t[i]={}),t[i]=L(t[i],a)):"object"===s&&(Q(n)&&0!==Object.keys(n).length||(n=!1),Q(a._defs_)||(a._defs_={}),t[i]=n||a._defs_):t[i]=[]);return t}function O(){return function t(e){function i(t,e,i){return i.indexOf(t)===e}function a(t){if(null!=g)return void a.highlightValueRun(t);var i=t.append("g").attr("class","tick widthSampling"),n=i.append("text").text("0");x.cssMarginTop=n.style("margin-top"),x.cssMarginBottom=n.style("margin-bottom"),x.cssMarginLeft=n.style("margin-left"),x.cssMarginRight=n.style("margin-right"),x.widthOfOneDigit=n[0][0].getBBox().width,x.heightOfOneDigit=n[0][0].getBBox().height,i.remove(),a.labelFactory(x),e(x.transitionDuration>0?t.transition().duration(x.transitionDuration):t);var s="top"==a.orient()||"bottom"==a.orient()?o:l,r=s==o&&a.pivot()||s==l&&!a.pivot()?h:c;t.selectAll(".vzb-axis-value").data([null]).enter().append("g").attr("class","vzb-axis-value").classed("vzb-hidden",!0).append("text"),t.selectAll("text").each(function(t,e){var i=d3.select(this);null!=a.pivot()&&(i.attr("transform","rotate("+(a.pivot()?-90:0)+")"),i.style("text-anchor",r==c?"middle":"end"),i.attr("x",r==c?0:-a.tickPadding()-a.tickSize()),i.attr("y",r==c?(s==l?-1:1)*(a.tickPadding()+a.tickSize()):0),i.attr("dy",r==c?s==l?0:".72em":".32em"))}),null!=a.repositionLabels()&&t.selectAll(".tick").each(function(t,e){var i=d3.select(this).select("text"),n=a.repositionLabels()[e]||{x:0,y:0};i.attr("x",+i.attr("x")+n.x),i.attr("y",+i.attr("y")+n.y)}),null==a.tickValuesMinor()&&a.tickValuesMinor([]);var d=t.selectAll(".tickMinor").data(b);d.exit().remove(),d.enter().append("line").attr("class","tickMinor");var u=a.tickSizeMinor().outbound,m=a.tickSizeMinor().inbound,p=a.scale();d.attr("y1",s==o?("top"==a.orient()?1:-1)*m:p).attr("y2",s==o?("top"==a.orient()?-1:1)*u:p).attr("x1",s==l?("right"==a.orient()?-1:1)*m:p).attr("x2",s==l?("right"==a.orient()?1:-1)*u:p),t.selectAll("path").remove();var f=t.selectAll(".vzb-axis-line").data([0]);f.exit().remove(),f.enter().append("line").attr("class","vzb-axis-line"),x.constantRakeLength?f.attr("x1",s==l?0:-1).attr("x2",s==l?0:x.constantRakeLength).attr("y1",0).attr("y2",s==o?0:x.constantRakeLength):f.attr("x1",s==l?0:d3.min(p.range())-(x.bump||0)-1).attr("x2",s==l?0:d3.max(p.range())+(x.bump||0)).attr("y1",s==o?0:d3.min(p.range())-(x.bump||0)).attr("y2",s==o?0:d3.max(p.range())+(x.bump||0))}function n(t,e){null==e&&(e=!0);var i=[],a=[];-1!=t.indexOf(0)&&(i.push([0]),a.push(t.indexOf(0)));for(var n=t.length;n>=1;n=4>n?n-1:n/2)i.push(t.filter(function(t,i){return i%Math.floor(n)!=0||-1!=a.indexOf(i)&&e?!1:(a.push(i),!0)}));return i}function s(t,e,i,a,n){if(null==t)return null;var s=i==l?{head:e.toolMargin.top,tail:e.toolMargin.bottom}:{head:e.toolMargin.right,tail:e.toolMargin.left},r={};return t.forEach(function(c,h){if(0==h||h==t.length-1){var d=s.head+e.bump+(i==o?1:0)*d3.max(a.range())-(i==o?0:1)*d3.min(a.range())+(i==o?-1:1)*a(c)-("x"==n)*e.formatter(c).length*e.widthOfOneDigit/2-("y"==n)*e.heightOfOneDigit/2-("x"==n)*parseInt(e.cssMarginRight)-("y"==n)*parseInt(e.cssMarginTop),u=Math.min(s.tail,e.widthOfOneDigit)+e.bump+(i==l?1:0)*d3.max(a.range())-(i==l?0:1)*d3.min(a.range())+(i==l?-1:1)*a(c)-("x"==n)*e.formatter(c).length*e.widthOfOneDigit/2-("y"==n)*e.heightOfOneDigit/2-("x"==n)*parseInt(e.cssMarginLeft)-("y"==n)*parseInt(e.cssMarginBottom);d>0&&(d=0),u>0&&(u=0),r[h]={x:0,y:0},r[h][n]=("y"==n&&i==l?-1:1)*(d-u)}}),t.forEach(function(s,c){if(0!=c&&c!=t.length-1){var h=Math.abs(a(s)-a(t[t.length-1]))-("y"==n)*(i==o?-1:1)*r[t.length-1][n]-("x"==n)*(i==o?1:-1)*r[t.length-1][n]-("x"==n)*e.widthOfOneDigit/2*e.formatter(s).length-("x"==n)*e.widthOfOneDigit/2*e.formatter(t[t.length-1]).length-("y"==n)*e.heightOfOneDigit*.7-("x"==n)*parseInt(e.cssMarginLeft)-("y"==n)*parseInt(e.cssMarginBottom),d=Math.abs(a(s)-a(t[0]))-("y"==n)*(i==l?-1:1)*r[0][n]-("x"==n)*(i==l?1:-1)*r[0][n]-("x"==n)*e.widthOfOneDigit/2*e.formatter(s).length-("x"==n)*e.widthOfOneDigit/2*e.formatter(t[0]).length-("y"==n)*e.heightOfOneDigit*.7-("x"==n)*parseInt(e.cssMarginLeft)-("y"==n)*parseInt(e.cssMarginBottom);h>0&&(h=0),d>0&&(d=0),r[c]={x:0,y:0},r[c][n]=("y"==n&&i==l?-1:1)*(h-d)}}),r}function r(t,e,i,n,s){return a.labelerOptions().isDevMode?null!=s?void console.log(t,e,i,n,s):null!=n?void console.log(t,e,i,n):null!=i?void console.log(t,e,i):null!=e?void console.log(t,e):null!=t?void console.log(t):void 0:void 0}var l="vertical axis",o="horizontal axis",c="labels stack side by side",h="labels stack top to bottom",d="optimistic approximation: labels have different lengths",u="pessimistic approximation: all labels have the largest length",m=10;a.highlightValueRun=function(t){var e="top"==a.orient()||"bottom"==a.orient()?o:l;t.select(".vzb-axis-value").classed("vzb-hidden","none"==g).select("text").text(a.tickFormat()("none"==g?0:g));var i=function(){return"none"==g?"translate(0,0)":"translate("+(e==o?a.scale()(g):0)+","+(e==l?a.scale()(g):0)+")"},n=function(t,e){return"none"==g?1:Math.min(1,Math.pow(Math.abs(a.scale()(t)-a.scale()(g))/(a.scale().range()[1]-a.scale().range()[0])*5,2))};p?(t.selectAll(".tick").each(function(t,e){d3.select(this).select("text").transition().duration(p).ease("linear").style("opacity",n(t,e))}),t.select(".vzb-axis-value").transition().duration(p).ease("linear").attr("transform",i)):(t.selectAll(".tick").each(function(t,e){d3.select(this).select("text").style("opacity",n(t,e))}),t.select(".vzb-axis-value").attr("transform",i)),g=null};var g=null;a.highlightValue=function(t){return arguments.length?(g=t,a):g};var p=0;a.highlightTransDuration=function(t){return arguments.length?(p=t,a):p};var f=null;a.repositionLabels=function(t){return arguments.length?(f=t,a):f};var v=!1;a.pivot=function(t){return arguments.length?(v=!!t,a):v};var b=[];a.tickValuesMinor=function(t){return arguments.length?(b=t,a):b};var y={outbound:0,inbound:0};a.tickSizeMinor=function(t,e){return arguments.length?(y={outbound:t,inbound:e||0},r("setting",y),a):y};var x={};return a.labelerOptions=function(t){return arguments.length?(x=t,a):x},a.METHOD_REPEATING="repeating specified powers",a.METHOD_DOUBLING="doubling the value",a.labelFactory=function(t){function e(e,i){return 0==e||0==i?0:(null==i&&(i=t.logBase),Math.log(e)/Math.log(i))}if(null==t&&(t={}),"linear"!=t.scaleType&&"time"!=t.scaleType&&"genericLog"!=t.scaleType&&"log"!=t.scaleType&&"ordinal"!=t.scaleType)return a.ticks(_).tickFormat(null).tickValues(null).tickValuesMinor(null).pivot(null).repositionLabels(null);if("ordinal"==t.scaleType)return a.tickValues(null);null==t.logBase&&(t.logBase=m),null==t.stops&&(t.stops=[1,2,5,3,7,4,6,8,9]),null==t.removeAllLabels&&(t.removeAllLabels=!1),null==t.formatterRemovePrefix&&(t.formatterRemovePrefix=!1),null==t.formatter&&(t.formatter=function(e){if("time"==t.scaleType)return e instanceof Date||(e=new Date(e)),t.timeFormat(e);var i="f",a=0;Math.abs(e)<1&&(a=1,i="r");var n="";if(t.formatterRemovePrefix)return d3.format("."+a+i)(e);switch(Math.floor(Math.log(Math.abs(e))/Math.LN10)){case-13:e=1e12*e,n="p";break;case-10:e=1e9*e,n="n";break;case-7:e=1e6*e,n="µ";break;case-6:e=1e6*e,n="µ";break;case-5:e=1e6*e,n="µ";break;case-4:break;case-3:break;case-2:break;case-1:break;case 0:break;case 1:break;case 2:break;case 3:break;case 4:break;case 5:e/=1e3,n="k";break;case 6:e/=1e6,n="M",a=1;break;case 7:e/=1e6,n="M";break;case 8:e/=1e6,n="M";break;case 9:e/=1e9,n="B",a=1;break;case 10:e/=1e9,n="B";break;case 11:e/=1e9,n="B";break;case 12:e/=1e12,n="T",a=1;break;default:return d3.format("."+a+"s")(e).replace("G","B")}return(d3.format("."+a+i)(e)+n).replace("G","B")}),t.cssLabelMarginLimit=5,(null==t.cssMarginLeft||parseInt(t.cssMarginLeft)<t.cssLabelMarginLimit)&&(t.cssMarginLeft=t.cssLabelMarginLimit+"px"),(null==t.cssMarginRight||parseInt(t.cssMarginRight)<t.cssLabelMarginLimit)&&(t.cssMarginRight=t.cssLabelMarginLimit+"px"),(null==t.cssMarginTop||parseInt(t.cssMarginTop)<t.cssLabelMarginLimit)&&(t.cssMarginTop=t.cssLabelMarginLimit+"px"),(null==t.cssMarginBottom||parseInt(t.cssMarginBottom)<t.cssLabelMarginLimit)&&(t.cssMarginBottom=t.cssLabelMarginLimit+"px"),null==t.toolMargin&&(t.toolMargin={left:30,bottom:30,right:30,top:30}),null==t.bump&&(t.bump=0),null==t.constantRakeLength&&(t.constantRakeLength=0),null==t.pivotingLimit&&(t.pivotingLimit=t.toolMargin[this.orient()]),null==t.showOuter&&(t.showOuter=!1),null==t.limitMaxTickNumber&&(t.limitMaxTickNumber=0);var c="top"==this.orient()||"bottom"==this.orient()?o:l;null==t.isPivotAuto&&(t.isPivotAuto=c==l),null==t.cssFontSize&&(t.cssFontSize="13px"),null==t.widthToFontsizeRatio&&(t.widthToFontsizeRatio=.75),null==t.heightToFontsizeRatio&&(t.heightToFontsizeRatio=1.2),null==t.widthOfOneDigit&&(t.widthOfOneDigit=parseInt(t.cssFontSize)*t.widthToFontsizeRatio),null==t.heightOfOneDigit&&(t.heightOfOneDigit=parseInt(t.cssFontSize)*t.heightToFontsizeRatio),r("********** "+c+" **********");var h=a.scale().domain(),g=a.scale().range(),p=(Math.abs(h[h.length-1]-h[0]),Math.abs(g[g.length-1]-g[0])),f=d3.min([h[0],h[h.length-1]]),v=d3.max([h[0],h[h.length-1]]),b=0>f&&v>0&&"time"!=t.scaleType;b&&"log"==t.scaleType&&console.error("It looks like your "+c+" log scale domain is crossing ZERO. Classic log scale can only be one-sided. If need crossing zero try using genericLog scale instead");var y=t.showOuter?[f,v]:[],x=[],_=5,M=d3.max(d3.range(f,v,(v-f)/17).concat(v).map(function(e){return t.formatter(e).length}))*t.widthOfOneDigit+parseInt(t.cssMarginLeft),z=t.isPivotAuto&&(M+a.tickPadding()+a.tickSize()>t.pivotingLimit&&c==l||!(M+a.tickPadding()+a.tickSize()>t.pivotingLimit)&&!(c==l)),w=c==o&&z||c==l&&!z,k=!w&&t.heightOfOneDigit>t.pivotingLimit;if(t.removeAllLabels)return a.tickValues([]);if(f==v)return a.tickValues([f]).ticks(1).tickFormat(t.formatter);var S=function(e,i,n,s){if(null==e||e.length<=1)return!0;if(null==n&&(n=u),null==s&&(scaleType="none"),w)return i>e.length*(t.heightOfOneDigit+parseInt(t.cssMarginTop)+parseInt(t.cssMarginBottom));var r=parseInt(t.cssMarginLeft)+parseInt(t.cssMarginRight),l=d3.max(e.map(function(e){return t.formatter(e).length}));return"log"==s?(i=Math.abs(a.scale()(d3.max(e))-a.scale()(d3.min(e))),i>d3.sum(e.map(function(e){return(t.widthOfOneDigit*(n==u?l:t.formatter(e).length)+r)*(1+Math.log(e.toString().replace(/([0\.])/g,"")[0])/Math.LN10)}))):i>e.length*r+(n==u?t.widthOfOneDigit*e.length*l:0)+(n==d?t.widthOfOneDigit*e.map(function(e){return t.formatter(e)}).join("").length:0)},E=function(e,i){if(null==i||0==i.length)return!1;i instanceof Array||(i=[i]);for(var n=0;n<i.length;n++)if(e!=i[n]&&0!=e&&Math.abs(a.scale()(e)-a.scale()(i[n]))<(w?t.heightOfOneDigit:(t.formatter(e).length+t.formatter(i[n]).length)*t.widthOfOneDigit/2))return!0;return!1};if("genericLog"==t.scaleType||"log"==t.scaleType){var T=a.scale().eps?a.scale().eps():0,L=b?[0]:[],O=T>v?[]:d3.range(Math.floor(e(Math.max(T,f))),Math.ceil(e(v)),1).concat(Math.ceil(e(v))).map(function(e){return Math.pow(t.logBase,e)}),A=f>-T?[]:d3.range(Math.floor(e(Math.max(T,-v))),Math.ceil(e(-f)),1).concat(Math.ceil(e(-f))).map(function(e){return-Math.pow(t.logBase,e)});if(null==t.method){var P=b?Math.max(Math.abs(v),Math.abs(f))/T:Math.max(Math.abs(v),Math.abs(f))/Math.min(Math.abs(v),Math.abs(f));t.method=P>=10&&1024>=P?this.METHOD_DOUBLING:this.METHOD_REPEATING}if(t.method==this.METHOD_DOUBLING){var D=[];b&&y.push(0);var C=[].concat(y),I=T>v?null:4*O[Math.floor(O.length/2)-1],q=f>-T?null:4*A[Math.floor(A.length/2)-1];if(I)for(var R=I;v>=R;R*=2)D.push(R);if(I)for(var R=I/2;R>=Math.max(f,T);R/=2)D.push(R);if(q)for(var R=q;R>=f;R*=2)D.push(R);if(q)for(var R=q/2;R<=Math.min(v,-T);R/=2)D.push(R);D=D.sort(d3.ascending).filter(function(t){return t>=f&&v>=t}),x=x.concat(D),D=n(D,!1);for(var B=y,F=0;F<D.length;F++){var H=B.concat(D[F]).filter(function(t){return!E(t,C)}).filter(i);if(!S(H,p,u,"none"))break;y=H}}if(t.method==this.METHOD_REPEATING){var N=L.concat(O).concat(A).sort(d3.ascending);t.stops.forEach(function(t,e){x=x.concat(N.map(function(e){return e*t}))}),N=n(N);var C=L.concat(y),j=!1;t.stops.forEach(function(e,a){if(0==a){for(var n=0;n<N.length;n++){var s=y.concat(N[n].map(function(t){return t*e})).filter(function(t){return!E(t,C)}).filter(function(t){return t>=f&&v>=t}).filter(i);if(!S(s,p,u,"none"))break;y=s}N=[].concat.apply([],N)}else{if(j)return;var s=y.concat(N.map(function(t){return t*e})).filter(function(t){return t>=f&&v>=t}).filter(i);if(!S(s,p,u,"log"))return void(j=!0);if(y.length>t.limitMaxTickNumber&&0!=t.limitMaxTickNumber)return void(j=!0);y=s}})}}if("linear"==t.scaleType||"time"==t.scaleType){b&&y.push(0);var C=[].concat(y);_=w?Math.max(Math.floor(p/(t.heightOfOneDigit+parseInt(t.cssMarginTop))),2):Math.max(Math.floor(p/M),2),0!=t.limitMaxTickNumber&&_>t.limitMaxTickNumber&&(_=t.limitMaxTickNumber);var Y=a.scale().ticks.apply(a.scale(),[_]).sort(d3.ascending).filter(function(t){return t>=f&&v>=t});x=x.concat(Y),Y=n(Y,!1);for(var B=y,F=0;F<Y.length;F++){var H=B.concat(Y[F]).filter(function(t){return!E(t,C)}).filter(i);if(!S(H,p,u,"none"))break;y=H}y=y.filter(function(t){return!E(t,C)}).filter(i)}return null!=y&&y.length<=2&&!b&&(y=[f,v]),null!=y&&y.length<=3&&b&&(y=E(0,[f,v])?[f,v]:[f,0,v]),null!=y&&y.sort(function(t,e){return(c==o?-1:1)*(a.scale()(e)-a.scale()(t))}),k&&(y=[]),x=x.filter(function(t){return-1==y.indexOf(t)&&t>=f&&v>=t}),r("final result",y),a.ticks(_).tickFormat(t.formatter).tickValues(y).tickValuesMinor(x).pivot(z).repositionLabels(s(y,t,c,a.scale(),w?"y":"x"))},a.copy=function(){return t(d3.svg.axis())},d3.rebind(a,e,"scale","orient","ticks","tickValues","tickFormat","tickSize","innerTickSize","outerTickSize","tickPadding","tickSubdivide")}(d3.svg.axis())}function A(t,e,i){var a,n,s,r,l,o,c,h,d,u,m;return{move:function(e,i){t.style("right",e+"px"),t.style("top",i+"px")},dragStart:function(i){if(ne()){var g=d3.touches(e.node());a=g[0][0],n=g[0][1]}else a=i.sourceEvent.clientX,n=i.sourceEvent.clientY;s=parseInt(t.style("top"))||0,r=parseInt(t.style("right"))||0,l=parseInt(t.style("margin-right"))||0,o=parseInt(t.style("width")),c=parseInt(t.style("height")),h=parseInt(e.style("width"))-l,d=parseInt(e.style("height")),u=a+r,m=n-s},drag:function(t){if(ne()){var s=d3.touches(e.node());a=s[0][0],n=s[0][1]}else a=t.sourceEvent.clientX,n=t.sourceEvent.clientY;var r=-a+u,l=n-m;-i>r&&(r=-i),0>l&&(l=0),r+o>h&&(r=h-o),l+c>d&&(l=d-c),this.move(r,l)}}}function P(){return window?void 0!==window.document.webkitIsFullScreen?window.document.webkitIsFullScreen:void 0!==window.document.mozFullScreen?window.document.mozFullScreen:void 0!==window.document.msFullscreenElement?window.document.msFullscreenElement:!1:!1}function D(t){P()||t()}function C(t){if(window){var e=window.document;this.exitFullscreenHandler=D.bind(this,t),e.addEventListener("webkitfullscreenchange",this.exitFullscreenHandler,!1),e.addEventListener("mozfullscreenchange",this.exitFullscreenHandler,!1),e.addEventListener("fullscreenchange",this.exitFullscreenHandler,!1),e.addEventListener("MSFullscreenChange",this.exitFullscreenHandler,!1)}}function I(){var t=window.document;t.removeEventListener("webkitfullscreenchange",this.exitFullscreenHandler),t.removeEventListener("mozfullscreenchange",this.exitFullscreenHandler),t.removeEventListener("fullscreenchange",this.exitFullscreenHandler),t.removeEventListener("MSFullscreenChange",this.exitFullscreenHandler)}function q(t){t.requestFullscreen?t.requestFullscreen():t.msRequestFullscreen?t.msRequestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen&&(navigator.vendor&&navigator.vendor.indexOf("Apple")>-1&&navigator.userAgent&&!navigator.userAgent.match("CriOS")||t.webkitRequestFullscreen())}function R(){I.call(this),document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()}function B(){function t(){function t(){for(var t=[],i=0;s>i;i++){var d=r+(1-r)/s*i;t.push([]);for(var u=0;a>=u;u++){var m=n+(1-n)/a*u;t[i].push({display:e(m,0==u?h:l,0==i?o:d),meaning:e(m,0==u?h:l,0==i?c:d)})}}return t}function e(t,e,i){var a,n,s;if(0==e)a=n=s=i;else{var r=function(t,e,i){return 0>i&&(i+=1),i>1&&(i-=1),1/6>i?t+6*(e-t)*i:.5>i?e:2/3>i?t+(e-t)*(2/3-i)*6:t},l=.5>i?i*(1+e):i+e-i*e,o=2*i-l;a=r(o,l,t+1/3),n=r(o,l,t),s=r(o,l,t-1/3)}return"#"+Math.round(255*a).toString(16)+Math.round(255*n).toString(16)+Math.round(255*s).toString(16)}function i(e){if(i.container=e,M=e.select("."+b.COLOR_PICKER),M.empty()){e.on("click",function(){i.show(!1),d3.event.stopPropagation()}),y=t(),M=e.append("svg").style("position","absolute").style("top","0").style("left","0").style("width","100%").style("max-width",u+"px").style("height","100%").style("max-height",m+"px").style("z-index",9999).attr("class",b.COLOR_PICKER+" vzb-dialog-shadow").classed(b.INVISIBLE,!w);var a=parseInt(M.style("width")),n=parseInt(M.style("height")),r=a/2*(1-g.left-g.right);E=M.append("rect").attr("width",a).attr("height",m).attr("class",b.COLOR_BUTTON+" "+b.COLOR_BACKGR).on("mouseover",function(t){A(p)});var l=M.append("g").attr("class",b.COLOR_CIRCLES).attr("transform","translate("+(r+a*g.left)+","+(r+n*g.top)+")");M.append("rect").attr("class",b.COLOR_SAMPLE).attr("width",a/2).attr("height",n*g.top/2),k=M.append("rect").attr("class",b.COLOR_SAMPLE).attr("width",a/2).attr("x",a/2).attr("height",n*g.top/2),M.append("text").attr("x",a*g.left).attr("y",n*g.top/2).attr("dy","0.5em").attr("class",b.COLOR_SAMPLE).style("text-anchor","start"),S=M.append("text").attr("x",a*(1-g.right)).attr("y",n*g.top/2).attr("dy","0.5em").attr("class",b.COLOR_SAMPLE).style("text-anchor","end"),M.append("text").attr("x",.1*a).attr("y",n*(1-g.bottom)).attr("dy","0.3em").attr("class","vzb-default-label").style("text-anchor","start").text("default"),M.append("circle").attr("class",b.COLOR_DEFAULT+" "+b.COLOR_BUTTON).attr("r",a*g.left/2).attr("cx",a*g.left*1.5).attr("cy",n*(1-1.5*g.bottom)).on("mouseover",function(){d3.select(this).style("stroke","#444"),A(f)}).on("mouseout",function(){d3.select(this).style("stroke","none")}),l.selectAll("."+b.COLOR_CIRCLE).data(y).enter().append("g").attr("class",b.COLOR_CIRCLE).each(function(t,e){x.outerRadius(d+(r-d)/s*(s-e)).innerRadius(d+(r-d)/s*(s-e-1));var i=d3.select(this).selectAll("."+b.COLOR_SEGMENT).data(_(t)).enter().append("g").attr("class",b.COLOR_SEGMENT);i.append("path").attr("class",b.COLOR_BUTTON).attr("d",x).style("fill",function(t){return t.data.display}).style("stroke",function(t){return t.data.display}).on("mouseover",function(t){A(t.data.meaning,this)}).on("mouseout",function(t){P()})}),l.append("circle").attr("r",d).attr("fill",v).attr("class",b.COLOR_BUTTON).on("mouseover",function(){d3.select(this).style("stroke","#555"),A(v)}).on("mouseout",function(){d3.select(this).style("stroke","none")}),z=l.append("path").attr("class",b.COLOR_POINTER+" "+b.INVISIBLE),M.selectAll("."+b.COLOR_BUTTON).on("click",function(){d3.event.stopPropagation(),O.show(!1)}),L(M),i.resize(M)}}var a=15,n=0,s=4,r=.5,l=.7,o=.4,c=.3,h=0,d=15,u=280,m=323,g={top:.1,bottom:.1,left:.1,right:.1},p="#000",f="#000",v="#f8f8f8",b={INVISIBLE:"vzb-invisible",COLOR_POINTER:"vzb-colorpicker-pointer",COLOR_BUTTON:"vzb-colorpicker-cell",COLOR_DEFAULT:"vzb-colorpicker-default",COLOR_SAMPLE:"vzb-colorpicker-sample",COLOR_PICKER:"vzb-colorpicker-svg",COLOR_CIRCLE:"vzb-colorpicker-circle",COLOR_CIRCLES:"vzb-colorpicker-circles",COLOR_SEGMENT:"vzb-colorpicker-segment",COLOR_BACKGR:"vzb-colorpicker-background"},y=[],x=d3.svg.arc(),_=d3.layout.pie().sort(null).value(function(t){return 1}),M=null,z=null,w=!1,k=null,S=null,E=null,T=function(t){console.info("Color picker callback example. Setting color to "+t)},L=function(t){t.select("."+b.COLOR_BACKGR).style("fill","white"),t.select("."+b.COLOR_POINTER).style("stroke-width",2).style("stroke",v).style("pointer-events","none").style("fill","none"),t.selectAll("."+b.COLOR_BUTTON).style("cursor","pointer"),t.selectAll("text").style("dominant-baseline","hanging").style("fill","#D9D9D9").style("font-size","0.7em").style("text-transform","uppercase"),t.selectAll("circle."+b.COLOR_BUTTON).style("stroke-width",2)},O=i,A=function(t,e){null!=e&&z.classed(b.INVISIBLE,!1).attr("d",d3.select(e).attr("d")),k.style("fill",t),S.text(t),T(t)},P=function(){z.classed(b.INVISIBLE,!0)},D="toggle";return i.show=function(t){return arguments.length?(null==M&&console.warn("Color picker is missing SVG element. Was init sequence performed?"),w=t==D?!w:t,w||(T=function(){}),void M.classed(b.INVISIBLE,!w)):w},i.nCellsH=function(t){return arguments.length?(a=t,i):a},i.minH=function(t){return arguments.length?(n=t,i):n},i.nCellsL=function(t){return arguments.length?(s=t,i):s},i.minL=function(t){return arguments.length?(r=t,i):r},i.outerL_display=function(t){return arguments.length?(o=t,i):o},i.outerL_meaning=function(t){return arguments.length?(c=t,i):c},i.satConstant=function(t){return arguments.length?(l=t,i):l},i.firstAngleSat=function(t){return arguments.length?(h=t,i):h},i.minRadius=function(t){return arguments.length?(d=t,i):d},i.margin=function(t){return arguments.length?(g=t,i):g},i.callback=function(t){return arguments.length?(T=t,i):T},i.colorDef=function(t){return arguments.length?("undefined"!=typeof t&&(f=t),null==M&&console.warn("Color picker is missing SVG element. Was init sequence performed?"),M.select("."+b.COLOR_DEFAULT).style("fill",f),i):f},i.fitToScreen=function(t){var e,a,n=i.container.node().getBoundingClientRect(),s=parseInt(M.style("width")),r=parseInt(M.style("height"));t?(e=t[0]-n.left,a=t[1]-n.top):(e=n.width-parseInt(M.style("right"))-s,a=parseInt(M.style("top")));var l={left:""};return.8*n.width<=s?l.right=.5*(n.width-s)+"px":e+s>n.width?l.right=Math.min(.1*n.width,20)+"px":l.right=n.width-e-s+"px",.8*n.height<=r?l.top=.5*(n.height-r)+"px":a+1.2*r>n.height?l.top=.9*n.height-r+"px":l.top=a+"px",M.style(l),i},i.colorOld=function(t){return arguments.length?(p=t,null==M&&console.warn("Color picker is missing SVG element. Was init sequence performed?"),M.select("rect."+b.COLOR_SAMPLE).style("fill",p),M.select("text."+b.COLOR_SAMPLE).text(p),i):p},i.resize=function(t){if(!arguments.length)return resize;if("undefined"!=typeof t){var e=t,a=parseInt(e.style("width")),n=parseInt(e.style("height")),s=a/2*(1-g.left-g.right),r=e.select("."+b.COLOR_DEFAULT),l=e.select(".vzb-default-label"),o=e.select("."+b.COLOR_CIRCLES),c=s+n*g.top,h=(1+.5*g.top)*n*.5;c=c>h?h:c,o.attr("transform","translate("+(s+a*g.left)+","+c+")"),r.attr("cx",a*g.left*1.5).attr("cy",n*(1-1.5*g.bottom)),l.attr("x",.1*a).attr("y",n*(1-g.bottom))}return i.fitToScreen(),i},i}return function(){return null==Va&&(Va=t()),Va}()}function F(){return function(){function t(t){t.selectAll("path").remove(),t.html(e),t.selectAll("path").datum(function(){return{"geo.name":d3.select(this).attr("id"),"geo.region":d3.select(this).attr("id")}})}var e='<svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 584.5 364.5"><path id="europe" d="M556.7,26.9l-35.5-7.3l-3.5,1.4l-49.9-5.2l-2.7,2l-45.8-4.1l-1.3-1.9l-15.3-2.2l-0.2,0.1h-0.1l-0.2,0.2l-6,0.6 l-0.5,0.5L372.4,17l-1.7,1.7l-5.8-3.1h-1.7l-1.5,3.7l1.8,2.5l-0.4,0.2l-10.1-1.5l-6.8,1.9l-5.3-0.6l-7.2,2.6l-4.2-1h-0.1l-3.1,3.2 l-0.9,0.2l-2.6,2.2l-2.3,0.8l-1.6,2h-1.7l-5.1-5.1l-1-0.2l-0.1-0.5l1.3-0.9l8.4,1.6l0.5-0.1l2.4-1.8l-0.8-0.9l-20.2-5.5l-16.9,3.4 L268,37l0.8,6.1l3.2,1.7l4-1l1.5,0.9l2.6,5.5h0.8l0.7,1.2l0.8,0.2l7.9-9.7l-2.9-5.4l8.5-8.9h0.5l1.3,1.7l-2.7,6.6l0.8,2.8l11.9,2.4 l-4,1.8l-3.5-0.3l-1.5,1.2l1,1.6l-0.1,2.2l-0.9-0.6H297l-1.8,1.2l-0.5,3.9l-2.3,2.2h-4.3l-4.2,1.9l-6.8-0.7l-0.6-0.4l2.5-1.7 l0.5-1.2l-0.9-1.7l-0.2-0.1l-2.3,0.5l-0.2-0.1l-0.2-3.4l-0.4-0.1l-2.6,3.9l1.3,3.7l-1.4,1.7L269,57l-18.9,13.1l0.1,1l1.7,1.6 l0.8,0.3l1.3,2.2l0.3,3.6l-3.1,4.5l-9.7-0.9l-1.3,1.5L239,97.9l0.4,1.1l5.1,3.1l0.2,0.8l1.6-0.2l0.1-0.2h0.1v-0.1l7.9-4.5l10-14.3 l10-2.8l1.2,0.5l11,11.5l0.2,2.3l-2,1.8l-1.9-0.4l-1.8,0.5l3.8,3.9l1.1-0.7l3.7-5.6l0.2-0.5l-0.9-1.9l0.2-0.4l2.3,0.3l0.8-1 l-1.7-0.9l-8.7-7.6l-0.5-4.5l1.4,0.2l10.4,8l3.4,9l1,0.5l0.5,0.6v1.5l4.5,6.1v0.4l0.7,1.1l3.7,1.3l1.4-1.6l-3.8-2.3l-0.1-1.7 l2.2-2.6l-6.3-6.3l5.6-2.2L306,90l5.8,8l4.2-0.6l2.7,0.9l1,4.7l0.7-0.1l1.8-2l-1.3-1.7l0.2-0.9h4.3l0.3,2.7l15.2-4.7l0.4-5.1 l1.5-0.9l2.5,2l3.9-2.1l1.4,1.5l0.3-3.9l-3.1-5.3l-1.3-8.6l2.9-2.5l-0.6-2.7l-3.8-3.8l4.5-6.9l6.8,1.6l1.1-3.1l9.2,3.8l13.3-3.1 l-1.8-6.7l0.2-1l8.7,7.4l22.2,7.4l4.3-2.7l1.5-4.5l1-0.5l0.2,0.2l6,0.4l1,1.2l1.7,0.8l0.5-0.3l7.5,2.9l7.5-4.2l1.5,1.8l22.1,0.8 l0.7-1.8l23.5-1.4l7,9.2l9.6-1.2l3.4,15.2l1,1.1l-0.2,0.2l1.7,1.7l0.5,0.1l1.8-2.2l1.6-5.3L508,56.7l-2.9-2.2l-5.5,0.3l-2.6-2.5 l1.8-7.8l0.5-0.3l0.2-0.9l3.4-1.7l14.2,0.6l1.3-4.8l1.6-1.2l0.4-0.1l4.3,1.2l0.1-0.1l0.2,0.1l3.1-2.5l1.7,0.9l-1,12l6.9,15.9l3.1-3 l0.1-0.3l2.3,1.1l0.8-2.2l-1.1-8.7l-4.8-5.8l0.1-2.6l0.8-1.5l4.5-2.2l2.2,0.2l4-3.7l2.1-0.3l1.1-1.7l-5.2-2.5l-0.5-1.7l2.9-1.7 l8.2,2.2l0.9-0.2l0.8-1.2L556.7,26.9 M331,87l-11.6-3.1l-8.9,2.9l-0.2-0.1l-0.5-1.9l2.9-7l2.9-2.5h1.7l2.1,1.1l2.3-1.7l1.8-3.4 l1.8-0.6l2.1,0.6l-0.8,3.9l7.7,7.3L331,87 M252.8,18.2l-5.8,5.6l-3.7,1.1l-1.1,4.3l-2.2,1.7l-0.2,1.2l0.9,1.7l7.8,1.2l-2.4,2.9 l-4.6,1.7l-5.9-2.9l2-1.8l1.9-0.8l-2.5-2.1l-11.4,1.7l-4.7,3.1l-8,1.7L203,49l-3.4,0.3l-3.7-2.8l-1.3-10.6l5.2-4.5l1.1-2l-1.9-3.3 l-0.5-0.3v-0.6l-0.5-0.3v-0.6l-0.6-0.3l-1.1-1.4l-3.1-1.4h-5.5l-4-1.7l71.2-3.4L252.8,18.2 M258.9,60.7l0.7,1.2l-10.5,1.5l3.4-1.5 l-0.1-1.5l-2.7-0.9l4.2-4.9l-2.7-2.7l-5.9,7.4l-4.4,0.8l1.1-2.7l-0.2-2.7l8.5-4.8l0.3-3.8l1-1.3l1.3,0.4l0.2,1.1l1.3,0.3l-0.8,3.2 l3.3,2.4l1.7,5.1l2.6,0.9L258.9,60.7"/><path id="africa" d="M322.7,114.7l-1-1.8l-6.5,2.3l-16-4.8l-2.3,1.7l-1.8,4.5l-16.9-8.6l-0.2-0.6l-0.3-5.5l-2-2.8l-29,4.4l-0.2-0.4 l-1.7,0.2l-0.1,1.1l-6.7,7l-0.5,1.9l-0.6,0.7l-0.3,3.3l-15.3,23.7l0.6,13.2l-1.4,3l1.1,7.6l12.1,17.9l6,2.8l7.1-1.9l4.5,0.8 l13.7-3.3l3.9,4.5h3.5l1.6,1.4l1.8,3.6l-1.1,10.7l9.2,27.4l-4,14.6l8.5,30.7l1.1,1.1v0.7h0.5l3.5,12.5l2,1.7l11.9-0.6l15-18.2v-3.9 l5.1-4.5l1.1-4.2l-1.1-5.9l10.5-12.2l0.6-0.3l1.6-3.7l-3.4-24l25-43.3l-13.1,1.1l-1.8-1.1l-24.7-48.6l0.9-0.4l0.6-1L322.7,114.7  M360.1,233.2l2.3,1.7l-8.6,30.5l-4.3-0.6l-2-7.6l2.8-14.6l6.4-4.4l2.8-4.9L360.1,233.2z"/><path id="americas" d="M134.8,152l-11.4,1.8l-3.1-1.7l5.3-1.3l-0.7-1.1l-3.3-1.4h-0.1l-8.1-0.9l-0.3-0.3l-0.3-1.5l-6.2-3.6l-3.4,0.8 l-1.6,1.3l-1.2-0.5l-0.7-1.7l3.8-1.6l9.1,0.7l9.5,5.3l0,0l3.3,1.8l1.7-0.5l6.6,2.8L134.8,152 M183.7,25.4l-0.5-1.5l-2.6-2.2 l-2.1-0.6l-2.9-2.2l-18.2-2.2l-5.1,3.7l2,4.3l-6,2.2l1-1.7l-4.6-1.9l-0.5-1.7l-1.1-1.2l-2.9,0.5l-2.1,4.2l-5.8,2.5l-15.5-2.2 l10.5-1.7l-1.3-4l-11.6-0.4l-3.2-1.5L96,20.7h5.8l4,1.9l-1.7,1l0.8,1l7.2,2.3l-78.9-5.3l-10,3.6l-0.4,4.4L18,31.1l1,1.8l1.7,1.2 l-5.5,4.5l-0.4,5.6L13.8,46l1.8,1.8l-4.4,6.2L22,43.7l1.8-0.5l1.3-1.2l13.4,4l4,4.2l-1.3,14l1.6,2.6l-3.3,1.3L39.4,70l2.7,2.6 L28.6,96.9l1.6,11.2l4.8,5.6l-0.2,3.4l2.5,6.1l-0.5,5l6.6,11.9L38,121.5l1.7-4l3.4,6.1l0.3,2.2l7.1,13.1l1.1,9.2l11.1,8.7l1.6,0.3 l1.3,0.9l5.5,1.2l3.4-0.9l5.5,4.2l0.3,0.5l0.8,0.3l2.1,1.9l5.5,0.5l0.2,0.6l0.8,0.3l4.8,8.9l2.3,1.5l0.2,0.5l7.1,3.4l1.6-1.7 l-5.1-2.2l-1.3-15.6l-6.3-2.2l-3.7,0.3v-4.6l3.7-8.9l-5.2-0.9l-0.5,0.3L83,151l-6.3,2.2l-4-2.8l-3.2-8.9l3.2-11.8l0.5-0.3l0.2-1.2 l2.6-3.1l8.5-3.6l6.3,1.8l4.5-3.1l9.2,1.1l2.5,3.1l1.5,7.8l1.3,1.8l2.1-4.5l-1.1-5l1.6-7l13.7-12.3l0.2-3.7l0.8-1.7l0.9-0.2l0.7,0.5 l0.6-1.9l15-8.8l2.2-3.9l11.9-5.1l-2.2,3.6l11.4-3.8l-5.2-1.7l-1.8-2.8l1.6-4.2l-0.8-0.9h-4.2l0.8-1.5l19.5-3.2l1.6,2.8l-4.5,4.2 l6,1.7l5.3-2.2l-6.3-7.6l4.5-6.1l-1.1-0.6l-0.2-0.5h-3.2l-3.7-13.4l-7.7,3.1l-1.8-1.9l0.2-3.9l-2.3-2.5l-3.4-1.5l-6.6,1.9l-2.1,4.2 l-1.1,0.6l-1.3,2.2l-0.3,3.4l-10,9.5l-0.8,2.8l-1.8,1.9l-2.1,0.3l-1.8-2.5l1.1-4.8l-11.9-6.1l-3.1-5.1l15-12l1.3,0.3l5.1-1.2 l1.1-1.2l0.4-1.2l3.4-0.3l-1.7,4.8L147,34l4.6,0.7l-2.2-2.9l-2.1-1.2l8.2-2.8l0.3-0.6l2-1.7l0.7,0.1l8.1-4.2l7.4,5.3l0.2,1.5l-6,1.5 l-1.8,2.2l3.7,5.3l3.4,1.2l2.3-2.2l2.9-1.2L179,33l-0.2-1.9l7.7-1.7L183.7,25.4 M119.7,74.5l0.8,3.1l1.7,1.8l3.3-0.2l5.4,4.7 l2.7,0.2l-0.5,1.7l-4.7-0.4l0.2-1.2l-2.6-0.9l-2,0.6l-2.6,3.4l3.1,1.7l-3.2,2.3l-2.6-1.2l0.1-9.3l-9.6,9.9L108,88l4.5-7l4.3-2 l-5.1-2.1l-4.8,0.5l0.2-1.7l1.3-1.2l8.7-2.2L119.7,74.5 M205.9,223.1l-1.3,3.1H204l-7.1,11.2l-1.9,18.2l-3.1,6.1h-0.5v0.6l-0.8,0.3 l-1.1,1.2l-2.7-0.3l-9.4,6.7l-7.7,21.6l-3.9,3.3l-5.1-1.1l2.1,3.3l0.5,5.3l-7.9,3.3l-1.4,1.5l-0.5,3.6l-1.1,0.6l-1.1-0.3l-1.8,0.9 l1.8,6.1l-1.8,5.6l3.4,6.1l-2,5.9l0.5,3.1l11.1,8.2l-0.2,0.5l-9.3-0.6l-4.3-5.1l-4.7-1.7l-8.6-17.1l0.5-1.7l-6-12.3l-4.5-56.7 l-12.4-10.2l-4.2-8.1l-0.8-0.6l-9.8-21.5l1.1-2.2l-0.3-2.6l-0.5-0.8l7.9-15.3l0.3-5.6l-1-2.8l1-3.9l1.8-0.3l9.7-8.2l2.1,0.3l0.8,5.1 l2.7-5.1l1.3-0.3l4.2,2.8h0.9l0.2,0.6l14.8,3.9l1.6,1.4l0.3,0.6l7.9,6.7l7.7,0.9l4.3,4l2,6.3l-1,4.6l4.4,1.4l1.1,2.2l5.2-1.1 l2.1,1.1l2.6,4l2.9-0.9l9,1.9l8.6,5.8L205.9,223.1"/><path id="asia" d="M322.9,118.9l22.8,42.5l13.5-5.9l16.8-19l-7.3-6.5l-0.7-3.4h-0.1l-5.7,5.2l-0.9,0.1l-3.2-4.4l-0.4-0.2l-0.7,1.7 l-1.2-0.4l-4.1-11.4l0.2-0.5l1.9-1.2l5.1,6.8l6.2,2.7l0.8-0.2l1.1-1.1l1.6,0.4l2.9,2.6l0.4,0.8l16.4,0.8l6.9,6.5l0.4,0.1l1.4-0.3 l0.3,0.1l-1.7,2.5l2.9,2.8h0.7l3.3-3.3l0.5,0.3l9.2,32.1l4,3.7l1.3-1.3h0.2l1.7,1.3l1.4,6.6l1.6,0.9l1.7-2.9l-2.3-7.3l-0.1,0.3v-0.2 l-1.7,0.6l-1.3-1.1l1.2-14.3l14.3-17.6l5.9-1.7l0.3,0.1l3.1,4.5l0.8,0.2l0.9,1.5l0.8,0.3l4.7,10.3l0.2,0.1l2-0.6l5.4,10.1l-0.3,10.5 l2.8,3.7l0,0l4.2,10.8l1.8,1.7l-1.1,2.4l-0.8-0.6l-1.9-4l-1.7-1.4l-0.3-0.9l-5.5-3.5l-2.4-0.3l-0.2,1.2l19.8,28.5l2.6-3.6l-5.7-11.2 l0.9-4l0.7-0.2l0.2-2.3l-9.3-18.6l-0.3-8.9l1.4-1.5l6.7,7.8l1.4,0.3l1.1-0.6l0.1,0.1l-0.2,3.4l0.6,0.5l0.5,0.2l7.4-7.9l-2-10.4 l-6.9-9.5l4.9-6l0.8,0.2l0.8,0.5l1.7,3.9l2.9-4.7l10.1-3.6l5.1-8.1l1.6-9.9l-2.5-2l1.1-1.7l-7.5-11.5l3.5-4.7l-6.1-0.9l-3.5-3.7 l4.1-4.3l0.8-0.1l1.4,0.9l0.6,2.9l2.8-1.3l3.9,1.4l0.9,3.2l2.3,0.5l5,9h0.4l2.3-2.4h0.3l1-1.5l-1.7-3.8l-5.8-5.9l2.1-4v-3.6l2.6-2.4 l0.5,0.1l0.2-0.1l-3.5-15.2l-0.2,0.1v-0.1l-9.3,1.2l-7.3-9.3L464,58.8l-0.8,1.9L441.2,60l-1.5-1.8l-0.2,0.1l0,0l-7.3,4.1l-7.5-3 l-0.5,0.3l-1.8-0.8l-0.9-1.2l-0.3,0.1l-0.1-0.1l-5.7-0.4l-0.3-0.2l0,0l0,0l-1,0.5l-1.5,4.5l-4.2,2.7l-16.8-4.4L377.5,50l0,0l-0.2,1 l1.8,6.7l-13.3,3l-9.2-3.8l-1.1,3.1l-6.7-1.6l-0.1,0.1h-0.2l-4.4,6.8l3.8,3.8l0.6,2.7l0,0l0,0L352,71l2.6,2.2V74l-2.3,1.9l-0.8,1.6 l1.6,3.9l0.9,0.3l1,1.1l2.6,0.9l1.7,1.7l-0.2,1.1l-1.5,2.8l2.1,3.7v4.5l-1.3,1.4l-3.8-0.9l-4.7-5.1v-0.6l-1.4-1.4l-3.9,2.1l-2.4-2.1 l-1.6,0.9l-0.3,5.1l-15.2,4.7l-1.7,9.8l-2.5,1.7L322.9,118.9 M531.1,99.3l-1,2l-4,1.7l-2.4,3l-3.3-2.5l-6.4,0.2l-0.2-0.7l8.9-4.2 l3.7-4.9l-0.6-3.3l-3.2-5.1l-0.7-0.4v-5.1l1.4-2.6l1.7,0.3l0.6,0.7h0.8l1.1,0.8l1.3,0.3l0.6,1.9l-1.7,2l-2.6-1.2L531.1,99.3  M500.5,130.3l1.9-0.9l-0.8,6.3l-1.6-0.3L500.5,130.3 M515.9,180.5l-1.7,0.4l-2.2-3.3l-3.6-2.2l4.3-2.5l0.9-3.1l-0.3-4.1l-4.6-2.1 l-2,0.5l-5.1,8.5l-2.4,0.3l-0.2-3.4l0.8-0.7l4.2-9.3l-1.8-3.7l1.4-9.3l2.4,1.8l1.6,3.6l-0.5,4.8l8,6.4l0.1-0.1l3.1,11.2L515.9,180.5 L515.9,180.5L515.9,180.5 M497.7,179.5l2.6,0.9l1.1,1.9l-1.8,5.1l0.8,7l-6,10.9l-9.2-1.7l-2.9-10.9L497.7,179.5L497.7,179.5  M509,194.8l-1.8,0.1L509,194.8 M515,193.9l-1.7,2.2l-2.4-0.2l-1.9-1.1l-3.3,1.3l-0.3,1.9l1.2,1.4l2.1-0.3l0.9-0.7l1.1,0.1l0.3,1.2 l-1.9,2.6l0.7,5.6l-2.3-2l-1-2l-1.5,1l0.9,5.2l-3.1-0.4l0.2-2.8l-1.4-2.5l2.9-10.5l3.2-1.6l3.8,1.2l3.4-1.1L515,193.9 M530.7,198.1 l2.5,0.5l0.4,0.4l2,5.3l2.1-2.2l4.2-1.7l14.5,11.5l2.4,0.5l4-2.6l-1.2,4.7l-3.5,1.4l-0.5,1.4l0.1,1.3l4.4,6.5l-4.4-1.5l-5.2-7.5 l-5.6,4.4l-5.6-2l-1.2-1.5l1.3-1.5l-1.9-2.4l-0.3-0.8l-8.5-5l-0.9-4.7l-3.4-3.1l2.4-1.4H530.7 M476.6,212.1l19.1,5l3.1-0.8l4.4,1.4 l3.3-0.9l12.4,2.1l-0.1,0.6l-8.2,4v-1.9l-35.4-5.6l-1.5-1.8l2.5-1.9H476.6 M569.4,280.1l-19,14.6l-0.7-1.1l2.2-4.6l5.1-3l7.4-9.7 l0.9-4.3l4.8,5.1L569.4,280.1 M554.3,267.3l-11.1,18.2l-5.7,3.1l-4.8,7.7l-2.5,0.5l-0.6-1.9l0.5-3.4l2.8-2.9l-6.6-0.8l-1.6-1.4 l-1.7-8.4l-0.9-0.9l-3.1,1.1l-5.2-3.9l-32.3,7.3l-2.3-1.9l2.3-4.5l0.6-21.9l1.8-2.5l13.9-6.4l4.3-4.8l0.3-0.9l10-9.2l4.2,1.9l5.5-7 l4.2-1.4l4.9,2l-1.1,5l2.8,4.8l4.5,2.8l3.2-4.5l2.5-11.7l4.6,10.8v7.6l7.7,18.5L554.3,267.3L554.3,267.3L554.3,267.3L554.3,267.3 L554.3,267.3L554.3,267.3"/></svg>';
return t}()}function H(){function t(t,i){return{type:"Feature",id:t.id,properties:t.properties,geometry:e(t.geometry,i)}}function e(t,i){if(!t)return null;if("GeometryCollection"===t.type)return{type:"GeometryCollection",geometries:object.geometries.map(function(t){return e(t,i)})};if(!me.hasOwnProperty(t.type))return null;var a=me[t.type];return d3.geo.stream(t,i(a)),a.result()}function i(){}function a(t){if((e=t.length)<4)return!1;for(var e,i=0,a=t[e-1][1]*t[0][0]-t[e-1][0]*t[0][1];++i<e;)a+=t[i-1][1]*t[i][0]-t[i-1][0]*t[i][1];return 0>=a}function n(t,e){for(var i=e[0],a=e[1],n=!1,s=0,r=t.length,l=r-1;r>s;l=s++){var o=t[s],c=o[0],h=o[1],d=t[l],u=d[0],m=d[1];h>a^m>a&&(u-c)*(a-h)/(m-h)+c>i&&(n=!n)}return n}function s(t){return t?t/Math.sin(t):1}function r(t){return t>0?1:0>t?-1:0}function l(t){return t>1?ve:-1>t?-ve:Math.asin(t)}function o(t){return t>1?0:-1>t?fe:Math.acos(t)}function c(t){return t>0?Math.sqrt(t):0}function h(t){function e(t,e){var i=Math.cos(t),n=Math.cos(e),s=Math.sin(e),r=n*i,l=-((1-r?Math.log(.5*(1+r))/(1-r):-.5)+a/(1+r));return[l*n*Math.sin(t),l*s]}var i=Math.tan(.5*t),a=2*Math.log(Math.cos(.5*t))/(i*i);return e.invert=function(e,i){var n,s=Math.sqrt(e*e+i*i),r=t*-.5,o=50;if(!s)return[0,0];do{var c=.5*r,h=Math.cos(c),d=Math.sin(c),u=Math.tan(c),m=Math.log(1/h);r-=n=(2/u*m-a*u-s)/(-m/(d*d)+1-a/(2*h*h))}while(Math.abs(n)>ge&&--o>0);var g=Math.sin(r);return[Math.atan2(e*g,s*Math.cos(r)),l(i*g/s)]},e}function d(){var t=ve,e=Me(h),i=e(t);return i.radius=function(i){return arguments.length?e(t=i*fe/180):t/fe*180},i}function u(t,e){var i=Math.cos(e),a=s(o(i*Math.cos(t/=2)));return[2*i*Math.sin(t)*a,Math.sin(e)*a]}function m(t){function e(t,e){var l=Math.cos(e),o=Math.cos(t/=2);return[(1+l)*Math.sin(t),(n*e>-Math.atan2(o,s)-.001?0:10*-n)+r+Math.sin(e)*a-(1+l)*i*o]}var i=Math.sin(t),a=Math.cos(t),n=t>0?1:-1,s=Math.tan(n*t),r=(1+i-a)/2;return e.invert=function(t,e){var l=0,o=0,c=50;do{var h=Math.cos(l),d=Math.sin(l),u=Math.cos(o),m=Math.sin(o),g=1+u,p=g*d-t,f=r+m*a-g*i*h-e,v=.5*g*h,b=-d*m,y=.5*i*g*d,x=a*u+i*h*m,_=b*y-x*v,M=.5*(f*b-p*x)/_,z=(p*y-f*v)/_;l-=M,o-=z}while((Math.abs(M)>ge||Math.abs(z)>ge)&&--c>0);return n*o>-Math.atan2(Math.cos(l),s)-.001?[2*l,o]:null},e}function g(){var t=fe/9,e=t>0?1:-1,i=Math.tan(e*t),a=Me(m),n=a(t),s=n.stream;return n.parallel=function(n){return arguments.length?(i=Math.tan((e=(t=n*fe/180)>0?1:-1)*t),a(t)):t/fe*180},n.stream=function(a){var r=n.rotate(),l=s(a),o=(n.rotate([0,0]),s(a));return n.rotate(r),l.sphere=function(){o.polygonStart(),o.lineStart();for(var a=-180*e;180>e*a;a+=90*e)o.point(a,90*e);for(;e*(a-=t)>=-180;)o.point(a,e*-Math.atan2(Math.cos(a*ye/2),i)*xe);o.lineEnd(),o.polygonEnd()},l},n}function p(t){return t=Math.exp(2*t),(t-1)/(t+1)}function f(t){return.5*(Math.exp(t)-Math.exp(-t))}function v(t){return.5*(Math.exp(t)+Math.exp(-t))}function b(t){return Math.log(t+c(t*t+1))}function y(t){return Math.log(t+c(t*t-1))}function x(t,e){var i=Math.tan(e/2),a=c(1-i*i),n=1+a*Math.cos(t/=2),s=Math.sin(t)*a/n,r=i/n,l=s*s,o=r*r;return[4/3*s*(3+l-3*o),4/3*r*(3+3*l-o)]}function _(t,e){var i=Math.abs(e);return fe/4>i?[t,Math.log(Math.tan(fe/4+e/2))]:[t*Math.cos(i)*(2*Math.SQRT2-1/Math.sin(i)),r(e)*(2*Math.SQRT2*(i-fe/4)-Math.log(Math.tan(i/2)))]}function M(t){function e(t,e){var a=we(t,e);if(Math.abs(t)>ve){var n=Math.atan2(a[1],a[0]),s=Math.sqrt(a[0]*a[0]+a[1]*a[1]),r=i*Math.round((n-ve)/i)+ve,o=Math.atan2(Math.sin(n-=r),2-Math.cos(n));n=r+l(fe/s*Math.sin(o))-o,a[0]=s*Math.cos(n),a[1]=s*Math.sin(n)}return a}var i=2*fe/t;return e.invert=function(t,e){var a=Math.sqrt(t*t+e*e);if(a>ve){var n=Math.atan2(e,t),s=i*Math.round((n-ve)/i)+ve,r=n>s?-1:1,l=a*Math.cos(s-n),o=1/Math.tan(r*Math.acos((l-fe)/Math.sqrt(fe*(fe-2*l)+a*a)));n=s+2*Math.atan((o+r*Math.sqrt(o*o-3))/3),t=a*Math.cos(n),e=a*Math.sin(n)}return we.invert(t,e)},e}function z(){var t=5,e=Me(M),i=e(t),a=i.stream,n=.01,s=-Math.cos(n*ye),r=Math.sin(n*ye);return i.lobes=function(i){return arguments.length?e(t=+i):t},i.stream=function(e){var o=i.rotate(),c=a(e),h=(i.rotate([0,0]),a(e));return i.rotate(o),c.sphere=function(){h.polygonStart(),h.lineStart();for(var e=0,i=360/t,a=2*fe/t,o=90-180/t,c=ve;t>e;++e,o-=i,c-=a)h.point(Math.atan2(r*Math.cos(c),s)*xe,l(r*Math.sin(c))*xe),-90>o?(h.point(-90,-180-o-n),h.point(-90,-180-o+n)):(h.point(90,o+n),h.point(90,o-n));h.lineEnd(),h.polygonEnd()},c},i}function w(t){return function(e){var i,a=t*Math.sin(e),n=30;do e-=i=(e+Math.sin(e)-a)/(1+Math.cos(e));while(Math.abs(i)>ge&&--n>0);return e/2}}function k(t,e,i){function a(i,a){return[t*i*Math.cos(a=n(a)),e*Math.sin(a)]}var n=w(i);return a.invert=function(a,n){var s=l(n/e);return[a/(t*Math.cos(s)),l((2*s+Math.sin(2*s))/i)]},a}function S(t,e){var i=2.00276,a=ke(e);return[i*t/(1/Math.cos(e)+1.11072/Math.cos(a)),(e+Math.SQRT2*Math.sin(a))/i]}function E(t){var e=0,i=Me(t),a=i(e);return a.parallel=function(t){return arguments.length?i(e=t*fe/180):e/fe*180},a}function T(t,e){return[t*Math.cos(e),e]}function L(t){function e(e,a){var n=i+t-a,s=n?e*Math.cos(a)/n:n;return[n*Math.sin(s),i-n*Math.cos(s)]}if(!t)return T;var i=1/Math.tan(t);return e.invert=function(e,a){var n=Math.sqrt(e*e+(a=i-a)*a),s=i+t-n;return[n/Math.cos(s)*Math.atan2(e,a),s]},e}function O(t){function e(e,i){for(var a=Math.sin(i),n=Math.cos(i),s=new Array(3),c=0;3>c;++c){var h=t[c];if(s[c]=P(i-h[1],h[3],h[2],n,a,e-h[0]),!s[c][0])return h.point;s[c][1]=C(s[c][1]-h.v[1])}for(var d=o.slice(),c=0;3>c;++c){var u=2==c?0:c+1,m=D(t[c].v[0],s[c][0],s[u][0]);s[c][1]<0&&(m=-m),c?1==c?(m=r-m,d[0]-=s[c][0]*Math.cos(m),d[1]-=s[c][0]*Math.sin(m)):(m=l-m,d[0]+=s[c][0]*Math.cos(m),d[1]+=s[c][0]*Math.sin(m)):(d[0]+=s[c][0]*Math.cos(m),d[1]-=s[c][0]*Math.sin(m))}return d[0]/=3,d[1]/=3,d}t=t.map(function(t){return[t[0],t[1],Math.sin(t[1]),Math.cos(t[1])]});for(var i,a=t[2],n=0;3>n;++n,a=i)i=t[n],a.v=P(i[1]-a[1],a[3],a[2],i[3],i[2],i[0]-a[0]),a.point=[0,0];var s=D(t[0].v[0],t[2].v[0],t[1].v[0]),r=D(t[0].v[0],t[1].v[0],t[2].v[0]),l=fe-s;t[2].point[1]=0,t[0].point[0]=-(t[1].point[0]=.5*t[0].v[0]);var o=[t[2].point[0]=t[0].point[0]+t[2].v[0]*Math.cos(s),2*(t[0].point[1]=t[1].point[1]=t[2].v[0]*Math.sin(s))];return e}function A(){var t=[[0,0],[0,0],[0,0]],e=Me(O),i=e(t),a=i.rotate;return delete i.rotate,i.points=function(n){if(!arguments.length)return t;t=n;var s=d3.geo.centroid({type:"MultiPoint",coordinates:t}),r=[-s[0],-s[1]];return a.call(i,r),e(t.map(d3.geo.rotation(r)).map(I))},i.points([[-150,55],[-35,55],[-92.5,10]])}function P(t,e,i,a,n,s){var r,c=Math.cos(s);if(Math.abs(t)>1||Math.abs(s)>1)r=o(i*n+e*a*c);else{var h=Math.sin(.5*t),d=Math.sin(.5*s);r=2*l(Math.sqrt(h*h+e*a*d*d))}return Math.abs(r)>ge?[r,Math.atan2(a*Math.sin(s),e*n-i*a*c)]:[0,0]}function D(t,e,i){return o(.5*(t*t+e*e-i*i)/(t*e))}function C(t){return t-2*fe*Math.floor((t+fe)/(2*fe))}function I(t){return[t[0]*ye,t[1]*ye]}function q(t,e){var i=c(1-Math.sin(e));return[2/be*t*i,be*(1-i)]}function R(t){function e(t,e){return[t,(t?t/Math.sin(t):1)*(Math.sin(e)*Math.cos(t)-i*Math.cos(e))]}var i=Math.tan(t);return e.invert=i?function(t,e){t&&(e*=Math.sin(t)/t);var a=Math.cos(t);return[t,2*Math.atan2(Math.sqrt(a*a+i*i-e*e)-a,i-e)]}:function(t,e){return[t,l(t?e*Math.tan(t)/t:e)]},e}function B(t,e){var i=Math.sqrt(3);return[i*t*(2*Math.cos(2*e/3)-1)/be,i*be*Math.sin(e/3)]}function F(t){function e(t,e){return[t*i,Math.sin(e)/i]}var i=Math.cos(t);return e.invert=function(t,e){return[t/i,l(e*i)]},e}function H(t){function e(t,e){return[t*i,(1+i)*Math.tan(.5*e)]}var i=Math.cos(t);return e.invert=function(t,e){return[t/i,2*Math.atan(e/(1+i))]},e}function N(t,e){var i=Math.sqrt(8/(3*fe));return[i*t*(1-Math.abs(e)/fe),i*e]}function j(t,e){var i=Math.sqrt(4-3*Math.sin(Math.abs(e)));return[2/Math.sqrt(6*fe)*t*i,r(e)*Math.sqrt(2*fe/3)*(2-i)]}function Y(t,e){var i=Math.sqrt(fe*(4+fe));return[2/i*t*(1+Math.sqrt(1-4*e*e/(fe*fe))),4/i*e]}function V(t,e){var i=(2+ve)*Math.sin(e);e/=2;for(var a=0,n=1/0;10>a&&Math.abs(n)>ge;a++){var s=Math.cos(e);e-=n=(e+Math.sin(e)*(s+2)-i)/(2*s*(1+s))}return[2/Math.sqrt(fe*(4+fe))*t*(1+Math.cos(e)),2*Math.sqrt(fe/(4+fe))*Math.sin(e)]}function X(t,e){return[t*(1+Math.cos(e))/Math.sqrt(2+fe),2*e/Math.sqrt(2+fe)]}function U(t,e){for(var i=(1+ve)*Math.sin(e),a=0,n=1/0;10>a&&Math.abs(n)>ge;a++)e-=n=(e+Math.sin(e)-i)/(1+Math.cos(e));return i=Math.sqrt(2+fe),[t*(1+Math.cos(e))/i,2*e/i]}function K(t,e){var i=Math.sin(t/=2),a=Math.cos(t),n=Math.sqrt(Math.cos(e)),s=Math.cos(e/=2),r=Math.sin(e)/(s+Math.SQRT2*a*n),l=Math.sqrt(2/(1+r*r)),o=Math.sqrt((Math.SQRT2*s+(a+i)*n)/(Math.SQRT2*s+(a-i)*n));return[Te*(l*(o-1/o)-2*Math.log(o)),Te*(l*r*(o+1/o)-2*Math.atan(r))]}function W(t,e){var i=Math.tan(e/2);return[t*Le*c(1-i*i),(1+Le)*i]}function Q(t,e){var i=e/2,a=Math.cos(i);return[2*t/be*Math.cos(e)*a*a,be*Math.tan(i)]}function G(t,e){function i(e,i){var s=Oe(e,i),r=s[0],l=s[1],o=r*r+l*l;if(o>n){var c=Math.sqrt(o),h=Math.atan2(l,r),d=a*Math.round(h/a),u=h-d,m=t*Math.cos(u),g=(t*Math.sin(u)-u*Math.sin(m))/(ve-m),p=Z(u,g),f=(fe-t)/$(p,m,fe);r=c;var v,b=50;do r-=v=(t+$(p,m,r)*f-c)/(p(r)*f);while(Math.abs(v)>ge&&--b>0);l=u*Math.sin(r),ve>r&&(l-=g*(r-ve));var y=Math.sin(d),x=Math.cos(d);s[0]=r*x-l*y,s[1]=r*y+l*x}return s}var a=2*fe/e,n=t*t;return i.invert=function(e,i){var s=e*e+i*i;if(s>n){var r=Math.sqrt(s),l=Math.atan2(i,e),o=a*Math.round(l/a),c=l-o,e=r*Math.cos(c);i=r*Math.sin(c);for(var h=e-ve,d=Math.sin(e),u=i/d,m=ve>e?1/0:0,g=10;;){var p=t*Math.sin(u),f=t*Math.cos(u),v=Math.sin(f),b=ve-f,y=(p-u*v)/b,x=Z(u,y);if(Math.abs(m)<pe||!--g)break;u-=m=(u*d-y*h-i)/(d-2*h*(b*(f+u*p*Math.cos(f)-v)-p*(p-u*v))/(b*b))}r=t+$(x,f,e)*(fe-t)/$(x,f,fe),l=o+u,e=r*Math.cos(l),i=r*Math.sin(l)}return Oe.invert(e,i)},i}function Z(t,e){return function(i){var a=t*Math.cos(i);return ve>i&&(a-=e),Math.sqrt(1+a*a)}}function J(){var t=6,e=30*ye,i=Math.cos(e),a=Math.sin(e),n=Me(G),s=n(e,t),r=s.stream,l=.01,o=-Math.cos(l*ye),c=Math.sin(l*ye);return s.radius=function(s){return arguments.length?(i=Math.cos(e=s*ye),a=Math.sin(e),n(e,t)):e*xe},s.lobes=function(i){return arguments.length?n(e,t=+i):t},s.stream=function(e){var n=s.rotate(),l=r(e),h=(s.rotate([0,0]),r(e));return s.rotate(n),l.sphere=function(){h.polygonStart(),h.lineStart();for(var e=0,n=2*fe/t,s=0;t>e;++e,s-=n)h.point(Math.atan2(c*Math.cos(s),o)*xe,Math.asin(c*Math.sin(s))*xe),h.point(Math.atan2(a*Math.cos(s-n/2),i)*xe,Math.asin(a*Math.sin(s-n/2))*xe);h.lineEnd(),h.polygonEnd()},l},s}function $(t,e,i){for(var a=50,n=(i-e)/a,s=t(e)+t(i),r=1,l=e;a>r;++r)s+=2*t(l+=n);return.5*s*n}function tt(t,e,i,a,n,s,r,l){function o(o,c){if(!c)return[t*o/fe,0];var h=c*c,d=t+h*(e+h*(i+h*a)),u=c*(n-1+h*(s-l+h*r)),m=(d*d+u*u)/(2*u),g=o*Math.asin(d/m)/fe;return[m*Math.sin(g),c*(1+h*l)+m*(1-Math.cos(g))]}return arguments.length<8&&(l=0),o.invert=function(o,h){var d,u,m=fe*o/t,g=h,p=50;do{var f=g*g,v=t+f*(e+f*(i+f*a)),b=g*(n-1+f*(s-l+f*r)),y=v*v+b*b,x=2*b,_=y/x,M=_*_,z=Math.asin(v/_)/fe,w=m*z;if(xB2=v*v,dxBdφ=(2*e+f*(4*i+6*f*a))*g,dyBdφ=n+f*(3*s+5*f*r),dpdφ=2*(v*dxBdφ+b*(dyBdφ-1)),dqdφ=2*(dyBdφ-1),dmdφ=(dpdφ*x-y*dqdφ)/(x*x),cosα=Math.cos(w),sinα=Math.sin(w),mcosα=_*cosα,msinα=_*sinα,dαdφ=m/fe*(1/c(1-xB2/M))*(dxBdφ*_-v*dmdφ)/M,fx=msinα-o,fy=g*(1+f*l)+_-mcosα-h,δxδφ=dmdφ*sinα+mcosα*dαdφ,δxδλ=mcosα*z,δyδφ=1+dmdφ-(dmdφ*cosα-msinα*dαdφ),δyδλ=msinα*z,denominator=δxδφ*δyδλ-δyδφ*δxδλ,!denominator)break;m-=d=(fy*δxδφ-fx*δyδφ)/denominator,g-=u=(fx*δyδλ-fy*δxδλ)/denominator}while((Math.abs(d)>ge||Math.abs(u)>ge)&&--p>0);return[m,g]},o}function et(t,e){var i=t*t,a=e*e;return[t*(1-.162388*a)*(.87-952426e-9*i*i),e*(1+a/12)]}function it(t){function e(){var t=!1,e=Me(i),a=e(t);return a.quincuncial=function(i){return arguments.length?e(t=!!i):t},a}function i(e){var i=e?function(e,i){var n=Math.abs(e)<ve,s=t(n?e:e>0?e-fe:e+fe,i),l=(s[0]-s[1])*Math.SQRT1_2,o=(s[0]+s[1])*Math.SQRT1_2;if(n)return[l,o];var c=a*Math.SQRT1_2,h=l>0^o>0?-1:1;return[h*l-r(o)*c,h*o-r(l)*c]}:function(e,i){var n=e>0?-.5:.5,s=t(e+n*fe,i);return s[0]-=n*a,s};return t.invert&&(i.invert=e?function(e,i){var n=(e+i)*Math.SQRT1_2,s=(i-e)*Math.SQRT1_2,r=Math.abs(n)<.5*a&&Math.abs(s)<.5*a;if(!r){var l=a*Math.SQRT1_2,o=n>0^s>0?-1:1,c=-o*(e+(s>0?1:-1)*l),h=-o*(i+(n>0?1:-1)*l);n=(-c-h)*Math.SQRT1_2,s=(c-h)*Math.SQRT1_2}var d=t.invert(n,s);return r||(d[0]+=n>0?fe:-fe),d}:function(e,i){var n=e>0?-.5:.5,s=t.invert(e+n*a,i),r=s[0]-n*fe;return-fe>r?r+=2*fe:r>fe&&(r-=2*fe),s[0]=r,s}),i}var a=t(ve,0)[0]-t(-ve,0)[0];return e.raw=i,e}function at(t,e){var i=r(t),a=r(e),n=Math.cos(e),s=Math.cos(t)*n,o=Math.sin(t)*n,c=Math.sin(a*e);t=Math.abs(Math.atan2(o,c)),e=l(s),Math.abs(t-ve)>ge&&(t%=ve);var h=nt(t>fe/4?ve-t:t,e);return t>fe/4&&(c=h[0],h[0]=-h[1],h[1]=-c),h[0]*=i,h[1]*=-a,h}function nt(t,e){if(e===ve)return[0,0];var i=Math.sin(e),a=i*i,n=a*a,s=1+n,r=1+3*n,o=1-n,h=l(1/Math.sqrt(s)),d=o+a*s*h,u=(1-i)/d,m=Math.sqrt(u),g=u*s,p=Math.sqrt(g),f=m*o;if(0===t)return[0,-(f+a*p)];var v=Math.cos(e),b=1/v,y=2*i*v,x=(-3*a+h*r)*y,_=(-d*v-(1-i)*x)/(d*d),M=.5*_/m,z=o*M-2*a*m*y,w=a*s*_+u*r*y,k=-b*y,S=-b*w,E=-2*b*z,T=4*t/fe;if(t>.222*fe||fe/4>e&&t>.175*fe){var L=(f+a*c(g*(1+n)-f*f))/(1+n);if(t>fe/4)return[L,L];var O=L,A=.5*L,P=50;L=.5*(A+O);do{var D=Math.sqrt(g-L*L),C=L*(E+k*D)+S*l(L/p)-T;if(!C)break;0>C?A=L:O=L,L=.5*(A+O)}while(Math.abs(O-A)>ge&&--P>0)}else{var I,L=ge,P=25;do{var q=L*L,D=c(g-q),R=E+k*D,C=L*R+S*l(L/p)-T,B=R+(S-k*q)/D;L-=I=D?C/B:0}while(Math.abs(I)>ge&&--P>0)}return[L,-f-a*c(g-L*L)]}function st(t,e){for(var i=0,a=1,n=.5,s=50;;){var r=n*n,l=Math.sqrt(n),o=Math.asin(1/Math.sqrt(1+r)),c=1-r+n*(1+r)*o,h=(1-l)/c,d=Math.sqrt(h),u=h*(1+r),m=d*(1-r),g=u-t*t,p=Math.sqrt(g),f=e+m+n*p;if(Math.abs(a-i)<pe||0===--s||0===f)break;f>0?i=n:a=n,n=.5*(i+a)}if(!s)return null;var v=Math.asin(l),b=Math.cos(v),y=1/b,x=2*l*b,_=(-3*n+o*(1+3*r))*x,M=(-c*b-(1-l)*_)/(c*c),z=.5*M/d,w=(1-r)*z-2*n*d*x,k=-2*y*w,S=-y*x,E=-y*(n*(1+r)*M+h*(1+3*r)*x);return[fe/4*(t*(k+S*p)+E*Math.asin(t/Math.sqrt(u))),v]}function rt(t,e,i){if(!t){var a=lt(e,1-i);return[[0,a[0]/a[1]],[1/a[1],0],[a[2]/a[1],0]]}var n=lt(t,i);if(!e)return[[n[0],0],[n[1],0],[n[2],0]];var a=lt(e,1-i),s=a[1]*a[1]+i*n[0]*n[0]*a[0]*a[0];return[[n[0]*a[2]/s,n[1]*n[2]*a[0]*a[1]/s],[n[1]*a[1]/s,-n[0]*n[2]*a[0]*a[2]/s],[n[2]*a[1]*a[2]/s,-i*n[0]*n[1]*a[0]/s]]}function lt(t,e){var i,a,n,s,r;if(ge>e)return s=Math.sin(t),a=Math.cos(t),i=.25*e*(t-s*a),[s-i*a,a+i*s,1-.5*e*s*s,t-i];if(e>=1-ge)return i=.25*(1-e),a=v(t),s=p(t),n=1/a,r=a*f(t),[s+i*(r-t)/(a*a),n-i*s*n*(r-t),n+i*s*n*(r+t),2*Math.atan(Math.exp(t))-ve+i*(r-t)/a];var o=[1,0,0,0,0,0,0,0,0],h=[Math.sqrt(e),0,0,0,0,0,0,0,0],d=0;for(a=Math.sqrt(1-e),r=1;Math.abs(h[d]/o[d])>ge&&8>d;)i=o[d++],h[d]=.5*(i-a),o[d]=.5*(i+a),a=c(i*a),r*=2;n=r*o[d]*t;do s=h[d]*Math.sin(a=n)/o[d],n=.5*(l(s)+n);while(--d);return[Math.sin(n),s=Math.cos(n),s/Math.cos(n-a),n]}function ot(t,e,i){var a=Math.abs(t),n=Math.abs(e),s=f(n);if(a){var l=1/Math.sin(a),o=1/(Math.tan(a)*Math.tan(a)),h=-(o+i*s*s*l*l-1+i),d=(i-1)*o,u=.5*(-h+Math.sqrt(h*h-4*d));return[ct(Math.atan(1/Math.sqrt(u)),i)*r(t),ct(Math.atan(c((u/o-1)/i)),1-i)*r(e)]}return[0,ct(Math.atan(s),1-i)*r(e)]}function ct(t,e){if(!e)return t;if(1===e)return Math.log(Math.tan(t/2+fe/4));for(var i=1,a=Math.sqrt(1-e),n=Math.sqrt(e),s=0;Math.abs(n)>ge;s++){if(t%fe){var r=Math.atan(a*Math.tan(t)/i);0>r&&(r+=fe),t+=r+~~(t/fe)*fe}else t+=t;n=(i+a)/2,a=Math.sqrt(i*a),n=((i=n)-a)/2}return t/(Math.pow(2,s)*i)}function ht(t,e){var i=(Math.SQRT2-1)/(Math.SQRT2+1),a=Math.sqrt(1-i*i),n=ct(ve,a*a),s=-1,r=Math.log(Math.tan(fe/4+Math.abs(e)/2)),l=Math.exp(s*r)/Math.sqrt(i),o=dt(l*Math.cos(s*t),l*Math.sin(s*t)),c=ot(o[0],o[1],a*a);return[-c[1],(e>=0?1:-1)*(.5*n-c[0])]}function dt(t,e){var i=t*t,a=e+1,n=1-i-e*e;return[.5*((t>=0?ve:-ve)-Math.atan2(n,2*t)),-.25*Math.log(n*n+4*i)+.5*Math.log(a*a+i)]}function ut(t,e){var i=e[0]*e[0]+e[1]*e[1];return[(t[0]*e[0]+t[1]*e[1])/i,(t[1]*e[0]-t[0]*e[1])/i]}function mt(t){function e(t,e){var s=n(t,e);t=s[0],e=s[1];var r=Math.sin(e),l=Math.cos(e),c=Math.cos(t),h=o(i*r+a*l*c),d=Math.sin(h),u=Math.abs(d)>ge?h/d:1;return[u*a*Math.sin(t),(Math.abs(t)>ve?u:-u)*(i*l-a*r*c)]}var i=Math.sin(t),a=Math.cos(t),n=gt(t);return n.invert=gt(-t),e.invert=function(t,e){var a=Math.sqrt(t*t+e*e),s=-Math.sin(a),r=Math.cos(a),l=a*r,o=-e*s,h=a*i,d=c(l*l+o*o-h*h),u=Math.atan2(l*h+o*d,o*h-l*d),m=(a>ve?-1:1)*Math.atan2(t*s,a*Math.cos(u)*r+e*Math.sin(u)*s);return n.invert(m,u)},e}function gt(t){var e=Math.sin(t),i=Math.cos(t);return function(t,a){var n=Math.cos(a),s=Math.cos(t)*n,r=Math.sin(t)*n,o=Math.sin(a);return[Math.atan2(r,s*i-o*e),l(o*i+s*e)]}}function pt(){var t=0,e=Me(mt),i=e(t),a=i.rotate,n=i.stream,s=d3.geo.circle();return i.parallel=function(a){if(!arguments.length)return t/fe*180;var n=i.rotate();return e(t=a*fe/180).rotate(n)},i.rotate=function(e){return arguments.length?(a.call(i,[e[0],e[1]-t/fe*180]),s.origin([-e[0],-e[1]]),i):(e=a.call(i),e[1]+=t/fe*180,e)},i.stream=function(t){return t=n(t),t.sphere=function(){t.polygonStart();var e,i=.01,a=s.angle(90-i)().coordinates[0],n=a.length-1,r=-1;for(t.lineStart();++r<n;)t.point((e=a[r])[0],e[1]);for(t.lineEnd(),a=s.angle(90+i)().coordinates[0],n=a.length-1,t.lineStart();--r>=0;)t.point((e=a[r])[0],e[1]);t.lineEnd(),t.polygonEnd()},t},i}function ft(t,e){function i(i,a){var n=Ie(i/e,a);return n[0]*=t,n}return arguments.length<2&&(e=t),1===e?Ie:e===1/0?bt:(i.invert=function(i,a){var n=Ie.invert(i/t,a);return n[0]*=e,n},i)}function vt(){var t=2,e=Me(ft),i=e(t);return i.coefficient=function(i){return arguments.length?e(t=+i):t},i}function bt(t,e){return[t*Math.cos(e)/Math.cos(e/=2),2*Math.sin(e)]}function yt(t,e){for(var i,a=Math.sin(e)*(0>e?2.43763:2.67595),n=0;20>n&&(e-=i=(e+Math.sin(e)-a)/(1+Math.cos(e)),!(Math.abs(i)<ge));n++);return[.85*t*Math.cos(e*=.5),Math.sin(e)*(0>e?1.93052:1.75859)]}function xt(t){function e(e,h){var d,u=Math.abs(h);if(u>a){var m=Math.min(t-1,Math.max(0,Math.floor((e+fe)/c)));e+=fe*(t-1)/t-m*c,d=d3.geo.collignon.raw(e,u),d[0]=d[0]*n/s-n*(t-1)/(2*t)+m*n/t,d[1]=r+4*(d[1]-l)*o/n,0>h&&(d[1]=-d[1])}else d=i(e,h);return d[0]/=2,d}var i=d3.geo.cylindricalEqualArea.raw(0),a=qe*fe/180,n=2*fe,s=d3.geo.collignon.raw(fe,a)[0]-d3.geo.collignon.raw(-fe,a)[0],r=i(0,a)[1],l=d3.geo.collignon.raw(0,a)[1],o=d3.geo.collignon.raw(0,ve)[1]-l,c=2*fe/t;return e.invert=function(e,a){e*=2;var h=Math.abs(a);if(h>r){var d=Math.min(t-1,Math.max(0,Math.floor((e+fe)/c)));e=(e+fe*(t-1)/t-d*c)*s/n;var u=d3.geo.collignon.raw.invert(e,.25*(h-r)*n/o+l);return u[0]-=fe*(t-1)/t-d*c,0>a&&(u[1]=-u[1]),u}return i.invert(e,a)},e}function _t(){function t(){var t=180/e;return{type:"Polygon",coordinates:[d3.range(-180,180+t/2,t).map(function(t,e){return[t,1&e?90-1e-6:qe]}).concat(d3.range(180,-180-t/2,-t).map(function(t,e){return[t,1&e?-90+1e-6:-qe]}))]}}var e=2,i=Me(xt),a=i(e),n=a.stream;return a.lobes=function(t){return arguments.length?i(e=+t):e},a.stream=function(e){var i=a.rotate(),s=n(e),r=(a.rotate([0,0]),n(e));return a.rotate(i),s.sphere=function(){d3.geo.stream(t(),r)},s},a}function Mt(t){function e(e,n){var l,o,u=1-Math.sin(n);if(u&&2>u){var m,g=ve-n,p=25;do{var f=Math.sin(g),v=Math.cos(g),b=s+Math.atan2(f,a-v),y=1+d-2*a*v;g-=m=(g-h*s-a*f+y*b-.5*u*i)/(2*a*f*b)}while(Math.abs(m)>pe&&--p>0);l=r*Math.sqrt(y),o=e*b/fe}else l=r*(t+u),o=e*s/fe;return[l*Math.sin(o),c-l*Math.cos(o)]}var i,a=1+t,n=Math.sin(1/a),s=l(n),r=2*Math.sqrt(fe/(i=fe+4*s*a)),c=.5*r*(a+Math.sqrt(t*(2+t))),h=t*t,d=a*a;return e.invert=function(t,e){var n=t*t+(e-=c)*e,u=(1+d-n/(r*r))/(2*a),m=o(u),g=Math.sin(m),p=s+Math.atan2(g,a-u);return[l(t/Math.sqrt(n))*fe/p,l(1-2*(m-h*s-a*g+(1+d-2*a*u)*p)/i)]},e}function zt(){var t=1,e=Me(Mt),i=e(t);return i.ratio=function(i){return arguments.length?e(t=+i):t},i}function wt(t,e){return e>-Re?(t=Se(t,e),t[1]+=Be,t):T(t,e)}function kt(t,e){return Math.abs(e)>Re?(t=Se(t,e),t[1]-=e>0?Be:-Be,t):T(t,e)}function St(t,e){return[3*t/(2*fe)*Math.sqrt(fe*fe/3-e*e),e]}function Et(t){function e(e,i){if(Math.abs(Math.abs(i)-ve)<ge)return[0,0>i?-2:2];var a=Math.sin(i),n=Math.pow((1+a)/(1-a),t/2),s=.5*(n+1/n)+Math.cos(e*=t);return[2*Math.sin(e)/s,(n-1/n)/s]}return e.invert=function(e,i){var a=Math.abs(i);if(Math.abs(a-2)<ge)return e?null:[0,r(i)*ve];if(a>2)return null;e/=2,i/=2;var n=e*e,s=i*i,o=2*i/(1+n+s);return o=Math.pow((1+o)/(1-o),1/t),[Math.atan2(2*e,1-n-s)/t,l((o-1)/(o+1))]},e}function Tt(){var t=.5,e=Me(Et),i=e(t);return i.spacing=function(i){return arguments.length?e(t=+i):t},i}function Lt(t,e){return[t*(1+Math.sqrt(Math.cos(e)))/2,e/(Math.cos(e/2)*Math.cos(t/6))]}function Ot(t,e){var i=t*t,a=e*e;return[t*(.975534+a*(-.119161+i*-.0143059+a*-.0547009)),e*(1.00384+i*(.0802894+a*-.02855+199025e-9*i)+a*(.0998909+a*-.0491032))]}function At(t,e){return[Math.sin(t)/Math.cos(e),Math.tan(e)*Math.cos(t)]}function Pt(t){function e(e,n){var s=n-t,r=Math.abs(s)<ge?e*i:Math.abs(r=fe/4+n/2)<ge||Math.abs(Math.abs(r)-ve)<ge?0:e*s/Math.log(Math.tan(r)/a);return[r,s]}var i=Math.cos(t),a=Math.tan(fe/4+t/2);return e.invert=function(e,n){var s,r=n+t;return[Math.abs(n)<ge?e/i:Math.abs(s=fe/4+r/2)<ge||Math.abs(Math.abs(s)-ve)<ge?0:e*Math.log(Math.tan(s)/a)/n,r]},e}function Dt(t,e){return[t,1.25*Math.log(Math.tan(fe/4+.4*e))]}function Ct(t){function e(e,a){for(var n,s=Math.cos(a),r=2/(1+s*Math.cos(e)),l=r*s*Math.sin(e),o=r*Math.sin(a),c=i,h=t[c],d=h[0],u=h[1];--c>=0;)h=t[c],d=h[0]+l*(n=d)-o*u,u=h[1]+l*u+o*n;return d=l*(n=d)-o*u,u=l*u+o*n,[d,u]}var i=t.length-1;return e.invert=function(e,a){var n=20,s=e,r=a;do{for(var o,c=i,h=t[c],d=h[0],u=h[1],m=0,g=0;--c>=0;)h=t[c],m=d+s*(o=m)-r*g,g=u+s*g+r*o,d=h[0]+s*(o=d)-r*u,u=h[1]+s*u+r*o;m=d+s*(o=m)-r*g,g=u+s*g+r*o,d=s*(o=d)-r*u-e,u=s*u+r*o-a;var p,f,v=m*m+g*g;s-=p=(d*m+u*g)/v,r-=f=(u*m-d*g)/v}while(Math.abs(p)+Math.abs(f)>ge*ge&&--n>0);if(n){var b=Math.sqrt(s*s+r*r),y=2*Math.atan(.5*b),x=Math.sin(y);return[Math.atan2(s*x,b*Math.cos(y)),b?l(r*x/b):0]}},e}function It(){var t=Fe.miller,e=Me(Ct),i=e(t);return i.coefficients=function(i){return arguments.length?e(t="string"==typeof i?Fe[i]:i):t},i}function qt(t,e){var i=Math.sqrt(6),a=Math.sqrt(7),n=Math.asin(7*Math.sin(e)/(3*i));return[i*t*(2*Math.cos(2*n/3)-1)/a,9*Math.sin(n/3)/a]}function Rt(t,e){for(var i,a=(1+Math.SQRT1_2)*Math.sin(e),n=e,s=0;25>s&&(n-=i=(Math.sin(n/2)+Math.sin(n)-a)/(.5*Math.cos(n/2)+Math.cos(n)),!(Math.abs(i)<ge));s++);return[t*(1+2*Math.cos(n)/Math.cos(n/2))/(3*Math.SQRT2),2*Math.sqrt(3)*Math.sin(n/2)/Math.sqrt(2+Math.SQRT2)]}function Bt(t,e){for(var i,a=Math.sqrt(6/(4+fe)),n=(1+fe/4)*Math.sin(e),s=e/2,r=0;25>r&&(s-=i=(s/2+Math.sin(s)-n)/(.5+Math.cos(s)),!(Math.abs(i)<ge));r++);return[a*(.5+Math.cos(s))*t/1.5,a*s]}function Ft(t,e){var i=e*e,a=i*i;return[t*(.8707-.131979*i+a*(-.013791+a*(.003971*i-.001529*a))),e*(1.007226+i*(.015085+a*(-.044475+.028874*i-.005916*a)))]}function Ht(t,e){return[t*(1+Math.cos(e))/2,2*(e-Math.tan(e/2))]}function Nt(t,e){var i=e*e;return[t,e*(He+i*i*(Ne+i*(je+Ye*i)))]}function jt(t,e){if(Math.abs(e)<ge)return[t,0];var i=Math.tan(e),a=t*Math.sin(e);return[Math.sin(a)/i,e+(1-Math.cos(a))/i]}function Yt(t){function e(e,a){var n=i?Math.tan(e*i/2)/i:e/2;if(!a)return[2*n,-t];var s=2*Math.atan(n*Math.sin(a)),r=1/Math.tan(a);return[Math.sin(s)*r,a+(1-Math.cos(s))*r-t]}var i=Math.sin(t);return e.invert=function(e,a){if(Math.abs(a+=t)<ge)return[i?2*Math.atan(i*e/2)/i:e,0];var n,s=e*e+a*a,r=0,c=10;do{var h=Math.tan(r),d=1/Math.cos(r),u=s-2*a*r+r*r;r-=n=(h*u+2*(r-a))/(2+u*d*d+2*(r-a)*h)}while(Math.abs(n)>ge&&--c>0);var m=e*(h=Math.tan(r)),g=Math.tan(Math.abs(a)<Math.abs(r+1/h)?.5*l(m):.5*o(m)+fe/4)/Math.sin(r);return[i?2*Math.atan(i*g)/i:2*g,r]},e}function Vt(t,e){var i,a=Math.min(18,36*Math.abs(e)/fe),n=Math.floor(a),s=a-n,r=(i=Ge[n])[0],l=i[1],o=(i=Ge[++n])[0],c=i[1],h=(i=Ge[Math.min(19,++n)])[0],d=i[1];return[t*(o+s*(h-r)/2+s*s*(h-2*o+r)/2),(e>0?ve:-ve)*(c+s*(d-l)/2+s*s*(d-2*c+l)/2)]}function Xt(t){function e(e,i){var a=Math.cos(i),n=(t-1)/(t-a*Math.cos(e));return[n*a*Math.sin(e),n*Math.sin(i)]}return e.invert=function(e,i){var a=e*e+i*i,n=Math.sqrt(a),s=(t-Math.sqrt(1-a*(t+1)/(t-1)))/((t-1)/n+n/(t-1));return[Math.atan2(e*s,n*Math.sqrt(1-s*s)),n?l(i*s/n):0]},e}function Ut(t,e){function i(e,i){var r=a(e,i),l=r[1],o=l*s/(t-1)+n;return[r[0]*n/o,l/o]}var a=Xt(t);if(!e)return a;var n=Math.cos(e),s=Math.sin(e);return i.invert=function(e,i){var r=(t-1)/(t-1-i*s);return a.invert(r*e,r*i*n)},i}function Kt(){var t=1.4,e=0,i=Me(Ut),a=i(t,e);return a.distance=function(a){return arguments.length?i(t=+a,e):t},a.tilt=function(a){return arguments.length?i(t,e=a*fe/180):180*e/fe},a}function Wt(t,e){var i=Math.tan(e/2),a=Math.sin(fe/4*i);return[t*(.74482-.34588*a*a),1.70711*i]}function Qt(t){function e(e,s){var r=o(Math.cos(s)*Math.cos(e-i)),l=o(Math.cos(s)*Math.cos(e-a)),h=0>s?-1:1;return r*=r,l*=l,[(r-l)/(2*t),h*c(4*n*l-(n-r+l)*(n-r+l))/(2*t)]}if(!t)return d3.geo.azimuthalEquidistant.raw;var i=-t/2,a=-i,n=t*t,s=Math.tan(a),r=.5/Math.sin(a);return e.invert=function(t,e){var n,l,c=e*e,h=Math.cos(Math.sqrt(c+(n=t+i)*n)),d=Math.cos(Math.sqrt(c+(n=t+a)*n));return[Math.atan2(l=h-d,n=(h+d)*s),(0>e?-1:1)*o(Math.sqrt(n*n+l*l)*r)]},e}function Gt(){var t=[[0,0],[0,0]],e=Me(Qt),i=e(0),a=i.rotate;return delete i.rotate,i.points=function(i){if(!arguments.length)return t;t=i;var n=d3.geo.interpolate(i[0],i[1]),s=n(.5),r=d3.geo.rotation([-s[0],-s[1]])(i[0]),o=.5*n.distance,c=-l(Math.sin(r[1]*ye)/Math.sin(o));return r[0]>0&&(c=fe-c),a.call(r,[-s[0],-s[1],-c*xe]),e(2*o)},i}function Zt(t){function e(t,e){var a=d3.geo.gnomonic.raw(t,e);return a[0]*=i,a}var i=Math.cos(t);return e.invert=function(t,e){return d3.geo.gnomonic.raw.invert(t/i,e)},e}function Jt(){var t=[[0,0],[0,0]],e=Me(Zt),i=e(0),a=i.rotate;return delete i.rotate,i.points=function(i){if(!arguments.length)return t;t=i;var n=d3.geo.interpolate(i[0],i[1]),s=n(.5),r=d3.geo.rotation([-s[0],-s[1]])(i[0]),o=.5*n.distance,c=-l(Math.sin(r[1]*ye)/Math.sin(o));return r[0]>0&&(c=fe-c),a.call(r,[-s[0],-s[1],-c*xe]),e(o)},i}function $t(t,e){if(Math.abs(e)<ge)return[t,0];var i=Math.abs(e/ve),a=l(i);if(Math.abs(t)<ge||Math.abs(Math.abs(e)-ve)<ge)return[0,r(e)*fe*Math.tan(a/2)];var n=Math.cos(a),s=Math.abs(fe/t-t/fe)/2,o=s*s,c=n/(i+n-1),h=c*(2/i-1),d=h*h,u=d+o,m=c-d,g=o+c;return[r(t)*fe*(s*m+Math.sqrt(o*m*m-u*(c*c-d)))/u,r(e)*fe*(h*g-s*Math.sqrt((o+1)*u-g*g))/u]}function te(t,e){if(Math.abs(e)<ge)return[t,0];var i=Math.abs(e/ve),a=l(i);if(Math.abs(t)<ge||Math.abs(Math.abs(e)-ve)<ge)return[0,r(e)*fe*Math.tan(a/2)];var n=Math.cos(a),s=Math.abs(fe/t-t/fe)/2,o=s*s,h=n*(Math.sqrt(1+o)-s*n)/(1+o*i*i);return[r(t)*fe*h,r(e)*fe*c(1-h*(2*s+h))]}function ee(t,e){if(Math.abs(e)<ge)return[t,0];var i=e/ve,a=l(i);if(Math.abs(t)<ge||Math.abs(Math.abs(e)-ve)<ge)return[0,fe*Math.tan(a/2)];var n=(fe/t-t/fe)/2,s=i/(1+Math.cos(a));return[fe*(r(t)*c(n*n+1-s*s)-n),fe*s]}function ie(t,e){if(!e)return[t,0];var i=Math.abs(e);if(!t||i===ve)return[0,e];var a=i/ve,n=a*a,s=(8*a-n*(n+2)-5)/(2*n*(a-1)),l=s*s,o=a*s,h=n+l+2*o,d=a+3*s,u=t/ve,m=u+1/u,g=r(Math.abs(t)-ve)*Math.sqrt(m*m-4),p=g*g,f=h*(n+l*p-1)+(1-n)*(n*(d*d+4*l)+12*o*l+4*l*l),v=(g*(h+l-1)+2*c(f))/(4*h+p);return[r(t)*ve*v,r(e)*ve*c(1+g*Math.abs(v)-v*v)]}function ae(t,e){return[t*Math.sqrt(1-3*e*e/(fe*fe)),e]}function ne(t,e){var i=.90631*Math.sin(e),a=Math.sqrt(1-i*i),n=Math.sqrt(2/(1+a*Math.cos(t/=3)));return[2.66723*a*n*Math.sin(t),1.24104*i*n]}function se(t,e){var i=Math.cos(e),a=Math.cos(t)*i,n=1-a,s=Math.cos(t=Math.atan2(Math.sin(t)*i,-Math.sin(e))),r=Math.sin(t);return i=c(1-a*a),[r*i-s*n,-s*i-r*n]}function re(t,e){var i=u(t,e);return[(i[0]+t/ve)/2,(i[1]+e)/2]}d3.geo.project=function(t,i){var a=i.stream;if(!a)throw new Error("not yet supported");return(t&&le.hasOwnProperty(t.type)?le[t.type]:e)(t,a)};var le={Feature:t,FeatureCollection:function(e,i){return{type:"FeatureCollection",features:e.features.map(function(e){return t(e,i)})}}},oe=[],ce=[],he={point:function(t,e){oe.push([t,e])},result:function(){var t=oe.length?oe.length<2?{type:"Point",coordinates:oe[0]}:{type:"MultiPoint",coordinates:oe}:null;return oe=[],t}},de={lineStart:i,point:function(t,e){oe.push([t,e])},lineEnd:function(){oe.length&&(ce.push(oe),oe=[])},result:function(){var t=ce.length?ce.length<2?{type:"LineString",coordinates:ce[0]}:{type:"MultiLineString",coordinates:ce}:null;return ce=[],t}},ue={polygonStart:i,lineStart:i,point:function(t,e){oe.push([t,e])},lineEnd:function(){var t=oe.length;if(t){do oe.push(oe[0].slice());while(++t<4);ce.push(oe),oe=[]}},polygonEnd:i,result:function(){if(!ce.length)return null;var t=[],e=[];return ce.forEach(function(i){a(i)?t.push([i]):e.push(i)}),e.forEach(function(e){var i=e[0];t.some(function(t){return n(t[0],i)?(t.push(e),!0):void 0})||t.push([e])}),ce=[],t.length?t.length>1?{type:"MultiPolygon",coordinates:t}:{type:"Polygon",coordinates:t[0]}:null}},me={Point:he,MultiPoint:he,LineString:de,MultiLineString:de,Polygon:ue,MultiPolygon:ue,Sphere:ue},ge=1e-6,pe=ge*ge,fe=Math.PI,ve=fe/2,be=Math.sqrt(fe),ye=fe/180,xe=180/fe,_e=d3.geo.projection,Me=d3.geo.projectionMutator;d3.geo.interrupt=function(t){function e(e,i){for(var a=0>i?-1:1,n=l[+(0>i)],s=0,r=n.length-1;r>s&&e>n[s][2][0];++s);var o=t(e-n[s][1][0],i);return o[0]+=t(n[s][1][0],a*i>a*n[s][0][1]?n[s][0][1]:i)[0],o}function i(){r=l.map(function(e){return e.map(function(e){var i,a=t(e[0][0],e[0][1])[0],n=t(e[2][0],e[2][1])[0],s=t(e[1][0],e[0][1])[1],r=t(e[1][0],e[1][1])[1];return s>r&&(i=s,s=r,r=i),[[a,s],[n,r]]})})}function a(){for(var t=1e-6,e=[],i=0,a=l[0].length;a>i;++i){var s=l[0][i],r=180*s[0][0]/fe,o=180*s[0][1]/fe,c=180*s[1][1]/fe,h=180*s[2][0]/fe,d=180*s[2][1]/fe;e.push(n([[r+t,o+t],[r+t,c-t],[h-t,c-t],[h-t,d+t]],30))}for(var i=l[1].length-1;i>=0;--i){var s=l[1][i],r=180*s[0][0]/fe,o=180*s[0][1]/fe,c=180*s[1][1]/fe,h=180*s[2][0]/fe,d=180*s[2][1]/fe;e.push(n([[h-t,d-t],[h-t,c+t],[r+t,c+t],[r+t,o-t]],30))}return{type:"Polygon",coordinates:[d3.merge(e)]}}function n(t,e){for(var i,a,n,s=-1,r=t.length,l=t[0],o=[];++s<r;){i=t[s],a=(i[0]-l[0])/e,n=(i[1]-l[1])/e;for(var c=0;e>c;++c)o.push([l[0]+c*a,l[1]+c*n]);l=i}return o.push(i),o}function s(t,e){return Math.abs(t[0]-e[0])<ge&&Math.abs(t[1]-e[1])<ge}var r,l=[[[[-fe,0],[0,ve],[fe,0]]],[[[-fe,0],[0,-ve],[fe,0]]]];t.invert&&(e.invert=function(i,a){for(var n=r[+(0>a)],o=l[+(0>a)],c=0,h=n.length;h>c;++c){var d=n[c];if(d[0][0]<=i&&i<d[1][0]&&d[0][1]<=a&&a<d[1][1]){var u=t.invert(i-t(o[c][1][0],0)[0],a);return u[0]+=o[c][1][0],s(e(u[0],u[1]),[i,a])?u:null}}});var o=d3.geo.projection(e),c=o.stream;return o.stream=function(t){var e=o.rotate(),i=c(t),n=(o.rotate([0,0]),c(t));return o.rotate(e),i.sphere=function(){d3.geo.stream(a(),n)},i},o.lobes=function(t){return arguments.length?(l=t.map(function(t){return t.map(function(t){return[[t[0][0]*fe/180,t[0][1]*fe/180],[t[1][0]*fe/180,t[1][1]*fe/180],[t[2][0]*fe/180,t[2][1]*fe/180]]})}),i(),o):l.map(function(t){return t.map(function(t){return[[180*t[0][0]/fe,180*t[0][1]/fe],[180*t[1][0]/fe,180*t[1][1]/fe],[180*t[2][0]/fe,180*t[2][1]/fe]]})})},o},(d3.geo.airy=d).raw=h,u.invert=function(t,e){if(!(t*t+4*e*e>fe*fe+ge)){var i=t,a=e,n=25;do{var s,r=Math.sin(i),l=Math.sin(i/2),c=Math.cos(i/2),h=Math.sin(a),d=Math.cos(a),u=Math.sin(2*a),m=h*h,g=d*d,p=l*l,f=1-g*c*c,v=f?o(d*c)*Math.sqrt(s=1/f):s=0,b=2*v*d*l-t,y=v*h-e,x=s*(g*p+v*d*c*m),_=s*(.5*r*u-2*v*h*l),M=.25*s*(u*l-v*h*g*r),z=s*(m*c+v*p*d),w=_*M-z*x;if(!w)break;var k=(y*_-b*z)/w,S=(b*M-y*x)/w;i-=k,a-=S}while((Math.abs(k)>ge||Math.abs(S)>ge)&&--n>0);return[i,a]}},(d3.geo.aitoff=function(){return _e(u)}).raw=u,(d3.geo.armadillo=g).raw=m,x.invert=function(t,e){if(t*=3/8,e*=3/8,!t&&Math.abs(e)>1)return null;var i=t*t,a=e*e,n=1+i+a,s=Math.sqrt(.5*(n-Math.sqrt(n*n-4*e*e))),o=l(s)/3,c=s?y(Math.abs(e/s))/3:b(Math.abs(t))/3,h=Math.cos(o),d=v(c),u=d*d-h*h;return[2*r(t)*Math.atan2(f(c)*h,.25-u),2*r(e)*Math.atan2(d*Math.sin(o),.25+u)]},(d3.geo.august=function(){return _e(x)}).raw=x;var ze=Math.log(1+Math.SQRT2);_.invert=function(t,e){if((a=Math.abs(e))<ze)return[t,2*Math.atan(Math.exp(e))-ve];var i,a,n=Math.sqrt(8),s=fe/4,l=25;do{var o=Math.cos(s/2),c=Math.tan(s/2);s-=i=(n*(s-fe/4)-Math.log(c)-a)/(n-.5*o*o/c)}while(Math.abs(i)>pe&&--l>0);return[t/(Math.cos(s)*(n-1/Math.sin(s))),r(e)*s]},(d3.geo.baker=function(){return _e(_);
}).raw=_;var we=d3.geo.azimuthalEquidistant.raw;(d3.geo.berghaus=z).raw=M;var ke=w(fe),Se=k(Math.SQRT2/ve,Math.SQRT2,fe);(d3.geo.mollweide=function(){return _e(Se)}).raw=Se,S.invert=function(t,e){var i,a,n=2.00276,s=n*e,r=0>e?-fe/4:fe/4,l=25;do a=s-Math.SQRT2*Math.sin(r),r-=i=(Math.sin(2*r)+2*r-fe*Math.sin(a))/(2*Math.cos(2*r)+2+fe*Math.cos(a)*Math.SQRT2*Math.cos(r));while(Math.abs(i)>ge&&--l>0);return a=s-Math.SQRT2*Math.sin(r),[t*(1/Math.cos(a)+1.11072/Math.cos(r))/n,a]},(d3.geo.boggs=function(){return _e(S)}).raw=S,T.invert=function(t,e){return[t/Math.cos(e),e]},(d3.geo.sinusoidal=function(){return _e(T)}).raw=T,(d3.geo.bonne=function(){return E(L).parallel(45)}).raw=L;var Ee=k(1,4/fe,fe);(d3.geo.bromley=function(){return _e(Ee)}).raw=Ee,(d3.geo.chamberlin=A).raw=O,q.invert=function(t,e){var i=(i=e/be-1)*i;return[i>0?t*Math.sqrt(fe/i)/2:0,l(1-i)]},(d3.geo.collignon=function(){return _e(q)}).raw=q,(d3.geo.craig=function(){return E(R)}).raw=R,B.invert=function(t,e){var i=Math.sqrt(3),a=3*l(e/(i*be));return[be*t/(i*(2*Math.cos(2*a/3)-1)),a]},(d3.geo.craster=function(){return _e(B)}).raw=B,(d3.geo.cylindricalEqualArea=function(){return E(F)}).raw=F,(d3.geo.cylindricalStereographic=function(){return E(H)}).raw=H,N.invert=function(t,e){var i=Math.sqrt(8/(3*fe)),a=e/i;return[t/(i*(1-Math.abs(a)/fe)),a]},(d3.geo.eckert1=function(){return _e(N)}).raw=N,j.invert=function(t,e){var i=2-Math.abs(e)/Math.sqrt(2*fe/3);return[t*Math.sqrt(6*fe)/(2*i),r(e)*l((4-i*i)/3)]},(d3.geo.eckert2=function(){return _e(j)}).raw=j,Y.invert=function(t,e){var i=Math.sqrt(fe*(4+fe))/2;return[t*i/(1+c(1-e*e*(4+fe)/(4*fe))),e*i/2]},(d3.geo.eckert3=function(){return _e(Y)}).raw=Y,V.invert=function(t,e){var i=.5*e*Math.sqrt((4+fe)/fe),a=l(i),n=Math.cos(a);return[t/(2/Math.sqrt(fe*(4+fe))*(1+n)),l((a+i*(n+2))/(2+ve))]},(d3.geo.eckert4=function(){return _e(V)}).raw=V,X.invert=function(t,e){var i=Math.sqrt(2+fe),a=e*i/2;return[i*t/(1+Math.cos(a)),a]},(d3.geo.eckert5=function(){return _e(X)}).raw=X,U.invert=function(t,e){var i=1+ve,a=Math.sqrt(i/2);return[2*t*a/(1+Math.cos(e*=a)),l((e+Math.sin(e))/i)]},(d3.geo.eckert6=function(){return _e(U)}).raw=U,K.invert=function(t,e){var i=d3.geo.august.raw.invert(t/1.2,1.065*e);if(!i)return null;var a=i[0],n=i[1],s=20;t/=Te,e/=Te;do{var r=a/2,l=n/2,o=Math.sin(r),c=Math.cos(r),h=Math.sin(l),d=Math.cos(l),u=Math.cos(n),m=Math.sqrt(u),g=h/(d+Math.SQRT2*c*m),p=g*g,f=Math.sqrt(2/(1+p)),v=Math.SQRT2*d+(c+o)*m,b=Math.SQRT2*d+(c-o)*m,y=v/b,x=Math.sqrt(y),_=x-1/x,M=x+1/x,z=f*_-2*Math.log(x)-t,w=f*g*M-2*Math.atan(g)-e,k=h&&Math.SQRT1_2*m*o*p/h,S=(Math.SQRT2*c*d+m)/(2*(d+Math.SQRT2*c*m)*(d+Math.SQRT2*c*m)*m),E=-.5*g*f*f*f,T=E*k,L=E*S,O=(O=2*d+Math.SQRT2*m*(c-o))*O*x,A=(Math.SQRT2*c*d*m+u)/O,P=-(Math.SQRT2*o*h)/(m*O),D=_*T-2*A/x+f*(A+A/y),C=_*L-2*P/x+f*(P+P/y),I=g*M*T-2*k/(1+p)+f*M*k+f*g*(A-A/y),q=g*M*L-2*S/(1+p)+f*M*S+f*g*(P-P/y),R=C*I-q*D;if(!R)break;var B=(w*C-z*q)/R,F=(z*I-w*D)/R;a-=B,n=Math.max(-ve,Math.min(ve,n-F))}while((Math.abs(B)>ge||Math.abs(F)>ge)&&--s>0);return Math.abs(Math.abs(n)-ve)<ge?[0,n]:s&&[a,n]};var Te=3+2*Math.SQRT2;(d3.geo.eisenlohr=function(){return _e(K)}).raw=K,W.invert=function(t,e){var i=e/(1+Le);return[t?t/(Le*c(1-i*i)):0,2*Math.atan(i)]};var Le=Math.cos(35*ye);(d3.geo.fahey=function(){return _e(W)}).raw=W,Q.invert=function(t,e){var i=Math.atan(e/be),a=Math.cos(i),n=2*i;return[t*be*.5/(Math.cos(n)*a*a),n]},(d3.geo.foucaut=function(){return _e(Q)}).raw=Q,d3.geo.gilbert=function(t){function e(e){return t([.5*e[0],l(Math.tan(.5*e[1]*ye))*xe])}var i=d3.geo.equirectangular().scale(xe).translate([0,0]);return t.invert&&(e.invert=function(e){return e=t.invert(e),e[0]*=2,e[1]=2*Math.atan(Math.sin(e[1]*ye))*xe,e}),e.stream=function(e){e=t.stream(e);var a=i.stream({point:function(t,i){e.point(.5*t,l(Math.tan(.5*-i*ye))*xe)},lineStart:function(){e.lineStart()},lineEnd:function(){e.lineEnd()},polygonStart:function(){e.polygonStart()},polygonEnd:function(){e.polygonEnd()}});return a.sphere=function(){e.sphere()},a.valid=!1,a},e};var Oe=d3.geo.azimuthalEquidistant.raw;(d3.geo.gingery=J).raw=G;var Ae=tt(2.8284,-1.6988,.75432,-.18071,1.76003,-.38914,.042555);(d3.geo.ginzburg4=function(){return _e(Ae)}).raw=Ae;var Pe=tt(2.583819,-.835827,.170354,-.038094,1.543313,-.411435,.082742);(d3.geo.ginzburg5=function(){return _e(Pe)}).raw=Pe;var De=tt(5/6*fe,-.62636,-.0344,0,1.3493,-.05524,0,.045);(d3.geo.ginzburg6=function(){return _e(De)}).raw=De,et.invert=function(t,e){var i,a=t,n=e,s=50;do{var r=n*n;n-=i=(n*(1+r/12)-e)/(1+r/4)}while(Math.abs(i)>ge&&--s>0);s=50,t/=1-.162388*r;do{var l=(l=a*a)*l;a-=i=(a*(.87-952426e-9*l)-t)/(.87-.00476213*l)}while(Math.abs(i)>ge&&--s>0);return[a,n]},(d3.geo.ginzburg8=function(){return _e(et)}).raw=et;var Ce=tt(2.6516,-.76534,.19123,-.047094,1.36289,-.13965,.031762);(d3.geo.ginzburg9=function(){return _e(Ce)}).raw=Ce,at.invert=function(t,e){var i=r(t),a=r(e),n=-i*t,s=-a*e,o=1>s/n,c=st(o?s:n,o?n:s),h=c[0],d=c[1];o&&(h=-ve-h);var u=Math.cos(d),t=Math.cos(h)*u,e=Math.sin(h)*u,m=Math.sin(d);return[i*(Math.atan2(e,-m)+fe),a*l(t)]},d3.geo.gringorten=it(at),ht.invert=function(t,e){var i=(Math.SQRT2-1)/(Math.SQRT2+1),a=Math.sqrt(1-i*i),n=ct(ve,a*a),s=-1,r=rt(.5*n-e,-t,a*a),l=ut(r[0],r[1]),o=Math.atan2(l[1],l[0])/s;return[o,2*Math.atan(Math.exp(.5/s*Math.log(i*l[0]*l[0]+i*l[1]*l[1])))-ve]},d3.geo.guyou=it(ht),(d3.geo.hammerRetroazimuthal=pt).raw=mt;var Ie=d3.geo.azimuthalEqualArea.raw;bt.invert=function(t,e){var i=2*l(e/2);return[t*Math.cos(i/2)/Math.cos(i),i]},(d3.geo.hammer=vt).raw=ft,yt.invert=function(t,e){var i=Math.abs(i=e*(0>e?.5179951515653813:.5686373742600607))>1-ge?i>0?ve:-ve:l(i);return[1.1764705882352942*t/Math.cos(i),Math.abs(i=((i+=i)+Math.sin(i))*(0>e?.4102345310814193:.3736990601468637))>1-ge?i>0?ve:-ve:l(i)]},(d3.geo.hatano=function(){return _e(yt)}).raw=yt;var qe=41+48/36+37/3600;(d3.geo.healpix=_t).raw=xt,(d3.geo.hill=zt).raw=Mt;var Re=.7109889596207567,Be=.0528035274542;wt.invert=function(t,e){return e>-Re?Se.invert(t,e-Be):T.invert(t,e)},(d3.geo.sinuMollweide=function(){return _e(wt).rotate([-20,-55])}).raw=wt,kt.invert=function(t,e){return Math.abs(e)>Re?Se.invert(t,e+(e>0?Be:-Be)):T.invert(t,e)},(d3.geo.homolosine=function(){return _e(kt)}).raw=kt,St.invert=function(t,e){return[2/3*fe*t/Math.sqrt(fe*fe/3-e*e),e]},(d3.geo.kavrayskiy7=function(){return _e(St)}).raw=St,(d3.geo.lagrange=Tt).raw=Et,Lt.invert=function(t,e){var i=Math.abs(t),a=Math.abs(e),n=fe/Math.SQRT2,s=ge,r=ve;n>a?r*=a/n:s+=6*o(n/a);for(var l=0;25>l;l++){var h=Math.sin(r),d=c(Math.cos(r)),u=Math.sin(r/2),m=Math.cos(r/2),g=Math.sin(s/6),p=Math.cos(s/6),f=.5*s*(1+d)-i,v=r/(m*p)-a,b=d?-.25*s*h/d:0,y=.5*(1+d),x=(1+.5*r*u/m)/(m*p),_=r/m*(g/6)/(p*p),M=b*_-x*y,z=(f*_-v*y)/M,w=(v*b-f*x)/M;if(r-=z,s-=w,Math.abs(z)<ge&&Math.abs(w)<ge)break}return[0>t?-s:s,0>e?-r:r]},(d3.geo.larrivee=function(){return _e(Lt)}).raw=Lt,Ot.invert=function(t,e){var i=r(t)*fe,a=e/2,n=50;do{var s=i*i,l=a*a,o=i*a,c=i*(.975534+l*(-.119161+s*-.0143059+l*-.0547009))-t,h=a*(1.00384+s*(.0802894+l*-.02855+199025e-9*s)+l*(.0998909+l*-.0491032))-e,d=.975534-l*(.119161+3*s*.0143059+.0547009*l),u=-o*(.238322+.2188036*l+.0286118*s),m=o*(.1605788+7961e-7*s+-0.0571*l),g=1.00384+s*(.0802894+199025e-9*s)+l*(3*(.0998909-.02855*s)-.245516*l),p=u*m-g*d,f=(h*u-c*g)/p,v=(c*m-h*d)/p;i-=f,a-=v}while((Math.abs(f)>ge||Math.abs(v)>ge)&&--n>0);return n&&[i,a]},(d3.geo.laskowski=function(){return _e(Ot)}).raw=Ot,At.invert=function(t,e){var i=t*t,a=e*e,n=a+1,s=t?Math.SQRT1_2*Math.sqrt((n-Math.sqrt(i*i+2*i*(a-1)+n*n))/i+1):1/Math.sqrt(n);return[l(t*s),r(e)*o(s)]},(d3.geo.littrow=function(){return _e(At)}).raw=At,(d3.geo.loximuthal=function(){return E(Pt).parallel(40)}).raw=Pt,Dt.invert=function(t,e){return[t,2.5*Math.atan(Math.exp(.8*e))-.625*fe]},(d3.geo.miller=function(){return _e(Dt)}).raw=Dt;var Fe={alaska:[[.9972523,0],[.0052513,-.0041175],[.0074606,.0048125],[-.0153783,-.1968253],[.0636871,-.1408027],[.3660976,-.2937382]],gs48:[[.98879,0],[0,0],[-.050909,0],[0,0],[.075528,0]],gs50:[[.984299,0],[.0211642,.0037608],[-.1036018,-.0575102],[-.0329095,-.0320119],[.0499471,.1223335],[.026046,.0899805],[7388e-7,-.1435792],[.0075848,-.1334108],[-.0216473,.0776645],[-.0225161,.0853673]],miller:[[.9245,0],[0,0],[.01943,0]],lee:[[.721316,0],[0,0],[-.00881625,-.00617325]]};(d3.geo.modifiedStereographic=It).raw=Ct,qt.invert=function(t,e){var i=Math.sqrt(6),a=Math.sqrt(7),n=3*l(e*a/9);return[t*a/(i*(2*Math.cos(2*n/3)-1)),l(3*Math.sin(n)*i/7)]},(d3.geo.mtFlatPolarParabolic=function(){return _e(qt)}).raw=qt,Rt.invert=function(t,e){var i=e*Math.sqrt(2+Math.SQRT2)/(2*Math.sqrt(3)),a=2*l(i);return[3*Math.SQRT2*t/(1+2*Math.cos(a)/Math.cos(a/2)),l((i+Math.sin(a))/(1+Math.SQRT1_2))]},(d3.geo.mtFlatPolarQuartic=function(){return _e(Rt)}).raw=Rt,Bt.invert=function(t,e){var i=Math.sqrt(6/(4+fe)),a=e/i;return Math.abs(Math.abs(a)-ve)<ge&&(a=0>a?-ve:ve),[1.5*t/(i*(.5+Math.cos(a))),l((a/2+Math.sin(a))/(1+fe/4))]},(d3.geo.mtFlatPolarSinusoidal=function(){return _e(Bt)}).raw=Bt,Ft.invert=function(t,e){var i,a=e,n=25;do{var s=a*a,r=s*s;a-=i=(a*(1.007226+s*(.015085+r*(-.044475+.028874*s-.005916*r)))-e)/(1.007226+s*(.045255+r*(-0.311325+.259866*s-.005916*11*r)))}while(Math.abs(i)>ge&&--n>0);return[t/(.8707+(s=a*a)*(-.131979+s*(-.013791+s*s*s*(.003971-.001529*s)))),a]},(d3.geo.naturalEarth=function(){return _e(Ft)}).raw=Ft,Ht.invert=function(t,e){for(var i=e/2,a=0,n=1/0;10>a&&Math.abs(n)>ge;a++){var s=Math.cos(e/2);e-=n=(e-Math.tan(e/2)-i)/(1-.5/(s*s))}return[2*t/(1+Math.cos(e)),e]},(d3.geo.nellHammer=function(){return _e(Ht)}).raw=Ht;var He=1.0148,Ne=.23185,je=-.14499,Ye=.02406,Ve=He,Xe=5*Ne,Ue=7*je,Ke=9*Ye,We=1.790857183;Nt.invert=function(t,e){e>We?e=We:-We>e&&(e=-We);var i,a=e;do{var n=a*a;a-=i=(a*(He+n*n*(Ne+n*(je+Ye*n)))-e)/(Ve+n*n*(Xe+n*(Ue+Ke*n)))}while(Math.abs(i)>ge);return[t,a]},(d3.geo.patterson=function(){return _e(Nt)}).raw=Nt;var Qe=it(ht);(d3.geo.peirceQuincuncial=function(){return Qe().quincuncial(!0).rotate([-90,-90,45]).clipAngle(180-1e-6)}).raw=Qe.raw,jt.invert=function(t,e){if(Math.abs(e)<ge)return[t,0];var i,a=t*t+e*e,n=.5*e,s=10;do{var c=Math.tan(n),h=1/Math.cos(n),d=a-2*e*n+n*n;n-=i=(c*d+2*(n-e))/(2+d*h*h+2*(n-e)*c)}while(Math.abs(i)>ge&&--s>0);return c=Math.tan(n),[(Math.abs(e)<Math.abs(n+1/c)?l(t*c):r(t)*(o(Math.abs(t*c))+ve))/Math.sin(n),n]},(d3.geo.polyconic=function(){return _e(jt)}).raw=jt,(d3.geo.rectangularPolyconic=function(){return E(Yt)}).raw=Yt;var Ge=[[.9986,-.062],[1,0],[.9986,.062],[.9954,.124],[.99,.186],[.9822,.248],[.973,.31],[.96,.372],[.9427,.434],[.9216,.4958],[.8962,.5571],[.8679,.6176],[.835,.6769],[.7986,.7346],[.7597,.7903],[.7186,.8435],[.6732,.8936],[.6213,.9394],[.5722,.9761],[.5322,1]];Ge.forEach(function(t){t[1]*=1.0144}),Vt.invert=function(t,e){var i=e/ve,a=90*i,n=Math.min(18,Math.abs(a/5)),s=Math.max(0,Math.floor(n));do{var r=Ge[s][1],l=Ge[s+1][1],o=Ge[Math.min(19,s+2)][1],c=o-r,h=o-2*l+r,d=2*(Math.abs(i)-l)/c,u=h/c,m=d*(1-u*d*(1-2*u*d));if(m>=0||1===s){a=(e>=0?5:-5)*(m+n);var g,p=50;do n=Math.min(18,Math.abs(a)/5),s=Math.floor(n),m=n-s,r=Ge[s][1],l=Ge[s+1][1],o=Ge[Math.min(19,s+2)][1],a-=(g=(e>=0?ve:-ve)*(l+m*(o-r)/2+m*m*(o-2*l+r)/2)-e)*xe;while(Math.abs(g)>pe&&--p>0);break}}while(--s>=0);var f=Ge[s][0],v=Ge[s+1][0],b=Ge[Math.min(19,s+2)][0];return[t/(v+m*(b-f)/2+m*m*(b-2*v+f)/2),a*ye]},(d3.geo.robinson=function(){return _e(Vt)}).raw=Vt,(d3.geo.satellite=Kt).raw=Ut,Wt.invert=function(t,e){var i=e/1.70711,a=Math.sin(fe/4*i);return[t/(.74482-.34588*a*a),2*Math.atan(i)]},(d3.geo.times=function(){return _e(Wt)}).raw=Wt,(d3.geo.twoPointEquidistant=Gt).raw=Qt,(d3.geo.twoPointAzimuthal=Jt).raw=Zt,$t.invert=function(t,e){if(Math.abs(e)<ge)return[t,0];if(Math.abs(t)<ge)return[0,ve*Math.sin(2*Math.atan(e/fe))];var i=(t/=fe)*t,a=(e/=fe)*e,n=i+a,s=n*n,l=-Math.abs(e)*(1+n),c=l-2*a+i,h=-2*l+1+2*a+s,d=a/h+(2*c*c*c/(h*h*h)-9*l*c/(h*h))/27,u=(l-c*c/(3*h))/h,m=2*Math.sqrt(-u/3),g=o(3*d/(u*m))/3;return[fe*(n-1+Math.sqrt(1+2*(i-a)+s))/(2*t),r(e)*fe*(-m*Math.cos(g+fe/3)-c/(3*h))]},(d3.geo.vanDerGrinten=function(){return _e($t)}).raw=$t,te.invert=function(t,e){if(!t)return[0,ve*Math.sin(2*Math.atan(e/fe))];var i=Math.abs(t/fe),a=(1-i*i-(e/=fe)*e)/(2*i),n=a*a,s=Math.sqrt(n+1);return[r(t)*fe*(s-a),r(e)*ve*Math.sin(2*Math.atan2(Math.sqrt((1-2*a*i)*(a+s)-i),Math.sqrt(s+a+i)))]},(d3.geo.vanDerGrinten2=function(){return _e(te)}).raw=te,ee.invert=function(t,e){if(!e)return[t,0];var i=e/fe,a=(fe*fe*(1-i*i)-t*t)/(2*fe*t);return[t?fe*(r(t)*Math.sqrt(a*a+1)-a):0,ve*Math.sin(2*Math.atan(i))]},(d3.geo.vanDerGrinten3=function(){return _e(ee)}).raw=ee,ie.invert=function(t,e){if(!t||!e)return[t,e];e/=fe;var i=r(t)*t/ve,a=(i*i-1+4*e*e)/Math.abs(i),n=a*a,s=2*e,l=50;do{var o=s*s,c=(8*s-o*(o+2)-5)/(2*o*(s-1)),h=(3*s-o*s-10)/(2*o*s),d=c*c,u=s*c,m=s+c,g=m*m,p=s+3*c,f=g*(o+d*n-1)+(1-o)*(o*(p*p+4*d)+d*(12*u+4*d)),v=-2*m*(4*u*d+(1-4*o+3*o*o)*(1+h)+d*(-6+14*o-n+(-8+8*o-2*n)*h)+u*(-8+12*o+(-10+10*o-n)*h)),b=Math.sqrt(f),y=a*(g+d-1)+2*b-i*(4*g+n),x=a*(2*c*h+2*m*(1+h))+v/b-8*m*(a*(-1+d+g)+2*b)*(1+h)/(n+4*g);s-=δ=y/x}while(δ>ge&&--l>0);return[r(t)*(Math.sqrt(a*a+4)+a)*fe/4,ve*s]},(d3.geo.vanDerGrinten4=function(){return _e(ie)}).raw=ie;var Ze=function(){var t=4*fe+3*Math.sqrt(3),e=2*Math.sqrt(2*fe*Math.sqrt(3)/t);return k(e*Math.sqrt(3)/fe,e,t/6)}();(d3.geo.wagner4=function(){return _e(Ze)}).raw=Ze,ae.invert=function(t,e){return[t/Math.sqrt(1-3*e*e/(fe*fe)),e]},(d3.geo.wagner6=function(){return _e(ae)}).raw=ae,ne.invert=function(t,e){var i=t/2.66723,a=e/1.24104,n=Math.sqrt(i*i+a*a),s=2*l(n/2);return[3*Math.atan2(t*Math.tan(s),2.66723*n),n&&l(e*Math.sin(s)/(1.24104*.90631*n))]},(d3.geo.wagner7=function(){return _e(ne)}).raw=ne,se.invert=function(t,e){var i=-.5*(t*t+e*e),a=Math.sqrt(-i*(2+i)),n=e*i+t*a,s=t*i-e*a,r=Math.sqrt(s*s+n*n);return[Math.atan2(a*n,r*(1+i)),r?-l(a*s/r):0]},(d3.geo.wiechel=function(){return _e(se)}).raw=se,re.invert=function(t,e){var i=t,a=e,n=25;do{var s,r=Math.cos(a),l=Math.sin(a),c=Math.sin(2*a),h=l*l,d=r*r,u=Math.sin(i),m=Math.cos(i/2),g=Math.sin(i/2),p=g*g,f=1-d*m*m,v=f?o(r*m)*Math.sqrt(s=1/f):s=0,b=.5*(2*v*r*g+i/ve)-t,y=.5*(v*l+a)-e,x=.5*s*(d*p+v*r*m*h)+.5/ve,_=s*(u*c/4-v*l*g),M=.125*s*(c*g-v*l*d*u),z=.5*s*(h*m+v*p*r)+.5,w=_*M-z*x,k=(y*_-b*z)/w,S=(b*M-y*x)/w;i-=k,a-=S}while((Math.abs(k)>ge||Math.abs(S)>ge)&&--n>0);return[i,a]},(d3.geo.winkel3=function(){return _e(re)}).raw=re}function N(){return function(){function t(u){return null==n?void console.warn("D3 collision resolver stopped: missing data to work with. Example: data = {asi: {valueY: 45, valueX: 87}, ame: {valueY: 987, valueX: 767}}"):null==s?void console.warn("D3 collision resolver stopped: missing a CSS slector"):null==r?void console.warn("D3 collision resolver stopped: missing height of the canvas"):null==o?void console.warn("D3 collision resolver stopped: missing pointer within data objects. Example: value = 'valueY' "):null==d?void console.warn("D3 collision resolver stopped: missing a key for data. Example: key = 'geo' "):(u.each(function(t,e){i[t[d]]=d3.select(this).select(s)[0][0].getBBox().height}),a=t.calculatePositions(n,o,r,l),void u.each(function(t,i){if(!n[t[d]][c]){var r=a[t[d]]||l(n[t[d]][o])||0,u=null;return null!=h?void h(t,i,this,u,r):void d3.select(this).selectAll(s).transition().duration(e).attr("transform","translate(0,"+r+")")}}))}var e=300,i={},a={};t.calculatePositions=function(t,e,a,n){var s={},r=Object.keys(t).sort(function(i,a){return t[i][e]-t[a][e]});r.forEach(function(a,l){s[a]=n(t[a][e]);for(var o=l;o>0;o--){var c=s[r[o-1]]-s[r[o]]-i[r[o]];if(0>c&&(s[r[o-1]]-=c),c>0)break}});var l=a-s[r[0]]-i[r[0]];if(0>l){s[r[0]]+=l;for(var o=0;o<r.length-1;o++){var l=s[r[o]]-s[r[o+1]]-i[r[o+1]];if(0>l&&(s[r[o+1]]+=l),l>0)break}}return s};var n=null;t.data=function(e){return arguments.length?(n=e,t):n};var s=null;t.selector=function(e){return arguments.length?(s=e,t):s};var r=null;t.height=function(e){return arguments.length?(r=e,t):r};var l=d3.scale.linear().domain([0,1]).range([0,1]);t.scale=function(e){return arguments.length?(l=e,t):l};var o=null;t.value=function(e){return arguments.length?(o=e,t):o};var c=null;t.fixed=function(e){return arguments.length?(c=e,t):c};var h=null;t.handleResult=function(e){return arguments.length?(h=e,t):h};var d=null;return t.KEY=function(e){return arguments.length?(d=e,t):d},t}()}function j(){return function t(e){function i(t){var i=1,n=0,l=0,h=0,d=s[0]<s[s.length-1],u=r[0]<r[r.length-1];if(d3.min(s)<0&&d3.max(s)>0){var m=d3.min(c([s[0],s[s.length-1]]));i=d!=u?(d3.max(r)+d3.max(r)-e(Math.max(a,m)))/d3.max(r):(d3.max(r)+e(Math.max(a,m)))/d3.max(r),d&&!u?(n=(d3.max(r)+o(0))/i,c(s[0])>c(s[s.length-1])&&(h-=e(Math.max(a,m))/i)):d||u?d&&u?(h=d3.max(r)/i,c(s[0])<c(s[s.length-1])&&(h-=(d3.max(r)-e(Math.max(a,m)))/i)):!d&&u&&(n=(d3.max(r)+o(0))/i,c(s[0])<c(s[s.length-1])&&(h-=e(Math.max(a,m))/i)):(h=e(Math.max(a,m))/i,c(s[0])<c(s[s.length-1])&&(h+=(d3.max(r)-e(Math.max(a,m)))/i))}else d3.min(s)<0&&d3.max(s)<0&&(n=d3.max(r));return t>a?e(t)/i+h+l:-a>t?-e(-t)/i+h+n:t>=0&&a>=t?o(t)/i+h+l:t>=-a&&0>t?-o(-t)/i+h+n:void 0}var a=1,n=5,s=e.domain(),r=e.range(),l=!1,o=d3.scale.linear().domain([0,a]).range([0,n]),c=function(t){return t instanceof Array?t.map(function(t){return Math.abs(t)}):Math.abs(t)},h=function(t){for(var e=Math.sign(t[0]),i=0;i<t.length;i++)if(Math.sign(t[i])!=e)return!1;return!0};return i.eps=function(t){return arguments.length?(a=t,i.domain(s),i):a},i.delta=function(t){return arguments.length?(n=t,i.range(r),i):n},i.domain=function(t){if(!arguments.length)return s;var n=[];switch(2!=t.length&&console.warn("generic log scale is best for 2 values in domain, but it tries to support other cases too"),t.length){case 0:n=s;break;case 1:n=[t[0]/2,2*t[0]];break;case 2:n=[t[0],t[1]];break;case 3:n=[t[0],t[2]],a=c(t[1]);break;default:n=[t[0],t[t.length-1]],a=d3.min(c(t.filter(function(e,i){return 0!=i&&i!=t.length-1})))}return n[0]==n[1]&&(n[0]=n[0]/2,n[1]=2*n[1]),h(n)&&d3.min(c(n))>=a?(n[0]>0&&n[1]>0?e.domain(n):e.domain([-n[1],-n[0]]),l=!1):h(n)&&d3.min(c(n))<a?(n[0]>0&&n[1]>0?n[0]<=n[1]?(e.domain([a,n[1]]),o.domain([0,a])):(e.domain([n[0],a]),o.domain([a,0])):n[0]<=n[1]?(e.domain([a,-n[0]]),o.domain([0,a])):(e.domain([-n[1],a]),o.domain([a,0])),l=!0):h(n)||(n[0]<=n[1]?(e.domain([a,d3.max(c(n))]),o.domain([0,a])):(e.domain([d3.max(c(n)),a]),o.domain([a,0])),l=!0),s=t,i},i.range=function(t){if(!arguments.length)return r;switch(2!=t.length&&console.warn("generic log scale is best for 2 values in range, but it tries to support other cases too"),t.length){case 0:t=r;break;case 1:t=[t[0]-100,t[0]+100];break;case 2:t=t;break;case 3:n=t[1],t=[t[0],t[2]];break;default:n=d3.min(t.filter(function(e,i){return 0!=i&&i!=t.length-1})),t=[t[0],t[t.length-1]]}return l?t[0]<t[1]?s[0]<s[s.length-1]?(e.range([n,t[1]]),o.range([0,n])):(e.range([0,t[1]-n]),o.range([t[1]-n,t[1]])):s[0]<s[s.length-1]?(e.range([t[0]-n,0]),o.range([t[0],t[0]-n])):(e.range([t[0],n]),o.range([n,0])):e.range(t),r=t,i},i.copy=function(){return t(d3.scale.log().domain([1,10])).domain(s).range(r).eps(a).delta(n)},d3.rebind(i,e,"invert","base","rangeRound","interpolate","clamp","nice","tickFormat","ticks")}(d3.scale.log().domain([1,10]))}function Y(t,e,i){var a,n=e?".onTap":".onLongTap";d3.select(t).on("touchstart"+n,function(t,e){a=d3.event.timeStamp}).on("touchend"+n,function(t,n){return d3.event.timeStamp-a<500?e?e(t,n):void 0:i?i(t,n):void 0})}var V={},X={linear:function(t,e,i,a,n){return+i+(a-i)*(n-t)/(e-t)},exp:function(t,e,i,a,n){return Math.exp((Math.log(i)*(e-n)-Math.log(a)*(t-n))/(e-t))},stepBefore:function(t,e,i,a,n){return a},stepAfter:function(t,e,i,a,n){return i},stepMiddle:function(t,e,i,a,n){return(t+e)/2>n?i:a}},U=function(){var t=0;return function(e){return e?e+(t+=1):t+=1}}(),K=function(t){return!(!t||1!==t.nodeType)},W=Array.isArray||function(t){return"[object Array]"===toString.call(t)},Q=function(t){var e=typeof t;return"object"===e&&!!t},G=function(t){return t instanceof Date},Z=function(t){return"string"==typeof t},J=function(t){return $(t)&&t!==+t},$=function(t){return"number"==typeof t||!!t&&"object"==typeof t&&"[object Number]"===Object.prototype.toString.call(t)},tt=function(t){return null!==t&&"[object Object]"===Object.prototype.toString.call(t)},et=function(t,e){if(t===e)return!0;if(null==t||null==e)return!1;if(t.length!=e.length)return!1;for(var i=0;i<t.length;++i)if(t[i]!==e[i])return!1;return!0},it=function(t,e){var i=function(t){return Object.prototype.toString.call(t).match(/^\[object\s(.*)\]$/)[1]},a=function(t){if(void 0===t)return"undefined";if(null===t)return"null";var e=typeof t;return"object"===e&&(e=i(t).toLowerCase()),"number"===e?t.toString().indexOf(".")>0?"float":"integer":e},n=function(t,e){if(t===e)return!0;for(var i in t){if(!e.hasOwnProperty(i))return!1;if(!l(t[i],e[i]))return!1}for(var i in e)if(!t.hasOwnProperty(i))return!1;return!0},s=function(t,e){if(t===e)return!0;if(t.length!==e.length)return!1;for(var i=0;i<t.length;i++)if(!l(t[i],e[i]))return!1;return!0},r={};r.array=s,r.object=n,r.date=function(t,e){return t.getTime()===e.getTime()},r.regexp=function(t,e){return t.toString()===e.toString()};var l=function(t,e){if(t!==e){var i=a(t),n=a(e);return i===n?r.hasOwnProperty(i)?r[i](t,e):t==e:!1}return!0};return n(t,e)},at=function(t){for(var e=0,i=0;t;)e+=t.offsetLeft-t.scrollLeft+t.clientLeft,i+=t.offsetTop-t.scrollTop+t.clientTop,t=t.offsetParent;return{x:e,y:i}},nt=function(t){for(var e=["scroll","auto"];t=t.parentNode;){var i=t.scrollHeight,a=t.clientHeight;if(i>a&&-1!==e.indexOf(d3.select(t).style("overflow")))return t}return null},st=function(t,e){return Math.round(t/e)*e},rt=function(t){return+t.replace(/[^\d.-]/g,"")},lt=function(t,e,i){if(t){var a,n;if(W(t))for(n=t.length,a=0;n>a&&e.apply(i,[t[a],a])!==!1;a+=1);else{var s=Object.keys(t);for(n=s.length,a=0;n>a&&e.apply(i,[t[s[a]],s[a]])!==!1;a+=1);}}},ot=function(t){var e=Array.prototype.slice.call(arguments,1);return lt(e,function(e,i){lt(e,function(i,a){e.hasOwnProperty(a)&&(t[a]=i)})}),t},ct=function(){if(arguments.length<1||"object"!=typeof arguments[0])return!1;if(arguments.length<2)return arguments[0];var a,n,s=arguments[0],r=Array.prototype.slice.call(arguments,1);return lt(r,function(r){"object"!=typeof r||W(r)||lt(Object.keys(r),function(l){return n=s[l],a=r[l],a===s?void 0:"object"!=typeof a||null===a?void(s[l]=a):W(a)?void(s[l]=i(a)):t(a)?void(s[l]=e(a)):"object"!=typeof n||null===n||W(n)?void(s[l]=ct({},a)):void(s[l]=ct(n,a))})}),s},ht=function(t){var e=Array.prototype.slice.call(arguments,1);return lt(e,function(e,i){lt(e,function(i,a){e.hasOwnProperty(a)&&(t.hasOwnProperty(a)?(W(t[a])||(t[a]=[t[a]]),t[a].push(i)):t[a]=i)})}),t},dt=function(t,e,i){if(W(t))return t.slice(0);var a={};return lt(t,function(n,s){e&&-1===e.indexOf(s)||i&&-1!==i.indexOf(s)||t.hasOwnProperty(s)&&(a[s]=n)}),a},ut=function(t){var e={};return W(t)&&(e=[]),lt(t,function(t,i){Q(t)||W(t)?e[i]=ut(t):e[i]=t}),e},mt=function(t,e){var i=t.indexOf(e);return-1!==i&&t.splice(i,1),t},gt=function(t,e){var i={},a=[];e||(e=function(t){return t});for(var n=0,s=t.length;s>n;n+=1){var r=e(t[n]);i.hasOwnProperty(r)||(a.push(t[n]),i[r]=1)}return a},pt=function(t,e){var i={},a=[];e||(e=function(t){return t});for(var n=0,s=t.length;s>n;n+=1){var r=e(t[n]);i.hasOwnProperty(r)&&a.splice(i[r],1),a.push(t[n]),i[r]=a.length-1}return a},ft=function(t,e){var i;return lt(t,function(t){return e(t)?(i=t,!1):void 0}),i},vt=function(t,e){for(var i,a,n=-1,s=t.length,r=-1,l=[],o=Object.keys(e),c=o.length;(n+=1)<s;){var h=t[n],d=!0;for(i=0;c>i;i+=1)if(a=o[i],!h.hasOwnProperty(a)||h[a]!==e[a]){d=!1;break}d&&(l[r+=1]=h)}return l},bt=function(t,e,i){for(var a,n,s=-1,r=t.length,l=-1,o=[],c=Object.keys(e),h=c.length;(s+=1)<r;){var d=t[s],u=!0;for(a=0;h>a;a+=1)if(n=c[a],!d.hasOwnProperty(n)||!yt(d[n],e[n],i)){u=!1;break}u&&(o[l+=1]=d)}return o},yt=function(t,e,i){W(t)||(t=[t]),i||(i="*");for(var a=!1,n=0;n<t.length;n++){var s=t[n];if(!W(e)&&s==e){a=!0;break}if(W(e)){for(var r=-1,l=0;l<e.length;l++){var o=e[l];if(!(W(o)||o!=s&&o!==i)){r=l;break}if(W(o)){var c=o[0],h=o[1]||c;if(s>=c&&h>=s){r=l;break}}}if(-1!==r){a=!0;break}}}return a},xt=function(t){var e=!1;t.on("mousewheel",function(i,a){var n=this.scrollTop,s=this.scrollHeight,r=t.node().offsetHeight,l=d3.event.wheelDelta,o=l>0,c=function(){return d3.event.stopPropagation(),d3.event.preventDefault(),d3.event.returnValue=!1,!1},h=function(t){return function(){var e=d3.interpolateNumber(this.scrollTop,t);return function(t){this.scrollTop=e(t)}}};return o?o&&(l>n&&n>0?(t.transition().delay(0).duration(0).tween("scrolltween",h(0)),e=!0,setTimeout(function(){e=!1},2e3)):s==r+n&&(e=!1)):-l>s-r-n&&s!=r+n?(t.transition().delay(0).duration(0).tween("scrolltween",h(s)),e=!0,setTimeout(function(){e=!1},2e3)):0==n&&(e=!1),e?c():void 0})},_t=function(t,e){function i(t,e){if(W(t)){for(var a=[],n=0;n<t.length;n++)a[n]=i(t[n],e);return a}return e(t)}var a=function(t){var e=t;if(""===t)e=null;else{var i=parseFloat(t);!J(i)&&isFinite(t)&&(e=i)}return e};return t=t.map(function(t){for(var n=Object.keys(t),s=0;s<n.length;s++){var r=n[s];t[r]=i(t[r],e[r]||a)}return t})},Mt=function(t){return t*t*Math.PI},zt=function(t){return Math.sqrt(t/Math.PI)},wt=function(t){console&&"function"==typeof console.timeStamp&&console.timeStamp(t)},kt=function(t){t=Array.prototype.slice.call(arguments).join(" "),console&&"function"==typeof console.warn&&console.warn(t)},St=function(t){t=Array.prototype.slice.call(arguments).join(" "),console&&"function"==typeof console.groupCollapsed&&console.groupCollapsed(t)},Et=function(){console&&"function"==typeof console.groupEnd&&console.groupEnd()},Tt=function(t){t=Array.prototype.slice.call(arguments).join(" "),console&&"function"==typeof console.error&&console.error(t)},Lt=function(t){return Math.floor(t.valueOf())===t.valueOf()?0:t.toString().split(".")[1].length||0},Ot=function(t,e){t.classList?t.classList.add(e):t.className+=" "+e},At=function(t,e){t.classList?t.classList.remove(e):t.className=t.className.replace(new RegExp("(^|\\b)"+e.split(" ").join("|")+"(\\b|$)","gi")," ")},Pt=function(t,e,i){if(i===!0)Ot(t,e);else{if(i!==!1)return Dt(t,e);At(t,e)}},Dt=function(t,e){return t.classList?t.classList.contains(e):new RegExp("(^| )"+e+"( |$)","gi").test(t.className)},Ct=function(t,e){var i,a,n,s=!1,r=function(){return n>Date.now()?(s=!0,i=arguments,void(a=this)):(n=Date.now()+e,s=!1,t.apply(this,arguments),void setTimeout(function(){l()},e))},l=function(){s&&(s=!1,t.apply(a,i))};return r.recallLast=l,r},It=function(t){return Object.keys(t)},qt=function(t){for(var e,i=Object.keys(t),a=i.length,n=0;a>n;n+=1)(e=e||[]).push(t[i[n]]);return e},Rt=function(t){return t.reduce(function(t,e){return e>t?t:e})},Bt=function(t){return t.reduce(function(t,e){return t>e?t:e})},Ft=function(t){return Ht(t)/t.length},Ht=function(t){return t.reduce(function(t,e){return t+e})},Nt=function(t){t=t.sort(function(t,e){return t-e});var e=Math.floor((t.length-1)/2);return t.length%2?t[e]:(t[e]+t[e+1])/2},jt=function(t){return t.length?t[t.length-1]:null},Yt=function(t,e){var i={};return lt(t,function(t,a){if(e.hasOwnProperty(a)){if(t!==e[a])if(tt(t)&&tt(e[a])){var n=Yt(t,e[a]);Object.keys(n).length>0&&(i[a]=n)}else W(t)&&W(e[a])&&et(t,e[a])||(i[a]=t)}else i[a]=t}),i},Vt=function(t){var e={};return lt(t,function(t,i){tt(t)&&t._defs_?e[i]=t._defs_:tt(t)?e[i]=Vt(t):e[i]=t}),e},Xt=function(t,e){var i={};return lt(t,function(t,a){"time"===a&&("object"==typeof t.value&&(t.value=e(t.value)),"object"==typeof t.start&&(t.start=e(t.start)),"object"==typeof t.end&&(t.end=e(t.end))),tt(t)?i[a]=Xt(t,e):i[a]=t}),i},Ut=function(t){setTimeout(t,1)},Kt=function(t,e){return setTimeout(t,e)},Wt=function(t){return clearTimeout(t)},Qt=function(t){Z(t)||(t=JSON.stringify(t));var e,i=0,a=t.length;if(0===a)return i;for(var n=0;a>n;n+=1)e=t.charCodeAt(n),i=(i<<5)-i+e,i&=i;return i.toString()},Gt=function(t){if(!t||!t.length||!t[0].key)return t;for(var e={},i=0;i<t.length;i++)e[t[i].key]=Gt(t[i].values);return e},Zt=function(){},Jt=function(t,e,i,a,n,s,r,l){if(!t||0===t.length)return kt("interpolatePoint failed because incoming array is empty. It was "+i),null;if("constant"===e)return i;if("property"===e)return t[0][i];if(l){if(s-t[0][n]<=0)return t[0][i];if(s-t[t.length-1][n]>=0)return t[t.length-1][i]}else if(s<t[0][n]||s>t[t.length-1][n])return null;if(a||0===a||(a=d3.bisectLeft(t.map(function(t){return t[n]}),s)),0===a)return t[0][i];if(void 0===t[a]||null===t[a][i]||null===t[a-1][i]||""===t[a][i])return kt("interpolatePoint failed because next/previous points are bad in "+i),null;var o=X[r||"linear"](t[a-1][n],t[a][n],t[a-1][i],t[a][i],s);return i===n&&(o=new Date(o)),J(o)&&(kt("interpolatePoint failed because result is NaN. It was "+i),o=null),o},$t=function(t){var e=new XMLHttpRequest;e.open(t.method,t.url,!0),"POST"!==t.method||t.json?"POST"===t.method&&t.json&&e.setRequestHeader("Content-Type","application/json; charset=UTF-8"):e.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),e.onload=function(){if(e.status>=200&&e.status<400){var i=t.json?JSON.parse(e.responseText):e.responseText;t.success&&t.success(i)}else t.error&&t.error()},e.onerror=function(){t.error&&t.error()},e.send(t.data)},te=function(t,e,i,a,n){e=e||[],lt(e,function(t,i){e.push(i+"="+t)}),t=e.length?t+"?"+e.join("&"):t,$t({method:"GET",url:t,success:i,error:a,json:n})},ee=function(t,e,i,a,n){$t({method:"POST",url:t,success:i,error:a,json:n,data:e})},ie=function(t){return function(){for(var e=Array.prototype.slice.call(arguments),i="",a=e.length,n=null;a--;)n=e[a],i+=n===Object(n)?JSON.stringify(n):n,t.memoize||(t.memoize={});return i in t.memoize?t.memoize[i]:t.memoize[i]=t.apply(this,e)}},ae=function(t,e,i){var a;return function(){var n=this,s=arguments,r=function(){a=null,i||t.apply(n,s)},l=i&&!a;clearTimeout(a),a=setTimeout(r,e),l&&t.apply(n,s)}},ne=function(){return!!("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)},se=function(t,e){var i={},a=[];return t.hasOwnProperty("children")&&(a=t.children.map(function(t){return se(t,e)}).filter(function(t){return 0!==Object.keys(t).length})),(0!=a.length||e(t))&&(i.id=t.id),0!=a.length&&(i.children=a),i},re=function(t,e){return t.selectAll("*").remove(),t.node().appendChild(t.node().ownerDocument.importNode((new DOMParser).parseFromString(e,"application/xml").documentElement,!0)),t},le={uniqueId:U,isElement:K,isArray:W,isObject:Q,isDate:G,isString:Z,isNaN:J,isNumber:$,isPlainObject:tt,arrayEquals:et,comparePlainObjects:it,getViewportPosition:at,findScrollableAncestor:nt,roundStep:st,strToFloat:rt,forEach:lt,extend:ot,deepExtend:ct,merge:ht,clone:dt,deepClone:ut,without:mt,unique:gt,uniqueLast:pt,find:ft,filter:vt,filterAny:bt,matchAny:yt,preventAncestorScrolling:xt,mapRows:_t,radiusToArea:Mt,areaToRadius:zt,timeStamp:wt,warn:kt,groupCollapsed:St,groupEnd:Et,error:Tt,countDecimals:Lt,addClass:Ot,removeClass:At,classed:Pt,hasClass:Dt,throttle:Ct,keys:It,values:qt,arrayMin:Rt,arrayMax:Bt,arrayMean:Ft,arraySum:Ht,arrayMedian:Nt,arrayLast:jt,diffObject:Yt,flattenDefaults:Vt,flattenDates:Xt,defer:Ut,delay:Kt,clearDelay:Wt,hashCode:Qt,nestArrayToObj:Gt,interpolateVector:Zt,interpolatePoint:Jt,ajax:$t,get:te,post:ee,memoize:ie,debounce:ae,isTouchDevice:ne,pruneTree:se,setIcon:re},oe=!1,ce=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/,he=function(){};he.extend=a,s.prototype.then=function(t,e){var i,a=this._next||(this._next=s()),n=this.status;if("pending"===n)return h(t)&&this._resolves.push(t),h(e)&&this._rejects.push(e),a;if("resolved"===n){if(h(t))try{i=t(this.value),r(a,i)}catch(l){this.reject(l)}else a.resolve(t);return a}if("rejected"===n){if(h(e))try{i=e(this.reason),r(a,i)}catch(l){this.reject(l)}else a.reject(e);return a}},s.prototype.resolve=function(t){if("rejected"===this.status)throw Error("Illegal call.");return this.status="resolved",this.value=t,this._resolves.length&&c(this),this},s.prototype.reject=function(t){if("resolved"===this.status)throw Error("Illegal call. "+t);return this.status="rejected",this.reason=t,this._rejects.length&&c(this),
this},s.prototype["catch"]=function(t){return this.then(void 0,t)},s.cast=function(t){var e=s();return t instanceof s?l(e,t):s.resolve(t)},s.resolve=function(t){var e=s();return u(t)?o(e,t):e.resolve(t)},s.all=function(t){var e,i=t.length,a=s(),n=[],r=0;return lt(t,function(t,s){t.then(function(t){n[s]=t,(r+=1)!==i||e||a.resolve(n)},function(t){e=!0,a.reject(t)})}),a},s.any=function(t){var e,i=s();return lt(t,function(t,a){t.then(function(t){e||(i.resolve(t),e=!0)},function(t){e=!0,i.reject(t)})}),i},s.reject=function(t){if(!(t instanceof Error))throw Error("reason must be an instance of Error");var e=s();return e.reject(t),e};var de=he.extend({init:function(t){this._name=this._name||t.reader,this._data=t.data||[],this._basepath=this._basepath||t.path||null,this._parsers=t.parsers,this._parsers&&(this._data=_t(this._data,this._parsers))},read:function(t,e){return new s.resolve},getData:function(){return this._data}}),ue=he.extend({init:function(){this._collection={},this._collectionPromises={}},load:function(t,e,i,a){var n=this,r=new s,l=(new s).resolve(),o=t===!0?!0:this.isCached(t,e,i),c=!1;return o||(wt("Vizabi Data: Loading Data"),a&&"function"==typeof a.load_start&&a.load_start(),l=new s,this.loadFromReader(t,e,i).then(function(t){c=!0,o=t,l.resolve()},function(t){kt(t),l.reject()})),l.then(function(){n._collection[o].data;c&&a&&"function"==typeof a.load_end&&a.load_end(),r.resolve(o)},function(){c&&a&&"function"==typeof a.load_end&&a.load_end(),r.reject()}),r},loadFromReader:function(t,e,i){var a=this,n=new s,r=i.reader,l=Qt([t,e,i]);return this.queryQueue=this.queryQueue||[],this.queryQueue.push({query:t,queryId:l,promise:n,reader:i}),Ut(function(){var n=[],s=!1;if(a.queryQueue=a.queryQueue.filter(function(e){return e.query==t?(n.push(e),s=!0,!1):it(e.query.where,t.where)&&it(e.query.grouping,t.grouping)?(Array.prototype.push.apply(t.select,e.query.select),ot(i.parsers,e.reader.parsers),n.push(e),!1):!0}),s){t.select=gt(t.select);var o,c,h=0;c=dt(t),o=It(c.grouping),et(c.select.slice(0,o.length),o)&&(c.select=o,h=Qt([c,e,i]));var d=de.get(r);if(!d)throw new Error("Unknown reader: "+r);var u=new d(i);u.read(t,e).then(function(){var e=u.getData(),i=t;e=e.map(function(t){for(var e=0;e<i.select.length;e+=1){var a=i.select[e];"undefined"==typeof t[a]&&(t[a]=null)}return t}),a._collection[l]={},a._collectionPromises[l]={};var s=a._collection[l];s.data=e,s.valid={},s.nested={},s.unique={},s.limits={},s.limitsPerFrame={},s.frames={},s.query=i,lt(n,function(t){a._collection[t.queryId]=a._collection[l],a._collectionPromises[t.queryId]=a._collectionPromises[l],t.promise.resolve(t.queryId)}),0!==h&&(a._collection[h]=a._collection[l])},function(t){lt(n,function(e){e.promise.reject(t)})})}}),n},get:function(t,e,i,a){if(!t)return kt("Data.js 'get' method doesn't like the queryId you gave it: "+t);if(!e||"data"==e)return this._collection[t].data;if(!i)return this._collection[t][e];var n=JSON.stringify(i);if(this._collection[t][e][n])return this._collection[t][e][n];switch(e){case"unique":this._collection[t][e][n]=this._getUnique(t,i);break;case"valid":this._collection[t][e][n]=this._getValid(t,i);break;case"limits":this._collection[t][e][n]=this._getLimits(t,i);break;case"nested":this._collection[t][e][n]=this._getNested(t,i)}return this._collection[t][e][n]},getMetadata:function(t){return V.metadata&&V.metadata.indicatorsDB?t?V.metadata.indicatorsDB[t]:V.metadata.indicatorsDB:{}},getIndicatorsTree:function(){return V.metadata&&V.metadata.indicatorsTree?V.metadata.indicatorsTree:{}},getFrames:function(t,e){var i=this,a=e[0]+" - "+e[e.length-1];return this._collectionPromises[t][a]||(this._collectionPromises[t][a]={queue:this.framesQueue(e),promise:null}),this._collectionPromises[t][a]&&this._collectionPromises[t][a].promise instanceof s?this._collectionPromises[t][a].promise:(this._collectionPromises[t][a].promise=new s(function(n,s){t||s(kt("Data.js 'get' method doesn't like the queryId you gave it: "+t)),i._getFrames(t,a,e).then(function(e){i._collection[t].frames[a]=e,n(i._collection[t].frames[a])})}),this._collectionPromises[t][a].promise)},getFrame:function(t,e,i){var a=this,n=a._collection[t].query,r=e[0]+" - "+e[e.length-1];n.select.filter(function(t){return"geo"!=t&&"time"!=t&&"_default"!==t});return new s(function(e,n){a._collection[t].frames[r]&&a._collection[t].frames[r][i]?e(a._collection[t].frames[r]):a._collectionPromises[t][r].queue.forceFrame(i,function(){e(a._collection[t].frames[r])})})},framesQueue:function(t){return new function(){this.callbacks={},this.forcedQueue=[],this.queue=t.slice(0),this.queue.splice(0,0,this.queue.splice(this.queue.length-1,1)[0]),this.key=0,this.getNext=function(){var t=this,e=null;if(this.forcedQueue.length>0)e=this.forcedQueue.shift();else{if(0==this.queue.length)return!1;0==this.forcedQueue.length&&this.key>=this.queue.length-1&&(this.key=0),e=this.queue.splice(this.key,1).pop()}this.callbacks[e]||(this.callbacks[e]=[]);var i=function(e){if(t.callbacks[e].length>0)for(var i=0;i<t.callbacks[e].length;i++)t.callbacks[e][i]()};return{frameName:e,callback:i}},this.forceFrame=function(t,e){var i=function(t,e){for(var i=e.toString(),a=-1,n=0,s=t.length;s>n;n++)if(t[n].toString()==i){a=n;break}return a};if(this.callbacks[t])this.callbacks[t].push(e);else{var a=i(this.queue,t);-1!==a?(this.forcedQueue.unshift(this.queue.splice(a,1).pop()),"function"==typeof e&&("object"!=typeof this.callbacks[t]&&(this.callbacks[t]=[]),this.callbacks[t].push(e)),this.key=a):"object"==typeof this.callbacks[t]?this.callbacks[t].push(e):this.callbacks[t]=[e]}}}},_getFrames:function(t,e,i){var a=this;return a._collection[t].frames[e]||(a._collection[t].frames[e]={}),new s(function(n,s){var r=a.getMetadata();r||kt("_getFrames in data.js is missing indicatorsDB, it's needed for gap filling"),i||kt("_getFrames in data.js is missing framesArray, it's needed so much");var l,o,c,h,d,u,m,g,p,f,v="geo",b="time",y={},x=a.get(t,"nested",[v,b]),_=Object.keys(x),M=a._collection[t].query,z=M.select.filter(function(t){return t!=v&&t!=b&&"_default"!==t}),w=z.length;for(g=0;g<_.length;g++)for(y[_[g]]={},f=0;w>f;f++)y[_[g]][z[f]]=null;var k=function(t,i,s,_){var S={};if(M.where.time){for(f=0;w>f;f++)S[z[f]]={};for(g=0;g<i.length;g++)for(m=i[g],f=0;w>f;f++)if(p=z[f],h=r[p]?r[p].interpolation:null,d=r[p]?r[p].use:"indicator",x[m]&&x[m][t]&&(x[m][t][0][p]||0===x[m][t][0][p]))S[p][m]=x[m][t][0][p];else{if(l=y[m][p],null===l){var E=Object.keys(x[m]);l=new Array(E.length),o=0;for(var T=0,L=E.length;L>T;T++)c=x[m][E[T]],(c[0][p]||0===c[0][p])&&(l[o++]=c[0]);l.length=o,0===o?y[m][p]=[]:y[m][p]=l}l&&l.length>0&&(u=null,S[p][m]=Jt(l,d,p,u,b,t,h))}}else{var O=a._collection[s].data;for(f=0;w>f;f++)S[z[f]]={};for(var A=0;A<O.length;A++){var P=O[A];for(f=0;w>f;f++)S[z[f]][P[v]]=P[z[f]]}}a._collection[s].frames[e][t]=S,"function"==typeof _&&_(t);var D=a._collectionPromises[s][e].queue.getNext();D?Ut(function(){k(D.frameName,i,s,D.callback)}):n(a._collection[s].frames[e])},S=a._collectionPromises[t][e].queue.getNext();S&&k(S.frameName,_,t,S.callback)})},_getNested:function(t,e){for(var i=d3.nest(),a=0;a<e.length;a++)i=i.key(function(t){return function(e){return e[t]}}(e[a]));return Gt(i.entries(this._collection[t].data))},_getUnique:function(t,e){var i,a=this._collection[t].data;if(W(e)){var n=a.map(function(t){return dt(t,e)});i=gt(n,function(t){return JSON.stringify(t)})}else{var n=a.map(function(t){return t[e]});i=gt(n)}return i},_getValid:function(t,e){return this._collection[t].data.filter(function(t){return t[e]||0===t[e]})},_getLimits:function(t,e){for(var i,a,n=this._collection[t].data,s=n.reduce(function(t,i){var a=G(i[e])?i[e]:parseFloat(i[e]);return isNaN(a)||t.push(a),t},[]),r={},l=0;l<s.length;l+=1){var o=s[l];("undefined"==typeof i||i>o)&&(i=o),("undefined"==typeof a||o>a)&&(a=o)}return r.min=i||0,r.max=a||100,r},isCached:function(t,e,i){var a=Qt([t,e,i]);return-1!==Object.keys(this._collection).indexOf(a)?a:!1}}),me=!1,ge=[],pe={},fe=he.extend({source:"",type:"default",init:function(t,e){this.source=t,e&&(this.type=e)}}),ve=fe.extend("change",{type:"change",init:function(t){this._super(t)}}),be=he.extend({init:function(){this._id=this._id||U("e"),this._events={},this._freeze=!1,this._freezer=[],this._freezeExceptions={}},on:function(t,e,i){if(!this.splitEventParameters(t,e,i,this.on)){var a=this.traversePath(e);a&&(a._events[t]=a._events[t]||[],"function"==typeof i?a._events[t].push(i):kt("Can't bind event '"+t+"'. It must be a function."))}},off:function(t,e,i){if(0==arguments.length)return void(this._events={});if(!this.splitEventparameters(t,e,i,this.off)){var a=this.traversePath(e);if(a&&this._events.hasOwnProperty(t)){if("undefined"==typeof i)return void(this._events[t]=[]);var n=this._events[t].indexOf(i);n>-1?array.splice(n,1):kt("Could not unbind function "+i.name+". Function not in bound function list.")}}},splitEventParameters:function(t,e,i,a){var n;if(W(t)){for(n=0;n<t.length;n+=1)a.call(this,t[n],i);return!0}if(Q(t)){for(n in t)a.call(this,n,t[n]);return!0}if("function"==typeof e){if(i=e,-1!==t.indexOf(":")){var s=t.split(":");t=s[0],e=s[1]}else e=void 0;return a.call(this,t,e,i),!0}if(W(e)){for(n=0;n<e.length;n+=1)a.call(this,t,e[n],i);return!0}if(i&&W(i)){for(n=0;n<i.length;n+=1)a.call(this,t,e,i[n]);return!0}return!1},traversePath:function(t){if("undefined"==typeof t||W(t)&&0==t.length)return this;if("string"==typeof t&&(t=t.split(".")),!W(t))return Tt("Path is wrong type. Path should be a string or array but is "+typeof t+"."),null;var e=t.shift();return void 0!==this[e]?this.getModelObject(e).traversePath(t):void kt("Can't find child \""+e+'" of the model '+this._name+".")},trigger:function(t,e){var i,a;if(W(t))for(i=0,a=t.length;a>i;i+=1)this.trigger(t[i],e);else{var n;if(t instanceof fe)n=t;else{var s=fe.get(t,!0);n=s?new s(this):new fe(this,t)}if(this._events.hasOwnProperty(n.type)){var r=this;lt(this._events[n.type],function(t){var i=function(){var i="Vizabi Event: "+n.type;wt(i),t.apply(r,[n,e])};r._freeze||me?me&&pe.hasOwnProperty(name)||!me&&r._freeze&&r._freezeExceptions.hasOwnProperty(name)?i():(r._freezer.push(i),me&&!ge[r._id]&&(r.freeze(),ge[r._id]=r)):i()})}}},freeze:function(t){if(this._freeze=!0,t){W(t)||(t=[t]);for(var e=0;e<t.length;e+=1)this._freezeExceptions[t[e]]=!0}},unfreeze:function(){for(this._freeze=!1,this._freezeExceptions={};this._freezer.length;){var t=this._freezer.shift();t()}},clearFrozen:function(){this._freeze=!1,this._freezeExceptions={},this._freezer=[]}});be.freezeAll=g,be.unfreezeAll=p;var ye=he.extend({init:function(){this.intervals={}},setInterval:function(t,e,i){this.clearInterval(t),this.intervals[t]=setInterval(e,i)},clearInterval:function(t){return t?clearInterval(this.intervals[t]):this.clearAllIntervals()},clearAllIntervals:function(){for(var t in this.intervals)this.clearInterval(t)}}),xe=new ue,_e=be.extend({_name:"",_parent:null,_persistent:!0,init:function(t,e,i,a){Object.defineProperty(this,"value",{get:this.get,set:this.set}),Object.defineProperty(this,"persistent",{get:function(){return this._persistent}}),this._super(),this._name=t,this._parent=i,this.value=e,this.on(a)},get:function(t){return t&&!this._persistent?this._persistentVal:this._val},set:function(t,e,i){(e||this._val!==t&&JSON.stringify(this._val)!==JSON.stringify(t))&&(i="undefined"!=typeof i?i:!0,i&&(this._persistentVal=t),this._val=t,this._persistent=i,this.trigger(new ve(this),this._name))},setTreeFreezer:function(t){t?this.freeze():this.unfreeze()}}),Me=be.extend({init:function(t,e,i,a){this._type=this._type||"model",this._id=this._id||U("m"),this._data={},this._parent=i,this._name=t,this._ready=!1,this._readyOnce=!1,this._loadedOnce=!1,this._loading=[],this._intervals=y(this),this._deps={parent:[],children:[]},this._space={},this._spaceDims={},this._dataId=!1,this._limits={},this._super(),e&&this.set(e),a&&this.on(a)},get:function(t){return t?f(this._data[t])?this._data[t]:this._data[t].value:this._data},set:function(t,e,i,a){var n,s=this._setting,r=!1;tt(t)?(n=t,a=i,i=e):(n={})[t]=e,this._setting=!0,this._freeze||(r=!0,this.setTreeFreezer(!0));var l=!1;for(var o in n){e=n[o];var c=tt(e)&&this._data[o]instanceof Me,h=!tt(e)&&this._data[o]instanceof _e;this._data[o]&&(c||h)?this._data[o].set(e,i,a):(this._data[o]=b(o,e,this),l=!0)}l&&v(this),this.validate&&!s&&this.validate(),s&&!i||(this._setting=!1,this.isHook()||this.setReady()),r&&this.setTreeFreezer(!1)},setTreeFreezer:function(t){lt(this._data,function(e){e.setTreeFreezer(t)}),t?this.freeze():this.unfreeze()},getType:function(){return this._type},getSubmodels:function(t,e){var i=t?{}:[],e=e||function(){return!0};return lt(this._data,function(a,n){a&&"undefined"!=typeof a._id&&f(a)&&e(a)&&(t?i[n]=a:i.push(a))}),i},getPlainObject:function(t){var e={};return lt(this._data,function(i,a){i instanceof Me?e[a]=i.getPlainObject(t):e[a]=i.get(t)}),e},getModelObject:function(t){return t?this._data[t]:this},clear:function(){var t=this.getSubmodels();for(var e in t)t[e].clear();this._spaceDims={},this.setReady(!1),this.off(),this._intervals.clearAllIntervals(),this._data={}},validate:function(){},isLoading:function(t){if(this.isHook()&&(!this._loadedOnce||this._loadCall))return!0;if(t)return-1!==this._loading.indexOf(t);if(this._loading.length>0)return!0;var e,i=this.getSubmodels();for(e=0;e<i.length;e+=1)if(i[e].isLoading())return!0;for(e=0;e<this._deps.children.length;e+=1){var a=this._deps.children[e];if(a.isLoading()||!a._ready)return!0}return!1},setLoading:function(t){this.isLoading()||this.trigger("load_start"),this._loading.push(t)},setLoadingDone:function(t){this._loading=mt(this._loading,t),this.setReady()},setReady:function(t){if(t===!1)return this._ready=!1,void(this._parent&&this._parent.setReady&&this._parent.setReady(!1));var e=this._ready;this._ready=!this.isLoading()&&!this._setting&&!this._loadCall,this._ready&&e!==this._ready&&(this._readyOnce||(this._readyOnce=!0,this.trigger("readyOnce")),this.trigger("ready"))},load:function(t){t=t||{};var e=t.splashScreen||!1,i=this,a=this._dataModel,n=this._languageModel,r=this.getQuery(e),l=new s,o=[];if(this._loadCall=!0,this.isHook()&&a&&r){this.trigger("hook_change");var c=a.getPlainObject();c.parsers=this._getAllParsers();var h=n?n.id:"en",d=new s,u={load_start:function(){i.setLoading("_hook_data"),be.freezeAll(["load_start","resize","dom_ready"])}};wt("Vizabi Model: Loading Data: "+i._id),xe.load(r,h,c,u).then(function(t){i._dataId=t,wt("Vizabi Model: Data loaded: "+i._id),i.afterLoad(),d.resolve()},function(t){kt("Problem with query: ",JSON.stringify(r)),d.reject(t)}),o.push(d)}lt(this.getSubmodels(!0),function(e,i){o.push(e.load(t))});var m=o.length?s.all(o):new s.resolve;return m.then(function(){i.validate&&i.validate(),wt("Vizabi Model: Model loaded: "+i._id),i._loadedOnce=!0,i._loadCall=!1,l.resolve(),Ut(function(){i.setReady()})},function(){i.trigger("load_error"),l.reject()}),l},afterPreload:function(){var t=this.getSubmodels();lt(t,function(t){t.afterPreload()})},afterLoad:function(){be.unfreezeAll(),this.setLoadingDone("_hook_data")},resetDeps:function(){this._deps.children=[]},addDep:function(t){this._deps.children.push(t),t._deps.parent.push(this)},getQuery:function(t){var e,i,a,n,s;if(!this.isHook())return!0;if(Object.keys(this._space).length<1)return Tt("Error:",this._id,"can't find the space"),!0;var r="property"===this.use,l=r?{exceptType:"time"}:{};return e=this._getAllDimensions(l),"constant"!==this.use&&(e=e.concat([this.which])),a=gt(e),i=this._getAllFilters(l,t),n=this._getGrouping(),s=r?null:this._space.time.dim,{select:a,where:i,grouping:n,orderBy:s}},isHook:function(){return!!this.use},setHooks:function(){if(this.isHook())this.hookModel();else{var t=this.getSubmodels();lt(t,function(t){t.setHooks()})}},hookModel:function(){var t=this,e=M(this);this._dataModel=x(this,"data"),this._languageModel=x(this,"language"),lt(e,function(e){t._space[e]=x(t,e),t._space[e].show&&t._space[e].on("change:show",function(e){"size"===t._type&&t.which===t.which_1&&(t.which_1=""),Ut(function(){t.load().then(function(){},function(t){kt(t)})})})}),this.on("change:which",function(e){t.load()}),this.on("hook_change",function(){t._spaceDims={},t.setReady(!1)})},getSubhooks:function(t){return this.getSubmodels(t,function(t){return t.isHook()})},getHookWhich:function(t){var e=[];return this.use&&this.use===t&&e.push(this.which),lt(this.getSubmodels(),function(i){e=gt(e.concat(i.getHookWhich(t)))}),e},getIndicators:function(){return this.getHookWhich("indicator")},getProperties:function(){return this.getHookWhich("property")},getDimension:function(){return this.dim||!1},getDimensionOrWhich:function(){return this.dim||("constant"!=this.use?this.which:!1)},getFilter:function(){return{}},mapValue:function(t){return t},getNestedItems:function(t){return t?xe.get(this._dataId,"nested",t):kt("No keys provided to getNestedItems(<keys>)")},getParser:function(){return null},getDataManager:function(){return xe},getLimits:function(t){return xe.get(this._dataId,"limits",t)},_getAllDimensions:function(t){var e=JSON.stringify(t);if(e in this._spaceDims)return this._spaceDims[e];t=t||{};var i,a=[],n=this._space;if(!this.isHook()&&this.space){n=[];var s=this;lt(this.space,function(t){n.push(x(s,t))})}return lt(n,function(e){return t.exceptType&&e.getType()===t.exceptType?!0:t.onlyType&&e.getType()!==t.onlyType?!0:void((i=e.getDimension())&&a.push(i))}),this._spaceDims[e]=a,a},_getFirstDimension:function(t){t=t||{};var e=this._space;if(!this.isHook()&&this.space){e=[];var i=this;lt(this.space,function(t){e.push(x(i,t))})}var a=!1;return lt(e,function(e){return t.exceptType&&e.getType()!==t.exceptType?(a=e.getDimension(),!1):t.type&&e.getType()===t.type?(a=e.getDimension(),!1):t.exceptType||t.type?void 0:(a=e.getDimension(),!1)}),a},_getAllFilters:function(t,e){t=t||{};var i={};return lt(this._space,function(a){return t.exceptType&&a.getType()===t.exceptType?!0:t.onlyType&&a.getType()!==t.onlyType?!0:void(i=ot(i,a.getFilter(e)))}),i},_getGrouping:function(){var t={};return lt(this._space,function(e){t[e.dim]=e.grouping||void 0}),t},_getAllParsers:function(){function t(t){var i=t.getParser(),a=t.getDimensionOrWhich();i&&a&&(e[a]=i)}var e={};return lt(this._space,function(e){t(e)}),t(this),e},getDefaults:function(){if(this._defaults)return this._defaults;var t={};return lt(this.getSubmodels(!0),function(e,i){t[i]=e.getDefaults()}),t}});/*!
       * VIZABI Time Model
       */
Date.prototype.utc=Date.prototype.toUTCString;var ze={year:d3.time.format.utc("%Y"),month:d3.time.format.utc("%Y%m"),day:d3.time.format.utc("%Y%m%d"),hour:d3.time.format.utc("%Y-%m-%d %H"),minute:d3.time.format.utc("%Y-%m-%d %H:%M"),second:d3.time.format.utc("%Y-%m-%d %H:%M:%S"),week:z(),quarter:w()},we=Me.extend({_defaults:{dim:"time",value:"2015",start:"1800",end:"2015",playable:!0,playing:!1,loop:!1,round:"round",delay:300,delayThresholdX2:300,delayThresholdX4:150,unit:"year",step:1,record:!1},init:function(t,e,i,a){this._type="time";var n=ut(this._defaults);e=ot(n,e),this._super(t,e,i,a);var s=this;this.timeFormat=ze[this.unit],this.dragging=!1,this.postponePause=!1,this.allSteps={},this.delayAnimations=this.delay,this.on({"change:playing":function(){s.playing===!0?s._startPlaying():s._stopPlaying()},"change:unit":function(){s.timeFormat=ze[s.unit]}})},_formatToDates:function(){for(var t=["value","start","end"],e=0;e<t.length;e++){var i=t[e];if(!G(this[i])){var a=this.parseToUnit(this[i].toString(),this.unit);this.set(i,a)}}},format:function(t,e){return e=e||this.unit,ze[e]?ze[e](t):ze.year(t)},parseToUnit:function(t,e){return e=e||this.unit,ze[e]?ze[e].parse(t):null},parse:function(t){for(var e=Object.keys(ze),i=0;i<e.length;i++){var a=ze[e[i]].parse(t);if(date)return{unit:e[i],time:a}}return null},validate:function(){ze[this.unit]||(kt(this.unit+' is not a valid time unit, using "year" instead.'),this.unit="year"),this.step<1&&(this.step=1),G(this.start)&&G(this.end)&&G(this.value)||this._formatToDates(),this.end<this.start&&(this.end=new Date(this.start)),this.value<this.start?this.value=new Date(this.start):this.value>this.end&&(this.value=new Date(this.end)),this.playable===!1&&this.playing===!0&&(this.playing=!1)},play:function(){this._startPlaying()},pause:function(t){t?this.postponePause=!0:this.playing=!1},dragStart:function(){this.dragging=!0},dragStop:function(){this.dragging=!1},getRange:function(){var t=this.getIntervalAndStep();return d3.time[t.interval].utc.range(this.start,this.end,t.step)},getIntervalAndStep:function(){var t,e;switch(this.unit){case"week":t="monday",e=this.step;break;case"quarter":t="month",e=3*this.step;break;default:t=this.unit,e=this.step}return{interval:t,step:e}},getFilter:function(t){var e=this.parseToUnit(this._defaults.start,this.unit),i=this.parseToUnit(this._defaults.end,this.unit),a=this.timeFormat(e||this.start),n=this.timeFormat(i||this.end),s=this.timeFormat(this.value),r=this.getDimension(),l={};return l[r]=t?[[s]]:[[a,n]],l},getParser:function(){return this.timeFormat.parse},getAllSteps:function(){var t=""+this.start+this.end+this.step;if(this.allSteps[t])return this.allSteps[t];this.allSteps[t]=[];for(var e=this.start;e<=this.end;){var i=this.getIntervalAndStep();this.allSteps[t].push(e),e=d3.time[i.interval].utc.offset(e,i.step)}return this.allSteps[t]},snap:function(t){if(this.round){null==t&&(t="value");var e="round";"ceil"===this.round&&(e="ceil"),"floor"===this.round&&(e="floor");var i=this.getIntervalAndStep(),a=d3.time[i.interval].utc[e](this[t]);this.set(t,a,!0)}},_startPlaying:function(){if(this.playable){var t=this;this.value>=this.end&&t.getModelObject("value").set(t.start,null,!1),this.playing=!0,this.playInterval(),this.trigger("play")}},playInterval:function(){if(this.playing){var t=this;this.delayAnimations=this.delay,this.delay<this.delayThresholdX2&&(this.delayAnimations*=2),this.delay<this.delayThresholdX4&&(this.delayAnimations*=2),this._intervals.setInterval("playInterval_"+this._id,function(){if(t.value>=t.end)return void(t.loop?t.getModelObject("value").set(t.start,null,!1):t.playing=!1);if(t._intervals.clearInterval("playInterval_"+t._id),t.postponePause||!t.playing)t.playing=!1,t.postponePause=!1,t.getModelObject("value").set(t.value,!0,!0);else{var e=t.getIntervalAndStep();t.delay<t.delayThresholdX2&&(e.step*=2),t.delay<t.delayThresholdX4&&(e.step*=2);var i=d3.time[e.interval].utc.offset(t.value,e.step);i>=t.end?t.getModelObject("value").set(t.end,null,!0):t.getModelObject("value").set(i,null,!1),t.playInterval()}},this.delayAnimations)}},_stopPlaying:function(){this._intervals.clearInterval("playInterval_"+this._id),this.trigger("pause")}}),ke=Me.extend({tickFormatter:function(t,e){if(G(t))return this._space.time.timeFormat(t);if(Z(t))return t;var i="f",a=0;Math.abs(t)<1&&(a=1,i="r");var n="";if(e)return d3.format("."+a+i)(t);switch(Math.floor(Math.log(Math.abs(t))/Math.LN10)){case-13:t=1e12*t,n="p";break;case-10:t=1e9*t,n="n";break;case-7:t=1e6*t,n="µ";break;case-6:t=1e6*t,n="µ";break;case-5:t=1e6*t,n="µ";break;case-4:break;case-3:break;case-2:break;case-1:break;case 0:break;case 1:break;case 2:break;case 3:break;case 4:break;case 5:t/=1e3,n="k";break;case 6:t/=1e6,n="M",a=1;break;case 7:t/=1e6,n="M";break;case 8:t/=1e6,n="M";break;case 9:t/=1e9,n="B",a=1;break;case 10:t/=1e9,n="B";break;case 11:t/=1e9,n="B";break;case 12:t/=1e12,n="T",a=1;break;default:return d3.format("."+a+"s")(t).replace("G","B")}return(d3.format("."+a+i)(t)+n).replace("G","B")},getScale:function(t){return this.scale||this.buildScale(t),this.scale},buildScale:function(){if(this.isHook()){var t,e=this.scaleType||"linear";switch(this.use){case"indicator":var i=this.getLimits(this.which);t=[i.min,i.max];break;case"property":t=this.getUnique(this.which);break;default:t=[this.which]}this.scale="time"===e?d3.time.scale.utc().domain(t):d3.scale[e]().domain(t)}},gerLimitsPerFrame:function(){if("property"===this.use)return kt("getMaxMinMean: strange that you ask min max mean of a property");if(!this.isHook)return kt("getMaxMinMean: only works for hooks");var t={},e=null,i=this._parent._parent.time.getAllSteps();if("constant"===this.use)i.forEach(function(i){e=this.which,t[i]={min:e,max:e}});else if("time"===this.which)i.forEach(function(i){e=new Date(i),t[i]={min:e,max:e}});else{var a={framesArray:i,which:this.which};t=this.getDataManager().get(this._dataId,"limitsPerFrame",a)}return t},getUnique:function(t){return this.isHook()?(t||(t=this._getFirstDimension({type:"time"})),this.getDataManager().get(this._dataId,"unique",t)):void 0},getValidItems:function(){return this.getDataManager().get(this._dataId,"valid",this.which)},getKeys:function(t){if(!this._dataId)return kt("hook:getKeys() -- returning nothing since no data is loaded");var e=this._getAllDimensions({exceptType:"time"}),i=this._getAllDimensions({onlyType:"time"});return this.getUnique(e).map(function(e){return lt(i,function(i){t&&t[i]&&(e[i]=t[i])}),e})},getMetadata:function(){return"constant"!==this.use?this.getDataManager().getMetadata(this.which):{}}}),Se={ALL:"all",_default:"none"},Ee=ke.extend({_defaults:{use:null,which:null,merge:!1},init:function(t,e,i,a){this._type="model";var n=ut(this._defaults);e=ot(n,e),this._super(t,e,i,a)},validate:function(){this.scale&&(this.scale=null),"indicator"===this.use&&(kt("stack model: use must not be 'indicator'. Resetting use to 'constant' and which to '"+Se._default),this.use="constant",this.which=Se._default),"constant"===this.use&&-1==qt(Se).indexOf(this.which)&&(kt("stack model: the requested value '"+this.which+"' is not allowed. resetting to '"+Se._default),this.which==Se._default)},getPalettes:function(){return Se},buildScale:function(){}}),Te={indicator:["linear","log","genericLog","time","pow"],property:["ordinal"],constant:["ordinal"]},Le=ke.extend({_defaults:{use:null,which:null,domainMin:null,domainMax:null,zoomedMin:null,zoomedMax:null},_type:"axis",init:function(t,e,i,a){var n=ut(this._defaults);e=ot(n,e),this._super(t,e,i,a)},validate:function(){-1===Te[this.use].indexOf(this.scaleType)&&(this.scaleType=Te[this.use][0]),this.which_1==this.which&&this.scaleType_1==this.scaleType||(this.scale=null),this.which_1=this.which,this.scaleType_1=this.scaleType,this.scale&&this._readyOnce&&"indicator"===this.use&&((null==this.domainMin||this.domainMin<=0&&"log"===this.scaleType)&&(this.domainMin=this.scale.domain()[0]),(null==this.domainMax||this.domainMax<=0&&"log"===this.scaleType)&&(this.domainMax=this.scale.domain()[1]),(null==this.zoomedMin||this.zoomedMin<=0&&"log"===this.scaleType)&&(this.zoomedMin=this.scale.domain()[0]),(null==this.zoomedMax||this.zoomedMax<=0&&"log"===this.scaleType)&&(this.zoomedMax=this.scale.domain()[1]),this.scale.domain([this.domainMin,this.domainMax]))},buildScale:function(t){var e;if("time"==this.scaleType){var i=this.getLimits(this.which);return void(this.scale=d3.time.scale.utc().domain([i.min,i.max]))}switch(this.use){case"indicator":var i=this.getLimits(this.which);e=[i.min,i.max],e=this.getMetadata().domain?this.getMetadata().domain:e,e=null!=this.domainMin&&null!=this.domainMax?[+this.domainMin,+this.domainMax]:e;break;case"property":e=this.getUnique(this.which);break;case"constant":default:e=[this.which]}var a=d3.min(e)<=0&&d3.max(e)>=0&&"log"===this.scaleType?"genericLog":this.scaleType;this.scale=d3.scale[a||"linear"]().domain(e)}}),Oe=Le.extend({_defaults:{use:null,which:null,domainMin:null,domainMax:null,zoomedMin:null,zoomedMax:null,extent:null},_type:"size",buildScale:function(t){this._super(t),"ordinal"!==this.scaleType&&this.scale.clamp(!0)}}),Ae=Me.extend({getTimeLimits:function(t){var e,i,a=this,n=this._parent.time,s=[],r=[],l={};this.cachedTimeLimits||(this.cachedTimeLimits={}),lt(this.getSubhooks(),function(t){if("indicator"===t.use){var o=t.getMetadata().availability,c=a.cachedTimeLimits[t._dataId+t.which];c?(e=c.min,i=c.max):o?(e=n.timeFormat.parse(o[0]+""),i=n.timeFormat.parse(o[1]+"")):(l=t.getValidItems().map(function(t){return t[n.getDimension()]}),e=d3.min(l),i=d3.max(l)),a.cachedTimeLimits[t._dataId+t.which]={min:e,max:i},s.push(e),r.push(i)}});var o=d3.max(s),c=d3.min(r);return o>c&&(o=d3.min(s),c=d3.max(r),kt("getTimeLimits(): Availability of the indicator's data has no intersection. I give up and just return some valid time range where you'll find no data points. Enjoy!")),{min:o,max:c}},getIntersectionOfKeys:function(){var t=this,e=[];return lt(this._dataCube,function(i,a){if("constant"!==i.use){var n=t.getDataManager().get(i._dataId,"nested",["geo","time"]),s=Object.keys(n);e=0==e.length?s:e.filter(function(t){return s.indexOf(t)>-1})}}),e},getKeys:function(t){var e=this.getSubhooks(),i=[];return e.length>1&&lt(e,function(t){return i=t.getKeys(),!1}),i},getFrame:function(t,e){var i=this;this.cachedFrames||(this.cachedFrames={}),this._dataCube=this._dataCube||this.getSubhooks(!0);var a=this._parent.time.getAllSteps(),n=a[0]+" - "+a[a.length-1];if(lt(this._dataCube,function(t,e){n=n+", "+e+":"+t.which+":"+t._dataId}),t&&i.cachedFrames[n]&&i.cachedFrames[n][t])return e(i.cachedFrames[n][t],t);if(t&&a.length>1){var s=d3.bisectLeft(a,t);a[s]||kt("The requested frame is out of range"),a[s].toString()!=t.toString()&&this._interpolateBetweenFrames(t,s,a,function(i){return e(i,t)})}i.getFrames(t).then(function(){return!t&&i.cachedFrames[n]?e(i.cachedFrames[n],t):i.cachedFrames[n][t]?e(i.cachedFrames[n][t],t):(kt("marker.js getFrame: Data is not available for frame: "+t),e(null,t))})},_interpolateBetweenFrames:function(t,e,i,a){var n=this;if(0==e)this.getFrame(i[e],function(t){return a(t)});else{var s=i[e-1],r=i[e];this.getFrame(s,function(e){n.getFrame(r,function(i){var n=(t-s)/(r-s),l={};lt(e,function(t,e){l[e]={},lt(t,function(t,a){var s=i[e][a];$(t)?l[e][a]=null==t||null==s?null:t+(s-t)*n:l[e][a]=t})}),a(l)})})}},getFrames:function(t){var e=this;this.frameQueues||(this.frameQueues={}),this.partialResult||(this.partialResult={});var i=this._parent.time.getAllSteps(),a=i[0]+" - "+i[i.length-1];return lt(this._dataCube,function(t,e){a=a+", "+e+":"+t.which+":"+t._dataId}),(!this.frameQueues[a]||!this.frameQueues[a]instanceof s)&&(this.frameQueues[a]=new s(function(t,n){e.partialResult[a]={},i.forEach(function(t){e.partialResult[a][t]={}});var r=e.getIntersectionOfKeys(),l=[];if(lt(e._dataCube,function(t,n){"constant"===t.use?i.forEach(function(i){e.partialResult[a][i][n]={},r.forEach(function(s){e.partialResult[a][i][n][s]=t.which})}):"geo"===t.which?i.forEach(function(t){e.partialResult[a][t][n]={},r.forEach(function(i){e.partialResult[a][t][n][i]=i})}):"time"===t.which?i.forEach(function(t){e.partialResult[a][t][n]={},r.forEach(function(i){e.partialResult[a][t][n][i]=new Date(t)})}):l.push({hook:t,name:n})}),l.length>0){for(var o=[],c=0;c<l.length;c++)!function(t){var n=l[t];o.push(new s(function(t,s){e.getDataManager().getFrames(n.hook._dataId,i).then(function(i){lt(i,function(t,i){e.partialResult[a][i][n.name]=t[n.hook.which]}),t()})}))}(c);s.all(o).then(function(){e.cachedFrames[a]=e.partialResult[a],t()})}else e.cachedFrames[a]=e.partialResult[a],t()})),new s(function(n,r){if(i.length<2||!t)e.frameQueues[a].then(function(){n()});else{var l=[];lt(e._dataCube,function(n,r){"constant"!==n.use&&"geo"!==n.which&&"time"!==n.which&&!function(n,r){l.push(new s(function(s,l){e.getDataManager().getFrame(n._dataId,i,t).then(function(i){e.partialResult[a][t][r]=i[t][n.which],s()})}))}(n,r)}),l.length>0&&s.all(l).then(function(){e.cachedFrames[a]||(e.cachedFrames[a]={}),e.cachedFrames[a][t]=e.partialResult[a][t],n()})}})},getValues:function(t,e,i){var a=this;if(this.isHook())return[];var n,s,r,l,o,c,h,d,o;this._dataCube=this._dataCube||this.getSubhooks(!0),t=dt(t,this._getAllDimensions()),n=this._getFirstDimension({type:"time"}),s=new Date(t[n]),t=dt(t,null,n);var u={},m=Object.keys(t),g=m.map(function(e){return t[e]});return m.length?lt(this._dataCube,function(e,p){if(c=e.use,h=e.which,"property"!==e.use&&(l=l||d3.bisectLeft(e.getUnique(n),s)),o=e.getMetadata().interpolation,r=a.getDataManager().get(e._dataId,"nested",m),lt(g,function(t){r=r[t]}),d=Jt(r,c,h,l,n,s,o),u[p]=e.mapValue(d),i){var f=vt(r,t).filter(function(t){return t[n]<=s}).map(function(t){return e.mapValue(t[h])}).concat(u[p]);u[p]=f}}):lt(this._dataCube,function(m,g){r=a.getDataManager().get(m._dataId,"nested",e),u[g]={},c=m.use,h=m.which,"property"!==m.use&&(l="undefined"==typeof l?d3.bisectLeft(m.getUnique(n),s):l),o=m.getMetadata().interpolation,lt(r,function(e,a){if(l=d3.bisectLeft(e.map(function(t){return t.time}),s),d=Jt(e,c,h,l,n,s,o),u[g][a]=m.mapValue(d),i){var r=vt(e,t).filter(function(t){return t[n]<=s}).map(function(t){return m.mapValue(t[h])}).concat(u[g][a]);u[g][a]=r}})}),u},getMetadata:function(){return this.getDataManager().getMetadata()},getIndicatorsTree:function(){return this.getDataManager().getIndicatorsTree()}}),Pe=Me.extend({_defaults:{id:"en",strings:{}},init:function(t,e,i,a){this._type="language";var n=ut(this._defaults);e=ot(n,e),this._super(t,e,i,a)},getUIString:function(t,e,i){return e=e||this.id,i=i||this.strings,i&&i.hasOwnProperty(e)&&i[e].hasOwnProperty(t)?i[e][t]:t},getTFunction:function(){var t=this.id,e=this.strings,i=this;return function(a){return i.getUIString(a,t,e)}}}),De=ke.extend({_defaults:{},init:function(t,e,i,a){this._type="label";var n=ut(this._defaults);e=ot(n,e),this._super(t,e,i,a)}}),Ce=ke.extend({_defaults:{use:null,which:null,merge:!1,manualSorting:null},init:function(t,e,i,a){this._type="model";var n=ut(this._defaults);e=ot(n,e),this._super(t,e,i,a)},validate:function(){this.scale&&(this.scale=null),"property"!=this.use&&(kt("group model: use must be 'property'. Resetting..."),this.use="property")},buildScale:function(){}}),Ie=Me.extend({_defaults:{show:{},select:[],highlight:[],opacitySelectDim:.3,opacityRegular:1},init:function(t,e,i,a){this._type="entities";var n=ut(this._defaults);e=ot(n,e),this._visible=[],this._multiple=!0,this._super(t,e,i,a)},validate:function(t){var e=this.getDimension(),i=this._visible.map(function(t){return t[e]});i.length&&(this.select=this.select.filter(function(t){return-1!==i.indexOf(t[e])}),this.setHighlight(this.highlight.filter(function(t){return-1!==i.indexOf(t[e])})))},setVisible:function(t){this._visible=t},getVisible:function(t){return this._visible},selectMultiple:function(t){this._multiple=t},getDimension:function(){return this.dim},getFilter:function(){return this.show.getPlainObject()},getSelected:function(){var t=this.getDimension();return this.select.map(function(e){return e[t]})},selectEntity:function(t,e,i){var a=this.getDimension(),n=t[a];if(this.isSelected(t))this.select=this.select.filter(function(t){return t[a]!==n});else{var s={};s[a]=n,e&&i&&(s.trailStartTime=i(t[e])),this.select=this._multiple?this.select.concat(s):[s]}},selectAll:function(t,e){if(this._multiple){var i,a=this.getDimension(),n=this._visible.map(function(n){return i={},i[a]=n[a],t&&e&&(i.trailStartTime=e(n[t])),i});this.select=n}},showEntity:function(t){this.clearSelected();var e=this.getDimension(),i=t[e],a=this.show[e];a&&"*"!==a[0]||(a=[]),a=a.concat([]),a=this.isShown(t)?a.filter(function(t){return t!==i}):a.concat(i),0===a.length&&(a=["*"]),this.show[e]=a.concat([])},setLabelOffset:function(t,e){if(0!==e[0]||1!==e[1]){var i=this.getDimension(),a=t[i];ft(this.select,function(t){return t[i]===a}).labelOffset=[Math.round(1e3*e[0])/1e3,Math.round(1e3*e[1])/1e3],this.set("select",this.select,!0)}},isSelected:function(t){var e=this.getDimension(),i=t[this.getDimension()];return-1!==this.select.map(function(t){return t[e]}).indexOf(i)},isShown:function(t){var e=this.getDimension();return this.show[e]&&-1!==this.show[e].indexOf(t[e])},clearSelected:function(){this.select=[]},clearShow:function(){var t=this.getDimension();this.show[t]=["*"]},setHighlight:function(t){W(t)||this.setHighlight([].concat(t)),this.getModelObject("highlight").set(t,!1,!1)},highlightEntity:function(t,e,i){var a=this.getDimension(),n=t[a];if(!this.isHighlighted(t)){var s={};s[a]=n,e&&i&&(s.trailStartTime=i(t[e])),this.setHighlight(this.highlight.concat(s))}},unhighlightEntity:function(t){var e=this.getDimension(),i=t[e];this.isHighlighted(t)&&this.setHighlight(this.highlight.filter(function(t){return t[e]!==i}))},isHighlighted:function(t){var e=this.getDimension(),i=t[this.getDimension()],a=this.highlight.map(function(t){return t[e]});return-1!==a.indexOf(i)},clearHighlighted:function(){this.setHighlight([])}}),qe=Me.extend({_defaults:{reader:"csv",splash:!1},init:function(t,e,i,a){this._type="data";var n=ut(this._defaults);e=ot(n,e),this._super(t,e,i,a)}}),Re={_continuous:{0:"#F77481",1:"#E1CE00",2:"#B4DE79"},_discrete:{0:"#bcfa83",1:"#4cd843",2:"#ff8684",3:"#e83739",4:"#ffb04b",5:"#ff7f00",6:"#f599f5",7:"#c027d4",8:"#f4f459",9:"#d66425",10:"#7fb5ed",11:"#0ab8d8"},_default:{_default:"#93daec"}},Be=ke.extend({_defaults:{use:null,palette:{},scaleType:null,which:null},init:function(t,e,i,a){this._type="color";var n=ut(this._defaults);e=ot(n,e),this._original_palette=e.palette,this._super(t,e,i,a),this._firstLoad=!0,this._hasDefaultColor=!1},getColorShade:function(t){var e=this.getPalette();if(!t)return kt("getColorShade() is missing arguments");if(t.colorID&&e[t.colorID]||(t.colorID="_default"),!W(e[t.colorID]))return e[t.colorID];var i=this.getMetadata().color,a=t.shadeID&&i&&i.shades&&i.shades[t.shadeID]?i.shades[t.shadeID]:0;return e[t.colorID][a]},afterPreload:function(){this._super()},isUserSelectable:function(){var t=this.getMetadata().color;return null==t||null==t.selectable||t.selectable},validate:function(){var t=["log","genericLog","linear","time","pow"];(!this.scaleType||"indicator"===this.use&&-1===t.indexOf(this.scaleType))&&(this.scaleType="linear"),"indicator"!==this.use&&"ordinal"!==this.scaleType&&(this.scaleType="ordinal"),this._firstLoad!==!1||this.which_1==this.which&&this.scaleType_1==this.scaleType||(this.palette&&(this.palette._data={}),this.scale=null),this.which_1=this.which,this.scaleType_1=this.scaleType,this._firstLoad=!1},setColor:function(t,e){var i=this.getPalette();i[e]=t,this.scale.range(qt(i)),this.palette[e]=t},mapValue:function(t){return null!=this.scale&&"property"==this.use&&this._hasDefaultColor&&-1==this.scale.domain().indexOf(t)&&(t="_default"),this._super(t)},getDefaultPalette:function(){var t,e=this.getMetadata().color;return t=e&&e.palette?dt(e.palette):Re[this.which]?dt(Re[this.which]):"constant"===this.use&&/^#([0-9a-f]{3}|[0-9a-f]{6})$/.test(this.which)?{_default:this.which}:dt("indicator"===this.use?Re._continuous:"property"===this.use?Re._discrete:Re._default)},getPalette:function(){return this.palette&&0!==Object.keys(this.palette._data).length||this.palette.set(this.getDefaultPalette(),!1,!1),this.palette.getPlainObject()},buildScale:function(){var t=this,e=t.getPalette(),i=Object.keys(e),a=qt(e);if(this._hasDefaultColor=i.indexOf("_default")>-1,"time"==this.scaleType){var n=this._parent._parent.time,s=n.beyondSplash?{min:n.beyondSplash.start,max:n.beyondSplash.end}:{min:n.start,max:n.end},r=(s.max.valueOf()-s.min.valueOf())/(a.length-1);return i=d3.range(s.min.valueOf(),s.max.valueOf(),r).concat(s.max.valueOf()),0===r&&(i.push(i[0]),a=[a[a.length-1]]),void(this.scale=d3.time.scale.utc().domain(i).range(a).interpolate(d3.interpolateRgb))}switch(this.use){case"indicator":var s=this.getLimits(this.which);i=[s.min,s.max],i=this.getMetadata().domain?this.getMetadata().domain:i;var l=i[0],o=i[1],r=(o-l)/(a.length-1);if(i=d3.range(l,o,r).concat(o),i.length>a.length&&i.pop(),i=i.reverse(),"log"==this.scaleType){var c=d3.scale.log().domain([0===l?1:l,o]).range([l,o]);i=i.map(function(t){return c.invert(t)})}return void(this.scale=d3.scale[this.scaleType]().domain(i).range(a).interpolate(d3.interpolateRgb));default:return a=a.map(function(t){return W(t)?t[0]:t}),void(this.scale=d3.scale.ordinal().domain(i).range(a))}}}),Fe={axis:Le,color:Be,data:qe,entities:Ie,group:Ce,hook:ke,label:De,language:Pe,marker:Ae,size:Oe,stack:Ee,time:we},He={axis:Le,color:Be,data:qe,entities:Ie,group:Ce,hook:ke,label:De,language:Pe,marker:Ae,size:Oe,stack:Ee,time:we,"default":Fe},Ne="vzb-loading",je="vzb-loading-first",Ye="vzb-error",Ve={},Xe=be.extend({init:function(t,e){if(this._id=this._id||U("c"),this._ready=!1,this._readyOnce=!1,this.name=this.name||t.name,this.template=this.template||"<div></div>",this.placeholder=this.placeholder||t.placeholder,this.template_data=this.template_data||{name:this.name},this.placeholder&&!K(this.placeholder))try{this.placeholder=e.placeholder.querySelector(this.placeholder)}catch(i){Tt("Error finding placeholder '"+this.placeholder+"' for component '"+this.name+"'")}this.parent=e||this,this.root=this.parent.root||this,this.components=this.components||[],this._components_config=this.components.map(function(t){return dt(t)}),this._frameRate=10,this.model_expects=this.model_expects||[],this.model_binds=this.model_binds||{},this.ui=this.ui||t.ui,this._super();var a=this;this.on({readyOnce:function(){"function"==typeof a.readyOnce&&a.readyOnce()},ready:function(){"function"==typeof a.ready&&a.ready()},domReady:function(){"function"==typeof a.domReady&&a.domReady()},resize:function(){"function"==typeof a.resize&&a.resize()}}),this.triggerResize=Ct(this.triggerResize,100)},preload:function(t){t.resolve()},afterPreload:function(){this.model&&this.model.afterPreload()},render:function(){function t(){At(i.placeholder,Ne),Ot(i.placeholder,Ye),i.setError({type:"data"})}function e(){At(i.placeholder,Ne),At(i.placeholder,je),i.setReady()}var i=this;if(this.loadTemplate(),this.loadComponents(),lt(this.components,function(t){t.render(),i.on("resize",function(){t.trigger("resize")})}),this.isRoot()&&this.model){this.model.on("ready",function(){e()}),this.model.setHooks();var a=this.model&&this.model.data&&this.model.data.splash;k(this).then(function(){var e=i.model.state.time;a?(e.splash=!0,e.beyondSplash=dt(e.getPlainObject(),["start","end"]),i.model.load({splashScreen:!0}).then(function(){Kt(function(){i.model.setLoading("restore_orig_time"),e.start=e.beyondSplash.start,e.end=e.beyondSplash.end,delete e.beyondSplash,i.model.load().then(function(){i.model.setLoadingDone("restore_orig_time"),e.splash=!1,e.trigger("change",e.getPlainObject())})},300)},function(){t()})):i.model.load().then(function(){Kt(function(){e.trigger("change")},300)},function(){t()})})}else this.model&&this.model.isLoading()?this.model.on("ready",function(){e()}):e()},setError:function(t){"function"==typeof this.error&&this.error(t)},setReady:function(t){this._readyOnce||(this.trigger("readyOnce"),this._readyOnce=!0),this._ready=!0,this.trigger("ready")},loadTemplate:function(){var t=this.template,e=this.template_data,i=this,a="";if(this.placeholder){if(e=ot(e,{t:this.getTranslationFunction(!0)}),this.template)try{a=S(t,e)}catch(n){Tt("Templating error for component: '"+this.name+"' - Check if template name is unique and correct. E.g.: 'bubblechart'"),At(this.placeholder,Ne),Ot(this.placeholder,Ye),this.setError({type:"template"})}Ot(this.placeholder,Ne),Ot(this.placeholder,je),this.placeholder.innerHTML=a,this.element=this.placeholder.children[0],this.layout&&(this.layout.setContainer(this.element),this.layout.on("resize",function(){i._ready&&i.triggerResize()})),this.trigger("domReady")}},triggerResize:function(){this.trigger("resize")},getActiveProfile:function(t,e){var i=this.getLayoutProfile(),a=this.getPresentationMode(),n=ut(t[i]);return a&&e[i]&&ct(n,e[i]),n},loadComponents:function(){var t,e,i=this;this.components=[],this.model&&this.model.resetDeps(),lt(this._components_config,function(a){if(!a.component)return void Tt("Error loading component: name not provided");if(e=Z(a.component)?Xe.get(a.component):a.component){t=ot(a,{name:a.component,ui:i._uiMapping(a.placeholder,a.ui)});var n=new e(t,i),s=a.model||[];n.model=i._modelMapping(n.name,s,n.model_expects,n.model_binds),i.components.push(n)}})},isRoot:function(){return this.parent===this},findChildByName:function(t){return ft(this.components,function(e){return e.name===t})},getLayoutProfile:function(){return this.layout?this.layout.currentProfile():this.parent.getLayoutProfile()},getPresentationMode:function(){return this.layout?this.layout.getPresentationMode():this.parent.getPresentationMode()},_uiMapping:function(t,e){if(e)return new Me("ui",e);if(t&&this.ui){t=t.replace(".","");var i=this.ui[t];if(i)return i}return this.ui},_modelMapping:function(t,e,i,a){function n(t){for(var e=t.split("."),i=s.model,a="";e.length;)a=e.shift(),i=i[a];return{name:t,model:i,type:i?i.getType():null}}var s=this,r={};if(W(e)&&W(i)){i.length!==e.length&&(St("DIFFERENCE IN NUMBER OF MODELS EXPECTED AND RECEIVED"),kt("Please, configure the 'model_expects' attribute accordingly in '"+t+"' or check the models passed in '"+s.name+"'.\n\nComponent: '"+s.name+"'\nSubcomponent: '"+t+"'\nNumber of Models Expected: "+i.length+"\nNumber of Models Received: "+e.length),Et()),lt(e,function(a,l){var o,c=n(a);i[l]?(o=i[l].name,!i[l].type||c.type===i[l].type||W(i[l].type)&&-1!==i[l].type.indexOf(c.type)||(St("UNEXPECTED MODEL TYPE: '"+c.type+"' instead of '"+i[l].type+"'"),kt("Please, configure the 'model_expects' attribute accordingly in '"+t+"' or check the models passed in '"+s.name+"'.\n\nComponent: '"+s.name+"'\nSubcomponent: '"+t+"'\nExpected Model: '"+i[l].type+"'\nReceived Model'"+c.type+"'\nModel order: "+l),Et())):(St("UNEXPECTED MODEL: '"+e[l]+"'"),kt("Please, configure the 'model_expects' attribute accordingly in '"+t+"' or check the models passed in '"+s.name+"'.\n\nComponent: '"+s.name+"'\nSubcomponent: '"+t+"'\nNumber of Models Expected: "+i.length+"\nNumber of Models Received: "+e.length),Et(),o=c.name),r[o]=c.model});var l=e.length,o=i.length;return o>l&&(i.splice(0,l),lt(o,function(t){r[t.name]={}})),new Me(t,r,null,a)}},getTranslationFunction:function(t){var e;try{e=this.model.get("language").getTFunction()}catch(i){this.parent&&this.parent!==this&&(e=this.parent.getTranslationFunction())}return e||(e=function(t){return t}),t?this._translatedStringFunction(e):e},_translatedStringFunction:function(t){return function(e){var i=t(e);return'<span data-vzb-translate="'+e+'">'+i+"</span>"}},translateStrings:function(){var t=this.getTranslationFunction(),e=this.placeholder.querySelectorAll("[data-vzb-translate]");0!==e.length&&lt(e,function(e){e&&e.getAttribute&&(e.innerHTML=t(e.getAttribute("data-vzb-translate")))})},isTool:function(){return"t"===this._id[0]},readyOnce:function(){},ready:function(){},resize:function(){},clear:function(){this.freeze(),this.model&&this.model.freeze(),lt(this.components,function(t){t.clear()})}});Xe.isComponent=function(t){return t._id&&("t"===t._id[0]||"c"===t._id[0])};var Ue="vzb-",Ke="presentation",We="vzb-portrait",Qe="vzb-landscape",Ge=be.extend({screen_profiles:{small:{min_width:0,min_height:0},medium:{min_width:600,min_height:400},large:{min_width:900,min_height:600}},init:function(t){this.ui=t||{},this._container=null,this._curr_profile=null,this._prev_size={};this.resizeHandler=this.resizeHandler||E.bind(this),window.addEventListener("resize",this.resizeHandler),this._super()},setSize:function(){var t=this,e=this._container.clientWidth,i=this._container.clientHeight;if(/^((?!chrome|android).)*safari/i.test(navigator.userAgent)&&navigator.userAgent.match(/iPhone/i)&&(this._container.style.top=0,this._container.clientWidth>this._container.clientHeight&&this._container.clientWidth<700)){var a=this._container.clientHeight,n=window.innerHeight;a-n>2&&45>=a-n&&(this._container.style.top="44px",document.body.scrollTop=44)}this._prev_size&&this._prev_size.width===e&&this._prev_size.height===i||(lt(this.screen_profiles,function(a,n){At(t._container,Ue+n),e>=a.min_width&&i>=a.min_height&&(t._curr_profile=n)}),Ot(this._container,Ue+this._curr_profile),i>e?(Ot(this._container,We),At(this._container,Qe)):(Ot(this._container,Qe),At(this._container,We)),this._prev_size.width=e,this._prev_size.height=i,this.trigger("resize"))},setContainer:function(t){this._container=t,this.setSize(),this.updatePresentation()},updatePresentation:function(){this.ui.presentation?Ot(this._container,Ue+Ke):At(this._container,Ue+Ke)},getPresentationMode:function(){return this.ui.presentation},currentProfile:function(){return this._curr_profile},clear:function(){window.removeEventListener("resize",this.resizeHandler)}}),Ze='<svg class="vzb-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1792 1792"><path d="M1615 0q70 0 122.5 46.5t52.5 116.5q0 63-45 151-332 629-465 752-97 91-218 91-126 0-216.5-92.5t-90.5-219.5q0-128 92-212l638-579q59-54 130-54zm-909 1034q39 76 106.5 130t150.5 76l1 71q4 213-129.5 347t-348.5 134q-123 0-218-46.5t-152.5-127.5-86.5-183-29-220q7 5 41 30t62 44.5 59 36.5 46 17q41 0 55-37 25-66 57.5-112.5t69.5-76 88-47.5 103-25.5 125-10.5z"/></svg>',Je='<svg class="vzb-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1792 1792"><path d="M1216 832q0-185-131.5-316.5t-316.5-131.5-316.5 131.5-131.5 316.5 131.5 316.5 316.5 131.5 316.5-131.5 131.5-316.5zm512 832q0 52-38 90t-90 38q-54 0-90-38l-343-342q-179 124-399 124-143 0-273.5-55.5t-225-150-150-225-55.5-273.5 55.5-273.5 150-225 225-150 273.5-55.5 273.5 55.5 225 150 150 225 55.5 273.5q0 220-124 399l343 343q37 37 37 90z"/></svg>',$e='<svg class="vzb-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1792 1792"><path d="M1664 896q0 209-103 385.5t-279.5 279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5 385.5-103 385.5 103 279.5 279.5 103 385.5z"/></svg>',ti='<svg class="vzb-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1792 1792"><path d="M883 1056q0 13-10 23l-332 332 144 144q19 19 19 45t-19 45-45 19h-448q-26 0-45-19t-19-45v-448q0-26 19-45t45-19 45 19l144 144 332-332q10-10 23-10t23 10l114 114q10 10 10 23zm781-864v448q0 26-19 45t-45 19-45-19l-144-144-332 332q-10 10-23 10t-23-10l-114-114q-10-10-10-23t10-23l332-332-144-144q-19-19-19-45t19-45 45-19h448q26 0 45 19t19 45z"/></svg>',ei='<svg class="vzb-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1792 1792"><path d="M1546 1050q46 26 59.5 77.5t-12.5 97.5l-64 110q-26 46-77.5 59.5t-97.5-12.5l-266-153v307q0 52-38 90t-90 38h-128q-52 0-90-38t-38-90v-307l-266 153q-46 26-97.5 12.5t-77.5-59.5l-64-110q-26-46-12.5-97.5t59.5-77.5l266-154-266-154q-46-26-59.5-77.5t12.5-97.5l64-110q26-46 77.5-59.5t97.5 12.5l266 153v-307q0-52 38-90t90-38h128q52 0 90 38t38 90v307l266-153q46-26 97.5-12.5t77.5 59.5l64 110q26 46 12.5 97.5t-59.5 77.5l-266 154z"/></svg>',ii='<svg class="vzb-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1792 1792"><path d="M 1381.375 17.1875 C 1375.7825 17.176804 1370.1216 17.316078 1364.4375 17.5625 C 1273.4913 21.505489 1197.0982 57.199956 1135.2188 124.6875 C 1076.5961 188.62338 1047.6964 263.96059 1048.5312 350.65625 L 835.71875 433 C 797.77288 391.67699 749.96961 361.96416 692.3125 343.84375 C 604.96227 316.39162 520.95691 323.70366 440.25 365.8125 C 359.5432 407.92133 305.45225 472.64985 278 560 C 250.54783 647.35004 257.89117 731.38694 300 812.09375 C 342.10886 892.80075 406.83755 946.89147 494.1875 974.34375 C 576.9404 1000.3512 657.38873 994.58645 735.5625 957.09375 L 959.28125 1171.4375 L 972.375 1184.4062 C 966.2931 1198.3454 961.94845 1209.2226 959.34375 1217.0625 C 956.73915 1224.9024 953.7186 1236.224 950.25 1251.0312 L 711.03125 1285.1875 C 669.59175 1209.0324 607.72526 1157.2863 525.40625 1129.9375 C 438.51381 1101.0693 354.34933 1107.021 272.96875 1147.8125 C 191.58796 1188.6039 136.49335 1252.4513 107.625 1339.3438 C 78.756758 1426.2362 84.708528 1510.3694 125.5 1591.75 C 166.29138 1673.1307 230.1387 1728.2567 317.03125 1757.125 C 403.92369 1785.9933 488.05682 1780.0415 569.4375 1739.25 C 650.81799 1698.4587 705.94425 1634.6111 734.8125 1547.7188 C 737.41718 1539.8788 740.43763 1528.5573 743.90625 1513.75 L 983.125 1479.5938 C 1024.5644 1555.7487 1086.4309 1607.4948 1168.75 1634.8438 C 1255.6425 1663.7119 1339.8069 1657.7603 1421.1875 1616.9688 C 1502.5682 1576.1772 1557.6631 1512.3299 1586.5312 1425.4375 C 1615.3996 1338.5451 1609.4477 1254.4119 1568.6562 1173.0312 C 1527.8647 1091.6506 1464.0174 1036.5244 1377.125 1007.6562 C 1294.9259 980.34721 1214.5066 984.74084 1135.8438 1020.8125 L 1120.2812 1005.9062 L 898.0625 785.96875 C 902.79653 774.40321 906.33847 765.03422 908.5 758.15625 C 920.42249 720.22 925.7916 682.90194 924.59375 646.21875 L 1130.9688 566.34375 C 1141.2015 577.59424 1149.3796 586.0106 1155.4688 591.59375 C 1222.9566 653.47326 1302.1474 682.44278 1393.0938 678.5 C 1484.04 674.55731 1560.4642 638.83151 1622.3438 571.34375 C 1684.2232 503.85591 1713.1929 424.6337 1709.25 333.6875 C 1705.3072 242.74139 1669.5816 166.34819 1602.0938 104.46875 C 1538.8238 46.456824 1465.2625 17.347946 1381.375 17.1875 z "/></svg>',ai='<svg class="vzb-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1792 1792"><path d="M640 768h512v-192q0-106-75-181t-181-75-181 75-75 181v192zm832 96v576q0 40-28 68t-68 28h-960q-40 0-68-28t-28-68v-576q0-40 28-68t68-28h32v-192q0-184 132-316t316-132 316 132 132 316v192h32q40 0 68 28t28 68z"/></svg>',ni='<svg class="vzb-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1792 1792"><path d="M1376 768q40 0 68 28t28 68v576q0 40-28 68t-68 28h-960q-40 0-68-28t-28-68v-576q0-40 28-68t68-28h32v-320q0-185 131.5-316.5t316.5-131.5 316.5 131.5 131.5 316.5q0 26-19 45t-45 19h-64q-26 0-45-19t-19-45q0-106-75-181t-181-75-181 75-75 181v320h736z"/></svg>',si='<svg class="vzb-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1792 1792"><path d="M896 960v448q0 26-19 45t-45 19-45-19l-144-144-332 332q-10 10-23 10t-23-10l-114-114q-10-10-10-23t10-23l332-332-144-144q-19-19-19-45t19-45 45-19h448q26 0 45 19t19 45zm755-672q0 13-10 23l-332 332 144 144q19 19 19 45t-19 45-45 19h-448q-26 0-45-19t-19-45v-448q0-26 19-45t45-19 45 19l144 144 332-332q10-10 23-10t23 10l114 114q10 10 10 23z"/></svg>',ri='<svg class="vzb-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 500"><path d="M430.25,379.655l-75.982-43.869v59.771H120.73V151.966h59.774l-43.869-75.983L92.767,0L48.898,75.983L5.029,151.966h59.775 v271.557c0,15.443,12.52,27.965,27.963,27.965h261.5v59.773l75.982-43.869l75.982-43.867L430.25,379.655z"/></svg>',li='<svg class="vzb-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1792 1792"><path d="M1152 896q0-106-75-181t-181-75-181 75-75 181 75 181 181 75 181-75 75-181zm512-109v222q0 12-8 23t-20 13l-185 28q-19 54-39 91 35 50 107 138 10 12 10 25t-9 23q-27 37-99 108t-94 71q-12 0-26-9l-138-108q-44 23-91 38-16 136-29 186-7 28-36 28h-222q-14 0-24.5-8.5t-11.5-21.5l-28-184q-49-16-90-37l-141 107q-10 9-25 9-14 0-25-11-126-114-165-168-7-10-7-23 0-12 8-23 15-21 51-66.5t54-70.5q-27-50-41-99l-183-27q-13-2-21-12.5t-8-23.5v-222q0-12 8-23t19-13l186-28q14-46 39-92-40-57-107-138-10-12-10-24 0-10 9-23 26-36 98.5-107.5t94.5-71.5q13 0 26 10l138 107q44-23 91-38 16-136 29-186 7-28 36-28h222q14 0 24.5 8.5t11.5 21.5l28 184q49 16 90 37l142-107q9-9 24-9 13 0 25 10 129 119 165 170 7 8 7 22 0 12-8 23-15 21-51 66.5t-54 70.5q26 50 41 98l183 28q13 2 21 12.5t8 23.5z"/></svg>',oi='<svg class="vzb-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 54.849 54.849"><g><path d="M54.497,39.614l-10.363-4.49l-14.917,5.968c-0.537,0.214-1.165,0.319-1.793,0.319c-0.627,0-1.254-0.104-1.79-0.318     l-14.921-5.968L0.351,39.614c-0.472,0.203-0.467,0.524,0.01,0.716L26.56,50.81c0.477,0.191,1.251,0.191,1.729,0L54.488,40.33     C54.964,40.139,54.969,39.817,54.497,39.614z"/><path d="M54.497,27.512l-10.364-4.491l-14.916,5.966c-0.536,0.215-1.165,0.321-1.792,0.321c-0.628,0-1.256-0.106-1.793-0.321     l-14.918-5.966L0.351,27.512c-0.472,0.203-0.467,0.523,0.01,0.716L26.56,38.706c0.477,0.19,1.251,0.19,1.729,0l26.199-10.479     C54.964,28.036,54.969,27.716,54.497,27.512z"/><path d="M0.361,16.125l13.662,5.465l12.537,5.015c0.477,0.191,1.251,0.191,1.729,0l12.541-5.016l13.658-5.463     c0.477-0.191,0.48-0.511,0.01-0.716L28.277,4.048c-0.471-0.204-1.236-0.204-1.708,0L0.351,15.41     C-0.121,15.614-0.116,15.935,0.361,16.125z"/></g></svg>',ci='<svg class="vzb-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1792 1792"><path d="M896 384q-53 0-90.5 37.5t-37.5 90.5v128h-32v-93q0-48-32-81.5t-80-33.5q-46 0-79 33t-33 79v429l-32-30v-172q0-48-32-81.5t-80-33.5q-46 0-79 33t-33 79v224q0 47 35 82l310 296q39 39 39 102 0 26 19 45t45 19h640q26 0 45-19t19-45v-25q0-41 10-77l108-436q10-36 10-77v-246q0-48-32-81.5t-80-33.5q-46 0-79 33t-33 79v32h-32v-125q0-40-25-72.5t-64-40.5q-14-2-23-2-46 0-79 33t-33 79v128h-32v-122q0-51-32.5-89.5t-82.5-43.5q-5-1-13-1zm0-128q84 0 149 50 57-34 123-34 59 0 111 27t86 76q27-7 59-7 100 0 170 71.5t70 171.5v246q0 51-13 108l-109 436q-6 24-6 71 0 80-56 136t-136 56h-640q-84 0-138-58.5t-54-142.5l-308-296q-76-73-76-175v-224q0-99 70.5-169.5t169.5-70.5q11 0 16 1 6-95 75.5-160t164.5-65q52 0 98 21 72-69 174-69z"/></svg>',hi='<svg class="vzb-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512.209 512.209"><path d="M507.345,439.683L288.084,37.688c-3.237-5.899-7.71-10.564-13.429-13.988c-5.705-3.427-11.893-5.142-18.554-5.142   s-12.85,1.718-18.558,5.142c-5.708,3.424-10.184,8.089-13.418,13.988L4.859,439.683c-6.663,11.998-6.473,23.989,0.57,35.98   c3.239,5.517,7.664,9.897,13.278,13.128c5.618,3.237,11.66,4.859,18.132,4.859h438.529c6.479,0,12.519-1.622,18.134-4.859   c5.62-3.23,10.038-7.611,13.278-13.128C513.823,463.665,514.015,451.681,507.345,439.683z M292.655,411.132   c0,2.662-0.91,4.897-2.71,6.704c-1.807,1.811-3.949,2.71-6.427,2.71h-54.816c-2.474,0-4.616-0.899-6.423-2.71   c-1.809-1.807-2.713-4.042-2.713-6.704v-54.248c0-2.662,0.905-4.897,2.713-6.704c1.807-1.811,3.946-2.71,6.423-2.71h54.812   c2.479,0,4.62,0.899,6.428,2.71c1.803,1.807,2.71,4.042,2.71,6.704v54.248H292.655z M292.088,304.357   c-0.198,1.902-1.198,3.47-3.001,4.709c-1.811,1.238-4.046,1.854-6.711,1.854h-52.82c-2.663,0-4.947-0.62-6.849-1.854   c-1.908-1.243-2.858-2.807-2.858-4.716l-4.853-130.47c0-2.667,0.953-4.665,2.856-5.996c2.474-2.093,4.758-3.14,6.854-3.14h62.809   c2.098,0,4.38,1.043,6.854,3.14c1.902,1.331,2.851,3.14,2.851,5.424L292.088,304.357z"/></svg>',di='<svg class="vzb-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1792 1792"><path d="M800 864v-448q0-14-9-23t-23-9-23 9-9 23v448q0 14 9 23t23 9 23-9 9-23zm672 352q0 26-19 45t-45 19h-429l-51 483q-2 12-10.5 20.5t-20.5 8.5h-1q-27 0-32-27l-76-485h-404q-26 0-45-19t-19-45q0-123 78.5-221.5t177.5-98.5v-512q-52 0-90-38t-38-90 38-90 90-38h640q52 0 90 38t38 90-38 90-90 38v512q99 0 177.5 98.5t78.5 221.5z"/></svg>',ui='<svg class="vzb-icon" xmlns="http://www.w3.org/2000/svg" viewBox="17 17 483 483"> <circle stroke-width="40" cx="258.57" cy="258.57" r="220"/> <path d="M299.756,413.021v-61.78c0-3.003-0.966-5.472-2.896-7.401s-4.398-2.896-7.401-2.896h-61.78 c-3.003,0-5.47,0.965-7.4,2.896c-1.932,1.931-2.896,4.398-2.896,7.401v61.78c0,3.002,0.965,5.47,2.896,7.399 c1.931,1.931,4.396,2.896,7.4,2.896h61.779c3.003,0,5.472-0.967,7.401-2.896S299.756,416.021,299.756,413.021z"/> <path d="M382.128,196.789c0-18.877-5.952-36.36-17.856-52.449c-11.905-16.088-26.762-28.53-44.566-37.325 c-17.804-8.795-36.037-13.192-54.7-13.192c-52.127,0-91.919,22.845-119.377,68.537c-3.218,5.148-2.359,9.653,2.574,13.514 l42.474,32.177c1.502,1.287,3.54,1.931,6.114,1.931c3.433,0,6.115-1.287,8.044-3.861c11.369-14.587,20.594-24.454,27.672-29.603 c7.294-5.148,16.519-7.723,27.673-7.723c10.297,0,19.468,2.789,27.513,8.366c8.044,5.578,12.065,11.906,12.065,18.985 c0,8.151-2.146,14.694-6.437,19.628c-4.29,4.934-11.583,9.76-21.881,14.479c-13.514,6.006-25.901,15.284-37.164,27.834 c-11.263,12.549-16.894,26.01-16.894,40.382v11.583c0,3.004,0.965,5.472,2.896,7.401c1.931,1.93,4.396,2.896,7.4,2.896h61.779 c3.003,0,5.471-0.965,7.401-2.896c1.93-1.931,2.896-4.397,2.896-7.401c0-4.075,2.306-9.385,6.917-15.928 c4.612-6.542,10.458-11.852,17.537-15.927c6.863-3.861,12.119-6.918,15.768-9.171c3.646-2.252,8.579-6.008,14.802-11.263 c6.22-5.255,10.993-10.402,14.317-15.443c3.325-5.042,6.328-11.53,9.01-19.467C380.788,214.916,382.128,206.228,382.128,196.789z"/> </svg>',mi='<svg class="vzb-icon vzb-icon-pin" viewBox="-150 -250 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1149 414q0 26 -19 45l-181 181l181 181q19 19 19 45q0 27 -19 46l-90 90q-19 19 -46 19q-26 0 -45 -19l-181 -181l-181 181q-19 19 -45 19q-27 0 -46 -19l-90 -90q-19 -19 -19 -46q0 -26 19 -45l181 -181l-181 -181q-19 -19 -19 -45q0 -27 19 -46l90 -90q19 -19 46 -19 q26 0 45 19l181 181l181 -181q19 -19 45 -19q27 0 46 19l90 90q19 19 19 46z"/></svg>',gi='<svg class="vzb-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path id="flip-chart-1" d="M334.549,393.834l58.607,68.666h-45.096l-58.709-68.666H334.549z M240.333,462.5h34.333v-68.666h-34.333 V462.5z M360.5,153.5h-34.334v137.334H360.5V153.5z M121.566,462.5h45.113l58.709-68.666h-45.197L121.566,462.5z M206,273.666 h-34.333v17.168H206V273.666z M257.5,239.333h-34.333v51.5H257.5V239.333z M309,205h-34.334v85.834H309V205z M446.334,102h-17.168 v257.5H85.833V102H68.667V50.5h377.667V102z M394.834,102H120.167v223.166h274.667V102z"/></svg>',pi='<svg class="vzb-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1792 1792"><path d="M1088 1256v240q0 16-12 28t-28 12h-240q-16 0-28-12t-12-28v-240q0-16 12-28t28-12h240q16 0 28 12t12 28zm316-600q0 54-15.5 101t-35 76.5-55 59.5-57.5 43.5-61 35.5q-41 23-68.5 65t-27.5 67q0 17-12 32.5t-28 15.5h-240q-15 0-25.5-18.5t-10.5-37.5v-45q0-83 65-156.5t143-108.5q59-27 84-56t25-76q0-42-46.5-74t-107.5-32q-65 0-108 29-35 25-107 115-13 16-31 16-12 0-25-8l-164-125q-13-10-15.5-25t5.5-28q160-266 464-266 80 0 161 31t146 83 106 127.5 41 158.5z"/></svg>',fi='<svg class="vzb-icon" viewBox="-200 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1389 1043q31 30 14 69-17 40-59 40h-382l201 476q10 25 0 49t-34 35l-177 75q-25 10-49 0t-35-34l-191-452-312 312q-19 19-45 19-12 0-24-5-40-17-40-59v-1504q0-42 40-59 12-5 24-5 27 0 45 19z"/></svg>',vi='<svg class="vzb-icon" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1088 800v64q0 13-9.5 22.5t-22.5 9.5h-224v224q0 13-9.5 22.5t-22.5 9.5h-64q-13 0-22.5-9.5t-9.5-22.5v-224h-224q-13 0-22.5-9.5t-9.5-22.5v-64q0-13 9.5-22.5t22.5-9.5h224v-224q0-13 9.5-22.5t22.5-9.5h64q13 0 22.5 9.5t9.5 22.5v224h224q13 0 22.5 9.5t9.5 22.5zm128 32q0-185-131.5-316.5t-316.5-131.5-316.5 131.5-131.5 316.5 131.5 316.5 316.5 131.5 316.5-131.5 131.5-316.5zm512 832q0 53-37.5 90.5t-90.5 37.5q-54 0-90-38l-343-342q-179 124-399 124-143 0-273.5-55.5t-225-150-150-225-55.5-273.5 55.5-273.5 150-225 225-150 273.5-55.5 273.5 55.5 225 150 150 225 55.5 273.5q0 220-124 399l343 343q37 37 37 90z"/></svg>',bi='<svg class="vzb-icon" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1088 800v64q0 13-9.5 22.5t-22.5 9.5h-576q-13 0-22.5-9.5t-9.5-22.5v-64q0-13 9.5-22.5t22.5-9.5h576q13 0 22.5 9.5t9.5 22.5zm128 32q0-185-131.5-316.5t-316.5-131.5-316.5 131.5-131.5 316.5 131.5 316.5 316.5 131.5 316.5-131.5 131.5-316.5zm512 832q0 53-37.5 90.5t-90.5 37.5q-54 0-90-38l-343-342q-179 124-399 124-143 0-273.5-55.5t-225-150-150-225-55.5-273.5 55.5-273.5 150-225 225-150 273.5-55.5 273.5 55.5 225 150 150 225 55.5 273.5q0 220-124 399l343 343q37 37 37 90z"/></svg>',yi='<svg class="vzb-icon" xmlns="http://www.w3.org/2000/svg"><g transform="translate(17 11)"><text x="0" y="0">100</text><text class="percent" x="0" y="0">%</text></g></svg>',xi={
paintbrush:Ze,search:Je,circle:$e,expand:ti,asterisk:ei,trails:ii,lock:ai,unlock:ni,unexpand:si,axes:ri,gear:li,stack:oi,drag:ci,warn:hi,pin:di,question:ui,close:mi,presentation:gi,about:pi,cursorArrow:fi,cursorPlus:vi,cursorMinus:bi,hundredPercent:yi},_i="vzb-loading-first",Mi="vzb-loading",zi="vzb-loading-error",wi="vzb-placeholder",ki="vzb-buttonlist-off",Si=Me.extend({init:function(t,e,i,a,n){if(this._id=U("tm"),this._type="tool",this.validate=T(this,n),e=e||{},i=i||{},e=L(e,i),this._super(t,e,null,a),e.language){var s=this;this.on("change:language.id",function(){s.trigger("translate")})}}}),Ei=Xe.extend({init:function(t,e){this._id=U("t"),this.template=this.template||'<div class="vzb-tool vzb-tool-'+this.name+'"><div class="vzb-tool-stage"><div class="vzb-tool-viz"></div><div class="vzb-tool-timeslider"></div></div><div class="vzb-tool-sidebar"><div class="vzb-tool-dialogs"></div><div class="vzb-tool-buttonlist"></div></div><div class="vzb-tool-treemenu vzb-hidden"></div><div class="vzb-tool-datawarning vzb-hidden"></div></div>',this.model_binds=this.model_binds||{},e=e||{},e.bind=e.bind||{};var i=this.validate.bind(this),a=this,n={change:function(t,e){a._ready&&(a.model.validate(),t.source.persistent&&a.model.trigger(new fe(t.source,"persistentChange"),a.getMinModel()))},"change:ui.presentation":function(){a.layout.updatePresentation(),a.trigger("resize")},translate:function(t,e){a._ready&&s.all([a.preloadLanguage(),a.model.load()]).then(function(){a.model.validate(),a.translateStrings()})},load_start:function(){a.beforeLoading()},ready:function(t){a._ready&&a.afterLoading()}};ot(n,this.model_binds,e.bind),delete e.bind,this.model=new Si(this.name,e,this.default_model,n,i),this.default_model=this.default_model||{},this.ui=this.model.ui||{},this.layout=new Ge(this.ui),this.ui.splash=this.model&&this.model.data&&this.model.data.splash,this._super({name:this.name||this._id,placeholder:t},this),this.render(),this._setUIModel()},ready:function(){this.checkTimeLimits()},checkTimeLimits:function(){var t=this.model.state.time,e=this.model.state.marker.getTimeLimits(t.getDimension());return e&&G(e.min)&&G(e.max)?(t.start-e.min!=0&&t.getModelObject("start").set(e.min,!1,!t.splash),t.end-e.max!=0&&t.getModelObject("end").set(e.max,!1,!t.splash),void t.validate()):kt("checkTimeLimits(): min-max dates look wrong: "+e)},getMinModel:function(){var t=this.model.getPlainObject(!0),e=this.default_model,i=this.model.getDefaults();e=Vt(e);var a=Yt(t,e);return a=Xt(a,this.model.state.time.timeFormat),Yt(a,i)},clear:function(){this.layout.clear(),this.setModel=this.getModel=function(){},this._super()},error:function(t){var e=t&&"data"===t.type?"Error loading chart data. <br>Please, try again soon.":"Error loading chart";this.placeholder.innerHTML='<div class="vzb-error-message"><h1>'+hi+"</h1><p>"+e+"</p></div>"},setModel:function(t,e){e?this.model.reset(t):this.model.set(t),this._setUIModel()},getModel:function(){return this.model.getPlainObject()||{}},beforeLoading:function(){this._readyOnce||Ot(this.placeholder,_i),Dt(this.placeholder,Mi)||Ot(this.placeholder,Mi)},afterLoading:function(){At(this.placeholder,Mi),At(this.placeholder,_i)},errorLoading:function(){Ot(this.placeholder,zi)},validate:function(t){return t=this.model||t,t&&t.state?t.state.time?t.state.marker?void 0:kt("tool validation aborted: marker looks wrong: "+marker):kt("tool validation aborted: time looks wrong: "+time):kt("tool validation aborted: model.state looks wrong: "+t)},_setUIModel:function(){Ot(this.placeholder,wi),this.ui&&this.ui.buttons&&this.ui.buttons.length?At(this.element,ki):Ot(this.element,ki)},preloadLanguage:function(){return s.resolve()}});Ei.isTool=function(t){return t._id&&"t"===t._id[0]};var Ti,Li,Oi,Ai,Pi,Di,Ci=Xe.extend({init:function(t,e){this.name="barchart",this.template="barchart.html",this.model_expects=[{name:"time",type:"time"},{name:"entities",type:"entities"},{name:"marker",type:"model"},{name:"language",type:"language"}];var i=this;this.model_binds={"change:time.value":function(t){i.model.marker.getFrame(i.model.time.value,function(t){i.values=t,i.updateEntities()})},"change:marker":function(t,e){i._readyOnce&&(e.indexOf("color.palette")>-1||e.indexOf("which")>-1||e.indexOf("use")>-1||i.ready())},"change:marker.color.palette":ae(function(t){i._readyOnce&&i.updateEntities()},200)},this._super(t,e),this.xScale=null,this.yScale=null,this.cScale=d3.scale.category10(),this.xAxis=O(),this.yAxis=O()},readyOnce:function(){this.element=d3.select(this.element),this.graph=this.element.select(".vzb-bc-graph"),this.yAxisEl=this.graph.select(".vzb-bc-axis-y"),this.xAxisEl=this.graph.select(".vzb-bc-axis-x"),this.yTitleEl=this.graph.select(".vzb-bc-axis-y-title"),this.xTitleEl=this.graph.select(".vzb-bc-axis-x-title"),this.bars=this.graph.select(".vzb-bc-bars"),this.year=this.element.select(".vzb-bc-year");var t=this;this.on("resize",function(){t.updateEntities()})},ready:function(){var t=this;this.model.marker.getFrame(this.model.time.value,function(e){t.values=e,t.updateIndicators(),t.resize(),t.updateEntities()})},updateIndicators:function(){var t=this;this.translator=this.model.language.getTFunction(),this.duration=this.model.time.delayAnimations;var e=this.translator("indicator/"+this.model.marker.axis_y.which),i=this.translator("indicator/"+this.model.marker.axis_x.which),a=this.yTitleEl.selectAll("text").data([0]);a.enter().append("text"),a.attr("y","-6px").attr("x","-9px").attr("dx","-0.72em").text(e).on("click",function(){t.parent.findChildByName("gapminder-treemenu").markerID("axis_y").alignX("left").alignY("top").updateView().toggle()});var n=this.xTitleEl.selectAll("text").data([0]);n.enter().append("text"),n.attr("y","-3px").attr("dx","-0.72em").text(i).on("click",function(){t.parent.findChildByName("gapminder-treemenu").markerID("axis_x").alignY("bottom").alignX("center").updateView().toggle()}),this.yScale=this.model.marker.axis_y.getScale(),this.xScale=this.model.marker.axis_x.getScale(),this.cScale=this.model.marker.color.getScale();var s="geo.region"==this.model.marker.axis_x.which?function(e){return t.translator("region/"+e)}:t.model.marker.axis_x.tickFormatter;this.yAxis.tickFormat(t.model.marker.axis_y.tickFormatter),this.xAxis.tickFormat(s)},updateEntities:function(){var t=this,e=this.model.time,i=e.getDimension(),a=this.model.entities.getDimension(),n=e.playing?e.delayAnimations:0,s={};s[i]=e.value;var r=this.model.marker.getKeys(s);this.entityBars=this.bars.selectAll(".vzb-bc-bar").data(r),this.entityBars.exit().remove(),this.entityBars.enter().append("rect").attr("class","vzb-bc-bar").on("mousemove",function(t,e){}).on("mouseout",function(t,e){}).on("click",function(t,e){});var l=(this.bars.selectAll(".vzb-bc-bar"),this.xScale.rangeBand());this.bars.selectAll(".vzb-bc-bar").attr("width",l).attr("fill",function(e){return t.cScale(t.values.color[e[a]])}).attr("x",function(e){return t.xScale(t.values.axis_x[e[a]])}).transition().duration(n).ease("linear").attr("y",function(e){return t.yScale(t.values.axis_y[e[a]])}).attr("height",function(e){return t.height-t.yScale(t.values.axis_y[e[a]])}),this.year.text(this.model.time.timeFormat(this.model.time.value))},resize:function(){var t=this;this.profiles={small:{margin:{top:30,right:20,left:40,bottom:50},padding:2,minRadius:2,maxRadius:40},medium:{margin:{top:30,right:60,left:60,bottom:60},padding:2,minRadius:3,maxRadius:60},large:{margin:{top:30,right:60,left:60,bottom:80},padding:2,minRadius:4,maxRadius:80}},this.activeProfile=this.profiles[this.getLayoutProfile()];var e=this.activeProfile.margin;this.height=parseInt(this.element.style("height"),10)-e.top-e.bottom,this.width=parseInt(this.element.style("width"),10)-e.left-e.right,this.graph.attr("transform","translate("+e.left+","+e.top+")"),"ordinal"!==this.model.marker.axis_y.scaleType?this.yScale.range([this.height,0]):this.yScale.rangePoints([this.height,0],t.activeProfile.padding).range(),"ordinal"!==this.model.marker.axis_x.scaleType?this.xScale.range([0,this.width]):this.xScale.rangePoints([0,this.width],t.activeProfile.padding).range(),this.yAxis.scale(this.yScale).orient("left").tickSize(6,0).tickSizeMinor(3,0).labelerOptions({scaleType:this.model.marker.axis_y.scaleType,timeFormat:this.model.time.timeFormat,toolMargin:{top:5,right:e.right,left:e.left,bottom:e.bottom},limitMaxTickNumber:6}),this.xAxis.scale(this.xScale).orient("bottom").tickSize(6,0).tickSizeMinor(3,0).labelerOptions({scaleType:this.model.marker.axis_x.scaleType,timeFormat:this.model.time.timeFormat,toolMargin:e,constantRakeLength:this.width}),this.xAxisEl.attr("transform","translate(0,"+this.height+")").call(this.xAxis),this.xScale.rangeRoundBands([0,this.width],.1,.2),this.yAxisEl.call(this.yAxis),this.xAxisEl.call(this.xAxis);var i=this.xAxisEl.node().getBoundingClientRect(),a=this.xTitleEl.node().getBoundingClientRect(),n=i.width/2-a.width/2,s=this.height+i.height+a.height;this.xTitleEl.attr("transform","translate("+n+","+s+")"),this.year.attr("x",this.width).attr("y",0)}}),Ii="vzb-active",qi=Xe.extend({init:function(t,e){var i=this;this.name="gapminder-zoombuttonlist",this.model_expects=[{name:"state",type:"model"},{name:"ui",type:"model"},{name:"language",type:"language"}],this._available_buttons={arrow:{title:"buttons/cursorarrow",icon:"cursorArrow",func:this.toggleCursorMode.bind(this),required:!0,statebind:"ui.cursorMode",statebindfunc:this.setCursorMode.bind(this)},plus:{title:"buttons/cursorplus",icon:"cursorPlus",func:this.toggleCursorMode.bind(this),required:!0,statebind:"ui.cursorMode",statebindfunc:this.setCursorMode.bind(this)},minus:{title:"buttons/cursorminus",icon:"cursorMinus",func:this.toggleCursorMode.bind(this),required:!0,statebind:"ui.cursorMode",statebindfunc:this.setCursorMode.bind(this)},hundredpercent:{title:"buttons/hundredpercent",icon:"hundredPercent",func:this.toggleHundredPercent.bind(this),required:!0}},this.model_binds={},void 0==t.ui.cursorMode&&t.ui.set("cursorMode",null,!1,!1),Object.keys(this._available_buttons).forEach(function(t){var e=i._available_buttons[t];e&&e.statebind&&(i.model_binds["change:"+e.statebind]=function(i){e.statebindfunc(t,i.source.value)})}),this._super(t,e)},readyOnce:function(){this.element=d3.select(this.placeholder),this.element.selectAll("div").remove(),this._addButtons(Object.keys(this._available_buttons),[]),this.setCursorMode("arrow")},_addButtons:function(t,e){var i=this;this._components_config=[];var a=[];if(t.length){for(var n=0;n<t.length;n++){var s=t[n],r=this._available_buttons[s],l=r?s:"_default",o=dt(this._available_buttons[l]);o.id=s,o.icon=xi[o.icon],a.push(o)}var c=this.getTranslationFunction(!0);this.element.selectAll("button").data(a).enter().append("button").attr("class",function(t){var i="vzb-buttonlist-btn";return e.length>0&&e.indexOf(t.id)>-1&&(i+=" vzb-dialog-side-btn"),i}).attr("data-btn",function(t){return t.id}).html(function(t){return"<span class='vzb-buttonlist-btn-icon fa'>"+t.icon+"</span><span class='vzb-buttonlist-btn-title'>"+c(t.title)+"</span>"});var h=this.element.selectAll(".vzb-buttonlist-btn");h.on("click",function(){d3.event.preventDefault(),d3.event.stopPropagation();var t=d3.select(this).attr("data-btn");i.proceedClick(t)})}},proceedClick:function(t){var e=this,i=e.element.selectAll(".vzb-buttonlist-btn[data-btn='"+t+"']"),a=i.attr("class"),n=e._available_buttons[t];if(n&&n.func)n.func(t);else{var s=-1===a.indexOf(Ii);i.classed(Ii,s);var r={};r.id=t,r.active=s,e.trigger("click",r)}},setButtonActive:function(t,e){var i=this.element.selectAll(".vzb-buttonlist-btn[data-btn='"+t+"']");i.classed(Ii,e)},toggleCursorMode:function(t){var e=t;this.model.ui.set("cursorMode",e,!1,!1)},setCursorMode:function(t){var e=this.model.ui.cursorMode?this.model.ui.cursorMode:"arrow";this.element.selectAll(".vzb-buttonlist-btn").classed(Ii,function(t){return t.id==e})},toggleHundredPercent:function(t){this.root.trigger("resetZoom")}}),Ri=1,Bi=2,Fi={wrapper:"vzb-treemenu-wrap",background:"vzb-treemenu-background",close:"vzb-treemenu-close",search:"vzb-treemenu-search",list:"vzb-treemenu-list",list_item:"vzb-treemenu-list-item",hasChild:"vzb-treemenu-list-item-children",list_item_label:"vzb-treemenu-list-item-label",list_top_level:"vzb-treemenu-list-top",search_wrap:"vzb-treemenu-search-wrap",isSpecial:"vzb-treemenu-list-item-special",hidden:"vzb-hidden",title:"vzb-treemenu-title",scaletypes:"vzb-treemenu-scaletypes",scaletypesDisabled:"vzb-treemenu-scaletypes-disabled",scaletypesActive:"vzb-treemenu-scaletypes-active",alignYt:"vzb-align-y-top",alignYb:"vzb-align-y-bottom",alignXl:"vzb-align-x-left",alignXr:"vzb-align-x-right",alignXc:"vzb-align-x-center",menuHorizontal:"vzb-treemenu-horizontal",menuVertical:"vzb-treemenu-vertical",absPosVert:"vzb-treemenu-abs-pos-vert",absPosHoriz:"vzb-treemenu-abs-pos-horiz",menuOpenLeftSide:"vzb-treemenu-open-left-side",noTransition:"notransition"},Hi={MOUSE_LOCS:[],MOUSE_LOCS_TRACKED:3,DELAY:200,TOLERANCE:150,LAST_DELAY_LOC:null,TIMEOUT:null,SEARCH_PROPERTY:"id",SUBMENUS:"children",SEARCH_MIN_STR:1,RESIZE_TIMEOUT:null,MOBILE_BREAKPOINT:400,CURRENT_PATH:[],MIN_COL_WIDTH:50,MENU_DIRECTION:Ri,MAX_MENU_WIDTH:300,MENU_OPEN_LEFTSIDE:!1},Ni=he.extend({init:function(t,e){var i=this;return this.parent=t,this.entity=e,this.width=Hi.MIN_COL_WIDTH,this.direction=Hi.MENU_DIRECTION,this._setDirectionClass(),this.menuItems=[],e.selectAll("."+Fi.list_item).filter(function(){return this.parentNode==i.entity.node()}).each(function(){i.addSubmenu(d3.select(this))}),this},setWidth:function(t,e){if(this.width!=t&&this.entity.node()){if(this.width=t,this.entity.classed("active")&&this.entity.transition().delay(0).duration(100).style("width",this.width+"px"),e)for(var i=0;i<this.menuItems.length;i++)this.menuItems[i].setWidth(this.width,e);return this}},setDirection:function(t,e){if(this.direction=t,this.entity.style("width","").style("height",""),e)for(var i=0;i<this.menuItems.length;i++)this.menuItems[i].setDirection(this.direction,e);return this._setDirectionClass(),this},_setDirectionClass:function(){this.direction==Ri?(this.entity.classed(Fi.menuVertical,!1),this.entity.classed(Fi.menuHorizontal,!0)):(this.entity.classed(Fi.menuHorizontal,!1),this.entity.classed(Fi.menuVertical,!0))},addSubmenu:function(t){this.menuItems.push(new ji(this,t))},open:function(){var t=this;return this.isActive()||this.closeNeighbors(function(){t.direction==Ri?(t._openHorizontal(),t.calculateMissingWidth(0)):t._openVertical()}),this},calculateMissingWidth:function(t,e){var i=this;this.entity.classed(Fi.list_top_level)?t>Hi.MAX_MENU_WIDTH&&e(t-Hi.MAX_MENU_WIDTH):this.parent.parentMenu.calculateMissingWidth(t+this.width,function(t){t>0&&i.reduceWidth(t,function(t){"function"==typeof e&&e()})})},restoreWidth:function(t,e,i){var a=this;if(e)this.parent.parentMenu.restoreWidth(t,!1,i);else if(0>=t)"function"==typeof i&&i();else if(this.entity.classed(Fi.list_top_level))"function"==typeof i&&i();else{var n=this.entity.node().offsetWidth;if(n<a.width){var s=250*(n/a.width);this.entity.transition().delay(0).duration(s).style("width",a.width+"px").each("end",function(){}),a.parent.parentMenu.restoreWidth(t-a.width+n,!1,i)}else this.parent.parentMenu.restoreWidth(t,!1,i)}},reduceWidth:function(t,e){var i=this,a=this.entity.node().offsetWidth;if(a<=Hi.MIN_COL_WIDTH)e(t);else{var n=Math.max(Hi.MIN_COL_WIDTH,Math.abs(i.width-t)),s=250/(i.width/n);this.entity.transition().delay(0).duration(s).style("width",n+"px").each("end",function(){e(t-i.width+n)})}},_openHorizontal:function(){var t=this;t.entity.transition().delay(0).duration(250).style("width",t.width+"px").each("end",function(){t.marqueeToggle(!0)}),t.entity.classed("active",!0)},_openVertical:function(){var t=this;t.entity.transition().delay(0).duration(250).style("height",35*t.menuItems.length+"px").each("end",function(){t.entity.style("height","auto"),t.marqueeToggle(!0)}),t.entity.classed("active",!0)},closeAllChildren:function(t){for(var e=0,i=0;i<this.menuItems.length;i++)this.menuItems[i].isActive()&&(++e,this.menuItems[i].submenu.close(function(){0==--e&&"function"==typeof t&&t()}));0==e&&"function"==typeof t&&t()},closeNeighbors:function(t){this.parent?this.parent.closeNeighbors(t):t()},close:function(t){var e=this;this.closeAllChildren(function(){e.direction==Ri?e._closeHorizontal(t):e._closeVertical(t)})},_closeHorizontal:function(t){var e=this.entity.node().offsetWidth,i=this;i.entity.transition().delay(0).duration(20).style("width","0px").each("end",function(){i.marqueeToggle(!1),i.entity.classed("active",!1),i.restoreWidth(e,!0,function(){"function"==typeof t&&t()})})},_closeVertical:function(t){var e=this;e.entity.transition().delay(0).duration(10).style("height","0px").each("end",function(){e.marqueeToggle(!1),e.entity.classed("active",!1),"function"==typeof t&&t()})},isActive:function(){return this.entity.classed("active")},marqueeToggle:function(t){for(var e=0;e<this.menuItems.length;e++)this.menuItems[e].marqueeToggle(t)}}),ji=he.extend({init:function(t,e){var i=this;this.parentMenu=t,this.entity=e;var a=e.select("."+Fi.list);return a.node()&&(this.submenu=new Ni(this,a)),this.entity.on("mouseenter",function(){ne()||i.parentMenu.direction==Ri&&i.openSubmenu()}).on("click",function(){ne()||(d3.event.stopPropagation(),i.toggleSubmenu())}).onTap(function(){d3.event.stopPropagation(),i.toggleSubmenu()}),this},setWidth:function(t,e){return this.submenu&&e&&this.submenu.setWidth(t,e),this},setDirection:function(t,e){return this.submenu&&e&&this.submenu.setDirection(t,e),this},toggleSubmenu:function(){this.submenu&&(this.submenu.isActive()?this.submenu.close():this.submenu.open())},openSubmenu:function(){this.submenu?this.submenu.open():this.closeNeighbors()},closeNeighbors:function(t){this.parentMenu.closeAllChildren(t)},isActive:function(){return this.submenu&&this.submenu.isActive()},marqueeToggle:function(t){if(t){var e=this.entity.select("."+Fi.list_item_label);e.node().scrollWidth>this.entity.node().offsetWidth&&(e.attr("data-content",e.text()),this.entity.classed("marquee",!0))}else this.entity.classed("marquee",!1)}}),Yi=function(t){console.log("Indicator selector: stub callback fired. New indicator is ",t)},Vi="center",Xi="center",Ui=Xe.extend({tree:function(t){return arguments.length?(Ti=t,this):Ti},lang:function(t){return arguments.length?(Oi=t,this):Oi},langStrings:function(t){return arguments.length?(Li=t,this):Li},callback:function(t){return arguments.length?(Yi=t,this):Yi},markerID:function(t){return arguments.length?(Ai=t,this):Ai},alignX:function(t){return arguments.length?(Vi=t,this):Vi},alignY:function(t){return arguments.length?(Xi=t,this):Xi},top:function(t){return arguments.length?(Pi=t,this):Pi},left:function(t){return arguments.length?(Di=t,this):Di},init:function(t,e){var i=this;this.name="gapminder-treemenu",this.model_expects=[{name:"marker",type:"model"},{name:"language",type:"language"}],this.context=e,this.menuEntity=null,this.model_binds={"change:marker":function(t,e){-1!=e.indexOf(Ai)&&i.updateView()},"change:language.strings":function(t){i.updateView()}},this._super(t,e),this.ui=ot({},this.ui)},ready:function(){this.updateView()},readyOnce:function(){this.element=d3.select(this.placeholder);var t=this;this.element.selectAll("div").remove(),this.element.append("div").attr("class",Fi.background).on("click",function(){d3.event.stopPropagation(),t.toggle()}),this.wrapper=this.element.append("div").classed(Fi.wrapper,!0).classed(Fi.noTransition,!0).classed("vzb-dialog-scrollable",!0),this.wrapper.on("click",function(){d3.event.stopPropagation()}),this.wrapper.append("div").html(mi).on("click",function(){d3.event.stopPropagation(),t.toggle()}).select("svg").attr("width","0px").attr("height","0px").attr("class",Fi.close),this.wrapper.append("div").classed(Fi.title,!0).append("span"),this.wrapper.append("div").classed(Fi.scaletypes,!0).append("span"),this.wrapper.append("div").classed(Fi.search_wrap,!0).append("input").classed(Fi.search,!0).attr("type","search").attr("id",Fi.search),d3.select("body").on("mousemove",t._mousemoveDocument),this.wrapper.on("mouseleave",function(){t.menuEntity.closeAllChildren()}),t._enableSearch(),t.resize()},resize:function(){var t=this;this.profiles={small:{col_width:200},medium:{col_width:200},large:{col_width:200}},this.activeProfile=this.profiles[this.getLayoutProfile()],this.wrapper.classed(Fi.noTransition,!0),this.width=t.element.node().offsetWidth,this.height=t.element.node().offsetHeight;var e=this.wrapper.node().getBoundingClientRect(),i=e.width,a=e.height;return Hi.IS_MOBILE="small"===this.getLayoutProfile(),i&&((Pi||Di)&&(Hi.IS_MOBILE?this.clearPos():(this.wrapper.node().offsetTop<0&&this.wrapper.style("top","10px"),this.height-t.wrapper.node().offsetTop-a<0&&this.wrapper.style("top",this.height-a-10+"px"))),this.wrapper.classed(Fi.alignXc,"center"===Vi),this.wrapper.style("margin-left","center"===Vi?"-"+i/2+"px":null),"center"===Vi?Hi.MAX_MENU_WIDTH=this.width/2-.5*i:(Hi.MAX_MENU_WIDTH=this.width-this.wrapper.node().offsetLeft-i-10,Hi.MENU_OPEN_LEFTSIDE=Hi.MAX_MENU_WIDTH<this.activeProfile.col_width+Hi.MIN_COL_WIDTH,Hi.MENU_OPEN_LEFTSIDE&&(Hi.MAX_MENU_WIDTH=t.wrapper.node().offsetLeft-10),this.wrapper.classed("vzb-treemenu-open-left-side",!Hi.IS_MOBILE&&Hi.MENU_OPEN_LEFTSIDE))),this.wrapper.classed(Fi.noTransition,!1),this.menuEntity&&(this.menuEntity.setWidth(this.activeProfile.col_width,!0),Hi.IS_MOBILE?this.menuEntity.direction!=Bi&&this.menuEntity.setDirection(Bi,!0):this.menuEntity.direction!=Ri&&this.menuEntity.setDirection(Ri,!0)),this},toggle:function(){var t=this,e=!this.element.classed(Fi.hidden);this.element.classed(Fi.hidden,e),e?((Pi||Di)&&this.clearPos(),this.menuEntity.marqueeToggle(!1)):((Pi||Di)&&this.setPos(),this.resize()),this.wrapper.classed(Fi.noTransition,e),this.parent.components.forEach(function(i){"gapminder-dialogs"==i.name?d3.select(i.placeholder.parentNode).classed("vzb-blur",!e):i.element.classed?i.element.classed("vzb-blur",i!=t&&!e):d3.select(i.element).classed("vzb-blur",i!=t&&!e)}),this.width=t.element.node().offsetWidth},setPos:function(){var t=this.wrapper.node().getBoundingClientRect();if(Pi&&(this.wrapper.style({top:Pi+"px",bottom:"auto"}),this.wrapper.classed(Fi.absPosVert,Pi)),Di){var e=this.element.node().offsetWidth-Di-t.width;this.wrapper.style({right:e+"px",left:"auto"}),this.wrapper.classed(Fi.absPosHoriz,e)}},clearPos:function(){Pi="",Di="",this.wrapper.attr("style",""),this.wrapper.classed(Fi.absPosVert,""),this.wrapper.classed(Fi.absPosHoriz,""),this.wrapper.classed(Fi.menuOpenLeftSide,"")},_enableSearch:function(){var t=this,e=this.wrapper.select("."+Fi.search),i=function(e){var i={_id:"root",children:[]},a=function(e,i,a){if(t.langStrings())for(var n in t.langStrings())for(var s in t.langStrings()[n])if(console.log(s.replace(/.*\//,"")),0==s.indexOf("indicator/")&&s.replace(/.*\//,"")==i[a][Hi.SEARCH_PROPERTY]&&t.langStrings()[n][s].toLowerCase().indexOf(e.toLowerCase())>=0)return!0;return!1},n=function(t){for(var s=0;s<t.length;s++){var r=!1;r=a(e,t,s),r&&i.children.push(t[s]),!r&&t[s][Hi.SUBMENUS]&&n(t[s][Hi.SUBMENUS])}};return n(Ti.children),i},a=function(){var a=e.node().value;a.length>=Hi.SEARCH_MIN_STR?t.redraw(i(a)):t.redraw()};e.on("keyup",a)},_selectIndicator:function(t,e){e=d3.select(e),e.attr("children")||(Yi("which",e.attr("info"),Ai),this.toggle())},redraw:function(t){var e=this;this.element.select("."+Fi.title).select("span").text(this.translator("buttons/"+Ai)),this.element.select("."+Fi.search).attr("placeholder",this.translator("placeholder/search")+"..."),null==t&&(t=Ti),this.wrapper.select("ul").remove();var i=e.model.marker.getMetadata(),a=e.model.marker[Ai]._type,n=It(i).filter(function(t){if(e.model.marker[Ai].allow&&e.model.marker[Ai].allow.names&&-1!=e.model.marker[Ai].allow.names.indexOf("!"+t))return!1;if(!e.model.marker[Ai].allow||!e.model.marker[Ai].allow.scales)return!0;if("*"==e.model.marker[Ai].allow.scales[0])return!0;if(!i[t].scales)return!0;for(var a=i[t].scales.length-1;a>=0;a--)if(e.model.marker[Ai].allow.scales.indexOf(i[t].scales[a])>-1)return!0;return!1}),s=se(t,function(t){return n.indexOf(t.id)>-1}),r=function(t,i,n){if(i.children){var s=t.append("ul").classed(Fi.list,!n).classed(Fi.list_top_level,n).selectAll("li").data(i.children,function(t){return t.id}).enter().append("li");s.append("span").classed(Fi.list_item_label,!0).text(function(t){return e.translator("indicator"+("_default"===t.id?"/"+a:"")+"/"+t.id)}).attr("info",function(t){return t.id}).attr("children",function(t){return t.children?"true":null}).on("click",function(t){e._selectIndicator(t,this)}),s.append("div").classed(Fi.list_item_label+"-mask",!0),s.classed(Fi.list_item,!0).classed(Fi.hasChild,function(t){return t.children}).classed(Fi.isSpecial,function(t){return t.special}).each(function(t){var e=d3.select(this);r(e,t)})}};Hi.IS_MOBILE&&(Hi.MENU_DIRECTION=Bi),r(this.wrapper,s,!0),this.menuEntity=new Ni(null,this.wrapper.select("."+Fi.list_top_level)),this.menuEntity&&this.menuEntity.setWidth(this.activeProfile.col_width,!0),this.menuEntity&&this.menuEntity.setDirection(Hi.MENU_DIRECTION);var l="_default";n.indexOf(this.model.marker[Ai].which)>-1&&(l=this.model.marker[Ai].which);var o=i[l].scales.filter(function(t){return e.model.marker[Ai].allow&&e.model.marker[Ai].allow.scales?"*"==e.model.marker[Ai].allow.scales[0]?!0:e.model.marker[Ai].allow.scales.indexOf(t)>-1:!0}),c=this.element.select("."+Fi.scaletypes).selectAll("span").data(o,function(t){return t});return c.exit().remove(),c.enter().append("span").on("click",function(t){d3.event.stopPropagation(),e._setModel("scaleType",t,Ai)}),c.classed(Fi.scaletypesDisabled,o.length<2).classed(Fi.scaletypesActive,function(t){return t==e.model.marker[Ai].scaleType&&o.length>1}).text(function(t){return e.translator("scaletype/"+t)}),this},updateView:function(){var t=this,e=t.model.language.id;if(Ai){this.wrapper.classed(Fi.absPosVert,Pi),this.wrapper.classed(Fi.alignYt,"top"===Xi),this.wrapper.classed(Fi.alignYb,"bottom"===Xi),this.wrapper.classed(Fi.absPosHoriz,Di),this.wrapper.classed(Fi.alignXl,"left"===Vi),this.wrapper.classed(Fi.alignXr,"right"===Vi);var i=Li?Li:{};i[e]=t.model.language.strings[e],this.translator=this.model.language.getTFunction();var a=this._setModel.bind(this);return this.langStrings(i).lang(e).callback(a).tree(this.model.marker.getIndicatorsTree()).redraw(),this}},_setModel:function(t,e,i){var a=this.model.marker.getMetadata(),n=this.model.marker[i],s={};s[t]=e,"which"==t&&(s.use=a[e].use,s.scaleType=a[e].scales[0]),"axis"!==n.getType()&&"size"!==n.getType()||(s.domainMin=null,s.domainMax=null,s.zoomedMin=null,s.zoomedMax=null),n.set(s)}}),Ki=1,Wi="vzb-playing",Qi="vzb-ts-loading",Gi="vzb-ts-hide-play-button",Zi="vzb-ts-dragging",Ji="vzb-ts-axis-aligned",$i="vzb-ts-show-value",ta="vzb-ts-show-value-when-drag-play",ea={small:{margin:{top:7,right:15,bottom:10,left:15},radius:8,label_spacing:10},medium:{margin:{top:16,right:15,bottom:10,left:15},radius:9,label_spacing:12},large:{margin:{top:14,right:15,bottom:10,left:15},radius:11,label_spacing:14}},ia={medium:{margin:{top:9}},large:{margin:{}}},aa=Xe.extend({init:function(t,e){this.name="gapminder-timeslider",this.template=this.template||"timeslider.html",this.prevPosition=null,this.model_expects=[{name:"time",type:"time"}];var i=this;this._splash=t.ui.splash,this.model_binds={"change:time":function(t,e){i._splash!==i.model.time.splash&&(i._splash=i.model.time.splash,i.readyOnce(),i.ready()),i._splash||(-1!==["time.start","time.end"].indexOf(e)&&i.changeLimits(),i._optionClasses())},"change:time.value":function(t,e){i._splash||i.model.time.dragging||i._setHandle(i.model.time.playing)},"change:time.start":function(t,e){i._splash||i.model.time.dragging||i._setHandle(i.model.time.playing)},"change:time.end":function(t,e){i._splash||i.model.time.dragging||i._setHandle(i.model.time.playing)}},this.ui=ot({show_limits:!1,show_value:!1,show_value_when_drag_play:!0,show_button:!0,class_axis_aligned:!1},t.ui,this.ui),this._super(t,e),this.width=0,this.height=0,this.getValueWidth=ie(this.getValueWidth),this._setTime=Ct(this._setTime,50)},readyOnce:function(){if(!this._splash){var t=this;this.element=W(this.element)?this.element:d3.select(this.element),this.element.classed(Qi,!1),this.slider_outer=this.element.select(".vzb-ts-slider"),this.slider=this.slider_outer.select("g"),this.axis=this.element.select(".vzb-ts-slider-axis"),this.slide=this.element.select(".vzb-ts-slider-slide"),this.handle=this.slide.select(".vzb-ts-slider-handle"),this.valueText=this.slide.select(".vzb-ts-slider-value"),this.xScale=d3.time.scale.utc().clamp(!0),this.xAxis=d3.svg.axis().orient("bottom").tickSize(0),this.valueText.attr("text-anchor","middle").attr("dy","-0.7em");var e=t._getBrushed(),i=t._getBrushedEnd();this.brush=d3.svg.brush().x(this.xScale).extent([0,0]).on("brush",function(){e.call(this)}).on("brushend",function(){i.call(this)}),this.slide.call(this.brush),this.slider_outer.on("mousewheel",function(){return t.model.time.dragging?(d3.event.stopPropagation(),d3.event.preventDefault(),d3.event.returnValue=!1,!1):void 0}),this.slide.selectAll(".extent,.resize").remove(),this.parent.on("myEvent",function(e,i){var a=t.getLayoutProfile();i.profile&&i.profile.margin&&(ea[a].margin=i.profile.margin),t.element.select(".vzb-ts-slider-wrapper").style("right",i.mRight-ea[a].margin.right+"px"),t.xScale.range([0,i.rangeMax]),t.resize()})}},ready:function(){if(!this._splash){var t=this.element.select(".vzb-ts-btn-play"),e=this.element.select(".vzb-ts-btn-pause"),i=this;this.model.time;t.on("click",function(){i.model.time.play()}),e.on("click",function(){i.model.time.pause("soft")}),this.changeLimits(),this.changeTime(),this.resize()}},changeLimits:function(){var t=this.model.time.start,e=this.model.time.end;this.xScale.domain([t,e]),this.xAxis.tickValues([t,e]).tickFormat(this.model.time.timeFormat)},changeTime:function(){this.ui.format=this.model.time.unit;this.model.time.value;this._optionClasses()},resize:function(){this.model.time.pause(),this.profile=this.getActiveProfile(ea,ia);var t=parseInt(this.slider_outer.style("width"),10),e=parseInt(this.slider_outer.style("height"),10);this.width=t-this.profile.margin.left-this.profile.margin.right,this.height=e-this.profile.margin.bottom-this.profile.margin.top;var i=this;this.slider.attr("transform","translate("+this.profile.margin.left+","+this.profile.margin.top+")"),(this.xScale.range()[1]=1)&&this.xScale.range([0,this.width]),this.xAxis=this.xAxis.scale(this.xScale).tickPadding(this.profile.label_spacing),this.axis.attr("transform","translate(0,"+this.height/2+")").call(this.xAxis),this.slide.select(".background").attr("height",this.height),this.handle.attr("transform","translate(0,"+this.height/2+")").attr("r",this.profile.radius),this.sliderWidth=i.slider.node().getBoundingClientRect().width,this._setHandle()},getValueWidth:function(t,e){return this.valueText.node().getBoundingClientRect().width},_getBrushed:function(){var t=this;return function(){t.model.time.playing&&t.model.time.pause(),t._optionClasses(),t.element.classed(Zi,!0);var e=t.brush.extent()[0];if(d3.event.sourceEvent){t.model.time.dragStart();var i=st(Math.round(d3.mouse(this)[0]),Ki);e=t.xScale.invert(i);var a=t.width;i>a?i=a:0>i&&(i=0),t.handle.attr("cx",i),t.valueText.attr("transform","translate("+i+","+t.height/2+")"),t.valueText.text(t.model.time.timeFormat(e))}e-t.model.time.value!==0&&t._setTime(e)}},_getBrushedEnd:function(){var t=this;return function(){t._setTime.recallLast(),t.element.classed(Zi,!1),t.model.time.dragStop(),t.model.time.snap()}},_setHandle:function(t){var e=this,i=this.model.time.value;this.slide.call(this.brush.extent([i,i]));var a=this.xScale(i);null==e.prevPosition&&(e.prevPosition=a);var n=a>e.prevPosition?this.model.time.delayAnimations:0;t?(this.handle.attr("cx",e.prevPosition).transition().duration(n).ease("linear").attr("cx",a),this.valueText.attr("transform","translate("+e.prevPosition+","+this.height/2+")").transition("text").delay(n).text(this.model.time.timeFormat(i)),
this.valueText.transition().duration(n).ease("linear").attr("transform","translate("+a+","+this.height/2+")")):(this.handle.interrupt().attr("cx",a),this.valueText.interrupt().interrupt("text").transition("text"),this.valueText.attr("transform","translate("+a+","+this.height/2+")").text(this.model.time.timeFormat(i))),e.prevPosition=a},_setTime:function(t){var e=this,i=!this.model.time.dragging&&!this.model.time.playing;e.model.time.getModelObject("value").set(t,!1,i)},_optionClasses:function(){var t=this.ui.show_limits,e=this.ui.show_value,i=this.ui.show_value_when_drag_play,a=this.ui.axis_aligned,n=this.ui.show_button&&this.model.time.playable;t||this.xAxis.tickValues([]).ticks(0),this.element.classed(Gi,!n),this.element.classed(Wi,this.model.time.playing),this.element.classed($i,e),this.element.classed(ta,i),this.element.classed(Ji,a)}}),na={EXTENT_MIN:0,EXTENT_MAX:1,TEXT_PARAMS:{TOP:18,LEFT:10,MAX_WIDTH:42,MAX_HEIGHT:16},BAR_WIDTH:6,THUMB_RADIUS:10,THUMB_STROKE_WIDTH:4,INTRO_DURATION:250,MARGIN:{TOP:2,LEFT:5,RIGHT:5}},sa={small:{minLabelTextSize:7,maxLabelTextSize:21,defaultLabelTextSize:12},medium:{minLabelTextSize:7,maxLabelTextSize:30,defaultLabelTextSize:15},large:{minLabelTextSize:6,maxLabelTextSize:48,defaultLabelTextSize:20}},ra=Xe.extend({init:function(t,e){function i(t,e){var i=n.model.size.extent||[na.EXTENT_MIN,na.EXTENT_MAX];n._updateLabels(i),n.sliderEl.call(n.brush.extent(i)),i[0]==i[1]&&n.sliderEl.selectAll(".resize").style("display","block")}function a(t){n.modelUse=n.model.size.use;var e=n.model.size.extent||[na.EXTENT_MIN,na.EXTENT_MAX];if("constant"!=n.modelUse)n.sizeScaleMinMax=n.model.size.getScale().domain(),n.sliderEl.selectAll(".w").classed("vzb-hidden",!1),n.sliderEl.select(".extent").classed("vzb-hidden",!1),n.sliderEl.select(".background").classed("vzb-pointerevents-none",!1),n._setLabelsText();else if(n.sliderEl.selectAll(".w").classed("vzb-hidden",!0),n.sliderEl.select(".extent").classed("vzb-hidden",!0),n.sliderEl.select(".background").classed("vzb-pointerevents-none",!0),!n.model.size.which){var i=n.propertyActiveProfile;e[1]=(i["default"]-i.min)/(i.max-i.min),n.model.size.which="_default"}n.sliderEl.call(n.brush.extent([e[0],e[1]])),n.sliderEl.call(n.brush.event)}this.name="sizeslider",this.template=this.template||"sizeslider.html",this.propertyName=t.propertyname,this.model_expects=[{name:"size",type:"size"},{name:"language",type:"language"}];var n=this;this.model_binds={"change:size.domainMin":i,"change:size.domainMax":i,"change:size.extent":i,ready:a},this._setModel=Ct(this._setModel,50),this._super(t,e)},readyOnce:function(){var t=this;t.model.size.extent||[na.EXTENT_MIN,na.EXTENT_MAX];this.element=d3.select(this.element),this.sliderSvg=this.element.select(".vzb-szs-svg"),this.sliderWrap=this.sliderSvg.select(".vzb-szs-slider-wrap"),this.sliderEl=this.sliderWrap.select(".vzb-szs-slider");var e=({v:na.TEXT_PARAMS.TOP,h:na.TEXT_PARAMS.LEFT},na.TEXT_PARAMS.MAX_WIDTH,na.TEXT_PARAMS.MAX_HEIGHT),i=na.BAR_WIDTH,a=na.THUMB_RADIUS,n=(na.THUMB_STROKE_WIDTH,{top:na.MARGIN.TOP+1.25*i,left:a,right:a,bottom:i+e}),s=this.element.node().offsetWidth;this.padding=n,this.propertyActiveProfile=this.getPropertyActiveProfile(),this.translator=this.model.language.getTFunction(),this.propertyScale=d3.scale.linear().domain([na.EXTENT_MIN,na.EXTENT_MAX]).range([this.propertyActiveProfile.min,this.propertyActiveProfile.max]).clamp(!0),this.xScale=d3.scale.linear().domain([na.EXTENT_MIN,na.EXTENT_MAX]).range([0,s-n.left-n.right]).clamp(!0),this.brush=d3.svg.brush().x(this.xScale).extent([na.EXTENT_MIN,na.EXTENT_MAX]).on("brush",function(){t._setFromExtent(!1,!1)}).on("brushend",function(){t.sliderEl.selectAll(".resize").style("display",null),t._setFromExtent(!0)}),this.sliderEl.call(t.brush),this.sliderEl.selectAll(".background").attr("style",""),this.sliderThumbs=this.sliderEl.selectAll(".resize").sort(d3.descending).classed("vzb-szs-slider-thumb",!0),this.sliderThumbs.append("g").attr("class","vzb-szs-slider-thumb-badge").append("path").attr("d",function(t,e){return"M0 "+.5*i+"l"+-a+" "+1.5*a+"h"+2*a+"Z"}),this.sliderThumbs.append("path").attr("class","vzb-szs-slider-thumb-arc"),this.sliderEl.selectAll("text").data([0,0]).enter().append("text").attr("class",function(t,e){return"vzb-szs-slider-thumb-label "+(e?"e":"w")}).attr("dy",1.25*-i+"px").attr("text-anchor",function(t,e){return 1-e?"start":"end"}),this.sliderLabelsEl=this.sliderEl.selectAll("text.vzb-szs-slider-thumb-label"),this.sliderEl.selectAll("rect").attr("height",i).attr("rx",.25*i).attr("ry",.25*i).attr("transform","translate(0,"+.5*-i+")"),this.sliderEl.select(".extent").classed("vzb-szs-slider-extent",!0),this.on("resize",function(){t.propertyActiveProfile=t.getPropertyActiveProfile(),t.propertyScale.range([t.propertyActiveProfile.min,t.propertyActiveProfile.max]);var e=t.element.node().offsetWidth;t.xScale.range([0,e-t.padding.left-t.padding.right]),t._updateSize(),t.sliderEl.call(t.brush.extent(t.brush.extent())).call(t.brush.event)}),this._updateSize(),t.sizeScaleMinMax=t.model.size.getScale().domain(),t.sizeScaleMinMax&&t._setLabelsText()},getPropertyActiveProfile:function(){var t=sa[this.getLayoutProfile()];return{min:t["min"+this.propertyName],max:t["max"+this.propertyName],"default":t["default"+this.propertyName]}},_updateSize:function(){this.sliderSvg.attr("height",this.propertyActiveProfile.max+this.padding.top+this.padding.bottom).attr("width","100%"),this.sliderWrap.attr("transform","translate("+this.padding.left+","+(this.propertyActiveProfile.max+this.padding.top)+")")},_updateLabels:function(t){var e=this,i=function(t,i){var a=e.xScale(i),n=0;return"translate("+a+","+n+")"};this.sliderLabelsEl.data(t).attr("transform",i).attr("font-size",function(t,i){return e.propertyScale(t)}),"constant"===e.model.size.use&&this.sliderLabelsEl.data(t).text(function(t){return~~e.propertyScale(t)+(e.translator(e.ui.constantUnit)||"")})},_setLabelsText:function(){var t=this;t.sliderLabelsEl.data([t.model.size.tickFormatter(t.sizeScaleMinMax[0]),t.model.size.tickFormatter(t.sizeScaleMinMax[1])]).text(function(t){return t})},_setFromExtent:function(t,e){var i=this.brush.extent();this._updateLabels(i),this._setModel(i,t,e)},_setModel:function(t,e,i){t=[+t[0].toFixed(2),+t[1].toFixed(2)],this.model.size.set({extent:t},e,i)}}),la=Xe.extend({init:function(t,e){this.template='<div class="vzb-ss-holder"><input type="range" id="vzb-ss-slider" class="vzb-ss-slider" step="1"></div>',this.model_expects=[{name:"submodel"}];var i=this;this.name="gapminder-simpleSlider",this.arg=t.arg,this.thumb_size=t.thumb_size,this.slider_properties=t.properties,this.model_binds={},this.model_binds["change:submodel."+this.arg]=function(t){i.updateView()},this._super(t,e),this._setModel=Ct(this._setModel,50)},readyOnce:function(){var t=0,e=1,i=.1,a=t,n=this;this.element=d3.select(this.element),this.slider=this.element.selectAll("#vzb-ss-slider"),this.elementSize=this.element.node().getBoundingClientRect(),this.sliderSize=this.slider.node().getBoundingClientRect(),this.slider.style("left",this.elementSize.left-this.sliderSize.left+"px"),this.slider_properties&&(null!=this.slider_properties.min&&(t=this.slider_properties.min),null!=this.slider_properties.max&&(e=this.slider_properties.max),null!=this.slider_properties.step&&(i=this.slider_properties.step),this.slider_properties.scale&&(a=this.slider_properties.scale(t))),this.roundTo=i>1?0:Math.round(Math.abs(Math.log(i)/Math.LN10)),this.thumb_size&&(this.slider.classed("vzb-ss-slider",!1),this.slider.classed("vzb-ss-slider-"+this.thumb_size,!0)),this.slider.attr("min",t).attr("max",e).attr("step",i).attr("value",a).on("input",function(){var t=+d3.event.target.value;n._setModel(t,!1,!1)}).on("change",function(){var t=+d3.event.target.value;n._setModel(t,!0)}),this.updateView()},updateView:function(){var t,e=this.model.submodel[this.arg],i=this.slider_properties;i&&(t=i.scale),t&&(e=t.invert(e)),this.slider.node().value=e},_setModel:function(t,e,i){this.slider_properties&&this.slider_properties.scale&&(t=this.slider_properties.scale(t)),this.model.submodel.getModelObject(this.arg).set(t.toFixed(this.roundTo),e,i)}}),oa=Xe.extend({init:function(t,e){this.template='<span class="vzb-sc-holder vzb-dialog-checkbox"><input type="checkbox"><label></label></span>';var i=this;this.name="gapminder-simplecheckbox",this.checkbox=t.checkbox,this.submodel=t.submodel,this.model_expects=[{name:"mdl"},{name:"language",type:"language"}],this.model_binds={"change:mdl":function(t){i.updateView()},"change:language.strings":function(t){i.updateView()}};var a=this.submodel?this.submodel+":":"";this.model_binds["change:mdl."+a+this.checkbox]=function(){i.updateView()},this._super(t,e)},ready:function(){this.parentModel=this.submodel?this.model.mdl[this.submodel]:this.model.mdl,this.updateView()},readyOnce:function(){var t=this;this.element=d3.select(this.element);var e="-check-"+1e3*Math.random();this.labelEl=this.element.select("label").attr("for",e),this.checkEl=this.element.select("input").attr("id",e).on("change",function(){t._setModel(d3.select(this).property("checked"))})},updateView:function(){this.translator=this.model.language.getTFunction(),this.labelEl.text(this.translator("check/"+this.checkbox)),this.checkEl.property("checked",!!this.parentModel[this.checkbox])},_setModel:function(t){this.parentModel[this.checkbox]=t}}),ca="domainMin",ha="domainMax",da="zoomedMin",ua="zoomedMax",ma=Xe.extend({init:function(t,e){this.name="gapminder-minmaxinputs",this.template="minmaxinputs.html";var i=this;this.model_expects=[{name:"marker",type:"model"},{name:"language",type:"language"}],this.markerID=t.markerID,t.markerID||kt("minmaxinputs.js complains on 'markerID' property: "+t.markerID),this.model_binds={},this.model_binds["change:language.strings"]=function(t){i.updateView()},this.model_binds["change:marker."+this.markerID]=function(t){i.updateView()},this.model_binds.ready=function(t){i.updateView()},this._super(t,e),this.ui=ot({selectDomainMinMax:!1,selectZoomedMinMax:!1},this.ui.getPlainObject())},ready:function(){this.updateView()},readyOnce:function(){var t=this;this.element=d3.select(this.element),this.el_domain_labelMin=this.element.select(".vzb-mmi-domainmin-label"),this.el_domain_labelMax=this.element.select(".vzb-mmi-domainmax-label"),this.el_domain_fieldMin=this.element.select(".vzb-mmi-domainmin"),this.el_domain_fieldMax=this.element.select(".vzb-mmi-domainmax"),this.el_break=this.element.select(".vzb-mmi-break"),this.el_zoomed_labelMin=this.element.select(".vzb-mmi-zoomedmin-label"),this.el_zoomed_labelMax=this.element.select(".vzb-mmi-zoomedmax-label"),this.el_zoomed_fieldMin=this.element.select(".vzb-mmi-zoomedmin"),this.el_zoomed_fieldMax=this.element.select(".vzb-mmi-zoomedmax"),t.el_domain_fieldMin.on("change",function(){t._setModel(ca,this.value)}),t.el_domain_fieldMax.on("change",function(){t._setModel(ha,this.value)}),t.el_zoomed_fieldMin.on("change",function(){t._setModel(da,this.value)}),t.el_zoomed_fieldMax.on("change",function(){t._setModel(ua,this.value)}),this.element.selectAll("input").on("keypress",function(t){13==d3.event.which&&document.activeElement.blur()})},updateView:function(){this.translator=this.model.language.getTFunction(),this.el_domain_labelMin.text(this.translator("min")+":"),this.el_domain_labelMax.text(this.translator("max")+":"),this.el_zoomed_labelMin.text(this.translator("min")+":"),this.el_zoomed_labelMax.text(this.translator("max")+":"),this.el_domain_labelMin.classed("vzb-hidden",!this.ui.selectDomainMinMax),this.el_domain_labelMax.classed("vzb-hidden",!this.ui.selectDomainMinMax),this.el_domain_fieldMin.classed("vzb-hidden",!this.ui.selectDomainMinMax),this.el_domain_fieldMax.classed("vzb-hidden",!this.ui.selectDomainMinMax),this.el_break.classed("vzb-hidden",!(this.ui.selectDomainMinMax&&this.ui.selectZoomedMinMax)),this.el_zoomed_labelMin.classed("vzb-hidden",!this.ui.selectZoomedMinMax),this.el_zoomed_labelMax.classed("vzb-hidden",!this.ui.selectZoomedMinMax),this.el_zoomed_fieldMin.classed("vzb-hidden",!this.ui.selectZoomedMinMax),this.el_zoomed_fieldMax.classed("vzb-hidden",!this.ui.selectZoomedMinMax);var t=d3.format(".2r");this.el_domain_fieldMin.property("value",t(this.model.marker[this.markerID].getScale().domain()[0])),this.el_domain_fieldMax.property("value",t(this.model.marker[this.markerID].getScale().domain()[1])),this.el_zoomed_fieldMin.property("value",t(this.model.marker[this.markerID].zoomedMin)),this.el_zoomed_fieldMax.property("value",t(this.model.marker[this.markerID].zoomedMax))},_setModel:function(t,e){this.model.marker[this.markerID][t]=rt(e)}}),ga=Xe.extend({init:function(t,e){this.name="gapminder-indicatorpicker",this.template='<span class="vzb-ip-select"></span>';var i=this;this.model_expects=[{name:"marker",type:"model"},{name:"language",type:"language"}],this.markerID=t.markerID,t.markerID||kt("indicatorpicker.js complains on 'markerID' property: "+t.markerID),this.model_binds={"change:language.strings":function(t){i.updateView()},"change:marker":function(t){i.updateView()},ready:function(t){i.updateView()}},this._super(t,e)},ready:function(){this.updateView()},readyOnce:function(){var t=this;this.el_select=d3.select(this.element),this.el_select.on("click",function(){var e=t.el_select.node().getBoundingClientRect(),i=t.root.element.getBoundingClientRect(),a=t.root.findChildByName("gapminder-treemenu"),n=a.activeProfile.col_width,s=parseInt(a.wrapper.style("padding-left"),10)||0,r=parseInt(a.wrapper.style("padding-right"),10)||0,l=e.bottom-i.top,o=e.left-i.left-.5*(s+r+n-e.width);a.markerID(t.markerID).alignX("left").alignY("top").top(l).left(o).updateView().toggle()})},updateView:function(){if(this._readyOnce){this.translator=this.model.language.getTFunction();var t=this.model.marker[this.markerID].which,e=this.model.marker[this.markerID]._type;this.el_select.text(this.translator("indicator"+("_default"===t?"/"+e:"")+"/"+t))}}}),pa=Xe.extend({init:function(t,e){this.template='<span class="vzb-dl-holder"><ul class="vzb-draggable list vzb-dialog-scrollable"></ul></span>';var i=this;this.name="draggableList",this.dataArrFn=t.dataArrFn,this.lang=t.lang,this.model_expects=[{name:"group",type:"model"},{name:"language",type:"language"}],this.groupID=t.groupID,t.groupID||kt("draggablelist.js complains on 'groupID' property: "+t.groupID),this.model_binds={"change:language.strings":function(t){i.updateView()}},this.model_binds["change:group."+this.groupID]=function(t){i.updateView()},this._super(t,e),this.updateData=ae(this.updateData,1e3),this.itemDragger=d3.behavior.drag().on("dragstart",function(t,e){i.dataUpdateFlag||(d3.event.sourceEvent.stopPropagation(),i.parentBoundRect=i.element.node().getBoundingClientRect(),i.element.selectAll("div").each(function(e,a){var n=this.getBoundingClientRect();e._y=n.top,e._top=0,t.data===e.data&&(e._height=n.height,i.selectedNode=this)}),d3.select(i.selectedNode).classed("dragged",!0))}).on("drag",function(t,e){if(!i.dataUpdateFlag){t._top+=d3.event.dy;var a=t._y+t._top;a>i.parentBoundRect.top&&a+t._height<i.parentBoundRect.top+i.parentBoundRect.height&&i.itemsEl.style("top",function(i,n){var s=0;return e>n&&i._y+.5*t._height>a?s=t._height:n>e&&i._y-.5*t._height<a&&(s=-t._height),n!=e&&(i._top=s),i._top+"px"})}}).on("dragend",function(t,e){i.dataUpdateFlag||i.getData()})},ready:function(){var t=this;this.updateView(),this.itemsEl=this.element.selectAll("div"),this.itemsEl.call(t.itemDragger);this.itemsEl.select("li").on("mouseover",function(){d3.select(this).classed("hover",!0)}).on("mouseout",function(){d3.select(this).classed("hover",!1)}).on("touchstart",function(){d3.event.preventDefault()})},updateView:function(){var t=this;this.translator=this.model.language.getTFunction(),this.items=this.element.selectAll("div").data(function(){return t.dataArrFn().map(function(t){return{data:t}})}),this.items.enter().append("div").attr("draggable",!0).append("li"),this.items.select("li").classed("hover",!1).each(function(e,i){d3.select(this).attr("data",e.data).text(t.translator(t.lang+e.data))}),this.items.exit().remove(),this.element.selectAll("div").style("top","").classed("dragged",!1),this.dataUpdateFlag=!1},getData:function(){var t=[],e=this.element.selectAll("div").data();t=e.sort(function(t,e){return t._y+t._top-(e._y+e._top)}).map(function(t){return t.data}),et(this.dataArrFn(),t)?this.updateView():(this.dataUpdateFlag=!0,this.updateData(t))},updateData:function(t){this.dataArrFn(t)},readyOnce:function(){this.element=d3.select(this.element).select(".list")}}),fa=Xe.extend({init:function(t,e){this.name=this.name||"",this.model_expects=this.model_expects||[{name:"state",type:"model"},{name:"ui",type:"model"},{name:"language",type:"language"}],this.template=this.name+".html",this._super(t,e)},readyOnce:function(){this.element=d3.select(this.element)},ready:function(){var t=this;this.placeholderEl=d3.select(this.placeholder),this.rootEl=d3.select(this.root.element),this.dragHandler=this.placeholderEl.select("[data-click='dragDialog']"),this.dragHandler.html(ci),this.pinIcon=this.placeholderEl.select("[data-click='pinDialog']"),this.pinIcon.html(di),this.dragContainerEl=d3.select(".vzb-tool"),this.topPos="";var e=this.getLayoutProfile(),i=A(this.placeholderEl,this.dragContainerEl,10),a=d3.behavior.drag().on("dragstart",function(){var e=t.placeholderEl.node().offsetTop;t.placeholderEl.style({top:e+"px",bottom:"auto"}),t.trigger("dragstart"),i.dragStart(d3.event)}).on("drag",function(){t.trigger("drag"),i.drag(d3.event)}).on("dragend",function(){t.rightPos=t.placeholderEl.style("right"),t.topPos=t.placeholderEl.style("top"),t.trigger("dragend")});this.dragHandler.call(a),this.dragHandler.classed("vzb-hidden","small"===e),this.pinIcon.classed("vzb-hidden","small"===e),this.resize()},resize:function(){if(this.placeholderEl&&this.dragContainerEl&&this.placeholderEl.classed("vzb-top-dialog")){var t=this.getLayoutProfile();if("small"!==t){var e=parseInt(this.dragContainerEl.style("width"),10),i=parseInt(this.rightPos,10),a=parseInt(this.rootEl.style("height"),10),n=parseInt(this.topPos,10),s=parseInt(this.placeholderEl.style("width"),10),r=parseInt(this.placeholderEl.style("height"),10),l=parseInt(this.placeholderEl.style("margin-right"),10)||0;$(i)&&i>e-s-l&&this.rightPos&&(this.rightPos=e-s-l+"px",this.isOpen&&this.placeholderEl.style("right",this.rightPos)),$(n)&&$(r)&&n>=0&&n>a-r&&this.topPos&&(this.topPos=(a-r>0?a-r:0)+"px",this.isOpen&&this.placeholderEl.style("top",this.topPos)),this.topPos&&"large"===this.getLayoutProfile()&&this.rootEl.classed("vzb-dialog-expand-true")&&this.placeholderEl.style("bottom","auto"),this.rootEl.classed("vzb-landscape"),this.element.style("max-height","")}else this.rightPos="",this.topPos="",this.placeholderEl.attr("style","");this.dragHandler.classed("vzb-hidden","small"===t),this.pinIcon.classed("vzb-hidden","small"===t),this._setMaxHeight()}},_setMaxHeight:function(){var t=this.root.element.offsetHeight;if("small"!==this.getLayoutProfile())if(!this.topPos&&"large"===this.getLayoutProfile()&&this.rootEl.classed("vzb-dialog-expand-true")){var e=parseInt(this.placeholderEl.style("bottom"),10);t-=e}else{var i=this.topPos?parseInt(this.topPos,10):this.placeholderEl[0][0].offsetTop;t-=i}else t=this.rootEl.classed("vzb-portrait")?t-50:t-10;this.element.style("max-height",t+"px")},beforeOpen:function(){var t=this;if(this.transitionEvents=["webkitTransitionEnd","transitionend","msTransitionEnd","oTransitionEnd"],this.transitionEvents.forEach(function(e){t.placeholderEl.on(e,t.transitionEnd.bind(t,e))}),this.placeholderEl.classed("notransition",!0),this.placeholderEl.style({top:"",bottom:""}),this.topPos&&"large"===this.getLayoutProfile()&&this.rootEl.classed("vzb-dialog-expand-true")){var e=this.placeholderEl.node().offsetTop;this.placeholderEl.style({top:e+"px",bottom:"auto"})}else"small"!==this.getLayoutProfile();this.placeholderEl.node().offsetTop,this.placeholderEl.classed("notransition",!1),"small"===this.getLayoutProfile()?this.placeholderEl.style("top",""):this.rootEl.classed("vzb-landscape")},open:function(){this.isOpen=!0,"small"!==this.getLayoutProfile()&&this.topPos&&(this.placeholderEl.style("top",this.topPos),this.placeholderEl.style("right",this.rightPos))},beforeClose:function(){this.rootEl.classed("vzb-portrait")&&"small"===this.getLayoutProfile()&&this.placeholderEl.style("top","auto"),"large"===this.getLayoutProfile()&&this.rootEl.classed("vzb-dialog-expand-true")&&(this.topPos0=this.topPos?this.placeholderEl.node().parentNode.offsetHeight-this.placeholderEl.node().offsetHeight+"px":""),this.placeholderEl.classed("notransition",!1),this.placeholderEl.node().offsetHeight},close:function(){this.rootEl.classed("vzb-portrait")&&"small"===this.getLayoutProfile()||(this.placeholderEl.style("top",""),this.placeholderEl.style("right","")),"large"===this.getLayoutProfile()&&this.rootEl.classed("vzb-dialog-expand-true")&&this.placeholderEl.style({top:this.topPos0,right:""}),this.isOpen=!1,this.trigger("close")},transitionEnd:function(t){var e=this;this.transitionEvents.forEach(function(t){e.placeholderEl.on(t,null)}),this.isOpen&&this.placeholderEl.classed("notransition",!0)}}),va=fa.extend({init:function(t,e){this.name="zoom",this.components=[{component:qi,placeholder:".vzb-dialog-zoom-buttonlist",model:["state","ui","language"]},{component:oa,placeholder:".vzb-nozoomonscrolling-switch",model:["ui","language"],checkbox:"noZoomOnScrolling"}],this._super(t,e)}}),ba=fa.extend({init:function(t,e){this.name="stack";var i=this;this.components=[{component:pa,placeholder:".vzb-dialog-draggablelist",model:["state.marker.group","language"],groupID:"manualSorting",dataArrFn:i.manualSorting.bind(i),lang:"region/"}],this.model_binds={"change:state.marker.stack":function(t){i.updateView()},"change:state.marker.group":function(t){i.updateView()}},this._super(t,e)},readyOnce:function(){this._super();var t=this;this.group=this.model.state.marker.group,this.stack=this.model.state.marker.stack,this.howToStackEl=this.element.select(".vzb-howtostack").selectAll("input").on("change",function(){t.setModel("stack",d3.select(this).node().value)}),this.howToMergeEl=this.element.select(".vzb-howtomerge").selectAll("input").on("change",function(){t.setModel("merge",d3.select(this).node().value)}),this.updateView()},updateView:function(){var t=this;this.howToStackEl.property("checked",function(){return d3.select(this).node().value===t.stack.which}),this.howToMergeEl.property("checked",function(){return"none"===d3.select(this).node().value?!t.group.merge&&!t.stack.merge:"grouped"===d3.select(this).node().value?t.group.merge:"stacked"===d3.select(this).node().value?t.stack.merge:void 0}).attr("disabled",function(){return"none"===d3.select(this).node().value?null:"grouped"===d3.select(this).node().value?"none"===t.stack.which?!0:null:"stacked"===d3.select(this).node().value?"all"===t.stack.which?null:!0:void 0})},manualSorting:function(t){return 0===arguments.length?this.model.state.marker.group.manualSorting:void(this.model.state.marker.group.manualSorting=t)},setModel:function(t,e){var i={stack:{},group:{}};if("merge"===t)switch(e){case"none":i.group.merge=!1,i.stack.merge=!1;break;case"grouped":i.group.merge=!0,i.stack.merge=!1;break;case"stacked":i.group.merge=!1,i.stack.merge=!0}"stack"===t&&(i.stack.which=e,"all"!==e&&"none"!==e?i.stack.use="property":i.stack.use="constant","none"===e&&this.group.merge&&(i.group.merge=!1),"all"!==e&&this.stack.merge&&(i.stack.merge=!1)),this.model.state.marker.set(i)}}),ya=fa.extend({init:function(t,e){this.name="speed",this.components=[{component:la,placeholder:".vzb-dialog-placeholder",model:["state.time"],arg:"delay",properties:{min:1,max:5,step:.1,scale:d3.scale.linear().domain([1,2,3,4,5]).range([1200,900,450,200,75])}}],this._super(t,e)}}),xa=fa.extend({init:function(t,e){this.name="size",this.components=[{component:Wa,placeholder:".vzb-dialog-bubblesize",model:["state.marker.size"],ui:{show_button:!1}},{component:ga,placeholder:".vzb-saxis-selector",model:["state.marker","language"],markerID:"size"}],this._super(t,e)}}),_a=fa.extend({init:function(t,e){this.name="show";var i=this;this.model_binds={"change:state.entities.show":function(t){i.redraw()}},this._super(t,e)},readyOnce:function(){this._super(),this.list=this.element.select(".vzb-show-list"),this.input_search=this.element.select("#vzb-show-search"),this.deselect_all=this.element.select("#vzb-show-deselect"),this.KEY=this.model.state.entities.getDimension(),this.TIMEDIM=this.model.state.time.getDimension();var t=this;this.input_search.on("input",function(){t.showHideSearch()}),this.deselect_all.on("click",function(){t.deselectEntities()}),this.root.on("ready",function(){t.redraw()})},open:function(){this._super(),this.input_search.node().value="",this.showHideSearch()},ready:function(){this._super(),this.redraw(),xt(this.element.select(".vzb-dialog-scrollable"))},redraw:function(){var t=this;this.translator=this.model.language.getTFunction(),this.model.state.marker_allpossible.getFrame(this.model.state.time.value,function(e){var i=It(e.label).map(function(i){var a={};return a[t.KEY]=i,a.label=e.label[i],a});i.sort(function(t,e){return t.label<e.label?-1:1}),t.list.html("");var a=t.list.selectAll(".vzb-show-item").data(i).enter().append("div").attr("class","vzb-show-item vzb-dialog-checkbox");a.append("input").attr("type","checkbox").attr("class","vzb-show-item").attr("id",function(e){return"-show-"+e[t.KEY]}).property("checked",function(e){return t.model.state.entities.isShown(e)}).on("change",function(e){t.model.state.entities.showEntity(e),t.showHideDeselect()}),a.append("label").attr("for",function(e){return"-show-"+e[t.KEY]}).text(function(t){return t.label}),t.input_search.attr("placeholder",t.translator("placeholder/search")+"..."),t.showHideSearch(),t.showHideDeselect()})},showHideSearch:function(){var t=this.input_search.node().value||"";t=t.toLowerCase(),this.list.selectAll(".vzb-show-item").classed("vzb-hidden",function(e){var i=e.label.toLowerCase();return-1===i.indexOf(t)})},showHideDeselect:function(){var t=this.model.state.entities.show[this.KEY];this.deselect_all.classed("vzb-hidden",!t||"*"===t[0])},deselectEntities:function(){this.model.state.entities.clearShow(),this.showHideDeselect()},transitionEnd:function(t){this._super(t),ne()||this.input_search.node().focus()}}),Ma=fa.extend({init:function(t,e){this.name="presentation",this.components=[{component:oa,placeholder:".vzb-presentationmode-switch",model:["ui","language"],checkbox:"presentation"}],this._super(t,e)}}),za=fa.extend({init:function(t,e){this.name="opacity",this.components=[{component:la,placeholder:".vzb-dialog-bubbleopacity-regular",model:["state.entities"],arg:"opacityRegular",properties:{step:.01}},{component:la,placeholder:".vzb-dialog-bubbleopacity-selectdim",model:["state.entities"],arg:"opacitySelectDim",properties:{step:.01}}],this._super(t,e)}}),wa="vzb-active",ka="vzb-hidden",Sa="vzb-active-locked",Ea="vzb-unavailable",Ta="vzb-force-fullscreen",La="vzb-container-fullscreen",Oa=Xe.extend({init:function(t,e){var i=this;this.name=this.name||"gapminder-buttonlist",this.model_expects=[{name:"state",type:"model"},{name:"ui",type:"model"},{name:"language",type:"language"}],this._available_buttons={find:{title:"buttons/find",icon:"search",required:!1},show:{title:"buttons/show",icon:"asterisk",required:!1},moreoptions:{title:"buttons/more_options",icon:"gear",required:!0},colors:{title:"buttons/colors",icon:"paintbrush",required:!1},size:{title:"buttons/size",icon:"circle",required:!1},fullscreen:{title:"buttons/expand",icon:"expand",func:this.toggleFullScreen.bind(this),required:!0},trails:{title:"buttons/trails",icon:"trails",func:this.toggleBubbleTrails.bind(this),required:!1,statebind:"ui.chart.trails",statebindfunc:this.setBubbleTrails.bind(this)},lock:{title:"buttons/lock",icon:"lock",func:this.toggleBubbleLock.bind(this),required:!1,statebind:"ui.chart.lockNonSelected",statebindfunc:this.setBubbleLock.bind(this)},presentation:{title:"buttons/presentation",icon:"presentation",func:this.togglePresentationMode.bind(this),required:!1,statebind:"ui.presentation",statebindfunc:this.setPresentationMode.bind(this)},about:{title:"buttons/about",icon:"about",required:!1},axes:{title:"buttons/axes",icon:"axes",required:!1},axesmc:{title:"buttons/axesmc",icon:"axes",required:!1},stack:{title:"buttons/stack",icon:"stack",required:!1},_default:{title:"Button",icon:"asterisk",required:!1}},this._active_comp=!1,this.model_binds={"change:state.entities.select":function(t){i._readyOnce&&(i.setBubbleTrails(),i.setBubbleLock(),i._toggleButtons())}},t.ui.buttons.forEach(function(t){var e=i._available_buttons[t];e&&e.statebind&&(i.model_binds["change:"+e.statebind]=function(i){e.statebindfunc(t,i.source.value)})}),this.validatePopupButtons(t.ui.buttons,t.ui.dialogs),this._super(t,e)},readyOnce:function(){var t=this;this.element=d3.select(this.placeholder),this.element.selectAll("div").remove(),this.root.findChildByName("gapminder-dialogs").on("close",function(e,i){t.setButtonActive(i.id,!1)});var e=(this.model.ui.dialogs||{}).sidebar||[],i=[].concat(this.model.ui.buttons);this.model.ui.buttons=i,this._addButtons(i,e),this._prev_body_overflow=document.body.style.overflow,this.setBubbleTrails(),this.setBubbleLock(),this.setPresentationMode(),this._toggleButtons()},proceedClick:function(t){var e=this,i=e.element.selectAll(".vzb-buttonlist-btn[data-btn='"+t+"']"),a=i.attr("class"),n=e._available_buttons[t];if(n&&n.func)n.func(t);else{var s=-1===a.indexOf(wa);i.classed(wa,s);var r={};r.id=t,r.active=s,e.trigger("click",r)}},validatePopupButtons:function(t,e){for(var i=this,a=e.popup,n=t.filter(function(t){return i._available_buttons[t]&&!i._available_buttons[t].func}),s=0,r=n.length;r>s;s++)if(-1==a.indexOf(n[s]))return Tt('Buttonlist: bad buttons config: "'+n[s]+'" is missing in popups list');return!1},_showAllButtons:function(){var t=this.element.selectAll(".vzb-buttonlist-btn");t.each(function(t,e){var i=d3.select(this);i.style("display","")})},_toggleButtons:function(){var t=this,e=this.parent.element.node?this.parent.element:d3.select(this.parent.element),i=(this.model.ui.dialogs||{}).sidebar||[];t._showAllButtons();var a=this.element.selectAll(".vzb-buttonlist-btn"),n=(this.element.node().getBoundingClientRect(),[]),s=[],r=80,l=80,o=this.element.node().getBoundingClientRect().width,c=this.element.node().getBoundingClientRect().height,h=0,d=0;a.each(function(e,a){var o=e,c=d3.select(this),u=-1!==i.indexOf(o.id),m={top:parseInt(c.style("margin-top")),right:parseInt(c.style("margin-right")),left:parseInt(c.style("margin-left")),bottom:parseInt(c.style("margin-bottom"))};r=c.node().getBoundingClientRect().width+m.right+m.left,l=c.node().getBoundingClientRect().height+m.top+m.bottom,c.classed(ka)||(u&&"large"===t.getLayoutProfile()?c.style("display","none"):(h+=r,d+=l,o.required?s.push(c):n.push(c)))});var u=h-o,m=d-c,g=1;e.classed("vzb-large")&&e.classed("vzb-dialog-expand-true")||e.classed("vzb-small")&&e.classed("vzb-portrait")?(u>0&&10>=u&&(o+=u),g=Math.floor(o/r)-s.length,0>g&&(g=0)):(m>0&&10>=m&&(c+=m),g=Math.floor(c/l)-s.length,0>g&&(g=0)),n.reverse();for(var p=[],f=0,v=n.length-g;v>f;f++)n[f].style("display","none"),p.push(n[f].attr("data-btn"));var b={};b.hiddenButtons=p,t.trigger("toggle",b)},_addButtons:function(t,e){var i=this;this._components_config=[];var a=[];if(t.length){for(var n=0;n<t.length;n++){var s=t[n],r=this._available_buttons[s],l=r?s:"_default",o=dt(this._available_buttons[l]);o.id=s,o.icon=xi[o.icon],a.push(o)}var c=this.getTranslationFunction(!0);this.element.selectAll("button").data(a).enter().append("button").attr("class",function(t){var i="vzb-buttonlist-btn";return e.length>0&&e.indexOf(t.id)>-1&&(i+=" vzb-dialog-side-btn"),i}).attr("data-btn",function(t){return t.id}).html(function(t){return"<span class='vzb-buttonlist-btn-icon fa'>"+t.icon+"</span><span class='vzb-buttonlist-btn-title'>"+c(t.title)+"</span>";
});var h=this.element.selectAll(".vzb-buttonlist-btn");h.on("click",function(){d3.event.preventDefault(),d3.event.stopPropagation();var t=d3.select(this).attr("data-btn");i.proceedClick(t)})}},scrollToEnd:function(){var t=0,e=d3.select(".vzb-tool");e.classed("vzb-portrait")&&e.classed("vzb-small")?(this.model.state.entities.select.length>0&&(t=this.element[0][0].scrollWidth),this.element[0][0].scrollLeft=t):(this.model.state.entities.select.length>0&&(t=this.element[0][0].scrollHeight),this.element[0][0].scrollTop=t)},resize:function(){"small"===this.getLayoutProfile()&&this.model.ui.presentation&&this.togglePresentationMode(),this._toggleButtons()},setButtonActive:function(t,e){var i=this.element.selectAll(".vzb-buttonlist-btn[data-btn='"+t+"']");i.classed(wa,e)},toggleBubbleTrails:function(){this.model.ui.chart.trails=!this.model.ui.chart.trails,this.setBubbleTrails()},setBubbleTrails:function(){var t=(this.model.ui.chart||{}).trails;if(t||t===!1){var e="trails",i=this.element.selectAll(".vzb-buttonlist-btn[data-btn='"+e+"']");if(!i.node())return kt("setBubbleTrails: no button '"+e+"' found in DOM. doing nothing");i.classed(Sa,t),i.classed(ka,0==this.model.state.entities.select.length)}},toggleBubbleLock:function(t){if(0!=this.model.state.entities.select.length){var e=this.model.ui.chart.lockNonSelected,i=this.model.state.time;e=e?0:i.timeFormat(i.value),this.model.ui.chart.lockNonSelected=e,this.setBubbleLock()}},setBubbleLock:function(){var t=(this.model.ui.chart||{}).lockNonSelected;if(t||0===t){0!==t&&0===this.model.state.entities.select.length&&(t=this.model.ui.chart.lockNonSelected=0);var e="lock",i=this.element.selectAll(".vzb-buttonlist-btn[data-btn='"+e+"']");if(!i.node())return kt("setBubbleLock: no button '"+e+"' found in DOM. doing nothing");var a=this.model.language.getTFunction();i.classed(Ea,0==this.model.state.entities.select.length),i.classed(ka,0==this.model.state.entities.select.length),i.classed(Sa,t),i.select(".vzb-buttonlist-btn-title").text(t?t:a("buttons/lock")),i.select(".vzb-buttonlist-btn-icon").html(xi[t?"lock":"unlock"])}},togglePresentationMode:function(){this.model.ui.presentation=!this.model.ui.presentation,this.setPresentationMode()},setPresentationMode:function(){var t="presentation",e=(this.model.language.getTFunction(),this.element.selectAll(".vzb-buttonlist-btn[data-btn='"+t+"']"));e.classed(Sa,this.model.ui.presentation)},toggleFullScreen:function(t){if(window){for(var e=this,i=e.placeholder,a=!1,n=this.element.selectAll(".vzb-buttonlist-btn[data-btn='"+t+"']"),s=!this.model.ui.fullscreen,r=s?"hidden":this._prev_body_overflow;!(a=Dt(i,"vzb-placeholder"));)e=e.parent,i=e.placeholder;s?(q(i),C.call(this,this.toggleFullScreen.bind(this,t))):R.call(this),Pt(i,Ta,s),"undefined"!=typeof container&&Pt(container,La,s),this.model.ui.fullscreen=s;var l=this.model.language.getTFunction();n.classed(Sa,s),n.select(".vzb-buttonlist-btn-icon").html(xi[s?"unexpand":"expand"]),n.select(".vzb-buttonlist-btn-title>span").text(l("buttons/"+(s?"unexpand":"expand"))).attr("data-vzb-translate","buttons/"+(s?"unexpand":"expand")),document.body.style.overflow=r,this.root.layout.resizeHandler()}}}),Aa="vzb-active",Pa=Oa.extend({init:function(t,e){this.name="gapminder-optionsbuttonlist",this._super(t,e)},readyOnce:function(){var t=this;Object.keys(this._available_buttons).forEach(function(e){var i=t._available_buttons[e];i.required=!i.required}),this.buttonListComp=this.root.findChildByName("gapminder-buttonlist"),this.buttonListComp.on("click",function(e,i){var a=t.element.selectAll(".vzb-buttonlist-btn[data-btn='"+i.id+"']");a.classed(Aa,i.active)}),this.buttonListComp.on("toggle",function(e,i){var a=t.element.selectAll(".vzb-buttonlist-btn"),n=0;a.each(function(t){var e=d3.select(this),a=-1==i.hiddenButtons.indexOf(t.id);e.style("display",a?"none":""),a||n++})}),this._super()},proceedClick:function(t){var e=this;this.buttonListComp.proceedClick(t);var i=this.element.selectAll(".vzb-buttonlist-btn[data-btn='"+t+"']").datum();i.func&&Kt(function(){e.root.findChildByName("gapminder-dialogs").closeAllDialogs()},200)},_toggleButtons:function(){}}),Da=fa.extend({init:function(t,e){this.name="moreoptions",this.components=[{component:Pa,placeholder:".vzb-dialog-options-buttonlist",model:["state","ui","language"]}],this._super(t,e)},readyOnce:function(){this._super();var t=this;this.contentEl=this.element.select(".vzb-dialog-content"),this.accordionEl=this.element.select(".vzb-accordion"),this.on("dragend",function(){t._setMaxHeight()});var e=(this.model.ui.dialogs||{}).popup||[],i=(this.model.ui.dialogs||{}).moreoptions||[];if(i===!0&&(i=e,(this.model.ui.dialogs||{}).moreoptions=i),this._addDialogs(i),this.accordionEl){var a=this.accordionEl.selectAll(".vzb-accordion-section").select(".vzb-dialog-title>span:first-child");a.on("click",function(e){var i=(t.components[e.component].element,t.components[e.component].placeholderEl),a=t.accordionEl.select(".vzb-accordion-active");a&&a.classed("vzb-accordion-active",!1),i.node()!==a.node()&&i.classed("vzb-accordion-active",!0)})}},_addDialogs:function(t){this._components_config=[];var e=[];if(t.length){for(var i=0;i<t.length;i++)if("moreoptions"!==t[i]){var a=t[i],n=ut(this.parent._available_dialogs[a]);if(n&&n.dialog){var s=this._components_config;s.push({component:n.dialog,placeholder:'.vzb-dialogs-dialog[data-dlg="'+a+'"]',model:["state","ui","language"]}),n.component=s.length-1,n.id=a,e.push(n)}}this.accordionEl.selectAll("div").data(e).enter().append("div").attr("class",function(t){var e="vzb-dialogs-dialog vzb-moreoptions vzb-accordion-section";return e}).attr("data-dlg",function(t){return t.id}),this.loadComponents();var r=this;lt(this.components,function(t){t.render(),r.on("resize",function(){t.trigger("resize")})})}}}),Ca=fa.extend({init:function(t,e){this.name="label",this.components=[{component:ra,placeholder:".vzb-dialog-sizeslider",model:["state.marker.size_label","language"],propertyname:"LabelTextSize",ui:{constantUnit:"unit/pixels"}},{component:ga,placeholder:".vzb-saxis-selector",model:["state.marker","language"],markerID:"size_label"},{component:oa,placeholder:".vzb-removelabelbox-switch",model:["ui.chart","language"],checkbox:"removeLabelBox",submodel:"labels"}],this._super(t,e)}}),Ia=fa.extend({init:function(t,e){this.name="find";var i=this;this.components=[{component:la,placeholder:".vzb-dialog-bubbleopacity",model:["state.entities"],arg:"opacitySelectDim",properties:{step:.01}}],this.model_binds={"change:state.entities.select":function(t){i.ready()},"change:state.time.value":function(t){i.model.state.time.playing||i.model.state.time.dragging||i.ready()},"change:language.strings":function(){i.translator=i.model.language.getTFunction(),i.input_search.attr("placeholder",i.translator("placeholder/search")+"...")}},this._super(t,e)},readyOnce:function(){this._super(),this.list=this.element.select(".vzb-find-list"),this.input_search=this.element.select("#vzb-find-search"),this.deselect_all=this.element.select("#vzb-find-deselect"),this.opacity_nonselected=this.element.select(".vzb-dialog-bubbleopacity"),this.KEY=this.model.state.entities.getDimension();var t=this;this.input_search.on("keyup",function(){var e=d3.event;13==e.keyCode&&"select all"==t.input_search.node().value&&(t.input_search.node().value="",ne()||t.model.state.entities.clearHighlighted(),t.model.state.entities.selectAll())}),this.input_search.on("input",function(){t.showHideSearch()}),this.deselect_all.on("click",function(){t.deselectEntities()}),this.translator=this.model.language.getTFunction(),this.input_search.attr("placeholder",this.translator("placeholder/search")+"..."),this.root.on("ready",function(){t.ready()})},open:function(){this._super(),this.input_search.node().value="",this.showHideSearch()},ready:function(){this._super();var t=this,e=this.KEY,i=(this.model.state.time.getDimension(),this.model.state.entities.getSelected()),a=this.model.state.marker,n=this.model.state.time.value;a.getFrame(n,function(n){var s=a.getKeys().map(function(t){var i={};return i[e]=t[e],i.name=n.label[t[e]],i}).filter(function(t){var i=!0;return lt(n,function(a,n){return"color"===n||"size_label"===n||a[t[e]]||0===a[t[e]]?void 0:void(i=!1)}),i});s.sort(function(t,e){return t.name<e.name?-1:1}),t.list.html("");var r=t.list.selectAll(".vzb-find-item").data(s).enter().append("div").attr("class","vzb-find-item vzb-dialog-checkbox");r.append("input").attr("type","checkbox").attr("class","vzb-find-item").attr("id",function(t){return"-find-"+t[e]}).property("checked",function(t){return-1!==i.indexOf(t[e])}).on("change",function(e){ne()||t.model.state.entities.clearHighlighted(),t.model.state.entities.selectEntity(e),ne()||t.model.state.entities.highlightEntity(e)}),r.append("label").attr("for",function(t){return"-find-"+t[e]}).text(function(t){return t.name}).on("mouseover",function(e){ne()||t.model.state.entities.highlightEntity(e)}).on("mouseout",function(e){ne()||t.model.state.entities.clearHighlighted()}),xt(t.element.select(".vzb-dialog-scrollable")),t.showHideSearch(),t.showHideDeselect()})},showHideSearch:function(){var t=this.input_search.node().value||"";t=t.toLowerCase(),this.list.selectAll(".vzb-find-item").classed("vzb-hidden",function(e){var i=e.name.toLowerCase();return-1===i.indexOf(t)})},showHideDeselect:function(){var t=!!this.model.state.entities.select.length;this.deselect_all.classed("vzb-hidden",!t),this.opacity_nonselected.classed("vzb-hidden",!t)},deselectEntities:function(){this.model.state.entities.clearSelected()},transitionEnd:function(t){this._super(t),ne()||this.input_search.node().focus()}}),qa=fa.extend({init:function(t,e){this.name="colors",this.components=[{component:ga,placeholder:".vzb-caxis-selector",model:["state.marker","language"],markerID:"color"},{component:Xa,placeholder:".vzb-clegend-container",model:["state.marker.color","state.entities","language"]}],this._super(t,e)}}),Ra=fa.extend({init:function(t,e){this.name="axesmc";var i=this;this.model_binds={"change:ui.chart.xLogStops":function(){i.updateView()},"change:ui.chart.yMaxMethod":function(){i.updateView()}},this.components=[{component:ma,placeholder:".vzb-xlimits-container",model:["state.marker","language"],markerID:"axis_x",ui:{selectDomainMinMax:!1,selectZoomedMinMax:!0}}],this._super(t,e)},readyOnce:function(){this._super();var t=this;this.yMaxRadio=this.element.select(".vzb-yaxis-container").selectAll("input").on("change",function(){t.setModel("yMaxMethod",d3.select(this).node().value)}),this.xLogStops=this.element.select(".vzb-xaxis-container").selectAll("input").on("change",function(){t.setModel("xLogStops",d3.select(this).node().value)}),this.probeFieldEl=this.element.select(".vzb-probe-field").on("change",function(){var e=parseFloat(this.value.replace(",","."));return!e||e<=t.model.state.marker.axis_x.tailCutX?void(this.value=t.model.ui.chart.probeX):(this.value=e,void t.setModel("probeX",e))}),this.updateView()},updateView:function(){var t=this;this.yMaxRadio.property("checked",function(){return d3.select(this).node().value===t.model.ui.chart.yMaxMethod}),this.xLogStops.property("checked",function(){return-1!==t.model.ui.chart.xLogStops.indexOf(+d3.select(this).node().value)}),this.probeFieldEl.property("value",this.model.ui.chart.probeX)},setModel:function(t,e){var i;"yMaxMethod"==t&&(i=e),"xLogStops"==t&&(i=[],this.xLogStops.each(function(){d3.select(this).property("checked")&&i.push(+d3.select(this).node().value)})),"probeX"==t&&(i=e),this.model.ui.chart[t]=i}}),Ba=fa.extend({init:function(t,e){this.name="axes";this.components=[{component:ga,placeholder:".vzb-xaxis-selector",model:["state.marker","language"],markerID:"axis_x"},{component:ma,placeholder:".vzb-xaxis-minmax",model:["state.marker","language"],markerID:"axis_x",ui:{selectDomainMinMax:!1,selectZoomedMinMax:!0}},{component:ga,placeholder:".vzb-yaxis-selector",model:["state.marker","language"],markerID:"axis_y"},{component:ma,placeholder:".vzb-yaxis-minmax",model:["state.marker","language"],markerID:"axis_y",ui:{selectDomainMinMax:!1,selectZoomedMinMax:!0}},{component:oa,placeholder:".vzb-axes-options",model:["ui.chart","language"],checkbox:"adaptMinMaxZoom"}],this._super(t,e)}}),Fa=fa.extend({init:function(t,e){this.name="about",this._super(t,e)},readyOnce:function(){var t=V.version,e=new Date(parseInt(V.build));this.element=d3.select(this.element),this.element.select(".vzb-about-text0").html("Vizabi, a project"),this.element.select(".vzb-about-text1").html("by <a href='http://gapminder.org'>Gapminder Foundation</a>"),this.element.select(".vzb-about-version").html("<a href='https://github.com/Gapminder/vizabi/releases/tag/v"+t+"'>Version: "+t+"</a>"),this.element.select(".vzb-about-updated").html("Build: "+d3.time.format("%Y-%m-%d at %H:%M")(e)),this.element.select(".vzb-about-text2").html("Pre-alpha, don't expect too much!"),this.element.select(".vzb-about-credits").html("<a href='https://github.com/Gapminder/vizabi/graphs/contributors'>Contributors</a>")}}),Ha="vzb-active",Na=Xe.extend({init:function(t,e){this.name="gapminder-dialogs",this._curr_dialog_index=20,this.model_expects=[{name:"state",type:"model"},{name:"ui",type:"model"},{name:"language",type:"language"}],this._available_dialogs={find:{dialog:Ia},show:{dialog:_a},moreoptions:{dialog:Da},colors:{dialog:qa},size:{dialog:xa},label:{dialog:Ca},zoom:{dialog:va},axes:{dialog:Ba},axesmc:{dialog:Ra},stack:{dialog:ba},speed:{dialog:ya},opacity:{dialog:za},presentation:{dialog:Ma},about:{dialog:Fa}},this._super(t,e)},readyOnce:function(){var t=this,e=(this.model.ui.dialogs||{}).popup||[],i=(this.model.ui.dialogs||{}).sidebar||[];if(this.element=d3.select(this.placeholder),this.element.selectAll("div").remove(),i===!0&&(i=e,(this.model.ui.dialogs||{}).sidebar=i),0!==i.length&&d3.select(this.root.element).classed("vzb-dialog-expand-true",!0),this._addDialogs(e,i),this.resize(),(this.model.ui.dialogs||{}).popup){this.root.findChildByName("gapminder-buttonlist").on("click",function(e,i){t._available_dialogs[i.id]&&(i.active?t.openDialog(i.id):t.closeDialog(i.id))});var a=this.element.selectAll(".vzb-top-dialog").filter(function(t){return e.indexOf(t.id)>-1}),n=a.select(".vzb-top-dialog>.vzb-dialog-modal>.vzb-dialog-buttons>[data-click='closeDialog']");n.on("click",function(e,i){t.closeDialog(e.id)});var s=a.select(".vzb-top-dialog>.vzb-dialog-modal>[data-click='pinDialog']");s.on("click",function(e,i){t.pinDialog(e.id)}),this.root.element.addEventListener("click",function(){t.closeAllDialogs()}),d3.select(this.root.element).on("mousedown",function(e){if(this._active_comp){for(var i=d3.event.target,a=!0;i;){if(i.classList.contains("vzb-dialog-modal")){a=!1;break}i=i.parentElement}a&&t.closeAllDialogs()}})}this.element.on("click",function(){d3.event.stopPropagation()})},resize:function(){var t=(this.model.ui.dialogs||{}).popup||[],e=(this.model.ui.dialogs||{}).sidebar||[],i=this.getLayoutProfile();this.element.selectAll(".vzb-top-dialog").each(function(a){var n=d3.select(this),s=n.attr("class").replace(" vzb-popup","").replace(" vzb-sidebar","");"large"===i&&e.indexOf(a.id)>-1?s+=" vzb-sidebar":t.indexOf(a.id)>-1&&(s+=" vzb-popup"),n.attr("class",s)})},_addDialogs:function(t,e){var i=(this.getLayoutProfile(),[]);i=t?i.concat(t):i,i=e?i.concat(e):i,i=gt(i),this._components_config=[];var a=[];if(i.length){for(var n=0;n<i.length;n++){var s=i[n],r=this._available_dialogs[s];if(r&&r.dialog){var l=this._components_config;l.push({component:r.dialog,placeholder:'.vzb-dialogs-dialog[data-dlg="'+s+'"]',model:["state","ui","language"]}),r.component=l.length-1}r.id=s,a.push(r)}this.element.selectAll("div").data(a).enter().append("div").attr("data-dlg",function(t){return t.id}).attr("class","vzb-top-dialog vzb-dialogs-dialog vzb-dialog-shadow"),this.loadComponents();var o=this;lt(this.components,function(t){t.render(),o.on("resize",function(){t.trigger("resize")}),t.on("dragstart",function(){o.bringForward(t.name)}),t.on("close",function(){this.placeholderEl.each(function(t){var e={};e.id=t.id,o.trigger("close",e)})})})}},bringForward:function(t){var e=this.element.select(".vzb-popup.vzb-dialogs-dialog[data-dlg='"+t+"']");e.style("z-index",this._curr_dialog_index),this._curr_dialog_index+=10},openDialog:function(t){var e="small"===this.getLayoutProfile();this.closeAllDialogs(e);var i=this.element.selectAll(".vzb-popup.vzb-dialogs-dialog[data-dlg='"+t+"']");this._active_comp=this.components[this._available_dialogs[t].component],this._active_comp.beforeOpen(),i.classed(Ha,!0),this.bringForward(t),this._active_comp.open()},pinDialog:function(t){var e=this.element.select(".vzb-popup.vzb-dialogs-dialog[data-dlg='"+t+"']");this._available_dialogs[t].ispin?(e.classed("pinned",!1),this._available_dialogs[t].ispin=!1):(e.classed("pinned",!0),this._available_dialogs[t].ispin=!0)},closeDialog:function(t){var e=this.element.selectAll(".vzb-popup.vzb-dialogs-dialog[data-dlg='"+t+"']");this._active_comp=this.components[this._available_dialogs[t].component],this._active_comp&&!this._active_comp.isOpen||(this._available_dialogs[t].ispin&&this.pinDialog(t),this._active_comp&&this._active_comp.beforeClose(),e.classed(Ha,!1),this._active_comp&&this._active_comp.close(),this._active_comp=!1)},closeAllDialogs:function(t){var e=this,i=t?".vzb-popup.vzb-dialogs-dialog.vzb-active":".vzb-popup.vzb-dialogs-dialog.vzb-active:not(.pinned)",a=this.element.selectAll(i);a.each(function(t){e.closeDialog(t.id)})}}),ja=!0,Ya=Xe.extend({init:function(t,e){var i=this;this.name="gapminder-datawarning",this.model_expects=[{name:"language",type:"language"}],this.context=e,this.model_binds={"change:language.strings":function(t){i.ready()}},this._super(t,e),this.ui=ot({},this.ui)},ready:function(){},readyOnce:function(){var t=this;this.element=d3.select(this.placeholder),this.translator=this.model.language.getTFunction(),this.element.selectAll("div").remove(),this.element.append("div").attr("class","vzb-data-warning-background").on("click",function(){t.toggle(!0)});var e=this.element.append("div").attr("class","vzb-data-warning-box");e.append("div").html(mi).on("click",function(){t.toggle()}).select("svg").attr("width","0px").attr("height","0px").attr("class","vzb-data-warning-close");var i=e.append("div").attr("class","vzb-data-warning-link").html(hi);i.append("div").text("Data doubts"),this.parent.datawarning_content.title&&e.append("div").attr("class","vzb-data-warning-title").html(this.parent.datawarning_content.title),e.append("div").attr("class","vzb-data-warning-body vzb-dialog-scrollable").html(this.parent.datawarning_content.body)},toggle:function(t){null==t&&(t=!ja),ja=t,this.element.classed("vzb-hidden",ja);var e=this;this.parent.components.forEach(function(t){t.element.classed("vzb-blur",t!=e&&!ja)})}}),Va=null,Xa=Xe.extend({init:function(t,e){var i=this;this.template='<div class="vzb-cl-outer"></div>',this.name="colorlegend",this.model_expects=[{name:"color",type:"color"},{name:"entities",type:"entities"},{name:"language",type:"language"}],this.needsUpdate=!1,this.which_1=!1,this.scaleType_1=!1,this.model_binds={"change:color":function(t){i.updateView()},"change:language.strings":function(t){i.updateView()},ready:function(t){i._readyOnce&&i.updateView()}},this._super(t,e)},readyOnce:function(){this.element=d3.select(this.element),this.listColorsEl=this.element.append("div").attr("class","vzb-cl-holder").append("div").attr("class","vzb-cl-colorlist"),this.rainbowEl=this.listColorsEl.append("div").attr("class","vzb-cl-rainbow"),this.worldmapEl=this.listColorsEl.append("div").attr("class","vzb-cl-worldmap"),this.colorPicker=B(),d3.select(this.root.element).call(this.colorPicker),this.worldMap=F(),this.worldmapEl.call(this.worldMap),this.updateView()},updateView:function(){var t=this;this.translator=this.model.language.getTFunction();var e=this.model.entities.getDimension(),i=this.model.color.getPalette(),a=this.model.color.getDefaultPalette();this.listColorsEl.selectAll(".vzb-cl-option").remove();var n=this.listColorsEl.selectAll(".vzb-cl-option").data(It(i),function(t){return t});if(n.enter().append("div").attr("class","vzb-cl-option").each(function(){d3.select(this).append("div").attr("class","vzb-cl-color-sample"),d3.select(this).append("div").attr("class","vzb-cl-color-legend")}).on("mouseover",function(){if(t.model.color.isUserSelectable()){var e=d3.select(this).select(".vzb-cl-color-sample");e.style("border-width","5px"),e.style("background-color","transparent")}}).on("mouseout",function(e){if(t.model.color.isUserSelectable()){var i=d3.select(this).select(".vzb-cl-color-sample");i.style("border-width","0px"),i.style("background-color",t.model.color.palette[e])}}).on("click",function(e){t.model.color.isUserSelectable()&&t.colorPicker.colorOld(i[e]).colorDef(a[e]).callback(function(i){t.model.color.setColor(i,e)}).fitToScreen([d3.event.pageX,d3.event.pageY]).show(!0)}),"indicator"==this.model.color.use){var s,r=this.listColorsEl.selectAll(".vzb-cl-option");if(r&&r[0]){var l=r[0][0].getBoundingClientRect(),o=r[0][r[0].length-1].getBoundingClientRect();s=o.bottom-l.top}isFinite(s)||(s=25*It(i).length+5),this.rainbowEl.classed("vzb-hidden",!1).style("height",s+2+"px").style("background","linear-gradient("+qt(i).join(", ")+")")}else this.rainbowEl.classed("vzb-hidden",!0);if("geo.region"==this.model.color.which){var c=this.worldmapEl.classed("vzb-hidden",!1).select("svg").selectAll("path");c.each(function(){var t=d3.select(this),e=i[t.attr("id")];t.style("fill",W(e)?e[0]:e)}).style("opacity",.8).on("mouseover",function(){var i=d3.select(this),a=i.attr("id");c.style("opacity",.5),i.style("opacity",1);var n=t.model.color.getNestedItems([e]),s=qt(n).map(function(t){return t[t.length-1]}).filter(function(t){return t["geo.region"]==a}).map(function(t){return dt(t,[e])});t.model.entities.setHighlight(s)}).on("mouseout",function(){c.style("opacity",.8),t.model.entities.clearHighlighted()}).on("click",function(e){if(t.model.color.isUserSelectable()){var n=d3.select(this),s=n.attr("id");t.colorPicker.colorOld(i[s]).colorDef(a[s]).callback(function(e){t.model.color.setColor(e,s)}).show(!0)}})}else this.worldmapEl.classed("vzb-hidden",!0),"property"!==this.model.color.use||this.model.color.getMetadata().color&&!this.model.color.getMetadata().color.palette?n.classed("vzb-cl-compact",!1):n.classed("vzb-cl-compact",!0);n.classed("vzb-hidden","geo.region"==this.model.color.which||"_default"==this.model.color.which),n.each(function(e,a){if(d3.select(this).select(".vzb-cl-color-sample").style("background-color",i[e]).style("border","1px solid "+i[e]),"indicator"==t.model.color.use){var n=t.model.color.getScale().domain();d3.select(this).select(".vzb-cl-color-legend").text(t.model.color.tickFormatter(n[a]))}else d3.select(this).select(".vzb-cl-color-legend").text(t.translator("indicator/color/"+e))})},resize:function(){this.colorPicker.resize(d3.select(".vzb-colorpicker-svg"))}}),Ua={EXTENT_MIN:0,EXTENT_MAX:1,TEXT_PARAMS:{TOP:18,LEFT:10,MAX_WIDTH:42,MAX_HEIGHT:16},BAR_WIDTH:6,THUMB_RADIUS:10,THUMB_STROKE_WIDTH:4,INTRO_DURATION:250},Ka={small:{minRadius:.5,maxRadius:40},medium:{minRadius:1,maxRadius:55},large:{minRadius:1,maxRadius:70}},Wa=Xe.extend({init:function(t,e){function i(t,e){var i=n.model.size.extent||[Ua.EXTENT_MIN,Ua.EXTENT_MAX];n._updateArcs(i),n._updateLabels(i),n.sliderEl.call(n.brush.extent(i)),i[0]==i[1]&&n.sliderEl.selectAll(".resize").style("display","block")}function a(t){n.sizeScaleMinMax=n.model.size.getScale().domain(),n._setLabelsText()}this.name="bubblesize",this.template=this.template||"bubblesize.html",this.model_expects=[{name:"size",type:"size"}];var n=this;this.model_binds={"change:size.domainMin":i,"change:size.domainMax":i,"change:size.extent":i,ready:a},this._setModel=Ct(this._setModel,50),this._super(t,e)},readyOnce:function(){var t=this,e=t.model.size.extent||[Ua.EXTENT_MIN,Ua.EXTENT_MAX];this.element=d3.select(this.element),this.sliderSvg=this.element.select(".vzb-bs-svg"),this.sliderWrap=this.sliderSvg.select(".vzb-bs-slider-wrap"),this.sliderEl=this.sliderWrap.select(".vzb-bs-slider");var i={v:Ua.TEXT_PARAMS.TOP,h:Ua.TEXT_PARAMS.LEFT},a=Ua.TEXT_PARAMS.MAX_WIDTH,n=Ua.TEXT_PARAMS.MAX_HEIGHT,s=Ua.BAR_WIDTH,r=Ua.THUMB_RADIUS,l=Ua.THUMB_STROKE_WIDTH,o={top:l,left:i.h+a,right:i.h+a,bottom:s+n};this.padding=o;var c=this.getMinMaxBubbleRadius();this.xScale=d3.scale.linear().domain([Ua.EXTENT_MIN,Ua.EXTENT_MAX]).range([2*c.min,2*c.max]).clamp(!0),this.brush=d3.svg.brush().x(this.xScale).extent([Ua.EXTENT_MIN,Ua.EXTENT_MIN]).on("brush",function(){t._setFromExtent(!1,!1)}).on("brushend",function(){t.sliderEl.selectAll(".resize").style("display",null),t._setFromExtent(!0)}),this.sliderEl.call(t.brush),this.sliderEl.selectAll(".background").attr("style",""),this.sliderThumbs=this.sliderEl.selectAll(".resize").sort(d3.descending).classed("vzb-bs-slider-thumb",!0),this.sliderThumbs.append("g").attr("class","vzb-bs-slider-thumb-badge").append("path").attr("d","M0 "+.5*s+"l"+-r+" "+1.5*r+"h"+2*r+"Z"),this.sliderThumbs.append("path").attr("class","vzb-bs-slider-thumb-arc"),this.sliderEl.selectAll("text").data([0,0]).enter().append("text").attr("class","vzb-bs-slider-thumb-label").attr("dy","0.35em").attr("text-anchor",function(t,e){return e?"start":"end"}).attr("dominant-baseline",function(t,e){return e?"text-after-edge":"text-before-edge"}),this.sliderLabelsEl=this.sliderEl.selectAll("text.vzb-bs-slider-thumb-label"),this.sliderEl.selectAll("rect").attr("height",s).attr("rx",.25*s).attr("ry",.25*s).attr("transform","translate(0,"+.5*-s+")"),this.sliderEl.select(".extent").classed("vzb-bs-slider-extent",!0),this.on("resize",function(){t.xScale.range([2*t.getMinMaxBubbleRadius().min,2*t.getMinMaxBubbleRadius().max]),t._updateSize(),t.sliderEl.call(t.brush.extent(t.brush.extent())).call(t.brush.event)}),this._updateSize(),this.sliderEl.call(this.brush.extent(e)).call(this.brush.event),t.sizeScaleMinMax=t.model.size.getScale().domain(),t.sizeScaleMinMax&&t._setLabelsText()},getMinMaxBubbleRadius:function(){return{min:Ka[this.getLayoutProfile()].minRadius,max:Ka[this.getLayoutProfile()].maxRadius}},_updateSize:function(){this.sliderSvg.attr("height",this.getMinMaxBubbleRadius().max+this.padding.top+this.padding.bottom).attr("width",2*this.getMinMaxBubbleRadius().max+this.padding.left+this.padding.right),this.sliderWrap.attr("transform","translate("+this.padding.left+","+(this.getMinMaxBubbleRadius().max+this.padding.top)+")")},_updateArcs:function(t){var e=this,i=d3.svg.arc().outerRadius(function(t){return.5*e.xScale(t)}).innerRadius(function(t){return.5*e.xScale(t)}).startAngle(.5*-Math.PI).endAngle(.5*Math.PI);this.sliderThumbs.select(".vzb-bs-slider-thumb-arc").data(t).attr("d",i).attr("transform",function(t){return"translate("+.5*-e.xScale(t)+",0)"})},_updateLabels:function(t){var e=this,i=function(t,i){var a={v:Ua.TEXT_PARAMS.TOP,h:Ua.TEXT_PARAMS.LEFT},n=a.h*(i?.5:-1)+e.xScale(t),s=i?-a.v:0;return"translate("+n+","+s+")"};this.sliderLabelsEl.data(t).attr("transform",i)},_setLabelsText:function(){var t=this;t.sliderLabelsEl.data([t.model.size.tickFormatter(t.sizeScaleMinMax[0]),t.model.size.tickFormatter(t.sizeScaleMinMax[1])]).text(function(t){return t})},_setFromExtent:function(t,e){var i=this.brush.extent();this._updateArcs(i),this._updateLabels(i),this._setModel(i,t,e)},_setModel:function(t,e,i){t=[+t[0].toFixed(2),+t[1].toFixed(2)],this.model.size.set({extent:t},e,i)}}),Qa={bubblesize:Wa,buttonlist:Oa,colorlegend:Xa,datawarning:Ya,_dialog:fa,dialogs:Na,draggablelist:pa,indicatorpicker:ga,minmaxinputs:ma,simplecheckbox:oa,simpleslider:la,sizeslider:ra,timeslider:aa,treemenu:Ui,zoombuttonlist:qi},Ga={bubblesize:Wa,buttonlist:Oa,colorlegend:Xa,datawarning:Ya,_dialog:fa,dialogs:Na,draggablelist:pa,indicatorpicker:ga,minmaxinputs:ma,simplecheckbox:oa,simpleslider:la,sizeslider:ra,timeslider:aa,treemenu:Ui,zoombuttonlist:qi,"default":Qa},Za=Ei.extend("BarChart",{init:function(t,e){this.name="barchart",this.components=[{component:Ci,placeholder:".vzb-tool-viz",model:["state.time","state.entities","state.marker","language"]},{component:aa,placeholder:".vzb-tool-timeslider",model:["state.time"]},{component:Na,placeholder:".vzb-tool-dialogs",model:["state","ui","language"]},{component:Oa,placeholder:".vzb-tool-buttonlist",model:["state","ui","language"]},{component:Ui,placeholder:".vzb-tool-treemenu",model:["state.marker","language"]}],this._super(t,e)},default_model:{state:{time:{},entities:{dim:"geo",show:{_defs_:{geo:["*"],"geo.cat":["region"]}}},marker:{space:["entities","time"],label:{use:"property",which:"geo.name"},axis_y:{use:"indicator",which:"lex"},axis_x:{use:"property",which:"geo.name"},color:{use:"property",which:"geo.region"}}},data:{reader:"csv",path:"data/waffles/basic-indicators.csv"}}}),Ja=he.extend({init:function(t,e){this.context=t,this.width=0,this.height=0,this.topOffset=0,this.leftOffset=0,this.bottomOffset=0,this.rightOffset=0,this.fontSize=0,this.fontWidth=0,this.fontHeight=0,this.xAlign="center",this.yAlign="center",this.symbols=[],e&&this.setConditions(e)},setConditions:function(t){return t.rightOffset&&!isNaN(parseFloat(t.rightOffset))&&isFinite(t.rightOffset)&&(this.rifgtOffset=t.rightOffset),t.leftOffset&&!isNaN(parseFloat(t.leftOffset))&&isFinite(t.leftOffset)&&(this.leftOffset=t.leftOffset),t.topOffset&&!isNaN(parseFloat(t.topOffset))&&isFinite(t.topOffset)&&(this.topOffset=t.topOffset),t.bottomOffset&&!isNaN(parseFloat(t.bottomOffset))&&isFinite(t.bottomOffset)&&(this.bottomOffset=t.bottomOffset),t.xAlign&&(this.xAlign=t.xAlign),t.yAlign&&(this.yAlign=t.yAlign),this},resize:function(t,e,i,a,n){this.width=t,this.height=e,this.fontSize=i,a&&(this.topOffset=a),n&&(this.leftOffset=n);var s=this.context.append("text").text("0").style("font-size",this.fontSize+"px");this.fontWidth=s[0][0].getBBox().width,this.fontHeight=.72*this.fontSize,d3.select(s[0][0]).remove(),this.__resizeText()},setText:function(t,e){var i=t.split("");return i.length!=this.symbols.length&&(e=!0),this.symbols=t.split(""),this.context.selectAll("text").data(this.symbols).exit().remove(),this.context.selectAll("text").data(this.symbols).enter().append("text").text(function(t){return t}),this.context.selectAll("text").each(function(t,e){d3.select(this).text(t)}),e?this.__resizeText():this},__resizeText:function(){var t=this;return this.context.attr("transform","translate("+this.__getLeftOffset()+","+this.__getTopOffset()+")"),this.context.selectAll("text").each(function(e,i){d3.select(this).attr("x",t.fontWidth*i).style("font-size",t.fontSize+"px").style("text-anchor","middle")}),this},__getLeftOffset:function(){switch(this.xAlign){case"right":return this.width-this.fontWidth*this.symbols.length+this.fontWidth/2;case"left":return this.fontWidth/2;default:return this.fontWidth/2+(this.width-this.fontWidth*this.symbols.length)/2}},__getTopOffset:function(){switch(this.yAlign){case"top":return this.fontHeight+this.topOffset;case"bottom":return this.height-this.bottomOffset;default:return this.fontHeight+(this.height-this.fontHeight)/2+this.topOffset}}}),$a=Xe.extend({init:function(t,e){this.name="barrankchart-component",this.template="barrank.html",this.model_expects=[{name:"time",type:"time"},{name:"entities",type:"entities"},{name:"marker",type:"model"},{name:"language",type:"language"},{name:"ui",type:"model"}];var i=this;this.model_binds={"change:time.value":function(t){i.onTimeChange()},"change:entities.select":function(t){i.selectBars()},"change:marker.axis_x.scaleType":function(t){i.draw()},"change:marker.color.palette":function(){}},this._super(t,e),this.xScale=null,this.cScale=d3.scale.category10(),this.xAxis=O()},onTimeChange:function(){var t=this;this.model.marker.getFrame(this.model.time.value,function(e){t.values=e,t.loadData(),t.draw()})},readyOnce:function(){this.element=d3.select(this.element),this.header=this.element.select(".vzb-br-header"),this.barViewport=this.element.select(".barsviewport"),this.barSvg=this.element.select(".vzb-br-bars-svg"),this.barContainer=this.element.select(".vzb-br-bars"),
this.xAxis.tickFormat(this.model.marker.axis_x.tickFormatter),this.ready(),this.selectBars()},readyRuns:0,ready:function(){var t=this;2!=++this.readyRuns&&this.model.marker.getFrame(this.model.time.value,function(e){t.values=e,t.loadData(),t.draw()})},resize:function(){this.draw()},loadData:function(){this.sortedEntities=this.sortByIndicator(this.values.axis_x);var t=this.model.language.getTFunction();this.header.select(".vzb-br-title").text(t("indicator/"+this.model.marker.axis_x.which)+" "+this.model.time.timeFormat(this.model.time.value)),this.header.select(".vzb-br-total").text("Σ = "+this.model.marker.axis_x.tickFormatter(this.total)),this.xScale=this.model.marker.axis_x.getScale(!1),this.cScale=this.model.marker.color.getScale()},draw:function(){this.drawAxes(),this.drawData()},drawAxes:function(){this.barHeight=20;var t={top:60,bottom:40,left:90,right:20};this.height=parseInt(this.element.style("height"),10)-t.top-t.bottom,this.width=parseInt(this.element.style("width"),10)-t.left-t.right,this.barContainer.attr("transform","translate("+t.left+", 0)"),this.barViewport.style("height",this.height+"px"),this.header.attr("height",t.top).select(".vzb-br-title").attr("dominant-baseline","middle").attr("y",t.top/2).attr("x",t.left),this.header.select(".vzb-br-total").attr("text-anchor","end").attr("dominant-baseline","middle").attr("y",t.top/2).attr("x",this.width+t.left),"ordinal"!==this.model.marker.axis_x.scaleType?this.xScale.range([0,this.width]):this.xScale.rangePoints([0,this.width]).range();var e=this.model.marker.axis_x.getLimits(this.model.marker.axis_x.which);this.xScale=this.xScale.domain([e.min,e.max])},drawData:function(){function t(t,e){return(a.barHeight+n)*e}function e(t){return t.entity}function i(t,e){0===t.size()&&e();var i=0;t.each(function(){++i}).each("end",function(){--i||e.apply(this,arguments)})}var a=this,n=2,s=this.model.time.playing?this.model.time.delayAnimations:0,r=this.barContainer.selectAll(".vzb-br-bar").data(this.sortedEntities,e).order();this.createAndDeleteBars(r),this.barContainer.selectAll(".vzb-br-bar").data(this.sortedEntities,e).order().each(function(t,e){var i=d3.select(this),n=a.xScale(t.value),r=a.model.marker.axis_x.tickFormatter(t.value);t.index=e,i.selectAll("rect").transition().duration(s).ease("linear").attr("width",n>0?n:0),i.selectAll(".vzb-br-value").text(r),i.selectAll("title").text(a.values.label[t.entity]+" ("+r+")")}).transition().duration(s).ease("linear").attr("transform",function(e,i){return"translate(0, "+t(e,i)+")"}).call(i,function(){function e(t){return function(){var e=d3.interpolateNumber(this.scrollTop,t);return function(t){this.scrollTop=e(t)}}}var i=a.barContainer.node().getBoundingClientRect().height;if(a.barSvg.attr("height",i+"px"),a.model.time.playing){var n=a.barContainer.select(".vzb-selected");if(!n.empty()){var r=n.datum(),l=t(r,r.index),o=a.barViewport.node().scrollTop,c=o+a.height,h=!1;o>l&&(h=l),l+a.barHeight>c&&(h=l+a.barHeight-a.height),h&&a.barViewport.transition().duration(s).tween("scrollfor"+r.entity,e(h))}}})},createAndDeleteBars:function(t){var e=this;t.exit().remove();var i=t.enter().append("g").attr("class","vzb-br-bar").attr("id",function(t){return"vzb-br-bar-"+t.entity}).on("mousemove",function(t){e.setHover(t,!0)}).on("mouseout",function(t){e.setHover(t,!1)}).on("click",function(t){lt(e.model.marker.space,function(i){"time"!==e.model[i].getDimension()&&e.model[i].selectEntity(t)})});i.append("rect").attr("x",0).attr("rx",this.barHeight/4).attr("ry",this.barHeight/4).attr("stroke","white").attr("stroke-opacity",0).attr("stroke-width",2).attr("height",this.barHeight).style("fill",function(t){var i=e.cScale(e.values.color[t.entity]);return d3.rgb(i)}),i.append("text").attr("class","vzb-br-label").attr("x",-5).attr("y",this.barHeight/2).attr("text-anchor","end").attr("dominant-baseline","middle").text(function(t,i){var a=e.values.label[t.entity];return a.length<12?a:a.substring(0,9)+"..."}).style("fill",function(t){var i=e.cScale(e.values.color[t.entity]);return d3.rgb(i).darker(2)}).append("title"),i.append("text").attr("class","vzb-br-value").attr("x",5).attr("y",this.barHeight/2).attr("dominant-baseline","middle").style("fill",function(t){var i=e.cScale(e.values.color[t.entity]);return d3.rgb(i).darker(2)})},drawColors:function(){function t(t){var e=i.cScale(i.values.color[t.entity]);return d3.rgb(e)}function e(e){return t(e).darker(2)}var i=this;this.barContainer.selectAll(".vzb-br-bar>rect").style("fill",t),this.barContainer.selectAll(".vzb-br-bar>text").style("fill",e)},sortByIndicator:function(t){var e=this,i=[];return this.total=0,lt(t,function(t,a){var n={entity:a,value:t};n[e.model.entities.dim]=a,i.push(n),e.total+=t}),i.sort(function(t,e){return e.value-t.value}),i},setHover:function(t,e){this.barContainer.classed("vzb-dimmed",e),this.barContainer.select("#vzb-br-bar-"+t.entity).classed("vzb-hovered",e)},selectBars:function(){var t=this,e=this.model.entities.dim,i=this.model.entities.select;this.barContainer.classed("vzb-dimmed-selected",!1),this.barContainer.selectAll(".vzb-br-bar.vzb-selected").classed("vzb-selected",!1),i.length&&(this.barContainer.classed("vzb-dimmed-selected",!0),lt(i,function(i){t.barContainer.select("#vzb-br-bar-"+i[e]).classed("vzb-selected",!0)}))}}),tn=Ei.extend("BarRankChart",{init:function(t,e){this.name="barrankchart",this.components=[{component:$a,placeholder:".vzb-tool-viz",model:["state.time","state.entities","state.marker","language","ui"]},{component:aa,placeholder:".vzb-tool-timeslider",model:["state.time"]},{component:Na,placeholder:".vzb-tool-dialogs",model:["state","ui","language"]},{component:Oa,placeholder:".vzb-tool-buttonlist",model:["state","ui","language"]},{component:Ui,placeholder:".vzb-tool-treemenu",model:["state.marker","language"]}],this._super(t,e)}}),en=function(){function t(t,e){function i(e){var i,a=t.arcs[0>e?~e:e],n=a[0];return t.transform?(i=[0,0],a.forEach(function(t){i[0]+=t[0],i[1]+=t[1]})):i=a[a.length-1],0>e?[i,n]:[n,i]}function a(t,e){for(var i in t){var a=t[i];delete e[a.start],delete a.start,delete a.end,a.forEach(function(t){n[0>t?~t:t]=1}),l.push(a)}}var n={},s={},r={},l=[],o=-1;return e.forEach(function(i,a){var n,s=t.arcs[0>i?~i:i];s.length<3&&!s[1][0]&&!s[1][1]&&(n=e[++o],e[o]=i,e[a]=n)}),e.forEach(function(t){var e,a,n=i(t),l=n[0],o=n[1];if(e=r[l])if(delete r[e.end],e.push(t),e.end=o,a=s[o]){delete s[a.start];var c=a===e?e:e.concat(a);s[c.start=e.start]=r[c.end=a.end]=c}else s[e.start]=r[e.end]=e;else if(e=s[o])if(delete s[e.start],e.unshift(t),e.start=l,a=r[l]){delete r[a.end];var h=a===e?e:a.concat(e);s[h.start=a.start]=r[h.end=e.end]=h}else s[e.start]=r[e.end]=e;else e=[t],s[e.start=l]=r[e.end=o]=e}),a(r,s),a(s,r),e.forEach(function(t){n[0>t?~t:t]||l.push([t])}),l}function e(e,i,a){function n(t){var e=0>t?~t:t;(h[e]||(h[e]=[])).push({i:t,g:c})}function s(t){t.forEach(n)}function r(t){t.forEach(s)}function l(t){"GeometryCollection"===t.type?t.geometries.forEach(l):t.type in d&&(c=t,d[t.type](t.arcs))}var o=[];if(arguments.length>1){var c,h=[],d={LineString:s,MultiLineString:r,Polygon:r,MultiPolygon:function(t){t.forEach(r)}};l(i),h.forEach(arguments.length<3?function(t){o.push(t[0].i)}:function(t){a(t[0].g,t[t.length-1].g)&&o.push(t[0].i)})}else for(var u=0,m=e.arcs.length;m>u;++u)o.push(u);return{type:"MultiLineString",arcs:t(e,o)}}function i(e,i){function a(t){t.forEach(function(e){e.forEach(function(e){(l[e=0>e?~e:e]||(l[e]=[])).push(t)})}),o.push(t)}function s(t){return d(r(e,{type:"Polygon",arcs:[t]}).coordinates[0])>0}var l={},o=[],c=[];return i.forEach(function(t){"Polygon"===t.type?a(t.arcs):"MultiPolygon"===t.type&&t.arcs.forEach(a)}),o.forEach(function(t){if(!t._){var e=[],i=[t];for(t._=1,c.push(e);t=i.pop();)e.push(t),t.forEach(function(t){t.forEach(function(t){l[0>t?~t:t].forEach(function(t){t._||(t._=1,i.push(t))})})})}}),o.forEach(function(t){delete t._}),{type:"MultiPolygon",arcs:c.map(function(i){var a=[];if(i.forEach(function(t){t.forEach(function(t){t.forEach(function(t){l[0>t?~t:t].length<2&&a.push(t)})})}),a=t(e,a),(n=a.length)>1)for(var r,o=s(i[0][0]),c=0;c<n;++c)if(o===s(a[c])){r=a[0],a[0]=a[c],a[c]=r;break}return a})}}function a(t,e){return"GeometryCollection"===e.type?{type:"FeatureCollection",features:e.geometries.map(function(e){return s(t,e)})}:s(t,e)}function s(t,e){var i={type:"Feature",id:e.id,properties:e.properties||{},geometry:r(t,e)};return null==e.id&&delete i.id,i}function r(t,e){function i(t,e){e.length&&e.pop();for(var i,a=h[0>t?~t:t],n=0,s=a.length;s>n;++n)e.push(i=a[n].slice()),c(i,n);0>t&&l(e,s)}function a(t){return t=t.slice(),c(t,0),t}function n(t){for(var e=[],a=0,n=t.length;n>a;++a)i(t[a],e);return e.length<2&&e.push(e[0].slice()),e}function s(t){for(var e=n(t);e.length<4;)e.push(e[0].slice());return e}function r(t){return t.map(s)}function o(t){var e=t.type;return"GeometryCollection"===e?{type:e,geometries:t.geometries.map(o)}:e in d?{type:e,coordinates:d[e](t)}:null}var c=p(t.transform),h=t.arcs,d={Point:function(t){return a(t.coordinates)},MultiPoint:function(t){return t.coordinates.map(a)},LineString:function(t){return n(t.arcs)},MultiLineString:function(t){return t.arcs.map(n)},Polygon:function(t){return r(t.arcs)},MultiPolygon:function(t){return t.arcs.map(r)}};return o(e)}function l(t,e){for(var i,a=t.length,n=a-e;n<--a;)i=t[n],t[n++]=t[a],t[a]=i}function o(t,e){for(var i=0,a=t.length;a>i;){var n=i+a>>>1;t[n]<e?i=n+1:a=n}return i}function c(t){function e(t,e){t.forEach(function(t){0>t&&(t=~t);var i=n[t];i?i.push(e):n[t]=[e]})}function i(t,i){t.forEach(function(t){e(t,i)})}function a(t,e){"GeometryCollection"===t.type?t.geometries.forEach(function(t){a(t,e)}):t.type in r&&r[t.type](t.arcs,e)}var n={},s=t.map(function(){return[]}),r={LineString:e,MultiLineString:i,Polygon:i,MultiPolygon:function(t,e){t.forEach(function(t){i(t,e)})}};t.forEach(a);for(var l in n)for(var c=n[l],h=c.length,d=0;h>d;++d)for(var u=d+1;h>u;++u){var m,g=c[d],p=c[u];(m=s[g])[l=o(m,p)]!==p&&m.splice(l,0,p),(m=s[p])[l=o(m,g)]!==g&&m.splice(l,0,g)}return s}function h(t,e){function i(t){s.remove(t),t[1][2]=e(t),s.push(t)}var a=p(t.transform),n=f(t.transform),s=g();return e||(e=u),t.arcs.forEach(function(t){for(var r,l,o=[],c=0,h=0,d=t.length;d>h;++h)l=t[h],a(t[h]=[l[0],l[1],1/0],h);for(var h=1,d=t.length-1;d>h;++h)r=t.slice(h-1,h+2),r[1][2]=e(r),o.push(r),s.push(r);for(var h=0,d=o.length;d>h;++h)r=o[h],r.previous=o[h-1],r.next=o[h+1];for(;r=s.pop();){var u=r.previous,m=r.next;r[1][2]<c?r[1][2]=c:c=r[1][2],u&&(u.next=m,u[2]=r[2],i(u)),m&&(m.previous=u,m[0]=r[0],i(m))}t.forEach(n)}),t}function d(t){for(var e,i=-1,a=t.length,n=t[a-1],s=0;++i<a;)e=n,n=t[i],s+=e[0]*n[1]-e[1]*n[0];return.5*s}function u(t){var e=t[0],i=t[1],a=t[2];return Math.abs((e[0]-a[0])*(i[1]-e[1])-(e[0]-i[0])*(a[1]-e[1]))}function m(t,e){return t[1][2]-e[1][2]}function g(){function t(t,e){for(;e>0;){var i=(e+1>>1)-1,n=a[i];if(m(t,n)>=0)break;a[n._=e]=n,a[t._=e=i]=t}}function e(t,e){for(;;){var i=e+1<<1,s=i-1,r=e,l=a[r];if(n>s&&m(a[s],l)<0&&(l=a[r=s]),n>i&&m(a[i],l)<0&&(l=a[r=i]),r===e)break;a[l._=e]=l,a[t._=e=r]=t}}var i={},a=[],n=0;return i.push=function(e){return t(a[e._=n]=e,n++),n},i.pop=function(){if(!(0>=n)){var t,i=a[0];return--n>0&&(t=a[n],e(a[t._=0]=t,0)),i}},i.remove=function(i){var s,r=i._;if(a[r]===i)return r!==--n&&(s=a[n],(m(s,i)<0?t:e)(a[s._=r]=s,r)),r},i}function p(t){if(!t)return v;var e,i,a=t.scale[0],n=t.scale[1],s=t.translate[0],r=t.translate[1];return function(t,l){l||(e=i=0),t[0]=(e+=t[0])*a+s,t[1]=(i+=t[1])*n+r}}function f(t){if(!t)return v;var e,i,a=t.scale[0],n=t.scale[1],s=t.translate[0],r=t.translate[1];return function(t,l){l||(e=i=0);var o=(t[0]-s)/a|0,c=(t[1]-r)/n|0;t[0]=o-e,t[1]=c-i,e=o,i=c}}function v(){}var b={version:"1.6.19",mesh:function(t){return r(t,e.apply(this,arguments))},meshArcs:e,merge:function(t){return r(t,i.apply(this,arguments))},mergeArcs:i,feature:a,neighbors:c,presimplify:h};return b}(),an=Xe.extend({init:function(t,e){this.name="bubblemap",this.template="bubblemap.html",this.bubblesDrawing=null;var i=function(){var t=!1;return function(e){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))&&(t=!0)}(navigator.userAgent||navigator.vendor||window.opera),t};this.isMobile=i(),this.model_expects=[{name:"time",type:"time"},{name:"entities",type:"entities"},{name:"marker",type:"model"},{name:"language",type:"language"},{name:"ui",type:"model"}];var a=this;this.model_binds={"change:time.value":function(t){a.model.marker.getFrame(a.model.time.value,a.frameChanged.bind(a))},"change:entities.highlight":function(t){a._readyOnce&&(a.highlightEntities(),a.updateOpacity())},"change:marker":function(t,e){a._readyOnce&&e.indexOf("scaleType")>-1&&a.ready()},"change:marker.size.extent":function(t,e){a._readyOnce&&(a.updateMarkerSizeLimits(),a.redrawDataPoints(null,!1))},"change:marker.color.palette":function(t,e){a._readyOnce&&a.redrawDataPoints(null,!1)},"change:entities.select":function(t){a._readyOnce&&(a.selectEntities(),a.redrawDataPoints(null,!1),a.updateOpacity(),a.updateDoubtOpacity())},"change:entities.opacitySelectDim":function(t){a.updateOpacity()},"change:entities.opacityRegular":function(t){a.updateOpacity()}},this._super(t,e),this.sScale=null,this.cScale=d3.scale.category10(),a.COLOR_WHITEISH="#fdfdfd",this.labelDragger=d3.behavior.drag().on("dragstart",function(t,e){if(d3.event.sourceEvent.stopPropagation(),a.ui.chart.labels.dragging){var i=a.KEY;a.druging=t[i]}}).on("drag",function(t,e){if(a.ui.chart.labels.dragging){var i=a.KEY,n=a.cached[t[i]];n.labelFixed=!0,n.labelX_+=d3.event.dx/a.width,n.labelY_+=d3.event.dy/a.height;var s=(n.labelX0+n.labelX_)*a.width,r=(n.labelY0+n.labelY_)*a.height,l=n.labelX0*a.width,o=n.labelY0*a.height,c=a.entityLines.filter(function(e){return e[i]==t[i]});a._repositionLabels(t,e,this,s,r,l,o,0,c)}}).on("dragend",function(t,e){if(a.ui.chart.labels.dragging){var i=a.KEY;a.druging=null,a.model.entities.setLabelOffset(t,[a.cached[t[i]].labelX_,a.cached[t[i]].labelY_])}}),this.defaultWidth=960,this.defaultHeight=500,this.boundBox=[[.02,0],[1,.85]],H()},afterPreload:function(){this.world||kt("bubble map afterPreload: missing country shapes "+this.world);var t=this.defaultWidth,e=this.defaultHeight,i=this.world,a=this.projection=d3.geo.robinson().scale(150).translate([t/2,e/2]).precision(.1),n=this.bgPath=d3.geo.path().projection(a),s=(d3.geo.graticule(),this.mapGraph=d3.select(this.element).select(".vzb-bmc-map-graph").attr("width",t).attr("height",e));s.html(""),s.insert("path",".graticule").datum(en.feature(i,i.objects.land)).attr("class","land").attr("d",n),s.insert("path",".graticule").datum(en.mesh(i,i.objects.countries,function(t,e){return t!==e})).attr("class","boundary").attr("d",n)},readyOnce:function(){this.element=d3.select(this.element),this.graph=this.element.select(".vzb-bmc-graph"),this.mapSvg=this.element.select(".vzb-bmc-map-background"),this.bubbleContainerCrop=this.graph.select(".vzb-bmc-bubbles-crop"),this.bubbleContainer=this.graph.select(".vzb-bmc-bubbles"),this.labelListContainer=this.graph.select(".vzb-bmc-bubble-labels"),this.labelsContainer=this.graph.select(".vzb-bmc-labels"),this.linesContainer=this.graph.select(".vzb-bmc-lines"),this.dataWarningEl=this.graph.select(".vzb-data-warning"),this.yTitleEl=this.graph.select(".vzb-bmc-axis-y-title"),this.cTitleEl=this.graph.select(".vzb-bmc-axis-c-title"),this.infoEl=this.graph.select(".vzb-bmc-axis-info"),this.entityBubbles=null,this.entityLabels=null,this.tooltip=this.element.select(".vzb-bmc-tooltip"),this.entityLines=null,this.yearEl=this.graph.select(".vzb-bmc-year"),this.year=new Ja(this.yearEl),this.year.setConditions({xAlign:"left",yAlign:"bottom",bottomOffset:5});var t=this;this.on("resize",function(){t.updateSize(),t.updateMarkerSizeLimits(),t.redrawDataPoints()}),this.KEY=this.model.entities.getDimension(),this.TIMEDIM=this.model.time.getDimension(),this.cached={},this.updateUIStrings(),this.wScale=d3.scale.linear().domain(this.parent.datawarning_content.doubtDomain).range(this.parent.datawarning_content.doubtRange)},ready:function(){var t=this;this.updateUIStrings(),this.updateIndicators(),this.updateSize(),this.updateMarkerSizeLimits(),this.model.marker.getFrame(this.model.time.value,function(e){t.values=e,t.updateEntities(),t.updateTime(),t.redrawDataPoints(),t.highlightEntities(),t.selectEntities(),t.updateDoubtOpacity(),t.updateOpacity()})},frameChanged:function(t,e){e.toString()==this.model.time.value.toString()&&(this.values=t,this.updateTime(),this.updateDoubtOpacity(),this.redrawDataPoints(null,!1))},updateUIStrings:function(){var t=this;this.translator=this.model.language.getTFunction();var e=this.model.marker.size.getMetadata();this.strings={title:{S:this.translator("indicator/"+t.model.marker.size.which),C:this.translator("indicator/"+t.model.marker.color.which)}},this.yTitleEl.select("text").text(this.translator("buttons/size")+": "+this.strings.title.S).on("click",function(){t.parent.findChildByName("gapminder-treemenu").markerID("size").alignX("left").alignY("top").updateView().toggle()}),this.cTitleEl.select("text").text(this.translator("buttons/color")+": "+this.strings.title.C).on("click",function(){t.parent.findChildByName("gapminder-treemenu").markerID("color").alignX("left").alignY("top").updateView().toggle()}),re(this.dataWarningEl,hi).select("svg").attr("width","0px").attr("height","0px"),this.dataWarningEl.append("text").attr("text-anchor","end").text(this.translator("hints/dataWarning")),this.infoEl.html(ui).select("svg").attr("width","0px").attr("height","0px"),this.infoEl.on("click",function(){window.open(e.sourceLink,"_blank").focus()}),this.dataWarningEl.on("click",function(){t.parent.findChildByName("gapminder-datawarning").toggle()}).on("mouseover",function(){t.updateDoubtOpacity(1)}).on("mouseout",function(){t.updateDoubtOpacity()})},updateTitleNumbers:function(){var t,e=this;if(e.isMobile&&e.model.entities.select&&1===e.model.entities.select.length&&(t=e.model.entities.select[0]),e.hovered||t){var i=e.hovered||t,a=e.model.marker.size.tickFormatter,n=e.model.marker.color.tickFormatter;e.yTitleEl.select("text").text(e.translator("buttons/size")+": "+a(e.values.size[i[e.KEY]])+" "+e.translator("unit/"+e.model.marker.size.which)),e.cTitleEl.select("text").text(e.translator("buttons/color")+": "+n(e.values.color[i[e.KEY]])+" "+e.translator("unit/"+e.model.marker.color.which)),this.infoEl.classed("vzb-hidden",!0)}else this.yTitleEl.select("text").text(this.translator("buttons/size")+": "+this.strings.title.S),this.cTitleEl.select("text").text(this.translator("buttons/color")+": "+this.strings.title.C),this.infoEl.classed("vzb-hidden",!1)},updateDoubtOpacity:function(t){null==t&&(t=this.wScale(+this.time.getUTCFullYear().toString())),this.someSelected&&(t=1),this.dataWarningEl.style("opacity",t)},updateOpacity:function(){var t=this,e=1,i=.3,a=this.model.entities.opacityRegular,n=this.model.entities.opacityRegular,s=this.model.entities.opacitySelectDim;this.entityBubbles.style("opacity",function(r){return t.someHighlighted&&t.model.entities.isHighlighted(r)?e:t.someSelected?t.model.entities.isSelected(r)?a:s:t.someHighlighted?i:n}),this.entityBubbles.classed("vzb-selected",function(e){return t.model.entities.isSelected(e)});var r=t.someSelected&&t.model.entities.opacitySelectDim<.01;r!==this.someSelectedAndOpacityZero_1&&this.entityBubbles.style("pointer-events",function(e){return!r||t.model.entities.isSelected(e)?"visible":"none"}),this.someSelectedAndOpacityZero_1=t.someSelected&&t.model.entities.opacitySelectDim<.01},updateIndicators:function(){this.sScale=this.model.marker.size.getScale(),this.cScale=this.model.marker.color.getScale()},updateEntities:function(){var t=this,e=this.KEY,i=this.TIMEDIM,a=function(a){return a=a||"",t.model.marker.getKeys().map(function(s){var r={};return r[e]=s[e],r[i]=n,r.sortValue=t.values.size[s[e]]||0,r[e]=a+s[e],r}).sort(function(t,e){return e.sortValue-t.sortValue})},n=this.model.time.end;this.model.entities.setVisible(a.call(this)),this.entityBubbles=this.bubbleContainer.selectAll(".vzb-bmc-bubble").data(this.model.entities.getVisible(),function(t){return t[e]}).order(),this.entityBubbles.exit().remove(),this.entityBubbles.enter().append("circle").attr("class","vzb-bmc-bubble").on("mouseover",function(e,i){ne()||t._interact()._mouseover(e,i)}).on("mouseout",function(e,i){ne()||t._interact()._mouseout(e,i)}).on("click",function(e,i){ne()||(t._interact()._click(e,i),t.highlightEntities())}).onTap(function(e,i){t._interact()._click(e,i),d3.event.stopPropagation()}).onLongTap(function(t,e){})},redrawDataPoints:function(t,e){var i=this;t||(t=this.duration),e||(e=!0),this.entityBubbles.each(function(a,n){var s=d3.select(this),r=i.values.lng[a[i.KEY]],l=i.values.lat[a[i.KEY]],o=i.values.size[a[i.KEY]],c=i.values.color[a[i.KEY]],h=i.values.label[a[i.KEY]];a.hidden_1=a.hidden,a.hidden=!o||null==r||null==l,a.hidden!==a.hidden_1&&s.classed("vzb-hidden",a.hidden),a.hidden||(a.r=zt(i.sScale(o||0)),a.label=h,s.classed("vzb-hidden",!1).attr("fill",c?i.cScale(c):i.COLOR_WHITEISH),e&&(a.cLoc=i.skew(i.projection([r||0,l||0])),s.attr("cx",a.cLoc[0]).attr("cy",a.cLoc[1])),t?s.transition().duration(t).ease("linear").attr("r",a.r):s.interrupt().attr("r",a.r),i._updateLabel(a,n,a.cLoc[0],a.cLoc[1],a.r,a.label,t))})},updateTime:function(){this.time_1=null==this.time?this.model.time.value:this.time,this.time=this.model.time.value,this.duration=this.model.time.playing&&this.time-this.time_1>0?this.model.time.delayAnimations:0,this.year.setText(this.model.time.timeFormat(this.time)),this.updateTitleNumbers()},fitSizeOfTitles:function(){var t=this.yTitleEl.select("text").style("font-size",null),e=this.cTitleEl.select("text").style("font-size",null),t=this.yTitleEl.select("text"),e=this.cTitleEl.select("text"),i=t.node().getBBox(),a=e.classed("vzb-hidden")?i:e.node().getBBox(),n=Math.max(parseInt(t.style("font-size")),parseInt(e.style("font-size")))*this.width/Math.max(i.width,a.width);Math.max(i.width,a.width)>this.width?(t.style("font-size",n+"px"),e.style("font-size",n+"px")):(t.style("font-size",null),e.style("font-size",null))},updateSize:function(){var t,e,i={small:{margin:{top:10,right:10,left:10,bottom:0},infoElHeight:16,minRadius:.5,maxRadius:30},medium:{margin:{top:20,right:20,left:20,bottom:30},infoElHeight:20,minRadius:1,maxRadius:55},large:{margin:{top:30,right:30,left:30,bottom:35},infoElHeight:22,minRadius:1,maxRadius:70}},a={medium:{infoElHeight:26},large:{infoElHeight:32}};this.activeProfile=this.getActiveProfile(i,a),t=this.activeProfile.margin,e=this.activeProfile.infoElHeight;var n=this.height=parseInt(this.element.style("height"),10)-t.top-t.bottom,s=this.width=parseInt(this.element.style("width"),10)-t.left-t.right,r=this.boundBox,l=[r[0][0]*this.defaultWidth,r[0][1]*this.defaultHeight,Math.abs(r[1][0]-r[0][0])*this.defaultWidth,Math.abs(r[1][1]-r[0][1])*this.defaultHeight];this.graph.attr("transform","translate("+t.left+","+t.top+")"),this.year.resize(this.width,this.height,Math.min(this.width/2.5,Math.max(this.height/4,this.width/4))/2.5),this.mapSvg.attr("width",s).attr("height",n).attr("viewBox",l.join(" ")).attr("preserveAspectRatio","none").style("transform","translate3d("+t.left+"px,"+t.top+"px,0)");this.skew=function(){var t=l,e=[t[0]+t[2]/2,t[1]+t[3]/2],i=t[2]||.001,a=t[3]||.001;return function(t){var r=(t[0]-e[0])/i*s+s/2,l=(t[1]-e[1])/a*n+n/2;return[r,l]}}();this.yTitleEl.style("font-size",e).attr("transform","translate(0,"+t.top+")");var o=this.yTitleEl.select("text").node().getBBox();this.cTitleEl.select("text").attr("transform","translate(0,"+(t.top+o.height)+")").classed("vzb-hidden",-1!=this.model.marker.color.which.indexOf("geo"));var c=this.dataWarningEl.select("text").node().getBBox();if(this.dataWarningEl.select("svg").attr("width",.75*c.height).attr("height",.75*c.height).attr("x",-c.width-1.2*c.height).attr("y",.65*-c.height),this.dataWarningEl.attr("transform","translate("+this.width+","+(this.height-.5*c.height)+")").select("text"),this.infoEl.select("svg").node()){var h=this.yTitleEl.node().getBBox(),d=d3.transform(this.yTitleEl.attr("transform")).translate;this.infoEl.select("svg").attr("width",e).attr("height",e),this.infoEl.attr("transform","translate("+(h.x+d[0]+h.width+.4*e)+","+(d[1]-.8*e)+")")}},updateMarkerSizeLimits:function(){var t=this,e=this.model.marker.size.extent||[0,1],i=this.activeProfile.minRadius,a=this.activeProfile.maxRadius;this.minRadius=Math.max(a*e[0],i),this.maxRadius=Math.max(a*e[1],i),"ordinal"!==this.model.marker.size.scaleType?this.sScale.range([Mt(t.minRadius),Mt(t.maxRadius)]):this.sScale.rangePoints([Mt(t.minRadius),Mt(t.maxRadius)],0).range()},_interact:function(){var t=this;return{_mouseover:function(e,i){t.model.time.dragging||(t.model.entities.highlightEntity(e),t.hovered=e,t.updateTitleNumbers(),t.fitSizeOfTitles(),t.model.entities.isSelected(e)?t._setTooltip():t._setTooltip(e))},_mouseout:function(e,i){t.model.time.dragging||(t._setTooltip(),t.hovered=null,t.updateTitleNumbers(),t.fitSizeOfTitles(),t.model.entities.clearHighlighted())},_click:function(e,i){t.model.entities.selectEntity(e)}}},highlightEntities:function(){this.someHighlighted=this.model.entities.highlight.length>0},_updateLabel:function(t,e,i,a,n,s,r){var l=this,o=this.KEY;if(t[o]!=l.druging){null==r&&(r=l.duration),null==l.cached[t[o]]&&(l.cached[t[o]]={});var c=l.cached[t[o]];if(l.model.entities.isSelected(t)&&null!=l.entityLabels){var h=ft(l.model.entities.select,function(e){return e[o]==t[o]}),d=l.entityLines.filter(function(e){return e[o]==t[o]});l.entityLabels.filter(function(e){return e[o]==t[o]}).each(function(o){c.valueX=i,c.valueY=a;var u,m,g,p;null!=c.scaledS0&&null!=c.labelX0&&null!=c.labelX0||(c.scaledS0=n,c.labelX0=i/l.width,c.labelY0=a/l.height);var f=d3.select(this),v=f.selectAll(".vzb-bmc-label-content").text(s);d.select("line").style("stroke-dasharray","0 "+n+" 100%");var b=f.select("rect"),y=v[0][0].getBBox();if(!c.contentBBox||c.contentBBox.width!=y.width){c.contentBBox=y;var x=f.select(".vzb-bmc-label-x").attr("x",4).attr("y",-1*y.height);x.select("circle").attr("cx",4).attr("cy",-1*y.height).attr("r",.5*y.height),x.select("svg").attr("x",.5*-y.height+4).attr("y",-1.5*y.height).attr("width",y.height).attr("height",y.height),b.attr("width",y.width+8).attr("height",1.2*y.height).attr("x",-y.width-4).attr("y",.85*-y.height).attr("rx",.2*y.height).attr("ry",.2*y.height)}g=c.labelX0*l.width,p=c.labelY0*l.height;var _=h.labelOffset||[0,0];c.labelX_=_[0]||(.75*-c.scaledS0-5)/l.width,c.labelY_=_[1]||(.75*-c.scaledS0-11)/l.height,u=g+c.labelX_*l.width,u-c.contentBBox.width<=0?(c.labelX_=(.75*c.scaledS0+c.contentBBox.width+10)/l.width,u=g+c.labelX_*l.width):u+15>l.width&&(c.labelX_=(l.width-15-g)/l.width,u=g+c.labelX_*l.width),m=p+c.labelY_*l.height,m-c.contentBBox.height<=0?(c.labelY_=(.75*c.scaledS0+c.contentBBox.height)/l.height,m=p+c.labelY_*l.height):m+10>l.height&&(c.labelY_=(l.height-10-p)/l.height,m=p+c.labelY_*l.height),l._repositionLabels(t,e,this,u,m,g,p,r,d)})}else null!=l.cached[t[o]]&&(l.cached[t[o]]=void 0)}},_repositionLabels:function(t,e,i,a,n,s,r,l,o){var c=this,h=this.cached[t[this.KEY]],d=d3.select(i),u=parseInt(d.select("rect").attr("width")),m=parseInt(d.select("rect").attr("height")),g=h.labelX0*c.width,p=h.labelY0*c.height,f=this.activeProfile.margin.top+1.2*this.activeProfile.infoElHeight;0>=a-u?(h.labelX_=(u-g)/this.width,a=g+h.labelX_*this.width):a+20>this.width&&(h.labelX_=(this.width-20-g)/this.width,a=g+h.labelX_*this.width),0>=n-(.5*m+f)?(h.labelY_=(.5*m+f-p)/this.height,n=p+h.labelY_*this.height):n+13>this.height&&(h.labelY_=(this.height-13-p)/this.height,n=h.labelY0+h.labelY_*this.height),l?(d.transition().duration(l).ease("linear").attr("transform","translate("+a+","+n+")"),o.transition().duration(l).ease("linear").attr("transform","translate("+a+","+n+")")):(d.interrupt().attr("transform","translate("+a+","+n+")"),o.interrupt().attr("transform","translate("+a+","+n+")"));var v=s-a,b=r-n,y=0,x=0,_=180*Math.atan2(v+u/2,b+m/2)/Math.PI;Math.abs(_)<=45&&(y=u/2,x=0),_>45&&135>_&&(y=0,x=m/4),-45>_&&_>-135&&(y=u-4,x=m/4),Math.abs(_)>=135&&(y=u/2,x=m/2),o.selectAll("line").attr("x1",v).attr("y1",b).attr("x2",-y).attr("y2",-x)},selectEntities:function(){var t=this,e=this.KEY;this.someSelected=this.model.entities.select.length>0,this.entityLabels=this.labelsContainer.selectAll(".vzb-bmc-entity").data(t.model.entities.select,function(t){return t[e]}),this.entityLines=this.linesContainer.selectAll(".vzb-bmc-entity").data(t.model.entities.select,function(t){return t[e]}),this.entityLabels.exit().remove(),this.entityLines.exit().remove(),this.entityLines.enter().append("g").attr("class","vzb-bmc-entity").each(function(t,e){d3.select(this).append("line").attr("class","vzb-bmc-label-line")}),this.entityLabels.enter().append("g").attr("class","vzb-bmc-entity").call(t.labelDragger).each(function(e,i){var a=d3.select(this);a.append("rect"),a.append("text").attr("class","vzb-bmc-label-content vzb-label-shadow"),a.append("text").attr("class","vzb-bmc-label-content");var n=a.append("g").attr("class","vzb-bmc-label-x vzb-transparent");re(n,mi),n.insert("circle","svg"),n.select("svg").attr("class","vzb-bmc-label-x-icon").attr("width","0px").attr("height","0px"),n.on("click",function(){t.model.entities.clearHighlighted(),d3.event.defaultPrevented||t.model.entities.selectEntity(e)})}).on("mouseover",function(e){ne()||(t.model.entities.highlightEntity(e),d3.select(this).selectAll(".vzb-bmc-label-x").classed("vzb-transparent",!1))}).on("mouseout",function(e){ne()||(t.model.entities.clearHighlighted(),d3.select(this).selectAll(".vzb-bmc-label-x").classed("vzb-transparent",!0))}).on("click",function(t){if(ne()){var e=d3.select(this).selectAll(".vzb-bmc-label-x");e.classed("vzb-transparent",!e.classed("vzb-transparent"))}}),t.hovered&&!t.model.entities.isSelected(t.hovered)||t._setTooltip()},_setTooltip:function(t){if(t){var e,i,a=t.label,n=t.cLoc[0],s=t.cLoc[1],r=t.r,l=d3.mouse(this.graph.node()).map(function(t){return parseInt(t)}),o=-1,c=-1,h=0,d=0;r&&(h=.71*r,d=.71*r),this.tooltip.classed("vzb-hidden",!1).selectAll("text").text(a);
var u=this.tooltip.select("text")[0][0].getBBox();n-h-u.width<0?(o=1,n+=u.width+5):n-=5,s-d-u.height<0?(c=1,s+=u.height):s-=11,r?(e=n+h*o,i=s+d*c):(e=n+h*o,i=s+d*c),this.tooltip.attr("transform","translate("+(e?e:l[0])+","+(i?i:l[1])+")"),this.tooltip.select("rect").attr("width",u.width+8).attr("height",1.2*u.height).attr("x",-u.width-4).attr("y",.85*-u.height).attr("rx",.2*u.height).attr("ry",.2*u.height)}else this.tooltip.classed("vzb-hidden",!0)}}),nn=Ei.extend("BubbleMap",{init:function(t,e){this.name="bubblemap",this.components=[{component:an,placeholder:".vzb-tool-viz",model:["state.time","state.entities","state.marker","language","ui"]},{component:aa,placeholder:".vzb-tool-timeslider",model:["state.time"]},{component:Na,placeholder:".vzb-tool-dialogs",model:["state","ui","language"]},{component:Oa,placeholder:".vzb-tool-buttonlist",model:["state","ui","language"]},{component:Ui,placeholder:".vzb-tool-treemenu",model:["state.marker","language"]},{component:Ya,placeholder:".vzb-tool-datawarning",model:["language"]}],this._super(t,e)},default_model:{state:{time:{},entities:{dim:"geo",show:{_defs_:{geo:["*"],"geo.cat":["region"]}}},marker:{space:["entities","time"],label:{use:"property",which:"geo.name"},axis_y:{use:"indicator",which:"lex"},axis_x:{use:"property",which:"geo.name"},color:{use:"property",which:"geo.region"}}},data:{reader:"csv",path:"data/waffles/basic-indicators.csv"},ui:{chart:{labels:{dragging:!0}},presentation:!0}}}),sn="",rn=[],ln='<?xml version="1.0" encoding="utf-8"?>',on=he.extend({init:function(t){this.context=t,this.shapes=[],this.groups=[],this.counter=0,this.name="",this.label=""},reset:function(){this.container.remove(),this.context.element.selectAll(".vzb-export-redball").remove(),this.context.element.selectAll(".vzb-export-counter").remove(),this.counter=0},prefix:function(t){return arguments.length?(sn=t,this):sn},deleteClasses:function(t){return arguments.length?(rn=t,this):rn},open:function(t,e){var i=this;this.svg&&this.reset(),t||(t=this.context.element),e||(e=this.context.name),this.name=e;var a=parseInt(t.style("width"),10),n=parseInt(t.style("height"),10);this.container=t.append("div").attr("class","vzb-svg-export"),this.svg=this.container.node().appendChild(t.select("svg").node().cloneNode(!0)),this.svg=d3.select(this.svg),this.svg.attr("viewBox","0 0 "+a+" "+n).attr("version","1.1").attr("param1","http://www.w3.org/2000/svg").attr("param2","http://www.w3.org/1999/xlink").attr("x","0px").attr("y","0px").attr("style","enable-background:new 0 0 "+a+" "+n).attr("xml:space","preserve"),this.redBall=t.append("div").attr("class","vzb-export-redball").style("position","absolute").style("top","20px").style("right","20px").style("width","20px").style("height","20px").style("background","red").style("color","white").style("text-align","center").style("border-radius","10px").style("font-size","14px").style("line-height","20px").style("opacity",.8).style("cursor","pointer").on("mouseover",function(){d3.select(this).style("opacity",1).text("▼"),i.counterEl.text("Download")}).on("mouseout",function(){d3.select(this).style("opacity",.8).text(""),i.counterEl.text(i.label)}).on("click",function(){i.close()}),this.counterEl=t.append("div").attr("class","vzb-export-counter").style("position","absolute").style("top","20px").style("right","45px").style("color","red").style("opacity",.8).style("line-height","20px").style("font-size","14px").style("text-align","center"),this.root=this.svg.select("."+sn+"graph"),this.root.selectAll("g, text, svg, line, rect").filter(function(){var t=d3.select(this),e=!1;return rn.forEach(function(i){e=e||t.classed(i)}),e}).remove(),this.svg.selectAll(".tick line").attr("fill","none").attr("stroke","#999"),this.svg.selectAll("."+sn+"axis-x path").attr("fill","none").attr("stroke","#999"),this.svg.selectAll("."+sn+"axis-y path").attr("fill","none").attr("stroke","#999")},write:function(t){var e="time";if(this.root||this.open(),!(this.shapes.indexOf(t.id+"_"+t.time)>-1)){this.shapes.push(t.id+"_"+t.time),-1==this.groups.indexOf(t[e])&&(this.root.append("g").attr("id","g_"+t[e]),this.groups.push(t[e])),null==t.opacity&&(t.opacity=.5),null==t.fill&&(t.fill="#ff80dd");var i=this.root.select("#g_"+t[e]).append(t.type).attr("id",t.id+"_"+t.time).style("fill",t.fill).style("opacity",t.opacity);switch(t.type){case"path":i.attr("d",t.d);break;case"circle":i.attr("cx",t.cx).attr("cy",t.cy).attr("r",t.r)}this.counter++,this.redBall.style("opacity",this.counter%10/12+.2),this.label=t.type+" shapes: "+this.counter,this.counterEl.text(this.label)}},close:function(){var t=ln+" "+this.container.node().innerHTML.replace("param1","xmlns").replace("param2","xmlns:xlink").replace(/\d+(\.\d+)/g,function(t){return Math.round(100*+t)/100+""});if(t.length/1024/1024>2)alert("The file size is "+Math.round(t.length/1024)+"kB, which is too large to download. Will try to print it in the console instead..."),console.log(t);else{var e=document.createElement("a");e.download=this.name+" "+this.counter+" shapes.svg",e.href="data:,"+t,e.click()}}}),cn=he.extend({init:function(t){this.context=t,this.xScaleFactor=1,this.xScaleShift=0},rescale:function(t){return Math.exp(this.xScaleFactor*Math.log(t)+this.xScaleShift)},unscale:function(t){return Math.exp((Math.log(t)-this.xScaleShift)/this.xScaleFactor)},generateMesh:function(t,e,i){var a="linear"===e?i[0]:Math.log(this.unscale(i[0])),n="linear"===e?i[1]:Math.log(this.unscale(i[1])),s=(n-a)/t,r=d3.range(a,n,s).concat(n);return r="linear"!==e?r.map(function(t){return Math.exp(t)}):r.filter(function(t){return t>0})},gdpToMu:function(t,e,i,a){return Math.log(t/365)-e*e/2},giniToSigma:function(t){return this.normsinv((t/100+1)/2)*Math.pow(2,.5)},pdf:{normal:function(t,e,i){return Math.exp(-.5*Math.log(2*Math.PI)-Math.log(i)-Math.pow(t-e,2)/(2*i*i))},lognormal:function(t,e,i){return Math.exp(-.5*Math.log(2*Math.PI)-Math.log(i)-Math.pow(Math.log(t)-e,2)/(2*i*i))}},normsinv:function(t){var e=[-39.69683028665376,220.9460984245205,-275.9285104469687,138.357751867269,-30.66479806614716,2.506628277459239],i=[-54.47609879822406,161.5858368580409,-155.6989798598866,66.80131188771972,-13.28068155288572],a=[-.007784894002430293,-.3223964580411365,-2.400758277161838,-2.549732539343734,4.374664141464968,2.938163982698783],n=[.007784695709041462,.3224671290700398,2.445134137142996,3.754408661907416],s=.02425,r=1-s;if(s>t){var l=Math.sqrt(-2*Math.log(t));return(((((a[0]*l+a[1])*l+a[2])*l+a[3])*l+a[4])*l+a[5])/((((n[0]*l+n[1])*l+n[2])*l+n[3])*l+1)}if(t>r){var l=Math.sqrt(-2*Math.log(1-t));return-(((((a[0]*l+a[1])*l+a[2])*l+a[3])*l+a[4])*l+a[5])/((((n[0]*l+n[1])*l+n[2])*l+n[3])*l+1)}var l=t-.5,o=l*l;return(((((e[0]*o+e[1])*o+e[2])*o+e[3])*o+e[4])*o+e[5])*l/(((((i[0]*o+i[1])*o+i[2])*o+i[3])*o+i[4])*o+1)}}),hn=he.extend({init:function(t){this.context=t},rebuild:function(t){var e=this.context,i=e.mountainPointers.concat(e.groupedPointers).concat(e.stackedPointers).filter(function(t){return e.model.entities.isSelected(t)}).sort(function(t,e){return t.sortValue&&e.sortValue?t.sortValue[1]===e.sortValue[1]?d3.descending(t.sortValue[0],e.sortValue[0]):d3.descending(t.sortValue[1],e.sortValue[1]):t.aggrLevel!=e.aggrLevel?d3.descending(t.aggrLevel,e.aggrLevel):t.aggrLevel&&e.aggrLevel?d3.descending(t.yMax,e.yMax):0});e.selectList=e.mountainLabelContainer.selectAll("g.vzb-mc-label").data(gt(i,function(t){return t.KEY()})),e.selectList.exit().remove(),e.selectList.enter().append("g").attr("class","vzb-mc-label").each(function(t,i){var a=d3.select(this);a.append("circle").attr("class","vzb-mc-label-legend"),a.append("text").attr("class","vzb-mc-label-shadow vzb-mc-label-text"),a.append("text").attr("class","vzb-mc-label-text"),a.append("g").attr("class","vzb-mc-label-x vzb-label-shadow vzb-invisible").on("click",function(t,i){ne()||(d3.event.stopPropagation(),e.model.entities.clearHighlighted(),e.model.entities.selectEntity(t),d3.event.stopPropagation())}).onTap(function(t,i){d3.select("#"+t.geo+"-label").remove(),e.model.entities.clearHighlighted(),e.model.entities.selectEntity(t)});var n=a.select("g.vzb-mc-label-x");ne()?(n.append("rect"),n.append("text").attr("class","vzb-mc-label-x-text").text("Deselect")):(re(n,mi).select("svg").attr("class","vzb-mc-label-x-icon").attr("width","0px").attr("height","0px"),n.insert("circle","svg"))}).on("mousemove",function(t,i){ne()||e.model.entities.highlightEntity(t)}).on("mouseout",function(t,i){ne()||e.model.entities.clearHighlighted()}).on("click",function(t,i){ne()||(e.model.entities.clearHighlighted(),e.model.entities.selectEntity(t))})},redraw:function(){var t=this.context;if(t.selectList&&t.someSelected){var e=t.mountainLabelContainer.append("g").attr("class","vzb-mc-label").append("text").text("0"),i=1.2*e[0][0].getBBox().height,a=parseFloat(e.style("font-size"))/i;d3.select(e[0][0].parentNode).remove();var n=t.model.marker.axis_y.tickFormatter,s=t.yTitleEl.select("text").node().getBBox().height||0,r=(t.height-3*s)/(t.selectList.data().length+2);i>r&&(i=r);var l="null",o=0;t.selectList.attr("transform",function(t,e){t.aggrLevel!=l&&(o+=i);var a=i*e+1.5*s+o;return l=t.aggrLevel,"translate(0,"+a+")"}).each(function(e,s){var l=d3.select(this).attr("id",e.geo+"-label"),o=e.key?t.translator("region/"+e.key):t.values.label[e.KEY()],c=t.values.axis_y[e.KEY()],h=o+": "+n(c)+(0===s?" "+t.translator("mount/people"):""),d=l.selectAll(".vzb-mc-label-text").attr("x",i).attr("y",i).text(h).style("font-size",i===r?i*a+"px":null),u=d[0][0].getBBox(),m=l.select(".vzb-mc-label-x");if(ne()){var g=m.select("text").node().getBBox();m.classed("vzb-revert-color",!0).select(".vzb-mc-label-x-text").classed("vzb-revert-color",!0).attr("x",u.width+1.12*u.height+.5*g.width).attr("y",.55*u.height),m.select("rect").attr("width",g.width+.6*u.height).attr("height",u.height).attr("x",u.width+.9*u.height).attr("y",0).attr("rx",.25*u.height).attr("ry",.25*u.height)}else m.attr("x",u.width+1.1*u.height).attr("y",u.height/3),m.select("circle").attr("r",.4*u.height).attr("cx",u.width+1.1*u.height).attr("cy",u.height/3),m.select("svg").attr("x",u.width+u.height*(1.1-.4)).attr("y",u.height*(1/3-.4)).attr("width",.8*u.height).attr("height",.8*u.height);l.select(".vzb-mc-label-legend").attr("r",i/3).attr("cx",.4*i).attr("cy",i/1.5).style("fill",t.cScale(t.values.color[e.KEY()])),l.onTap(function(e,i){d3.event.stopPropagation(),t.model.entities.highlightEntity(e),setTimeout(function(){t.model.entities.unhighlightEntity(e)},2e3)})})}}}),dn=he.extend({init:function(t){this.context=t},redraw:function(t){var e=this.context;if(t||(t={}),t.level||(t.level=e.model.ui.chart.probeX),e.probeEl.classed("vzb-hidden",!t.level),t.level){e.xAxisEl.call(e.xAxis.highlightValue(t.full?t.level:"none"));var i=0,a=0,n=0,s=function(s){i+=e.values.axis_y[s.KEY()],e.cached[s.KEY()].forEach(function(i){a+=i.y,e._math.rescale(i.x)<t.level&&(n+=i.y)})};"all"===e.model.marker.stack.which?e.stackedPointers.forEach(s):"none"===e.model.marker.stack.which?e.mountainPointers.forEach(s):e.groupedPointers.forEach(s);var r=d3.format(".3r"),l=e.model.marker.axis_y.tickFormatter;e.heightOfLabels=e.heightOfLabels||.66*e.height,e.probeTextEl.each(function(i,a){if(8===a){var n=d3.select(this);t.full||e.model.ui.chart.probeX!=e.model.marker.axis_x.tailFatX?n.classed("vzb-hidden",!0):(n.text(e.translator("mount/extremepoverty")).classed("vzb-hidden",!1).attr("x",-e.height).attr("y",e.xScale(t.level)).attr("dy","-1em").attr("dx","0.5em").attr("transform","rotate(-90)"),e.heightOfLabels=e.height-n.node().getBBox().width-1.75*n.node().getBBox().height)}}),e.probeTextEl.each(function(s,o){if(8!==o){var c,h=d3.select(this);0!==o&&4!==o||(c=r(n/a*100)+"%"),1!==o&&5!==o||(c=r(100-n/a*100)+"%"),2!==o&&6!==o||(c=l(i*n/a)),3!==o&&7!==o||(c=l(i*(1-n/a))+" "+e.translator("mount/people")),h.text(c).classed("vzb-hidden",!t.full&&0!==o&&4!==o).attr("x",e.xScale(t.level)+([0,4,2,6].indexOf(o)>-1?-5:5)).attr("y",e.heightOfLabels).attr("dy",[0,1,4,5].indexOf(o)>-1?0:"1.5em")}}),e.probeLineEl.attr("x1",e.xScale(t.level)).attr("x2",e.xScale(t.level)).attr("y1",e.height+6).attr("y2",0)}}}),un=.001,mn=Xe.extend({init:function(t,e){var i=this;this.name="mountainchart",this.template="mountainchart.html",this.model_expects=[{name:"time",type:"time"},{name:"entities",type:"entities"},{name:"marker",type:"model"},{name:"language",type:"language"},{name:"ui",type:"model"}],this.model_binds={"change:time.value":function(t){i.model.marker.getFrame(i.model.time.value,i.frameChanged.bind(i))},"change:time.playing":function(t){i.model.time.playing||i.redrawDataPoints()},"change:marker.axis_x.xScaleFactor":function(){i.ready()},"change:marker.axis_x.xScaleShift":function(){i.ready()},"change:marker.axis_x.tailFatX":function(){i.ready()},"change:marker.axis_x.tailCutX":function(){i.ready()},"change:marker.axis_x.tailFade":function(){i.ready()},"change:ui.chart.probeX":function(){i.ready()},"change:ui.chart.xPoints":function(){i.ready()},"change:ui.chart.xLogStops":function(){i.updateSize()},"change:ui.chart.yMaxMethod":function(){i._adjustMaxY({force:!0}),i.redrawDataPoints()},"change:time.record":function(t){i.model.time.record?i._export.open(this.element,this.name):i._export.reset()},"change:entities.highlight":function(t){i._readyOnce&&(i.highlightEntities(),i.updateOpacity())},"change:entities.select":function(t){i._readyOnce&&(i.selectEntities(),i._selectlist.redraw(),i.updateOpacity(),i.updateDoubtOpacity(),i.redrawDataPoints())},"change:entities.opacitySelectDim":function(t){i.updateOpacity()},"change:entities.opacityRegular":function(t){i.updateOpacity()},"change:marker":function(t,e){return i._readyOnce?e.indexOf("scaleType")>-1?void i.ready():e.indexOf("zoomedMin")>-1||e.indexOf("zoomedMax")>-1?(i.zoomToMaxMin(),i.redrawDataPoints(),void i._probe.redraw()):void 0:void 0},"change:marker.group":function(t,e){i._readyOnce&&(e.indexOf("group.merge")>-1||i.ready())},"change:marker.group.merge":function(t){i._readyOnce&&(i.updateTime(),i.redrawDataPoints())},"change:marker.stack":function(t){i._readyOnce&&i.ready()},"change:marker.color.palette":function(t){i._readyOnce&&(i.redrawDataPointsOnlyColors(),i._selectlist.redraw())}},this._super(t,e),this._math=new cn(this),this._export=new on(this),this._export.prefix("vzb-mc-").deleteClasses(["vzb-mc-mountains-mergestacked","vzb-mc-mountains-mergegrouped","vzb-mc-mountains","vzb-mc-year","vzb-mc-mountains-labels","vzb-mc-axis-labels"]),this._probe=new dn(this),this._selectlist=new hn(this),this.area=d3.svg.area().interpolate("basis").x(function(t){return i.xScale(i._math.rescale(t.x))}).y0(function(t){return i.yScale(t.y0)}).y1(function(t){return i.yScale(t.y0+t.y)}),this.stack=d3.layout.stack().order("reverse").values(function(t){return i.cached[t.KEY()]}).out(function(t,e,i){t.y0=e}),this.xScale=null,this.yScale=null,this.cScale=null,this.xAxis=O(),this.rangeRatio=1,this.rangeShift=0,this.cached={},this.mesh=[],this.yMax=0},domReady:function(){var t=this;this.element=d3.select(this.element),this.graph=this.element.select(".vzb-mc-graph"),this.xAxisEl=this.graph.select(".vzb-mc-axis-x"),this.xTitleEl=this.graph.select(".vzb-mc-axis-x-title"),this.yTitleEl=this.graph.select(".vzb-mc-axis-y-title"),this.infoEl=this.graph.select(".vzb-mc-axis-info"),this.dataWarningEl=this.graph.select(".vzb-data-warning"),this.yearEl=this.graph.select(".vzb-mc-year"),this.year=new Ja(this.yearEl),this.mountainMergeStackedContainer=this.graph.select(".vzb-mc-mountains-mergestacked"),this.mountainMergeGroupedContainer=this.graph.select(".vzb-mc-mountains-mergegrouped"),this.mountainAtomicContainer=this.graph.select(".vzb-mc-mountains"),this.mountainLabelContainer=this.graph.select(".vzb-mc-mountains-labels"),this.tooltip=this.element.select(".vzb-mc-tooltip"),this.eventAreaEl=this.element.select(".vzb-mc-eventarea"),this.probeEl=this.element.select(".vzb-mc-probe"),this.probeLineEl=this.probeEl.select("line"),this.probeTextEl=this.probeEl.selectAll("text"),this.element.onTap(function(e,i){t._interact()._mouseout(e,i)})},afterPreload:function(){var t=this,e=t.model.time.value.getUTCFullYear(),i=t.model.time.end.getUTCFullYear();if(this._math.xScaleFactor=this.model.marker.axis_x.xScaleFactor,this._math.xScaleShift=this.model.marker.axis_x.xScaleShift,this.precomputedShapes&&this.precomputedShapes[e]&&this.precomputedShapes[i]){var a=this.precomputedShapes["immediate"==this.model.ui.chart.yMaxMethod?e:i].yMax,n=this.precomputedShapes[e].shape;a&&n&&0!==n.length&&(this.xScale=d3.scale.log().domain([this.model.marker.axis_x.domainMin,this.model.marker.axis_x.domainMax]),this.yScale=d3.scale.linear().domain([0,Math.round(a)]),t.updateSize(n.length),t.zoomToMaxMin(),n=n.map(function(e,i){return{x:t.mesh[i],y0:0,y:+e}}),this.mountainAtomicContainer.selectAll(".vzb-mc-prerender").data([0]).enter().append("path").attr("class","vzb-mc-prerender").style("fill","pink").style("opacity",0).attr("d",t.area(n)).transition().duration(1e3).ease("linear").style("opacity",1))}},readyOnce:function(){this.eventAreaEl.on("mousemove",function(){t.model.time.dragging||t._probe.redraw({level:t.xScale.invert(d3.mouse(this)[0]),full:!0})}).on("mouseout",function(){t.model.time.dragging||t._probe.redraw()});var t=this;this.on("resize",function(){t.updateSize(),t.updateTime(),t.redrawDataPoints(),t._selectlist.redraw(),t._probe.redraw()}),this.KEY=this.model.entities.getDimension(),this.TIMEDIM=this.model.time.getDimension(),this.mountainAtomicContainer.select(".vzb-mc-prerender").remove(),this.wScale=d3.scale.linear().domain(this.parent.datawarning_content.doubtDomain).range(this.parent.datawarning_content.doubtRange)},ready:function(){var t=this;this._math.xScaleFactor=this.model.marker.axis_x.xScaleFactor,this._math.xScaleShift=this.model.marker.axis_x.xScaleShift,this.updateUIStrings(),this.updateIndicators(),this.model.marker.getFrame(this.model.time.value,function(e){t.values=e,t.updateEntities(),t.updateSize(),t.zoomToMaxMin(),t._spawnMasks(),t.updateTime(),t._adjustMaxY({force:!0}),t.redrawDataPoints(),t.redrawDataPointsOnlyColors(),t.highlightEntities(),t.selectEntities(),t._selectlist.redraw(),t.updateOpacity(),t.updateDoubtOpacity(),t._probe.redraw()})},frameChanged:function(t,e){e.toString()==this.model.time.value.toString()&&(this.values=t,this.updateTime(),this.redrawDataPoints(),this._selectlist.redraw(),this._probe.redraw(),this.updateDoubtOpacity())},updateSize:function(t){var e,i,a={small:{margin:{top:10,right:10,left:10,bottom:18},infoElHeight:16},medium:{margin:{top:20,right:20,left:20,bottom:30},infoElHeight:20},large:{margin:{top:30,right:30,left:30,bottom:35},infoElHeight:22}},n={medium:{margin:{top:20,right:20,left:20,bottom:50},infoElHeight:26},large:{margin:{top:30,right:30,left:30,bottom:50},infoElHeight:32}};this.activeProfile=this.getActiveProfile(a,n),e=this.activeProfile.margin,i=this.activeProfile.infoElHeight,this.height=parseInt(this.element.style("height"),10)-e.top-e.bottom,this.width=parseInt(this.element.style("width"),10)-e.left-e.right,this.graph.attr("transform","translate("+e.left+","+e.top+")");var s={topOffset:"large"===this.getLayoutProfile()?2*e.top:0,xAlign:"large"===this.getLayoutProfile()?"right":"center",yAlign:"large"===this.getLayoutProfile()?"top":"center"},r="large"===this.getLayoutProfile()?this.width/6:Math.max(this.height/4,this.width/4);this.year.setConditions(s).resize(this.width,this.height,r),this.yScale.range([this.height,0]),this.xScale.range([this.rangeShift,this.width*this.rangeRatio+this.rangeShift]);var l=this._readyOnce?this.model.marker.axis_x.scaleType:"log";this.xAxis.scale(this.xScale).orient("bottom").tickSize(6,0).tickSizeMinor(3,0).labelerOptions({scaleType:l,toolMargin:e,pivotingLimit:1.5*e.bottom,method:this.xAxis.METHOD_REPEATING,stops:this._readyOnce?this.model.ui.chart.xLogStops:[1]}),this.xAxisEl.attr("transform","translate(0,"+this.height+")").call(this.xAxis),this.xTitleEl.select("text").attr("transform","translate("+this.width+","+this.height+")").attr("dy","-0.36em"),this.yTitleEl.style("font-size",i+"px").attr("transform","translate(0,"+e.top+")");var o=this.dataWarningEl.select("text").node().getBBox();if(this.dataWarningEl.select("svg").attr("width",o.height).attr("height",o.height).attr("x",.1*o.height).attr("y",1*-o.height+1),this.dataWarningEl.attr("transform","translate(0,"+(e.top+1.5*o.height)+")").select("text").attr("dx",1.5*o.height),this.infoEl.select("svg").node()){var c=this.yTitleEl.node().getBBox(),h=d3.transform(this.yTitleEl.attr("transform")).translate;this.infoEl.select("svg").attr("width",i+"px").attr("height",i+"px"),this.infoEl.attr("transform","translate("+(c.x+h[0]+c.width+.4*i)+","+(h[1]-.8*i)+")")}this.eventAreaEl.attr("y",this.height).attr("width",this.width).attr("height",e.bottom),t||(t=this.model.ui.chart.xPoints),this.mesh=this._math.generateMesh(t,l,this.xScale.domain())},zoomToMaxMin:function(){if(null!=this.model.marker.axis_x.zoomedMin&&null!=this.model.marker.axis_x.zoomedMax){var t=this.xScale(this.model.marker.axis_x.zoomedMin),e=this.xScale(this.model.marker.axis_x.zoomedMax);this.rangeRatio=this.width/(e-t)*this.rangeRatio,this.rangeShift=(this.rangeShift-t)/(e-t)*this.width,this.xScale.range([this.rangeShift,this.width*this.rangeRatio+this.rangeShift]),this.xAxisEl.call(this.xAxis)}},updateUIStrings:function(){var t=this;this.translator=this.model.language.getTFunction();var e=this.model.marker.axis_x.getMetadata();this.xTitleEl.select("text").text(this.translator("unit/mountainchart_hardcoded_income_per_day")),this.yTitleEl.select("text").text(this.translator("mount/title")),re(this.dataWarningEl,hi).select("svg").attr("width","0px").attr("height","0px"),this.dataWarningEl.append("text").text(this.translator("hints/dataWarning")),re(this.infoEl,ui).select("svg").attr("width","0px").attr("height","0px"),this.infoEl.on("click",function(){window.open(e.sourceLink,"_blank").focus()}),this.dataWarningEl.on("click",function(){t.parent.findChildByName("gapminder-datawarning").toggle()}).on("mouseover",function(){t.updateDoubtOpacity(1)}).on("mouseout",function(){t.updateDoubtOpacity()})},updateDoubtOpacity:function(t){null==t&&(t=this.wScale(+this.time.getUTCFullYear().toString())),this.someSelected&&(t=1),this.dataWarningEl.style("opacity",t)},updateIndicators:function(){var t=this;this.yScale=this.model.marker.axis_y.getScale(),this.xScale=this.model.marker.axis_x.getScale(),this.cScale=this.model.marker.color.getScale(),this.xAxis.tickFormat(t.model.marker.axis_x.tickFormatter)},updateEntities:function(){var t=this;this.mountainPointers=this.model.marker.getKeys().filter(function(e){return t.values.axis_x[e[t.KEY]]&&t.values.axis_y[e[t.KEY]]&&t.values.axis_s[e[t.KEY]]}).map(function(e){var i={};return i[t.KEY]=e[t.KEY],i.KEY=function(){return this[t.KEY]},i.sortValue=[t.values.axis_y[i.KEY()]||0,0],i.aggrLevel=0,i}),this.groupedPointers=d3.nest().key(function(e){return"property"===t.model.marker.stack.use?t.values.stack[e.KEY()]:t.values.group[e.KEY()]}).sortValues(function(t,e){return e.sortValue[0]-t.sortValue[0]}).entries(this.mountainPointers);var e=this.model.marker.group.manualSorting;this.groupedPointers.forEach(function(i){var a=d3.sum(i.values.map(function(t){return t.sortValue[0]}));e&&e.length>1&&(a=e.length-1-e.indexOf(i.key)),i.values.forEach(function(t){t.sortValue[1]=a}),i[t.model.entities.getDimension()]=i.key,i.KEY=function(){return this.key},i.aggrLevel=1});var i={};t.groupedPointers.map(function(t){i[t.key]=t.values[0].sortValue[1]}),"none"===t.model.marker.stack.which?(this.stackedPointers=[],this.mountainPointers.sort(function(t,e){return e.sortValue[0]-t.sortValue[0]})):(this.stackedPointers=d3.nest().key(function(e){return t.values.stack[e.KEY()]}).key(function(e){return t.values.group[e.KEY()]}).sortKeys(function(t,e){return i[e]-i[t]}).sortValues(function(t,e){return e.sortValue[0]-t.sortValue[0]}).entries(this.mountainPointers),this.mountainPointers.sort(function(t,e){return e.sortValue[1]-t.sortValue[1]}),this.stackedPointers.forEach(function(e){e.KEY=function(){return this.key},e[t.model.entities.getDimension()]=e.key,e.aggrLevel=2})),this.mountainsMergeStacked=this.mountainAtomicContainer.selectAll(".vzb-mc-mountain.vzb-mc-aggrlevel2").data(this.stackedPointers),this.mountainsMergeGrouped=this.mountainAtomicContainer.selectAll(".vzb-mc-mountain.vzb-mc-aggrlevel1").data(this.groupedPointers),this.mountainsAtomic=this.mountainAtomicContainer.selectAll(".vzb-mc-mountain.vzb-mc-aggrlevel0").data(this.mountainPointers),this.mountainsMergeStacked.exit().remove(),this.mountainsMergeGrouped.exit().remove(),this.mountainsAtomic.exit().remove(),this.mountainsMergeStacked.enter().append("path").attr("class","vzb-mc-mountain vzb-mc-aggrlevel2"),this.mountainsMergeGrouped.enter().append("path").attr("class","vzb-mc-mountain vzb-mc-aggrlevel1"),this.mountainsAtomic.enter().append("path").attr("class","vzb-mc-mountain vzb-mc-aggrlevel0"),this.mountains=this.mountainAtomicContainer.selectAll(".vzb-mc-mountain"),this.mountains.on("mousemove",function(e,i){ne()||t._interact()._mousemove(e,i)}).on("mouseout",function(e,i){ne()||t._interact()._mouseout(e,i)}).on("click",function(e,i){ne()||(t._interact()._click(e,i),t.highlightEntities())}).onTap(function(e,i){t._interact()._click(e,i),d3.event.stopPropagation()}).onLongTap(function(t,e){})},_interact:function(){var t=this;return{_mousemove:function(e,i){if(!t.model.time.dragging&&!t.model.time.playing){t.model.entities.highlightEntity(e);d3.mouse(t.graph.node()).map(function(t){return parseInt(t)});t._setTooltip(e.key?t.translator("region/"+e.key):t.values.label[e.KEY()])}},_mouseout:function(e,i){t.model.time.dragging||t.model.time.playing||(t._setTooltip(""),t.model.entities.clearHighlighted())},_click:function(e,i){t.model.time.dragging||t.model.time.playing||t.model.entities.selectEntity(e)}}},highlightEntities:function(){var t=this;this.someHighlighted=this.model.entities.highlight.length>0,this.selectList&&this.someSelected&&(this.selectList.classed("vzb-highlight",function(e){return t.model.entities.isHighlighted(e)}),this.selectList.each(function(e,i){d3.select(this).selectAll(".vzb-mc-label-x").classed("vzb-invisible",function(i){return!t.model.entities.isHighlighted(e)})}))},selectEntities:function(){this.someSelected=this.model.entities.select.length>0,this._selectlist.rebuild()},_sumLeafPointersByMarker:function(t,e){var i=this;return t.key?d3.sum(t.values.map(function(t){return i._sumLeafPointersByMarker(t,e)})):i.values[e][t.KEY()]},updateOpacity:function(){var t=this,e=1,i=.3,a=this.model.entities.opacityRegular,n=this.model.entities.opacityRegular,s=this.model.entities.opacitySelectDim;this.mountains.style("opacity",function(r){return t.someHighlighted&&t.model.entities.isHighlighted(r)?e:t.someSelected?t.model.entities.isSelected(r)?a:s:t.someHighlighted?i:n}),this.mountains.classed("vzb-selected",function(e){return t.model.entities.isSelected(e)});var r=t.someSelected&&t.model.entities.opacitySelectDim<.01;r!==this.someSelectedAndOpacityZero_1&&this.mountainsAtomic.style("pointer-events",function(e){return!r||t.model.entities.isSelected(e)?"visible":"none"}),this.someSelectedAndOpacityZero_1=t.someSelected&&t.model.entities.opacitySelectDim<.01},updateTime:function(t){var e=this;this.time=this.model.time.value,null==t&&(t=this.time),this.year.setText(t.getUTCFullYear().toString()),this.yMax=0,this.mountainPointers.forEach(function(t,i){var a=e._spawn(e.values,t);e.cached[t.KEY()]=a,t.hidden=0===a.length}),"none"!==e.model.marker.stack.which&&this.stackedPointers.forEach(function(t){var i=[];t.values.forEach(function(t){i=i.concat(t.values.filter(function(t){return!t.hidden}))}),e.stack(i)}),this.mountainPointers.forEach(function(t){t.yMax=d3.max(e.cached[t.KEY()].map(function(t){return t.y0+t.y})),e.yMax<t.yMax&&(e.yMax=t.yMax)});var i=e.model.marker.group.merge,a=e.model.marker.stack.merge;(e.model.time.dragging||e.model.time.playing)&&"none"!==this.model.marker.stack.which;this.stackedPointers.forEach(function(t){var i=e._getFirstLastPointersInStack(t);e.cached[t.key]=e._getVerticesOfaMergedShape(i),e.values.color[t.key]="_default",e.values.axis_y[t.key]=e._sumLeafPointersByMarker(t,"axis_y"),t.yMax=i.first.yMax}),this.groupedPointers.forEach(function(t){var i=e._getFirstLastPointersInStack(t);e.cached[t.key]=e._getVerticesOfaMergedShape(i),e.values.color[t.key]=e.values.color[i.first.KEY()],e.values.axis_y[t.key]=e._sumLeafPointersByMarker(t,"axis_y"),t.yMax=i.first.yMax}),a||i||"property"!==this.model.marker.stack.use||this.groupedPointers.forEach(function(t){var e=t.values.filter(function(t){return!t.hidden});t.yMax=e[0].yMax,t.values.forEach(function(e){e.yMaxGroup=t.yMax})})},_getFirstLastPointersInStack:function(t){var e,i;if(t.values[0].values){e=t.values[0].values.filter(function(t){return!t.hidden}),i=t.values[t.values.length-1].values.filter(function(t){return!t.hidden});var a=e[0],n=i[i.length-1]}else{e=t.values.filter(function(t){return!t.hidden});var a=e[0],n=e[e.length-1]}return(!e.length||i&&!i.length)&&kt("mountain chart failed to generate shapes. check the incoming data"),{first:a,last:n}},_getVerticesOfaMergedShape:function(t){var e=this,i=t.first.KEY(),a=t.last.KEY();return e.mesh.map(function(t,n){var s=e.cached[i][n].y0+e.cached[i][n].y-e.cached[a][n].y0,r=e.cached[a][n].y0;return{x:t,y0:r,y:s}})},_spawnMasks:function(){var t=this,e=this._math.unscale(this.model.marker.axis_x.tailFatX),i=this._math.unscale(this.model.marker.axis_x.tailCutX),a=this.model.marker.axis_x.tailFade,n=2*Math.PI/(Math.log(e)-Math.log(i)),s=Math.PI-Math.log(e)*n;this.spawnMask=[],this.cosineShape=[],this.cosineArea=0,this.mesh.map(function(r,l){t.spawnMask[l]=i>r?1:r>7*a?0:Math.exp((i-r)/a),t.cosineShape[l]=r>i&&e>r?1+Math.cos(Math.log(r)*n+s):0,t.cosineArea+=t.cosineShape[l]})},_spawn:function(t,e){var i=this,a=t.axis_y[e.KEY()],n=i._math.giniToSigma(t.axis_s[e.KEY()]),s=i._math.gdpToMu(t.axis_x[e.KEY()],n);if(!a||!s||!n)return[];var r=[],l=0;this.mesh.map(function(t,e){r[e]=i._math.pdf.lognormal(t,s,n),l+=i.spawnMask[e]*r[e]});var o=this.mesh.map(function(t,e){return{x:t,y0:0,y:a*(r[e]*(1-i.spawnMask[e])+i.cosineShape[e]/i.cosineArea*l)}});return o},_adjustMaxY:function(t){t||(t={});var e=this,i=this.model.ui.chart.yMaxMethod;if("immediate"===i||t.force)if("latest"===i){var a=e.values;e.model.marker.getFrame(e.model.time.end,function(t){e.values=t,e.updateTime(),e.values=a,e.yScale.domain([0,Math.round(e.yMax)]),e.updateTime()})}else e.yMax||kt("Setting yMax to "+e.yMax+". You failed again :-/"),e.yScale.domain([0,Math.round(e.yMax)])},redrawDataPoints:function(){var t=this,e=this.model.marker.group.merge,i=this.model.marker.stack.merge,a=this.model.marker.stack.which,n=(this.model.time.dragging||this.model.time.playing)&&"none"!==a&&!(this.model.time.value-this.model.time.end==0&&!this.model.time.loop);this._adjustMaxY(),this.mountainsMergeStacked.each(function(e){var a=d3.select(this),n=!i;t._renderShape(a,e.KEY(),n)}),this.mountainsMergeGrouped.each(function(a){var s=d3.select(this),r=!e&&!n||i&&!t.model.entities.isSelected(a);t._renderShape(s,a.KEY(),r)}),this.mountainsAtomic.each(function(a,s){var r=d3.select(this),l=a.hidden||(e||i||n)&&!t.model.entities.isSelected(a);t._renderShape(r,a.KEY(),l)}),"none"===a?this.mountainsAtomic.sort(function(t,e){return e.yMax-t.yMax}):"all"===a||(e||n?this.mountainsMergeGrouped.sort(function(t,e){return e.yMax-t.yMax}):this.mountainsAtomic.sort(function(t,e){return e.yMaxGroup-t.yMaxGroup}))},redrawDataPointsOnlyColors:function(){var t=this;this.mountains.style("fill",function(e){return t.values.color[e.KEY()]?t.cScale(t.values.color[e.KEY()]):"transparent"})},_renderShape:function(t,e,i){var a=this.model.marker.stack.which,n=this;if(t.classed("vzb-hidden",i),i)return void("none"!==a&&t.style("stroke-opacity",0));var s={};s[this.KEY]=e,this.model.entities.isSelected(s)?t.attr("d",this.area(this.cached[e].filter(function(t){return t.y>n.values.axis_y[e]*un}))):t.attr("d",this.area(this.cached[e])),
"indicator"===this.model.marker.color.use&&t.style("fill",this.values.color[e]?n.cScale(this.values.color[e]):"transparent"),"none"!==a&&t.transition().duration(900*Math.random()+100).ease("circle").style("stroke-opacity",.5),this.model.time.record&&this._export.write({type:"path",id:e,time:this.model.time.value.getUTCFullYear(),fill:this.cScale(this.values.color[e]),d:this.area(this.cached[e])})},_setTooltip:function(t){if(t){var e=d3.mouse(this.graph.node()).map(function(t){return parseInt(t)});this.tooltip.classed("vzb-hidden",!1).attr("transform","translate("+e[0]+","+e[1]+")").selectAll("text").attr("text-anchor","middle").attr("alignment-baseline","middle").text(t);var i=this.tooltip.select("text")[0][0].getBBox();this.tooltip.select("rect").attr("width",i.width+8).attr("height",i.height+8).attr("x",-i.width-25).attr("y",-i.height-25).attr("rx",.2*i.height).attr("ry",.2*i.height),this.tooltip.selectAll("text").attr("x",-i.width-25+(i.width+8)/2).attr("y",-i.height-25+(i.height+11)/2);var a=e[0]-i.width-25>0?e[0]:i.width+25,n=e[1]-i.height-25>0?e[1]:i.height+25;this.tooltip.attr("transform","translate("+a+","+n+")")}else this.tooltip.classed("vzb-hidden",!0)}}),gn=Ei.extend("MountainChart",{init:function(t,e){this.name="mountainchart",this.components=[{component:mn,placeholder:".vzb-tool-viz",model:["state.time","state.entities","state.marker","language","ui"]},{component:aa,placeholder:".vzb-tool-timeslider",model:["state.time"]},{component:Na,placeholder:".vzb-tool-dialogs",model:["state","ui","language"]},{component:Oa,placeholder:".vzb-tool-buttonlist",model:["state","ui","language"]},{component:Ui,placeholder:".vzb-tool-treemenu",model:["state.marker","language"]},{component:Ya,placeholder:".vzb-tool-datawarning",model:["language"]}],this._super(t,e)}}),pn=Xe.extend({init:function(t,e){var i=this;this.name="linechart",this.template="linechart.html",this.model_expects=[{name:"time",type:"time"},{name:"entities",type:"entities"},{name:"marker",type:"model"},{name:"language",type:"language"}],this.model_binds={"change:time.value":function(){i._readyOnce&&(i.updateTime(),i.redrawDataPoints())},"change:time.playing":function(){i.model.time.playing&&ne()&&!i.tooltip.classed("vzb-hidden")&&i.tooltip.classed("vzb-hidden",!0)},"change:marker":function(t,e){i._readyOnce&&(e.indexOf("which")>-1||e.indexOf("use")>-1||i.ready())}},this._super(t,e),this.xScale=null,this.yScale=null,this.xAxis=O().orient("bottom"),this.yAxis=O().orient("left"),this.isDataPreprocessed=!1,this.timeUpdatedOnce=!1,this.sizeUpdatedOnce=!1,this.getNearestKey=ie(this.getNearestKey)},readyOnce:function(){var t=this;this.element=d3.select(this.element),this.graph=this.element.select(".vzb-lc-graph"),this.yAxisEl=this.graph.select(".vzb-lc-axis-y"),this.xAxisEl=this.graph.select(".vzb-lc-axis-x"),this.xTitleEl=this.graph.select(".vzb-lc-axis-x-title"),this.yTitleEl=this.graph.select(".vzb-lc-axis-y-title"),this.xValueEl=this.graph.select(".vzb-lc-axis-x-value"),this.yValueEl=this.graph.select(".vzb-lc-axis-y-value"),this.linesContainer=this.graph.select(".vzb-lc-lines"),this.labelsContainer=this.graph.select(".vzb-lc-labels"),this.verticalNow=this.labelsContainer.select(".vzb-lc-vertical-now"),this.tooltip=this.element.select(".vzb-tooltip"),this.projectionX=this.graph.select("g").select(".vzb-lc-projection-x"),this.projectionY=this.graph.select("g").select(".vzb-lc-projection-y"),this.entityLines=null,this.entityLabels=null,this.totalLength_1={},this.KEY=this.model.entities.getDimension(),this.on("resize",function(){t.updateSize(),t.updateTime(),t.redrawDataPoints()})},ready:function(){this.updateUIStrings();var t=this;this.model.marker.getFrame(null,function(e){t.all_values=e,t.model.marker.getFrame(t.model.time.value,function(e){t.values=e,t.updateShow(),t.updateTime(),t.updateSize(),t.redrawDataPoints()})}),this.graph.on("mousemove",this.entityMousemove.bind(this,null,null,this)).on("mouseleave",this.entityMouseout.bind(this,null,null,this))},updateUIStrings:function(){this.translator=this.model.language.getTFunction();var t=this.translator("indicator/"+this.model.marker.axis_x.which),e=this.translator("indicator/"+this.model.marker.axis_y.which),i=this.xTitleEl.selectAll("text").data([0]);i.enter().append("text"),i.attr("text-anchor","end").attr("y","-0.32em").text(t);var a=this.yTitleEl.selectAll("text").data([0]);a.enter().append("text"),a.attr("y","-0px").attr("x","-9px").attr("dy","-0.36em").attr("dx","-0.72em").text(e)},updateShow:function(){var t=this,e=this.KEY;this.cached={},this.yScale=this.model.marker.axis_y.getScale(),this.xScale=this.model.marker.axis_x.getScale(),this.cScale=this.model.marker.color.getScale(),this.yAxis.tickSize(6,0).tickFormat(this.model.marker.axis_y.tickFormatter),this.xAxis.tickSize(6,0).tickFormat(this.model.marker.axis_x.tickFormatter),this.collisionResolver=N().selector(".vzb-lc-label").value("valueY").scale(this.yScale).KEY(e),this.line=d3.svg.line().interpolate("basis").x(function(e){return t.xScale(e[0])}).y(function(e){return t.yScale(e[1])}),this.all_steps=this.model.time.getAllSteps()},updateTime:function(){var t=this,e=(this.KEY,null===this.time?this.model.time.value:this.time);this.time=this.model.time.value,this.duration=this.model.time.playing&&this.time-e>0?this.model.time.delayAnimations:0;var i=this.model.time.getDimension(),a={};a[i]=this.time,this.data=this.model.marker.getKeys(a),this.prev_steps=this.all_steps.filter(function(e){return e<=t.time}),this.entityLines=this.linesContainer.selectAll(".vzb-lc-entity").data(this.data),this.entityLabels=this.labelsContainer.selectAll(".vzb-lc-entity").data(this.data),this.timeUpdatedOnce=!0},updateSize:function(){var t=this,e=this.values,i=this.KEY,a=2;this.profiles={small:{margin:{top:30,right:20,left:55,bottom:30},tick_spacing:60,text_padding:8,lollipopRadius:6,limitMaxTickNumberX:5},medium:{margin:{top:40,right:60,left:65,bottom:40},tick_spacing:80,text_padding:12,lollipopRadius:7,limitMaxTickNumberX:10},large:{margin:{top:50,right:60,left:70,bottom:50},tick_spacing:100,text_padding:20,lollipopRadius:9,limitMaxTickNumberX:0}};var n={small:{margin:{top:9,right:15,bottom:10,left:10}},medium:{margin:{top:9,right:15,bottom:10,left:20}},large:{margin:{top:9,right:15,bottom:10,left:25}}};this.activeProfile=this.profiles[this.getLayoutProfile()],this.margin=this.activeProfile.margin,this.tick_spacing=this.activeProfile.tick_spacing;var s=this.model.marker.getKeys().map(function(t,a){return e.label[t[i]]}),r=0,l=this.linesContainer.selectAll(".samplingView").data(s);l.enter().append("text").attr("class","samplingView vzb-lc-labelname").style("opacity",0).text(function(t){return t.length<13?t:t.substring(0,10)+"..."}).each(function(t){r>this.getComputedTextLength()||(r=this.getComputedTextLength())}).remove(),this.margin.right=Math.max(this.margin.right,r+this.activeProfile.text_padding+20),this.height=parseInt(this.element.style("height"),10)-this.margin.top-this.margin.bottom,this.width=parseInt(this.element.style("width"),10)-this.margin.left-this.margin.right,this.collisionResolver.height(this.height),this.graph.attr("width",this.width+this.margin.right+this.margin.left).attr("height",this.height+this.margin.top+this.margin.bottom).select("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")"),"ordinal"!==this.model.marker.axis_y.scaleType?this.yScale.range([this.height,0]):this.yScale.rangePoints([this.height,0],a).range(),"ordinal"!==this.model.marker.axis_x.scaleType,this.xScale.range([0,this.width]),this.yAxis.scale(this.yScale).labelerOptions({scaleType:this.model.marker.axis_y.scaleType,timeFormat:this.model.time.timeFormat,toolMargin:{top:5,right:this.margin.right,left:this.margin.left,bottom:this.margin.bottom},limitMaxTickNumber:6}),this.xAxis.scale(this.xScale).labelerOptions({scaleType:this.model.marker.axis_x.scaleType,timeFormat:this.model.time.timeFormat,toolMargin:this.margin,limitMaxTickNumber:this.activeProfile.limitMaxTickNumberX}),this.yAxisEl.call(this.yAxis),this.xAxisEl.call(this.xAxis),this.xAxisEl.attr("transform","translate(0,"+this.height+")"),this.xValueEl.attr("transform","translate(0,"+this.height+")").attr("y",this.xAxis.tickPadding()+this.xAxis.tickSize()),this.xTitleEl.attr("transform","translate("+this.width+","+this.height+")"),this.verticalNow.attr("y1",this.yScale.range()[0]).attr("y2",this.yScale.range()[1]).attr("x1",0).attr("x2",0),this.projectionX.attr("y1",t.yScale.range()[0]),this.projectionY.attr("x2",t.xScale.range()[0]),ne()&&(t.tooltip.classed("vzb-hidden",!0),t.verticalNow.style("opacity",1),t.projectionX.style("opacity",0),t.projectionY.style("opacity",0),t.xAxisEl.call(t.xAxis.highlightValue(t.time)),t.yAxisEl.call(t.yAxis.highlightValue("none")),t.graph.selectAll(".vzb-lc-entity").each(function(){d3.select(this).classed("vzb-dimmed",!1).classed("vzb-hovered",!1)}),t.hoveringNow=null);var o={rangeMax:this.xScale.range()[1],mRight:this.margin.right,profile:n[this.getLayoutProfile()]};this.parent.trigger("myEvent",o),this.sizeUpdatedOnce=!0},redrawDataPoints:function(){var t=this,e=this.KEY,i=this.values;this.timeUpdatedOnce||this.updateTime(),this.sizeUpdatedOnce||this.updateSize(),this.entityLabels.exit().remove(),this.entityLines.exit().remove(),this.entityLines.enter().append("g").attr("class","vzb-lc-entity").each(function(t,e){var i=d3.select(this);i.append("path").attr("class","vzb-lc-line-shadow").attr("transform","translate(0,2)"),i.append("path").attr("class","vzb-lc-line")}),this.entityLabels.enter().append("g").attr("class","vzb-lc-entity").each(function(t,a){var n=d3.select(this);i.label[t[e]];n.append("circle").attr("class","vzb-lc-circle").attr("cx",0);var s=n.append("g").attr("class","vzb-lc-label");s.append("text").attr("class","vzb-lc-labelname").attr("dy",".35em"),s.append("text").attr("class","vzb-lc-label-value").attr("dy","1.6em")}),this.entityLines.each(function(a,n){var s=d3.select(this),r=(i.label[a[e]],t.cScale(i.color[a[e]])),l="geo.region"==t.model.marker.color.which?t.model.marker.color.getColorShade({colorID:i.color[a[e]],shadeID:"shade"}):d3.rgb(r).darker(.5).toString(),o=t.prev_steps.map(function(i,n){return[+i,+t.all_values[i].axis_y[a[e]]]}).filter(function(t){return!J(t[1])});t.cached[a[e]]={valueY:o[o.length-1][1]};var c=s.select(".vzb-lc-line"),h=c.node().getTotalLength(),d=s.select(".vzb-lc-line-shadow").attr("stroke-dasharray",h).style("stroke",l).attr("d",t.line(o));c.attr("stroke-dasharray",h).style("stroke",r).attr("d",t.line(o)),t.model.time.playing?(null===t.totalLength_1[a[e]]&&(t.totalLength_1[a[e]]=h),d.interrupt().attr("stroke-dashoffset",h-t.totalLength_1[a[e]]).transition().delay(0).duration(t.duration).ease("linear").attr("stroke-dashoffset",0),c.interrupt().attr("stroke-dashoffset",h-t.totalLength_1[a[e]]).transition().delay(0).duration(t.duration).ease("linear").attr("stroke-dashoffset",0),t.totalLength_1[a[e]]=h):(t.totalLength_1[a[e]]=null,d.attr("stroke-dasharray","none").attr("stroke-dashoffset","none"),c.attr("stroke-dasharray","none").attr("stroke-dashoffset","none"))}),this.entityLabels.each(function(a,n){var s=d3.select(this),r=i.label[a[e]],l=t.cScale(i.color[a[e]]),o="geo.region"==t.model.marker.color.which?t.model.marker.color.getColorShade({colorID:i.color[a[e]],shadeID:"shade"}):d3.rgb(l).darker(.5).toString();s.select(".vzb-lc-circle").style("fill",l).transition().duration(t.duration).ease("linear").attr("r",t.profiles[t.getLayoutProfile()].lollipopRadius).attr("cy",t.yScale(t.cached[a[e]].valueY)+1),s.select(".vzb-lc-label").transition().duration(t.duration).ease("linear").attr("transform","translate(0,"+t.yScale(t.cached[a[e]].valueY)+")");var c=t.yAxis.tickFormat()(t.cached[a[e]].valueY),h=r.length<13?r:r.substring(0,10)+"...",d=t.ui.chart.labels.min_number_of_entities_when_values_hide,u=s.select(".vzb-lc-labelname").style("fill",o).attr("dx",t.activeProfile.text_padding).text(h+" "+(t.data.length<d?c:""));if(s.select(".vzb-lc-label-value").style("fill",o).attr("dx",t.activeProfile.text_padding).text(""),t.data.length<d){var m=t.xScale(t.time)+u[0][0].getComputedTextLength()+t.activeProfile.text_padding,g=t.width+t.margin.right;m>g&&(s.select(".vzb-lc-labelname").text(h),s.select(".vzb-lc-label-value").text(c))}}),this.labelsContainer.transition().duration(t.duration).ease("linear").attr("transform","translate("+t.xScale(t.time)+",0)"),this.verticalNow.style("opacity",this.time-this.model.time.start===0||t.hoveringNow?0:1),this.hoveringNow||this.xAxisEl.call(this.xAxis.highlightValue(t.time).highlightTransDuration(t.duration)),0==t.duration&&d3.timer.flush(),clearTimeout(t.collisionTimeout),t.collisionTimeout=setTimeout(function(){t.entityLabels.call(t.collisionResolver.data(t.cached))},1.5*t.model.time.delayAnimations)},entityMousemove:function(t,e,i,a){var n=i,s=n.KEY,r=(n.values,d3.mouse(n.graph.node()).map(function(t){return parseInt(t)})),l=n.xScale.invert(r[0]-n.margin.left);n.time-l<0?l=n.time:l<this.model.time.start&&(l=this.model.time.start);var o,c=(n.model.time.getDimension(),r[1]-n.margin.bottom);G(l)||(l=this.model.time.timeFormat.parse(l)),this.model.marker.getFrame(l,function(e){var i=n.getNearestKey(c,e.axis_y,n.yScale.bind(n));if(o=e.axis_y[i],t||(t={}),t[s]=i,n.hoveringNow=t,n.graph.selectAll(".vzb-lc-entity").each(function(){d3.select(this).classed("vzb-dimmed",function(t){return t[s]!==n.hoveringNow[s]}).classed("vzb-hovered",function(t){return t[s]===n.hoveringNow[s]})}),!J(o)){var a=n.xScale(l),r=n.yScale(o);n.ui.chart.whenHovering.showTooltip&&n.tooltip.style("left",a+n.margin.left+"px").style("bottom",n.height-r+n.margin.bottom+"px").text(n.yAxis.tickFormat()(o)).classed("vzb-hidden",!1),n.ui.chart.whenHovering.hideVerticalNow&&n.verticalNow.style("opacity",0),n.ui.chart.whenHovering.showProjectionLineX&&n.projectionX.style("opacity",1).attr("y2",r).attr("x1",a).attr("x2",a),n.ui.chart.whenHovering.showProjectionLineY&&n.projectionY.style("opacity",1).attr("y1",r).attr("y2",r).attr("x1",a),n.ui.chart.whenHovering.higlightValueX&&n.xAxisEl.call(n.xAxis.highlightValue(l).highlightTransDuration(0)),n.ui.chart.whenHovering.higlightValueY&&n.yAxisEl.call(n.yAxis.highlightValue(o).highlightTransDuration(0)),clearTimeout(n.unhoverTimeout)}})},entityMouseout:function(t,e,i){var a=i;d3.event.relatedTarget&&d3.select(d3.event.relatedTarget).classed("vzb-tooltip")||(a.unhoverTimeout=setTimeout(function(){a.tooltip.classed("vzb-hidden",!0),a.verticalNow.style("opacity",1),a.projectionX.style("opacity",0),a.projectionY.style("opacity",0),a.xAxisEl.call(a.xAxis.highlightValue(a.time)),a.yAxisEl.call(a.yAxis.highlightValue("none")),a.graph.selectAll(".vzb-lc-entity").each(function(){d3.select(this).classed("vzb-dimmed",!1).classed("vzb-hovered",!1)}),a.hoveringNow=null},300))},getNearestKey:function(t,e,i){for(var a=Object.keys(e),n=a[0],s=1;s<a.length;s++){var r=a[s];Math.abs((i?i(e[r]):e[r])-t)<Math.abs((i?i(e[n]):e[n])-t)&&(n=r)}return n}}),fn=Ei.extend("LineChart",{init:function(t,e){this.name="linechart",this.components=[{component:pn,placeholder:".vzb-tool-viz",model:["state.time","state.entities","state.marker","language"]},{component:aa,placeholder:".vzb-tool-timeslider",model:["state.time"],ui:{show_value_when_drag_play:!1,axis_aligned:!0}},{component:Na,placeholder:".vzb-tool-dialogs",model:["state","ui","language"]},{component:Oa,placeholder:".vzb-tool-buttonlist",model:["state","ui","language"]},{component:Ui,placeholder:".vzb-tool-treemenu",model:["state.marker","language"]}],this._super(t,e)},default_model:{state:{time:{start:1990,end:2012,value:2012,step:1},entities:{dim:"geo",show:{_defs_:{geo:["*"],"geo.cat":["region"]}}},marker:{space:["entities","time"],label:{use:"property",which:"geo.name"},axis_y:{use:"indicator",which:"gdp_pc",scaleType:"log"},axis_x:{use:"indicator",which:"time",scaleType:"time"},color:{use:"property",which:"geo.region"}}},data:{reader:"csv",path:"data/waffles/basic-indicators.csv"},ui:{"vzb-tool-line-chart":{labels:{min_number_of_entities_when_values_hide:10},whenHovering:{hideVerticalNow:!0,showProjectionLineX:!0,showProjectionLineY:!0,higlightValueX:!0,higlightValueY:!0,showTooltip:!0}}}}}),vn=he.extend({init:function(t){this.context=t,this._isCreated=null},toggle:function(t){var e=this.context;t?(e._trails.create(),e._trails.run(["resize","recolor","opacityHandler","findVisible","reveal"])):(e._trails.run("remove"),e.model.entities.select.forEach(function(t){t.trailStartTime=null}))},create:function(t){var e=this.context;return this._isCreated=new s(function(i,a){var n=e.KEY;if(e.model.ui.chart.trails&&e.model.entities.select.length){for(var r=+e.model.time.timeFormat(e.model.time.start),l=+e.model.time.timeFormat(e.model.time.end),o=e.model.time.step,c=[],h=r;l>=h;h+=o)c.push(h);t=null==t?e.model.entities.select:[t],t.forEach(function(t){var a=c.map(function(t){return{t:e.model.time.timeFormat.parse(""+t)}}),r=e.entityTrails.filter(function(e){return e[n]=="trail-"+t[n]}).selectAll("g").data(a);r.exit().remove(),r.enter().append("g").attr("class","vzb-bc-trailsegment").on("mouseover",function(t,i){if(!ne()){var a=d3.select(this.parentNode).data()[0][n],s={};s[n]=a.replace("trail-",""),s.time=t.t,e._axisProjections(s);var r=e.model.time.timeFormat(t.t),l=e.entityLabels.filter(function(t){return t[n]==s[n]}).classed("vzb-highlighted",!0).datum();r!==l.trailStartTime&&e.model.marker.getFrame(s.time,function(t){var i=e.xScale(t.axis_x[s[n]]),a=e.yScale(t.axis_y[s[n]]),l=zt(e.sScale(t.size[s[n]]));e._setTooltip(r,i,a,l)}),d3.select(this).style("opacity",1)}}).on("mouseout",function(t,i){ne()||(e._axisProjections(),e._setTooltip(),e.entityLabels.classed("vzb-highlighted",!1),d3.select(this).style("opacity",e.model.entities.opacityRegular))}).each(function(t,e){var i=d3.select(this);i.append("circle"),i.append("line")});var l=[];e.model.marker.getFrame(null,function(e){r.each(function(i,a){l.push(new s(function(a,s){var r=e[i.t];i.valueY=r.axis_y[t[n]],i.valueX=r.axis_x[t[n]],i.valueS=r.size[t[n]],i.valueC=r.color[t[n]],a()}))}),l.length>0?s.all(l).then(function(t){i(!0)}):i(!0)})})}}),this._isCreated},run:function(t,e,i){var a=this.context,n=a.KEY;this._isCreated&&this._isCreated.then(function(){(a.model.ui.chart.trails&&a.model.entities.select.length||"remove"==t)&&(i||(i=0),t=[].concat(t),e=null==e?a.model.entities.select:[e],e.forEach(function(e){var s=a.entityTrails.filter(function(t){return t[n]=="trail-"+e[n]}).selectAll("g");t.forEach(function(t){a._trails["_"+t](s,i,e)})}))})},_remove:function(t,e,i){t.remove()},_resize:function(t,e,i){var a=this.context;a.model.time.splash||t.each(function(t,e){if(null!=t.valueY&&null!=t.valueX&&null!=t.valueS){var i=d3.select(this);i.select("circle").attr("cy",a.yScale(t.valueY)).attr("cx",a.xScale(t.valueX)).attr("r",zt(a.sScale(t.valueS)));var n=this.parentNode.childNodes[e+1];if(null!=n&&(n=n.__data__,null!=n.valueY&&null!=n.valueX)){var s=Math.sqrt(Math.pow(a.xScale(t.valueX)-a.xScale(n.valueX),2)+Math.pow(a.yScale(t.valueY)-a.yScale(n.valueY),2));i.select("line").attr("x1",a.xScale(n.valueX)).attr("y1",a.yScale(n.valueY)).attr("x2",a.xScale(t.valueX)).attr("y2",a.yScale(t.valueY)).style("stroke-dasharray",s).style("stroke-dashoffset",zt(a.sScale(t.valueS)))}}})},_recolor:function(t,e,i){var a=this.context;t.each(function(t,e){var i=d3.select(this),n="geo.region"==a.model.marker.color.which?a.model.marker.color.getColorShade({colorID:t.valueC,shadeID:"shade"}):null!=t.valueC?a.cScale(t.valueC):a.COLOR_BLACKISH;i.select("circle").style("fill",null!=t.valueC?a.cScale(t.valueC):a.COLOR_WHITEISH),i.select("line").style("stroke",n)})},_opacityHandler:function(t,e,i){var a=this.context;t.each(function(t,e){var n=d3.select(this);n.style("opacity",i.opacity||a.model.entities.opacityRegular)})},_findVisible:function(t,e,i){var a=this.context,n=a.KEY,s=!0,r=a.model.time.timeFormat.parse(""+i.trailStartTime);t.each(function(t,e){t.transparent=null==i.trailStartTime||t.t-a.time>=0||r-t.t>0||i.trailStartTime-a.model.time.timeFormat(a.time)>=0||null==t.valueX||null==t.valueY||null==t.valueS,s&&!t.transparent&&(a.cached[i[n]].labelX0=t.valueX,a.cached[i[n]].labelY0=t.valueY,a.cached[i[n]].scaledS0=zt(a.sScale(t.valueS)),s=!1)})},_reveal:function(t,e,i){var a=this.context,n=a.KEY;t.each(function(t,e){var s=d3.select(this);if(s.classed("vzb-invisible",t.transparent),!t.transparent){var r=this.parentNode.childNodes[e+1];null!=r&&(r=r.__data__,null!=r.valueY&&null!=r.valueX&&(t.t-a.time<=0&&a.time-r.t<=0?(r=a.cached[i[n]],s.select("line").attr("x2",a.xScale(t.valueX)).attr("y2",a.yScale(t.valueY)).attr("x1",a.xScale(t.valueX)).attr("y1",a.yScale(t.valueY)).attr("x1",a.xScale(r.valueX)).attr("y1",a.yScale(r.valueY))):s.select("line").attr("x2",a.xScale(t.valueX)).attr("y2",a.yScale(t.valueY)).attr("x1",a.xScale(r.valueX)).attr("y1",a.yScale(r.valueY))))}})}}),bn=he.extend({init:function(t){this.context=t,this.enabled=!1,this.dragRectangle=d3.behavior.drag(),this.zoomer=d3.behavior.zoom(),this.dragLock=!1,this.dragRectangle.on("dragstart",this.drag().start).on("drag",this.drag().go).on("dragend",this.drag().stop),this.zoomer.scaleExtent([1,100]).on("zoomstart",this.zoom().start).on("zoom",this.zoom().go).on("zoomend",this.zoom().stop),this.zoomer.ratioX=1,this.zoomer.ratioY=1,t._zoomZoomedDomains={x:{zoomedMin:null,zoomedMax:null},y:{zoomedMin:null,zoomedMax:null}}},drag:function(){var t=this.context,e=this;return{start:function(i,a){!d3.event.sourceEvent.ctrlKey&&!d3.event.sourceEvent.metaKey&&"plus"!==t.ui.cursorMode||("touchmove"===d3.event.sourceEvent.type||"touchstart"===d3.event.sourceEvent.type)&&(d3.event.sourceEvent.touches.length>1||d3.event.sourceEvent.targetTouches.length>1)||(e.dragLock=!0,this.origin={x:d3.mouse(this)[0],y:d3.mouse(this)[1]},t.zoomRect.classed("vzb-invisible",!1))},go:function(i,a){if(!e.dragLock||("touchmove"===d3.event.sourceEvent.type||"touchstart"===d3.event.sourceEvent.type)&&(d3.event.sourceEvent.touches.length>1||d3.event.sourceEvent.targetTouches.length>1))return e.dragLock=!1,void t.zoomRect.attr("width",0).attr("height",0).classed("vzb-invisible",!0);var n=this.origin,s={x:d3.event.x,y:d3.event.y};t.zoomRect.attr("x",Math.min(s.x,n.x)).attr("y",Math.min(s.y,n.y)).attr("width",Math.abs(s.x-n.x)).attr("height",Math.abs(s.y-n.y))},stop:function(i){if(e.dragLock){e.dragLock=!1,t.zoomRect.attr("width",0).attr("height",0).classed("vzb-invisible",!0),this.target={x:d3.mouse(this)[0],y:d3.mouse(this)[1]};var a=d3.event.sourceEvent.ctrlKey||d3.event.sourceEvent.metaKey||"plus"===t.ui.cursorMode;e._zoomOnRectangle(d3.select(this),this.origin.x,this.origin.y,this.target.x,this.target.y,a,500)}}}},zoom:function(){var t=this.context,e=this.zoomer,i=this;return{start:function(){this.savedScale=e.scale()},go:function(){var a=d3.event.sourceEvent;if((null==a||!a.ctrlKey&&!a.metaKey)&&(null===a||"touchmove"!==a.type&&"touchstart"!==a.type||!(a.touches.length>1||a.targetTouches.length>1)||(i.dragLock=!1),!i.dragLock)){if(null!=a&&t.ui.noZoomOnScrolling&&"wheel"===a.type)return t.scrollableAncestor&&!i.enabled&&(t.scrollableAncestor.scrollTop+=a.deltaY),d3.event.scale=null,e.scale(this.savedScale),void(this.quitZoom=!0);if(null!=a&&t.scrollableAncestor&&null!=a&&!i.enabled)return t.scrollableAncestor.scrollTop+=a.deltaY,e.scale(1),void(this.quitZoom=!0);this.quitZoom=!1,t.model._data.entities.clearHighlighted(),t._setTooltip();var n=d3.event.scale,s=d3.event.translate,r=e.ratioY,l=e.ratioX;t.draggingNow=!0,(isNaN(n)||null==n)&&(n=e.scale()),(isNaN(n)||null==n)&&(n=1),1===n&&null!==a&&("wheel"===a.type&&a.deltaY>0||"touchmove"===a.type&&a.touches.length>1)&&(e.ratioX=1,l=1,e.ratioY=1,r=1),(isNaN(s[0])||isNaN(s[1])||null==s[0]||null==s[1])&&(s=e.translate()),(isNaN(s[0])||isNaN(s[1])||null==s[0]||null==s[1])&&(s=[0,0]),1>n*r&&(r=1/n,e.ratioY=r),1>n*l&&(l=1/n,e.ratioX=l),s[0]>0&&(s[0]=0),s[1]>0&&(s[1]=0),s[0]<(1-n*l)*t.width&&(s[0]=(1-n*l)*t.width),s[1]<(1-n*r)*t.height&&(s[1]=(1-n*r)*t.height);var o=t.width*n*l,c=t.height*n*r,h=[0*n*l+s[0],o+s[0]],d=[c+s[1],0*n*r+s[1]],u=t._rangeBump(h),m=t._rangeBump(d),g=(u[0]-h[0])*n*l,p=(u[1]-h[1])*n*l,f=(m[0]-d[0])*n*r,v=(m[1]-d[1])*n*r;h[0]=h[0]+g,h[1]=h[1]+p,d[0]=d[0]+f,d[1]=d[1]+v;var b=[0,t.width],y=[t.height,0],x=t._rangeBump(b),_=t._rangeBump(y);h[0]>x[0]&&(s[0]=x[0]-g),h[1]<x[1]&&(s[0]=x[1]-p-o),d[0]<_[0]&&(s[1]=_[0]-f-c),d[1]>_[1]&&(s[1]=_[1]-v),e.translate(s),h[0]>x[0]&&(h[1]=h[1]-Math.abs(h[0]-x[0]),h[0]=x[0]),h[1]<x[1]&&(h[0]=h[0]+Math.abs(h[1]-x[1]),h[1]=x[1]),d[0]<_[0]&&(d[1]=d[1]+Math.abs(d[0]-_[0]),d[0]=_[0]),d[1]>_[1]&&(d[0]=d[0]-Math.abs(d[1]-_[1]),d[1]=_[1]),"ordinal"===t.model.marker.axis_x.scaleType?t.xScale.rangeBands(h):t.xScale.range(h),"ordinal"===t.model.marker.axis_y.scaleType?t.yScale.rangeBands(d):t.yScale.range(d);var M=function(t){return d3.round(t,2)},z=x,w=_;z[0]=b[0]>h[0]?b[0]:h[0],z[1]=b[1]<h[1]?b[1]:h[1],w[0]=y[0]<d[0]?y[0]:d[0],w[1]=y[1]>d[1]?y[1]:d[1],t._zoomZoomedDomains={x:{zoomedMin:M(t.xScale.invert(z[0])),zoomedMax:M(t.xScale.invert(z[1]))},y:{zoomedMin:M(t.yScale.invert(w[0])),zoomedMax:M(t.yScale.invert(w[1]))}},t.model.marker.axis_x.set(t._zoomZoomedDomains.x,null,!1),t.model.marker.axis_y.set(t._zoomZoomedDomains.y,null,!1);var k=t.yAxis.labelerOptions(),S=t.xAxis.labelerOptions();k.limitMaxTickNumber=2>n*r?7:14,k.transitionDuration=e.duration,S.transitionDuration=e.duration,t.xAxisEl.call(t.xAxis.labelerOptions(S)),t.yAxisEl.call(t.yAxis.labelerOptions(k)),t.redrawDataPoints(e.duration),t._trails.run("resize",null,e.duration),e.duration=0}},stop:function(){t.draggingNow=!1,this.quitZoom||(t.model.marker.axis_x.set(t._zoomZoomedDomains.x,!0,!0),t.model.marker.axis_y.set(t._zoomZoomedDomains.y,!0,!0))}}},expandCanvas:function(t){var e=this.context;t||(t=e.duration);var i=d3.extent(qt(e.frame.axis_x)),a=d3.extent(qt(e.frame.axis_y)),n=zt(e.sScale(d3.extent(qt(e.frame.size))[1]))||0;if(!i[0]&&0!==i[0]||!i[1]&&0!==i[1]||!a[0]&&0!==a[0]||!a[1]&&0!==a[1])return kt("panZoom.expandCanvas: X or Y min/max are broken. Aborting with no action");var s={x1:e.xScale(i[0])-n,y1:e.yScale(a[0])+n,x2:e.xScale(i[1])+n,y2:e.yScale(a[1])-n},r=[0,e.width],l=[e.height,0],o={x1:r[0],x2:r[1],y1:l[0],y2:l[1]},c=0;if(!e.isCanvasPreviouslyExpanded||s.x1<o.x1*(1-c)||s.x2>o.x2*(1+c)||s.y2<o.y2*(1-c)||s.y1>o.y1*(1+c)){if(e.isCanvasPreviouslyExpanded){var h=e._rangeBump(r),d=e._rangeBump(l),u=e.xScale.copy().range(h),m=e.yScale.copy().range(d),g=[u.invert(r[0]),u.invert(r[1])],p=[m.invert(l[0]),m.invert(l[1])];s.x1>0?s.x1=0:e.xScale.invert(s.x1)<g[0]&&(s.x1=e.xScale(g[0])),s.x2<e.width?s.x2=e.width:e.xScale.invert(s.x2)>g[1]&&(s.x2=e.xScale(g[1])),s.y1<e.height?s.y1=e.height:e.yScale.invert(s.y1)<p[0]&&(s.y1=e.yScale(p[0])),s.y2>0?s.y2=0:e.yScale.invert(s.y2)>p[1]&&(s.y2=e.yScale(p[1]))}e.isCanvasPreviouslyExpanded=!0,this._zoomOnRectangle(e.element,s.x1,s.y1,s.x2,s.y2,!1,t)}else e.redrawDataPoints(t)},zoomToMaxMin:function(t,e,i,a,n){var s=this.context,r=t,l=e,o=i,c=a,h=[0,s.width],d=[s.height,0],u=s.xScale.domain(),m=s.yScale.domain();r<u[0]&&(r=u[0]),l>u[1]&&(l=u[1]),o<m[0]&&(o=m[0]),c>m[1]&&(c=m[1]);var g=Number.EPSILON?Number.EPSILON:2.220446049250313e-16;s.xScale.invert(h[0])<u[0]&&Math.abs(r-u[0])<g&&(r=s.xScale.invert(h[0])),s.xScale.invert(h[1])>u[1]&&Math.abs(l-u[1])<g&&(l=s.xScale.invert(h[1])),s.yScale.invert(d[0])<m[0]&&Math.abs(o-m[0])<g&&(o=s.yScale.invert(d[0])),s.yScale.invert(d[1])>m[1]&&Math.abs(c-m[1])<g&&(c=s.yScale.invert(d[1]));var p=[s.xScale(r),s.xScale(l)],f=[s.yScale(o),s.yScale(c)];this._zoomOnRectangle(s.element,p[0],f[0],p[1],f[1],!1,n)},_zoomOnRectangle:function(t,e,i,a,n,s,r){var l=this.context,o=this.zoomer,c=e,h=i,d=a,u=n;s&&o.translate([o.translate()[0]+c-d,o.translate()[1]+h-u]);var m=[0,l.width],g=[l.height,0],p=l.xScale.domain(),f=l.yScale.domain();if(l.xScale.invert(c)<p[0]?c=this._scaleCoordinate(c,m[1]-d,l.xScale.range()[0],m[1]):l.xScale.invert(d)<p[0]&&(d=this._scaleCoordinate(d,m[1]-c,l.xScale.range()[0],m[1])),l.xScale.invert(d)>p[1]?d=this._scaleCoordinate(d,c-m[0],l.xScale.range()[1],m[0]):l.xScale.invert(c)>p[1]&&(c=this._scaleCoordinate(c,d-m[0],l.xScale.range()[1],m[0])),l.yScale.invert(h)<f[0]?h=this._scaleCoordinate(h,u-g[1],l.yScale.range()[0],g[1]):l.yScale.invert(u)<f[0]&&(u=this._scaleCoordinate(u,h-g[1],l.yScale.range()[0],g[1])),l.yScale.invert(u)>f[1]?u=this._scaleCoordinate(u,g[0]-h,l.yScale.range()[1],g[0]):l.yScale.invert(h)>f[1]&&(h=this._scaleCoordinate(h,g[0]-u,l.yScale.range()[1],g[0])),!(Math.abs(c-d)<10||Math.abs(h-u)<10)){var v=o.scaleExtent()[1];if(Math.abs(c-d)>Math.abs(h-u)){var b=l.height/Math.abs(h-u)*o.scale();b>v&&(b=v);var y=l.width/Math.abs(c-d)*o.scale()/b*o.ratioX,x=o.ratioY}else{var b=l.width/Math.abs(c-d)*o.scale();b>v&&(b=v);var x=l.height/Math.abs(h-u)*o.scale()/b*o.ratioY,y=o.ratioX}var _=[(o.translate()[0]-Math.min(c,d))/o.scale()/o.ratioX*b*y,(o.translate()[1]-Math.min(h,u))/o.scale()/o.ratioY*b*x];o.scale(b),o.ratioY=x,o.ratioX=y,o.translate(_),o.duration=r?r:0,o.event(t)}},_scaleCoordinate:function(t,e,i,a){var n=e/Math.abs(i-a);return(t-i)*(1-n)+i},_scaleToMin:function(t,e,i,a){var n=(t-e)*i,s=Math.max(a,e-a),r=Math.max(n,s);return r},zoomByIncrement:function(t,e){var i=this.context,a=this.zoomer.scale(),n=[this.zoomer.translate()[0],this.zoomer.translate()[1]],s=d3.mouse(i.element.node()),r=Math.log(a)/Math.LN2;"plus"!=t&&t||(r=Math.floor(r)+1),"minus"==t&&(r=Math.ceil(r)-1);var l=[(s[0]-n[0])/a,(s[1]-n[1])/a],o=this.zoomer.scaleExtent();a=Math.max(o[0],Math.min(o[1],Math.pow(2,r))),l=[l[0]*a+n[0],l[1]*a+n[1]],n[0]+=s[0]-l[0],n[1]+=s[1]-l[1],this.zoomer.scale(a),this.zoomer.translate([n[0],n[1]]),this.zoomer.duration=e||0,this.zoomer.event(i.element)},resetZoomState:function(t){this.zoomer.scale(1),this.zoomer.ratioY=1,this.zoomer.ratioX=1,this.zoomer.translate([0,0])},reset:function(t,e){var i=this.context;i.isCanvasPreviouslyExpanded=!1,this.zoomer.scale(1),this.zoomer.ratioY=1,this.zoomer.ratioX=1,this.zoomer.translate([0,0]),this.zoomer.duration=e||0,this.zoomer.event(t||i.element)},rerun:function(t){var e=this.context;this.zoomer.event(t||e.element)}}),yn=Xe.extend({init:function(t,e){var i=this;this.name="bubblechart",this.template="bubblechart.html",this.model_expects=[{name:"time",type:"time"},{name:"entities",type:"entities"},{name:"marker",type:"model"},{name:"language",type:"language"},{name:"ui",type:"model"}],this.model_binds={"change:time.start":function(t,e){"time"===i.model.marker.color.scaleType&&(i.model.marker.color.scale=null)},"change:time.record":function(){i.model.time.record?i._export.open(this.element,this.name):i._export.reset()},"change:ui.chart.trails":function(t){i._trails.toggle(i.model.ui.chart.trails),i.redrawDataPoints()},"change:ui.chart.lockNonSelected":function(t){i.redrawDataPoints(500)},"change:marker":function(t,e){if(i._readyOnce){if(e.indexOf("scaleType")>-1)return void i.ready();if(-1===e.indexOf("marker.size")&&-1===e.indexOf("marker.size_label")){if(e.indexOf("domainMin")>-1||e.indexOf("domainMax")>-1)return i.updateSize(),i.updateMarkerSizeLimits(),i.updateLabelSizeLimits(),i._trails.run("findVisible"),i.redrawDataPoints(),void i._trails.run("resize");if(e.indexOf("zoomedMin")>-1||e.indexOf("zoomedMax")>-1){if(i.draggingNow)return;if(i._zoomZoomedDomains.x.zoomedMin==i.model.marker.axis_x.zoomedMin&&i._zoomZoomedDomains.x.zoomedMax==i.model.marker.axis_x.zoomedMax&&i._zoomZoomedDomains.y.zoomedMin==i.model.marker.axis_y.zoomedMin&&i._zoomZoomedDomains.y.zoomedMax==i.model.marker.axis_y.zoomedMax)return;return void i._panZoom.zoomToMaxMin(i.model.marker.axis_x.zoomedMin,i.model.marker.axis_x.zoomedMax,i.model.marker.axis_y.zoomedMin,i.model.marker.axis_y.zoomedMax,500)}}}},"change:entities.select":function(){i._readyOnce&&(i.selectDataPoints(),i.redrawDataPoints(),i._trails.run(["resize","recolor","opacityHandler","findVisible","reveal"]),i.updateBubbleOpacity(),i._updateDoubtOpacity())},"change:entities.highlight":function(){i._readyOnce&&i.highlightDataPoints()},"change:time.value":function(){i._readyOnce&&(i.calculationQueue?i.calculationQueue.push(i.model.time.value.toString()):i.calculationQueue=[i.model.time.value.toString()],
function(t){i.model.marker.getFrame(t,function(t,e){if(!t)return!1;var a=i.calculationQueue.indexOf(e.toString());-1!=a&&(i.calculationQueue.splice(0,a+1),i.frameChanged(t,e))})}(i.model.time.value))},"change:ui.chart.adaptMinMaxZoom":function(){i.model.ui.chart.adaptMinMaxZoom?i._panZoom.expandCanvas(500):i._panZoom.reset()},"change:marker.size.extent":function(t,e){i._readyOnce&&(i.updateMarkerSizeLimits(),i._trails.run("findVisible"),i.redrawDataPointsOnlySize(),i._trails.run("resize"))},"change:marker.size_label.extent":function(t,e){i._readyOnce&&(i.updateLabelSizeLimits(),i._trails.run("findVisible"),i.redrawDataPoints(),i._trails.run("resize"))},"change:ui.chart.labels.removeLabelBox":function(t,e){i._readyOnce&&(i._trails.run("findVisible"),i.redrawDataPoints(),i._trails.run("resize"))},"change:marker.color.palette":function(t,e){i._readyOnce&&(i.redrawDataPointsOnlyColors(),i._trails.run("recolor"))},"change:entities.opacitySelectDim":function(){i.updateBubbleOpacity()},"change:entities.opacityRegular":function(){i.updateBubbleOpacity(),i._trails.run("opacityHandler")},"change:ui.cursorMode":function(){var t=i.element.select("svg");"plus"===i.model.ui.cursorMode?(t.classed("vzb-zoomin",!0),t.classed("vzb-zoomout",!1)):"minus"===i.model.ui.cursorMode?(t.classed("vzb-zoomin",!1),t.classed("vzb-zoomout",!0)):(t.classed("vzb-zoomin",!1),t.classed("vzb-zoomout",!1))},ready:function(){}},this._super(t,e),this.xScale=null,this.yScale=null,this.sScale=null,this.cScale=null,this.xAxis=O(),this.yAxis=O(),i.COLOR_BLACKISH="#333",i.COLOR_WHITEISH="#fdfdfd",this.cached={},this.isCanvasPreviouslyExpanded=!1,this.draggingNow=null,this._trails=new vn(this),this._panZoom=new bn(this),this._export=new on(this),this._export.prefix("vzb-bc-").deleteClasses(["vzb-bc-bubbles-crop","vzb-hidden","vzb-bc-year","vzb-bc-zoom-rect","vzb-bc-projection-x","vzb-bc-projection-y","vzb-bc-axis-c-title"]),this.labelDragger=d3.behavior.drag().on("dragstart",function(t,e){d3.event.sourceEvent.stopPropagation();var a=i.KEY;i.druging=t[a]}).on("drag",function(t,e){var a=i.KEY;if(i.ui.chart.labels.dragging){var n=i.cached[t[a]];n.labelFixed=!0,n.labelX_+=d3.event.dx/i.width,n.labelY_+=d3.event.dy/i.height;var s=i.xScale(n.labelX0)+n.labelX_*i.width,r=i.yScale(n.labelY0)+n.labelY_*i.height,l=i.xScale(n.labelX0),o=i.yScale(n.labelY0),c=i.entityLines.filter(function(e){return e[a]==t[a]});i._repositionLabels(t,e,this,s,r,l,o,0,null,c)}}).on("dragend",function(t,e){var a=i.KEY;i.druging=null,i.model.entities.setLabelOffset(t,[i.cached[t[a]].labelX_,i.cached[t[a]].labelY_])})},_rangeBump:function(t,e){var i=this.activeProfile.maxRadius;if(e=e?-1:1,W(t)&&t.length>1){var a=t[0],n=t[t.length-1];return n>a?(a+=i*e,n-=i*e,a>n&&(a=n=(a+n)/2)):a>n?(a-=i*e,n+=i*e,n>a&&(a=n=(a+n)/2)):kt("rangeBump error: the input scale range has 0 length. that sucks"),[a,n]}kt("rangeBump error: input is not an array or empty")},readyOnce:function(){var t=this;this._readyOnce=!1,this.scrollableAncestor=nt(this.element),this.element=d3.select(this.element),this.graph=this.element.select(".vzb-bc-graph"),this.yAxisElContainer=this.graph.select(".vzb-bc-axis-y"),this.yAxisEl=this.yAxisElContainer.select("g"),this.xAxisElContainer=this.graph.select(".vzb-bc-axis-x"),this.xAxisEl=this.xAxisElContainer.select("g"),this.yTitleEl=this.graph.select(".vzb-bc-axis-y-title"),this.xTitleEl=this.graph.select(".vzb-bc-axis-x-title"),this.sTitleEl=this.graph.select(".vzb-bc-axis-s-title"),this.cTitleEl=this.graph.select(".vzb-bc-axis-c-title"),this.yearEl=this.graph.select(".vzb-bc-year"),this.year=new Ja(this.yearEl),this.yInfoEl=this.graph.select(".vzb-bc-axis-y-info"),this.xInfoEl=this.graph.select(".vzb-bc-axis-x-info"),this.dataWarningEl=this.graph.select(".vzb-data-warning"),this.projectionX=this.graph.select(".vzb-bc-projection-x"),this.projectionY=this.graph.select(".vzb-bc-projection-y"),this.trailsContainer=this.graph.select(".vzb-bc-trails"),this.bubbleContainerCrop=this.graph.select(".vzb-bc-bubbles-crop"),this.bubbleContainer=this.graph.select(".vzb-bc-bubbles"),this.labelsContainer=this.graph.select(".vzb-bc-labels"),this.linesContainer=this.graph.select(".vzb-bc-lines"),this.zoomRect=this.element.select(".vzb-bc-zoom-rect"),this.eventArea=this.element.select(".vzb-bc-eventarea"),this.entityBubbles=null,this.entityLabels=null,this.tooltip=this.element.select(".vzb-bc-tooltip"),this.tooltipMobile=this.element.select(".vzb-tooltip-mobile"),this.entityLines=null,this.on("resize",function(){t.updateSize(),t.updateMarkerSizeLimits(),t.updateLabelSizeLimits(),t._trails.run("findVisible"),t._panZoom.rerun()}),d3.select("body").on("keydown",function(){"arrow"===t.model.ui.cursorMode&&(d3.event.metaKey||d3.event.ctrlKey)&&t.element.select("svg").classed("vzb-zoomin",!0)}).on("keyup",function(){"arrow"===t.model.ui.cursorMode&&(d3.event.metaKey||d3.event.ctrlKey||t.element.select("svg").classed("vzb-zoomin",!1))}),this.root.on("resetZoom",function(){t._panZoom.reset(null,500)}),this.bubbleContainerCrop.call(this._panZoom.zoomer).call(this._panZoom.dragRectangle).on("dblclick.zoom",null).on("mouseup",function(){t.draggingNow=!1}).on("click",function(){var e=t.model.ui.cursorMode;d3.event.defaultPrevented||"arrow"===e||t._panZoom.zoomByIncrement(e,500)}),d3.select(this.parent.placeholder).onTap(function(){t._panZoom.enabled=!0}).on("mousedown",function(){t._panZoom.enabled=!0}).on("mouseleave",function(){clearTimeout(t.timeoutMouseEnter),t.timeoutMouseLeave=setTimeout(function(){t._panZoom.enabled=!1},800)}).on("mouseenter",function(){clearTimeout(t.timeoutMouseLeave),t.timeoutMouseEnter=setTimeout(function(){t._panZoom.enabled=!0},2e3)}),this.KEY=this.model.entities.getDimension(),this.TIMEDIM=this.model.time.getDimension(),this.updateUIStrings(),this.wScale=d3.scale.linear().domain(this.parent.datawarning_content.doubtDomain).range(this.parent.datawarning_content.doubtRange),this.model.marker.getFrame(this.model.time.value,function(e){t.frame=e,t.updateIndicators(),t.updateSize(),t.updateEntities(),t._trails.create(),t.updateTime(),t.updateMarkerSizeLimits(),t.updateLabelSizeLimits(),t.updateBubbleOpacity(),t.selectDataPoints(),t._updateDoubtOpacity(),t.zoomToMarkerMaxMin(),t._trails.run(["recolor","opacityHandler","findVisible","reveal"]),t._readyOnce=!0})},ready:function(){var t=this;this.updateUIStrings();this.model.time.end;this.model.marker.getFrame(this.model.time.value,function(e){e&&(t.frame=e,t.updateIndicators(),t.updateSize(),t.updateMarkerSizeLimits(),t.updateLabelSizeLimits(),t.updateEntities(),t.redrawDataPoints(),t.updateBubbleOpacity(),t.cached={},t._trails.create(),t._trails.run("findVisible"),t.zoomToMarkerMaxMin(),t._trails.run(["recolor","opacityHandler","reveal"]),t.model.ui.chart.adaptMinMaxZoom&&t._panZoom.expandCanvas())})},zoomToMarkerMaxMin:function(){this._panZoom.resetZoomState();var t=this.model.marker.axis_x,e=this.model.marker.axis_y,i=t.getScale().domain(),a=e.getScale().domain(),n=t.zoomedMin?t.zoomedMin:i[0],s=t.zoomedMax?t.zoomedMax:i[1],r=e.zoomedMin?e.zoomedMin:a[0],l=e.zoomedMax?e.zoomedMax:a[1];this._panZoom.zoomToMaxMin(n,s,r,l)},updateIndicators:function(){var t=this;this.yScale=this.model.marker.axis_y.getScale(),this.xScale=this.model.marker.axis_x.getScale(),this.sScale=this.model.marker.size.getScale(),this.cScale=this.model.marker.color.getScale(),this.labelSizeTextScale=this.model.marker.size_label.getScale(),this.yAxis.tickFormat(t.model.marker.axis_y.tickFormatter),this.xAxis.tickFormat(t.model.marker.axis_x.tickFormatter)},frameChanged:function(t,e){this.frame=t,this.updateTime(),this._updateDoubtOpacity(),this._trails.run("findVisible"),this.model.ui.chart.adaptMinMaxZoom?this._panZoom.expandCanvas():this.redrawDataPoints(),this._trails.run("reveal"),this.tooltipMobile.classed("vzb-hidden",!0)},updateUIStrings:function(){var t=this;this.translator=this.model.language.getTFunction(),this.strings={title:{Y:this.translator("indicator/"+this.model.marker.axis_y.which),X:this.translator("indicator/"+this.model.marker.axis_x.which),S:this.translator("indicator/"+this.model.marker.size.which),C:this.translator("indicator/"+this.model.marker.color.which)},unit:{Y:this.translator("unit/"+this.model.marker.axis_y.which),X:this.translator("unit/"+this.model.marker.axis_x.which),S:this.translator("unit/"+this.model.marker.size.which),C:this.translator("unit/"+this.model.marker.color.which)}},this.strings.unit.Y&&(this.strings.unit.Y=", "+this.strings.unit.Y),this.strings.unit.X&&(this.strings.unit.X=", "+this.strings.unit.X),this.strings.unit.S&&(this.strings.unit.S=", "+this.strings.unit.S),this.strings.unit.C&&(this.strings.unit.C=", "+this.strings.unit.C);var e=this.yTitleEl.selectAll("text").data([0]);e.enter().append("text"),e.on("click",function(){t.parent.findChildByName("gapminder-treemenu").markerID("axis_y").alignX("left").alignY("top").updateView().toggle()});var i=this.xTitleEl.selectAll("text").data([0]);i.enter().append("text"),i.on("click",function(){t.parent.findChildByName("gapminder-treemenu").markerID("axis_x").alignX("left").alignY("bottom").updateView().toggle()});var a=this.sTitleEl.selectAll("text").data([0]);a.enter().append("text"),a.attr("text-anchor","end"),re(this.dataWarningEl,hi).select("svg").attr("width","0px").attr("height","0px"),this.dataWarningEl.append("text").attr("text-anchor","end").text(this.translator("hints/dataWarning")),re(this.yInfoEl,ui).select("svg").attr("width","0px").attr("height","0px"),re(this.xInfoEl,ui).select("svg").attr("width","0px").attr("height","0px"),this.yInfoEl.on("click",function(){window.open(t.model.marker.axis_y.getMetadata().sourceLink,"_blank").focus()}),this.xInfoEl.on("click",function(){window.open(t.model.marker.axis_x.getMetadata().sourceLink,"_blank").focus()}),this.dataWarningEl.on("click",function(){t.parent.findChildByName("gapminder-datawarning").toggle()}).on("mouseover",function(){t._updateDoubtOpacity(1)}).on("mouseout",function(){t._updateDoubtOpacity()})},_updateDoubtOpacity:function(t){null==t&&(t=this.wScale(+this.model.time.timeFormat(this.time))),this.someSelected&&(t=1),this.dataWarningEl.style("opacity",t)},updateEntities:function(){var t=this,e=this.KEY,i=this.TIMEDIM,a=function(a){return a=a||"",this.model.marker.getKeys().map(function(s){var r={};return r[e]=s[e],r[i]=n,r.sortValue=t.frame.size[s[e]]||0,r[e]=a+s[e],r}).sort(function(t,e){return e.sortValue-t.sortValue})},n=this.model.time.end;this.model.entities.setVisible(a.call(this)),this.entityBubbles=this.bubbleContainer.selectAll(".vzb-bc-entity").data(this.model.entities.getVisible(),function(t){return t[e]}).order(),this.entityBubbles.exit().remove(),this.entityBubbles.enter().append("circle").attr("class",function(t){return"vzb-bc-entity bubble-"+t[e]}).on("mouseover",function(e,i){ne()||"arrow"!==t.model.ui.cursorMode||t._bubblesInteract().mouseover(e,i)}).on("mouseout",function(e,i){ne()||"arrow"!==t.model.ui.cursorMode||t._bubblesInteract().mouseout(e,i)}).on("click",function(e,i){ne()||"arrow"!==t.model.ui.cursorMode||t._bubblesInteract().click(e,i)}).onTap(function(e,i){d3.event.stopPropagation(),t._bubblesInteract().click(e,i)}).onLongTap(function(t,e){}),this.entityTrails=this.bubbleContainer.selectAll(".vzb-bc-entity").data(a.call(this,"trail-"),function(t){return t[e]}),this.entityTrails.enter().insert("g",function(t){return document.querySelector(".vzb-bc-bubbles ."+t[e].replace("trail-","bubble-"))}).attr("class",function(t){return"vzb-bc-entity "+t[e]})},_bubblesInteract:function(){var t=this,e=this.KEY;this.TIMEDIM;return{mouseover:function(i,a){t.model.entities.highlightEntity(i),t.entityLabels.filter(function(t){return t[e]==i[e]}).select(".vzb-bc-label-x").classed("vzb-transparent",!1)},mouseout:function(i,a){t.model.entities.clearHighlighted(),t.entityLabels.filter(function(t){return t[e]==i[e]}).select(".vzb-bc-label-x").classed("vzb-transparent",!0)},click:function(e,i){if(!t.draggingNow){var a=t.model.entities.isSelected(e);t.model.entities.selectEntity(e),!ne()&&a&&(t.model.entities.highlightEntity(e),t.highlightDataPoints())}}}},updateTime:function(){var t=this;if(this.time_1=null==this.time?this.model.time.value:this.time,this.time=this.model.time.value,this.duration=this.model.time.playing&&this.time-this.time_1>0?this.model.time.delayAnimations:0,this.duration){var e=t.time;this.yearDelayId=Kt(function(){t.year.setText(t.model.time.timeFormat(e))},this.duration)}else this.yearDelayId&&(Wt(this.yearDelayId),this.yearDelayId=null),t.year.setText(t.model.time.timeFormat(t.time))},updateSize:function(){var t={small:{margin:{top:30,right:10,left:40,bottom:35},padding:2,minRadius:.5,maxRadius:30,minLabelTextSize:7,maxLabelTextSize:21,defaultLabelTextSize:12,infoElHeight:16,yAxisTitleBottomMargin:6,xAxisTitleBottomMargin:4},medium:{margin:{top:40,right:15,left:60,bottom:55},padding:2,minRadius:1,maxRadius:55,minLabelTextSize:7,maxLabelTextSize:30,defaultLabelTextSize:15,infoElHeight:20,yAxisTitleBottomMargin:6,xAxisTitleBottomMargin:5},large:{margin:{top:50,right:20,left:60,bottom:60},padding:2,minRadius:1,maxRadius:70,minLabelTextSize:6,maxLabelTextSize:48,defaultLabelTextSize:20,infoElHeight:22,yAxisTitleBottomMargin:6,xAxisTitleBottomMargin:5}},e={medium:{margin:{top:80,bottom:80,left:100},yAxisTitleBottomMargin:20,xAxisTitleBottomMargin:20,infoElHeight:26},large:{margin:{top:80,bottom:100,left:100},yAxisTitleBottomMargin:20,xAxisTitleBottomMargin:20,infoElHeight:32}},i=this;this.activeProfile=this.getActiveProfile(t,e);var a=this.activeProfile.margin,n=this.activeProfile.infoElHeight;this.height=parseInt(this.element.style("height"),10)-a.top-a.bottom,this.width=parseInt(this.element.style("width"),10)-a.left-a.right,this.graph.attr("transform","translate("+a.left+","+a.top+")"),this.year.resize(this.width,this.height,Math.min(this.width/2.5,Math.max(this.height/4,this.width/4))),this.eventArea.attr("width",this.width).attr("height",Math.max(0,this.height)),"ordinal"!==this.model.marker.axis_y.scaleType?this.yScale.range(this._rangeBump([this.height,0])):this.yScale.rangePoints([this.height,0],i.activeProfile.padding).range(),"ordinal"!==this.model.marker.axis_x.scaleType?this.xScale.range(this._rangeBump([0,this.width])):this.xScale.rangePoints([0,this.width],i.activeProfile.padding).range(),this.yAxis.scale(this.yScale).orient("left").tickSize(6,0).tickSizeMinor(3,0).labelerOptions({scaleType:this.model.marker.axis_y.scaleType,timeFormat:this.model.time.timeFormat,toolMargin:a,limitMaxTickNumber:6,bump:this.activeProfile.maxRadius,constantRakeLength:this.height}),this.xAxis.scale(this.xScale).orient("bottom").tickSize(6,0).tickSizeMinor(3,0).labelerOptions({scaleType:this.model.marker.axis_x.scaleType,timeFormat:this.model.time.timeFormat,toolMargin:a,bump:this.activeProfile.maxRadius,constantRakeLength:this.width}),this.bubbleContainerCrop.attr("width",this.width).attr("height",Math.max(0,this.height)),this.xAxisElContainer.attr("width",this.width+1).attr("height",this.activeProfile.margin.bottom).attr("y",this.height-1).attr("x",-1),this.xAxisEl.attr("transform","translate(1,1)"),this.yAxisElContainer.attr("width",this.activeProfile.margin.left).attr("height",Math.max(0,this.height)).attr("x",-this.activeProfile.margin.left),this.yAxisEl.attr("transform","translate("+(this.activeProfile.margin.left-1)+",0)"),this.yAxisEl.call(this.yAxis),this.xAxisEl.call(this.xAxis),this.projectionX.attr("y1",i.yScale.range()[0]+this.activeProfile.maxRadius),this.projectionY.attr("x2",i.xScale.range()[0]-this.activeProfile.maxRadius);var s="constant"!==this.model.marker.size.use,r="constant"!==this.model.marker.color.use,l=this.sTitleEl.select("text").style("font-size",null).text((s?this.translator("buttons/size")+": "+this.strings.title.S:"")+(s&&r?", ":"")+(r?this.translator("buttons/colors")+": "+this.strings.title.C:"")),o=l.node().getBBox().width,c=this.height-30,h=parseInt(l.style("font-size"))*c/o;l.style("font-size",o>c?h+"px":null);var d=this.yAxisElContainer.select("g").node().getBBox().width;this.yTitleEl.style("font-size",n+"px").attr("transform","translate("+-d+", -"+this.activeProfile.yAxisTitleBottomMargin+")"),this.xTitleEl.style("font-size",n+"px").attr("transform","translate(0,"+(this.height+a.bottom-this.activeProfile.xAxisTitleBottomMargin)+")"),this.sTitleEl.attr("transform","translate("+this.width+",20) rotate(-90)");var u=this.yTitleEl.select("text").text(this.strings.title.Y+this.strings.unit.Y);u.node().getBBox().width>this.width&&u.text(this.strings.title.Y);var m=this.xTitleEl.select("text").text(this.strings.title.X+this.strings.unit.X);if(m.node().getBBox().width>this.width-100&&m.text(this.strings.title.X),this.yInfoEl.select("svg").node()){var g=this.yTitleEl.node().getBBox(),p=d3.transform(this.yTitleEl.attr("transform")).translate;this.yInfoEl.select("svg").attr("width",n+"px").attr("height",n+"px"),this.yInfoEl.attr("transform","translate("+(g.x+p[0]+g.width+.4*n)+","+(p[1]-.8*n)+")")}if(this.xInfoEl.select("svg").node()){var g=this.xTitleEl.node().getBBox(),p=d3.transform(this.xTitleEl.attr("transform")).translate;this.xInfoEl.select("svg").attr("width",n+"px").attr("height",n+"px"),this.xInfoEl.attr("transform","translate("+(g.x+p[0]+g.width+.4*n)+","+(p[1]-.8*n)+")")}this._resizeDataWarning()},_resizeDataWarning:function(){this.dataWarningEl.attr("transform","translate("+this.width+","+(this.height+this.activeProfile.margin.bottom-this.activeProfile.xAxisTitleBottomMargin)+")");var t=this.dataWarningEl.select("text").style("font-size",null),e=t.node().getBBox().width+3*t.node().getBBox().height,i=this.width-this.xTitleEl.node().getBBox().width-this.activeProfile.infoElHeight,a=parseInt(t.style("font-size"))*i/e;t.style("font-size",e>i?a+"px":null);var n=t.node().getBBox();this.dataWarningEl.select("svg").attr("width",.75*n.height).attr("height",.75*n.height).attr("x",-n.width-1.2*n.height).attr("y",.65*-n.height)},updateMarkerSizeLimits:function(){var t=this,e=this.model.marker.size.extent||[0,1];if(!this.activeProfile)return kt("updateMarkerSizeLimits() is called before ready(). This can happen if events get unfrozen and getFrame() still didn't return data");var i=this.activeProfile.minRadius,a=this.activeProfile.maxRadius;this.minRadius=Math.max(a*e[0],i),this.maxRadius=Math.max(a*e[1],i),"ordinal"!==this.model.marker.size.scaleType?this.sScale.range([Mt(t.minRadius),Mt(t.maxRadius)]):this.sScale.rangePoints([Mt(t.minRadius),Mt(t.maxRadius)],0).range()},updateLabelSizeLimits:function(){var t=this,e=this.model.marker.size_label.extent||[0,1],i=this.activeProfile.minLabelTextSize,a=this.activeProfile.maxLabelTextSize,n=a-i;this.minLabelTextSize=Math.max(i+n*e[0],i),this.maxLabelTextSize=Math.max(i+n*e[1],i),"constant"==this.model.marker.size_label.use&&(this.minLabelTextSize=this.maxLabelTextSize),"ordinal"!==this.model.marker.size_label.scaleType||"constant"==this.model.marker.size_label.use?this.labelSizeTextScale.range([t.minLabelTextSize,t.maxLabelTextSize]):this.labelSizeTextScale.rangePoints([t.minLabelTextSize,t.maxLabelTextSize],0).range()},redrawDataPointsOnlyColors:function(){var t=this,e=this.KEY,i=t.frame,a=this.model.time.value;this.model.ui.chart.lockNonSelected&&this.someSelected&&(a=this.model.time.timeFormat.parse(""+this.model.ui.chart.lockNonSelected)),this.model.marker.getFrame(a,function(a){t.entityBubbles.style("fill",function(n){var s=t.cached[n[e]],r=s&&t.model.ui.chart.lockNonSelected?a.color[n[e]]:i.color[n[e]];return null!=r?t.cScale(r):t.COLOR_WHITEISH})})},redrawDataPointsOnlySize:function(){var t,e=this,i=this.KEY,a=this.model.time.value;this.model.ui.chart.lockNonSelected&&this.someSelected&&(a=this.model.time.timeFormat.parse(""+this.model.ui.chart.lockNonSelected)),this.model.marker.getFrame(a,function(a){return a?(t=e.frame,void e.entityBubbles.each(function(n,s){var r=e.cached[n[i]],l=r&&e.model.ui.chart.lockNonSelected?t.size[n[i]]:a.size[n[i]];if(null!=l){var o=zt(e.sScale(l));if(d3.select(this).attr("r",o),r){var c=e.xScale(r.labelX0)+r.labelX_*e.width,h=e.yScale(r.labelY0)+r.labelY_*e.height,d=e.xScale(r.labelX0),u=e.yScale(r.labelY0),m=e.entityLines.filter(function(t){return t[i]==n[i]}),g=ft(e.model.entities.select,function(t){return t[i]==n[i]}),p=e.model.time.timeFormat.parse(""+g.trailStartTime);e.model.ui.chart.trails&&p-e.time!=0||(r.scaledS0=o),e.entityLabels.filter(function(t){return t[i]==n[i]}).each(function(t){e._repositionLabels(n,s,this,c,h,d,u,0,null,m)})}}})):kt("redrawDataPointsOnlySize: empty data received from marker.getFrames(). doing nothing")})},redrawDataPoints:function(t){var e=this;this.KEY;if(null==t&&(t=e.duration),this.model.ui.chart.lockNonSelected&&this.someSelected){var i=this.model.time.timeFormat.parse(""+this.model.ui.chart.lockNonSelected);this.model.marker.getFrame(i,function(i){return i?void e.entityBubbles.each(function(a,n){var s=e.model.entities.isSelected(a)?e.frame:i;e._updateBubble(a,s,n,d3.select(this),t)}):kt("redrawDataPoints: empty data received from marker.getFrames(). doing nothing")})}else e.entityBubbles.each(function(i,a){e._updateBubble(i,e.frame,a,d3.select(this),t)})},_updateBubble:function(t,e,i,a,n){var s=this,r=this.KEY,l=!1,o=e.axis_y[t[r]],c=e.axis_x[t[r]],h=e.size[t[r]],d=e.label[t[r]],u=e.color[t[r]],m=e.size_label[t[r]];if(!d&&0!==d||!o&&0!==o||!c&&0!==c||!h&&0!==h)t.hidden||(t.hidden=!0,l=!0),l&&a.classed("vzb-invisible",t.hidden);else{(t.hidden||a.classed("vzb-invisible"))&&(t.hidden=!1,l=!0);var g=zt(s.sScale(h));a.style("fill",null!=u?s.cScale(u):s.COLOR_WHITEISH),n?a.transition().duration(n).ease("linear").attr("cy",s.yScale(o)).attr("cx",s.xScale(c)).attr("r",g).each("end",function(){l&&a.classed("vzb-invisible",t.hidden)}):(a.interrupt().attr("cy",s.yScale(o)).attr("cx",s.xScale(c)).attr("r",g),l&&a.classed("vzb-invisible",t.hidden)),this.model.time.record&&s._export.write({type:"circle",id:t[r],time:this.model.time.value.getUTCFullYear(),fill:null!=u?s.cScale(u):s.COLOR_WHITEISH,cx:s.xScale(c),cy:s.yScale(o),r:g})}s._updateLabel(t,i,c,o,g,d,m,n,l)},_updateLabel:function(t,e,i,a,n,s,r,l,o){var c=this,h=this.KEY;if(t[h]!=c.druging){null==c.cached[t[h]]&&(c.cached[t[h]]={});var d=c.cached[t[h]];if(c.model.entities.isSelected(t)&&null!=c.entityLabels){var u=ft(c.model.entities.select,function(e){return e[h]==t[h]}),m=c.model.time.timeFormat.parse(""+u.trailStartTime),g=!i&&0!==i||!a&&0!==a||!n&&0!==n;g||c.model.ui.chart.trails&&!(m-c.time>0)&&null!=u.trailStartTime||(u.trailStartTime=c.model.time.timeFormat(c.time),d.scaledS0=n,d.labelX0=i,d.labelY0=a);var p=c.entityLines.filter(function(e){return e[h]==t[h]});c.entityLabels.filter(function(e){return e[h]==t[h]}).each(function(h){d.valueX=i,d.valueY=a,null!=d.scaledS0&&null!=d.labelX0&&null!=d.labelX0||(d.scaledS0=n,d.labelX0=i,d.labelY0=a);var g=d3.select(this),f=g.selectAll(".vzb-bc-label-content").text(s+(c.model.ui.chart.trails?" "+u.trailStartTime:"")),v=c.model.ui.chart.labels;g.classed("vzb-label-boxremoved",v.removeLabelBox);var b=c.labelSizeTextScale.range(),y=b[0]+Math.sqrt((c.labelSizeTextScale(r)-b[0])*(b[1]-b[0]));f.attr("font-size",y+"px");var x=g.select("rect"),_=f[0][0].getBBox();if(!d.contentBBox||d.contentBBox.width!=_.width){d.contentBBox=_;var M=1.2*c.activeProfile.infoElHeight,z=g.select(".vzb-bc-label-x").attr("transform","translate(4,"+.85*-_.height+")");z.select("circle").attr("cx",0).attr("cy",0).attr("r",.5*M),z.select("svg").attr("x",.5*-M).attr("y",M*-.5).attr("width",M).attr("height",M),x.attr("width",_.width+8).attr("height",1.2*_.height).attr("x",-_.width-4).attr("y",.85*-_.height).attr("rx",.2*_.height).attr("ry",.2*_.height)}var w=u.labelOffset||[0,0];d.labelX_=w[0]||(.75*-d.scaledS0-5)/c.width,d.labelY_=w[1]||(.75*-d.scaledS0-11)/c.height;var k=c.xScale(d.labelX0),S=c.yScale(d.labelY0),E=k+d.labelX_*c.width,T=S+d.labelY_*c.height;o&&t.hidden&&c.model.ui.chart.trails&&m&&m<c.time&&(o=!1),t.hidden&&!c.model.ui.chart.trails&&(o=!0),c._repositionLabels(t,e,this,E,T,k,S,l,o,p)})}else null!=c.cached[t[h]]&&(c.cached[t[h]]=void 0)}},_repositionLabels:function(t,e,i,a,n,s,r,l,o,c){var h=this.cached[t[this.KEY]],d=d3.select(i),u=!a&&0!==a||!n&&0!==n||!s&&0!==s||!r&&0!==r;if(u)return d.classed("vzb-invisible",u),void c.classed("vzb-invisible",u);var m=d.select("rect").node().getBBox(),g=m.width,p=m.height,f=d.node().getBBox().height-p;0>=a-g?(h.labelX_=(g-this.xScale(h.labelX0))/this.width,a=this.xScale(h.labelX0)+h.labelX_*this.width):a+23>this.width&&(h.labelX_=(this.width-23-this.xScale(h.labelX0))/this.width,a=this.xScale(h.labelX0)+h.labelX_*this.width),0>=n-.75*p-f?(h.labelY_=(.75*p+f-this.yScale(h.labelY0))/this.height,n=this.yScale(h.labelY0)+h.labelY_*this.height):n+13>this.height&&(h.labelY_=(this.height-13-this.yScale(h.labelY0))/this.height,n=this.yScale(h.labelY0)+h.labelY_*this.height),null==l&&(l=_this.duration),l?(d.transition().duration(l).ease("linear").attr("transform","translate("+a+","+n+")").each("end",function(){o&&d.classed("vzb-invisible",t.hidden)}),c.transition().duration(l).ease("linear").attr("transform","translate("+a+","+n+")").each("end",function(){o&&c.classed("vzb-invisible",t.hidden)})):(d.interrupt().attr("transform","translate("+a+","+n+")"),c.interrupt().attr("transform","translate("+a+","+n+")"),o&&d.classed("vzb-invisible",t.hidden),o&&c.classed("vzb-invisible",t.hidden));var v=s-a,b=r-n,y=d.select("text").node().getBBox(),x=.5*-y.width,_=.2*-p,M=this.model.ui.chart.labels,z=M.removeLabelBox?y:m,w=this.circleRectIntersects({x:v,y:b,r:h.scaledS0},{x:x,y:_,width:2*z.height+z.width,height:3*z.height});if(c.select("line").classed("vzb-invisible",w),!w){if(M.removeLabelBox){var k=180*Math.atan2(v-x,b-_)/Math.PI,S=k>=0&&180>=k?.5*z.width:.5*-z.width,E=Math.abs(k)<=90?.55*z.height:.45*-z.height;x+=Math.abs(v-x)>.5*y.width?S:0,_+=Math.abs(b-_)>.5*y.height?E:.05*y.height}var T=Math.abs(v)>Math.abs(b)?Math.abs(v)/this.width:Math.abs(b)/this.height;c.select("line").style("stroke-dasharray","0 "+(h.scaledS0+2)+" "+~~(T+2)+"00%"),c.selectAll("line").attr("x1",v).attr("y1",b).attr("x2",x).attr("y2",_)}},circleRectIntersects:function(t,e){var i=Math.abs(t.x-e.x),a=Math.abs(t.y-e.y),n=.5*e.width,s=.5*e.height;if(i>n+t.r)return!1;if(a>s+t.r)return!1;if(n>=i)return!0;if(s>=a)return!0;var r=Math.pow(i-n,2)+Math.pow(a-s,2);return r<=Math.pow(t.r,2)},selectDataPoints:function(){var t=this,e=this.KEY;t._setTooltip(),t.someSelected=t.model.entities.select.length>0,this.entityLabels=this.labelsContainer.selectAll(".vzb-bc-entity").data(t.model.entities.select,function(t){return t[e]}),this.entityLines=this.linesContainer.selectAll(".vzb-bc-entity").data(t.model.entities.select,function(t){return t[e]}),this.entityLabels.exit().each(function(e){t._trails.run("remove",e)}).remove(),this.entityLines.exit().each(function(e){t._trails.run("remove",e)}).remove(),this.entityLines.enter().append("g").attr("class","vzb-bc-entity").each(function(t,e){d3.select(this).append("line").attr("class","vzb-bc-label-line")}),this.entityLabels.enter().append("g").attr("class","vzb-bc-entity").call(t.labelDragger).each(function(e,i){var a=d3.select(this);a.append("rect"),a.append("text").attr("class","vzb-bc-label-content vzb-label-shadow"),a.append("text").attr("class","vzb-bc-label-content");var n=a.append("g").attr("class","vzb-bc-label-x vzb-transparent");re(n,mi),n.insert("circle","svg"),n.select("svg").attr("class","vzb-bc-label-x-icon").attr("width","0px").attr("height","0px"),n.on("click",function(){t.model.entities.clearHighlighted(),d3.event.defaultPrevented||t.model.entities.selectEntity(e)}),t._trails.create(e)}).on("mouseover",function(e){ne()||(t.model.entities.highlightEntity(e),t.entityLabels.sort(function(t,i){return t.geo!=e.geo?-1:1}),d3.select(this).selectAll(".vzb-bc-label-x").classed("vzb-transparent",!1))}).on("mouseout",function(e){ne()||(t.model.entities.clearHighlighted(),d3.select(this).selectAll(".vzb-bc-label-x").classed("vzb-transparent",!0))}).on("click",function(t){if(ne()){var e=d3.select(this).selectAll(".vzb-bc-label-x");e.classed("vzb-transparent",!e.classed("vzb-transparent"))}})},_setTooltip:function(t,e,i,a){if(t){var n,s,r=-1,l=-1,o=0,c=0;a&&(o=.71*a,c=.71*a),this.tooltip.classed("vzb-hidden",!1).selectAll("text").text(t);var h=this.tooltip.select("text")[0][0].getBBox();e-o-h.width<0?(r=1,e+=h.width+5):e-=5,i-c-h.height<0?(l=1,i+=h.height):i-=11,a?(n=e+o*r,s=i+c*l):(n=e+o*r,s=i+c*l),this.tooltip.attr("transform","translate("+n+","+s+")"),this.tooltip.select("rect").attr("width",h.width+8).attr("height",1.2*h.height).attr("x",-h.width-4).attr("y",.85*-h.height).attr("rx",.2*h.height).attr("ry",.2*h.height)}else this.tooltip.classed("vzb-hidden",!0)},_axisProjections:function(t){var e=this,i=this.TIMEDIM,a=this.KEY;null!=t?this.model.marker.getFrame(t[i],function(i){var n=i.axis_y[t[a]],s=i.axis_x[t[a]],r=i.size[t[a]],l=zt(e.sScale(r));n&&s&&r&&(e.ui.chart.whenHovering.showProjectionLineX&&e.xScale(s)>0&&e.xScale(s)<e.width&&e.yScale(n)+l<e.height&&e.projectionX.style("opacity",1).attr("y2",e.yScale(n)+l).attr("x1",e.xScale(s)).attr("x2",e.xScale(s)),e.ui.chart.whenHovering.showProjectionLineY&&e.yScale(n)>0&&e.yScale(n)<e.height&&e.xScale(s)-l>0&&e.projectionY.style("opacity",1).attr("y1",e.yScale(n)).attr("y2",e.yScale(n)).attr("x1",e.xScale(s)-l),e.ui.chart.whenHovering.higlightValueX&&e.xAxisEl.call(e.xAxis.highlightValue(s)),e.ui.chart.whenHovering.higlightValueY&&e.yAxisEl.call(e.yAxis.highlightValue(n)))}):(this.projectionX.style("opacity",0),this.projectionY.style("opacity",0),this.xAxisEl.call(this.xAxis.highlightValue("none")),this.yAxisEl.call(this.yAxis.highlightValue("none")))},highlightDataPoints:function(){var t=this,e=this.TIMEDIM,i=this.KEY;if(this.someHighlighted=this.model.entities.highlight.length>0,this.updateBubbleOpacity(),1===this.model.entities.highlight.length){var a=dt(this.model.entities.highlight[0]);t.model.ui.chart.lockNonSelected&&t.someSelected&&!t.model.entities.isSelected(a)?a[e]=t.model.time.timeFormat.parse(""+t.model.ui.chart.lockNonSelected):a[e]=t.model.time.timeFormat.parse(""+a.trailStartTime)||t.time,t.model.marker.getFrame(a[e],function(n){var s=t.xScale(n.axis_x[a[i]]),r=t.yScale(n.axis_y[a[i]]),l=zt(t.sScale(n.size[a[i]])),o=!1;(0>s+l||s-l>t.width||0>r+l||r-l>t.height)&&(o=!0);var c="",h=!1;if(t.model.entities.isSelected(a)&&t.model.ui.chart.trails){c=t.model.time.timeFormat(t.time);var d=t.entityLabels.filter(function(t){return t[i]==a[i]}).classed("vzb-highlighted",!0).datum();h=c!==d.trailStartTime&&!d3.select(d3.event.target).classed("bubble-"+a[i]),c=c!==d.trailStartTime&&t.time===a[e]?c:""}else c=t.model.entities.isSelected(a)?"":n.label[a[i]];o||h||t._axisProjections(a),!c||o||h||t._setTooltip(c,s,r,l);var u=ft(t.model.entities.select,function(t){return t[i]==a[i]});if(u){var m=dt(u);m.opacity=1,t._trails.run(["opacityHandler"],m)}})}else this._axisProjections(),this._trails.run(["opacityHandler"]),this._setTooltip(),this.entityLabels.classed("vzb-highlighted",!1)},updateBubbleOpacity:function(t){var e=this,i=1,a=.3,n=this.model.entities.opacityRegular,s=this.model.entities.opacityRegular,r=this.model.entities.opacitySelectDim;this.entityBubbles.style("opacity",function(t){return e.someHighlighted&&e.model.entities.isHighlighted(t)?i:e.someSelected?e.model.entities.isSelected(t)?n:r:e.someHighlighted?a:s});var l=e.someSelected&&e.model.entities.opacitySelectDim<.01;l!=this.someSelectedAndOpacityZero_1&&this.entityBubbles.style("pointer-events",function(t){return!l||e.model.entities.isSelected(t)?"visible":"none"}),this.someSelectedAndOpacityZero_1=e.someSelected&&e.model.entities.opacitySelectDim<.01}}),xn=Ei.extend("BubbleChart",{init:function(t,e){this.name="bubblechart",this.components=[{component:yn,placeholder:".vzb-tool-viz",model:["state.time","state.entities","state.marker","language","ui"]},{component:aa,placeholder:".vzb-tool-timeslider",model:["state.time"]},{component:Na,placeholder:".vzb-tool-dialogs",model:["state","ui","language"]},{component:Oa,
placeholder:".vzb-tool-buttonlist",model:["state","ui","language"]},{component:Ui,placeholder:".vzb-tool-treemenu",model:["state.marker","language"]},{component:Ya,placeholder:".vzb-tool-datawarning",model:["language"]}],this._super(t,e)},default_model:{state:{time:{round:"ceil"},entities:{dim:"geo",show:{_defs_:{geo:["*"],"geo.cat":["country"]}},opacitySelectDim:.3,opacityRegular:1},marker:{space:["entities","time"],type:"geometry",label:{use:"property",which:"geo.name"},size_label:{use:"constant"},axis_y:{use:"indicator",which:"lex"},axis_x:{use:"indicator",which:"gdp_pc"},color:{use:"property",which:"geo.region"},size:{use:"indicator",which:"pop"}}},data:{reader:"csv",path:"data/waffles/basic-indicators.csv"},ui:{chart:{whenHovering:{showProjectionLineX:!0,showProjectionLineY:!0,higlightValueX:!0,higlightValueY:!0},labels:{dragging:!0,removeLabelBox:!1},trails:!0,lockNonSelected:0,adaptMinMaxZoom:!1},presentation:!0}}}),_n=Xe.extend({init:function(t,e){this.name="popbyage",this.template="popbyage.html",this.model_expects=[{name:"time",type:"time"},{name:"entities",type:"entities"},{name:"age",type:"entities"},{name:"marker",type:"model"},{name:"language",type:"language"}];var i=this;this.model_binds={"change:time.value":function(t){i._updateEntities()},"change:entities.show":function(t){console.log("Trying to change show")},"change:age.select":function(t){i._selectBars()},"change:marker.color.palette":function(t){i._readyOnce&&i._updateEntities()},"change:marker.color.scaleType":function(t){i._readyOnce&&i._updateEntities()}},this._super(t,e),this.xScale=null,this.yScale=null,this.cScale=null,this.xAxis=O(),this.yAxis=O()},readyOnce:function(){this.el=this.el?this.el:d3.select(this.element),this.element=this.el,this.graph=this.element.select(".vzb-bc-graph"),this.yAxisEl=this.graph.select(".vzb-bc-axis-y"),this.xAxisEl=this.graph.select(".vzb-bc-axis-x"),this.yTitleEl=this.graph.select(".vzb-bc-axis-y-title"),this.bars=this.graph.select(".vzb-bc-bars"),this.labels=this.graph.select(".vzb-bc-labels"),this.title=this.element.select(".vzb-bc-title"),this.year=this.element.select(".vzb-bc-year"),this.model.age.selectMultiple(!0);var t=this;this.on("resize",function(){t._updateEntities()})},ready:function(){this.AGEDIM=this.model.age.getDimension(),this.TIMEDIM=this.model.time.getDimension(),this.updateUIStrings(),this._updateIndicators(),this.resize(),this._updateEntities(),this._updateEntities()},updateUIStrings:function(){this.translator=this.model.language.getTFunction();var t=this.translator("indicator/"+this.model.marker.axis_y.which),e=this.yTitleEl.selectAll("text").data([0]);e.enter().append("text"),e.attr("y","-6px").attr("x","-9px").attr("dx","-0.72em").text(t)},_updateIndicators:function(){var t=this;this.duration=this.model.time.delayAnimations,this.yScale=this.model.marker.axis_y.getScale(),this.xScale=this.model.marker.axis_x.getScale(!1),this.yAxis.tickFormat(t.model.marker.axis_y.tickFormatter),this.xAxis.tickFormat(t.model.marker.axis_x.tickFormatter)},_updateEntities:function(){var t=this,e=this.model.time,i=this.AGEDIM,a=this.TIMEDIM,n=e.playing?e.delayAnimations:0,s=this.model.age.grouping||1,r={};r[a]=e.value;var l=this.model.marker.getKeys(r),o=this.model.marker.getValues(r,[i]),c=this.yScale.domain();this.cScale=this.model.marker.color.getScale(),this.model.age.setVisible(l),this.entityBars=this.bars.selectAll(".vzb-bc-bar").data(l),this.entityLabels=this.labels.selectAll(".vzb-bc-label").data(l),this.entityBars.exit().remove(),this.entityLabels.exit().remove();var h=this._highlightBar.bind(this),d=this._unhighlightBars.bind(this);this.entityBars.enter().append("g").attr("class","vzb-bc-bar").attr("id",function(t){return"vzb-bc-bar-"+t[i]}).on("mouseover",h).on("mouseout",d).on("click",function(e,i){ne()||t.model.age.selectEntity(e)}).onTap(function(e){d3.event.stopPropagation(),t.model.age.selectEntity(e)}).append("rect"),this.entityLabels.enter().append("g").attr("class","vzb-bc-label").attr("id",function(t){return"vzb-bc-label-"+t[i]}).append("text").attr("class","vzb-bc-age");var u=this.height/(c[1]-c[0]),m=u*s,g=this.height-m;this.bars.selectAll(".vzb-bc-bar > rect").attr("fill",function(e){return t._temporaryBarsColorAdapter(o,e,i)}).attr("shape-rendering","crispEdges").attr("x",0).transition().duration(n).ease("linear").attr("y",function(t,e){return g-(t[i]-c[0])*u}).attr("height",m).attr("width",function(e){return t.xScale(o.axis_x[e[i]])}),this.labels.selectAll(".vzb-bc-label > .vzb-bc-age").text(function(a,n){var r=t.model.marker.axis_x.tickFormatter,l=t.translator("popbyage/yearOldsIn"),c=parseInt(a[i],10);return s>1&&(c=c+"-to-"+(c+s-1)),c+l+" "+t.model.time.timeFormat(e.value)+": "+r(o.axis_x[a[i]])}).attr("x",7).attr("y",function(t,e){return g-(t[i]-c[0])*u-10}).style("fill",function(e){var a=t.cScale(o.color[e[i]]);return d3.rgb(a).darker(2)});var p=qt(o.label_name).reverse()[0];p="usa"===p?"United States":"Sweden",this.title.text(p),this.year.text(this.model.time.timeFormat(this.model.time.value));var f=this.model.marker.axis_x.getLimits(this.model.marker.axis_x.which);if(1==s)this.xScale=this.xScale.domain([f.min,f.max]);else{var o=qt(o.axis_x);o.push(f.max),this.xScale=this.xScale.domain([f.min,Math.max.apply(Math,o)])}this.resize()},_temporaryBarsColorAdapter:function(t,e,i){return this.cScale(t.color[e[i]])},_unhighlightBars:function(){ne()||(this.bars.classed("vzb-dimmed",!1),this.bars.selectAll(".vzb-bc-bar.vzb-hovered").classed("vzb-hovered",!1),this.labels.selectAll(".vzb-hovered").classed("vzb-hovered",!1))},_highlightBar:function(t){if(!ne()){this.bars.classed("vzb-dimmed",!0);var e=this.bars.select("#vzb-bc-bar-"+t[this.AGEDIM]);e.classed("vzb-hovered",!0);var i=this.labels.select("#vzb-bc-label-"+t[this.AGEDIM]);i.classed("vzb-hovered",!0)}},_selectBars:function(){var t=this,e=this.AGEDIM,i=this.model.age.select;this._unselectBars(),i.length&&(this.bars.classed("vzb-dimmed-selected",!0),lt(i,function(i){t.bars.select("#vzb-bc-bar-"+i[e]).classed("vzb-selected",!0),t.labels.select("#vzb-bc-label-"+i[e]).classed("vzb-selected",!0)}))},_unselectBars:function(){this.bars.classed("vzb-dimmed-selected",!1),this.bars.selectAll(".vzb-bc-bar.vzb-selected").classed("vzb-selected",!1),this.labels.selectAll(".vzb-selected").classed("vzb-selected",!1)},resize:function(){this.profiles={small:{margin:{top:70,right:20,left:40,bottom:40},minRadius:2,maxRadius:40},medium:{margin:{top:80,right:60,left:60,bottom:40},minRadius:3,maxRadius:60},large:{margin:{top:100,right:60,left:60,bottom:40},minRadius:4,maxRadius:80}},this.activeProfile=this.profiles[this.getLayoutProfile()];var t=this.activeProfile.margin;this.height=parseInt(this.element.style("height"),10)-t.top-t.bottom,this.width=parseInt(this.element.style("width"),10)-t.left-t.right,this.graph.attr("transform","translate("+t.left+","+t.top+")"),"ordinal"!==this.model.marker.axis_y.scaleType?this.yScale.range([this.height,0]):this.yScale.rangePoints([this.height,0]).range(),"ordinal"!==this.model.marker.axis_x.scaleType?this.xScale.range([0,this.width]):this.xScale.rangePoints([0,this.width]).range(),this.yAxis.scale(this.yScale).orient("left").tickSize(6,6).tickSizeMinor(3,0).labelerOptions({scaleType:this.model.marker.axis_y.scaleType,toolMargin:t,limitMaxTickNumber:6}),this.xAxis.scale(this.xScale).orient("bottom").tickSize(6,0).tickSizeMinor(3,0).labelerOptions({scaleType:this.model.marker.axis_x.scaleType,toolMargin:t,limitMaxTickNumber:6}),this.xAxisEl.attr("transform","translate(0,"+this.height+")").call(this.xAxis),this.yAxisEl.call(this.yAxis),this.title.attr("x",t.right).attr("y",t.top/2),this.year.attr("x",this.width+t.left).attr("y",t.top/2)}}),Mn=Ei.extend("PopByAge",{init:function(t,e){this.name="popbyage",this.components=[{component:_n,placeholder:".vzb-tool-viz",model:["state.time","state.entities","state.entities_age","state.marker","language"]},{component:aa,placeholder:".vzb-tool-timeslider",model:["state.time"]},{component:Na,placeholder:".vzb-tool-dialogs",model:["state","ui","language"]},{component:Oa,placeholder:".vzb-tool-buttonlist",model:["state","ui","language"]},{component:Ui,placeholder:".vzb-tool-treemenu",model:["state.marker","language"]}],this._super(t,e)}}),zn=(Xe.extend("donut",{init:function(t,e){var i=this;this.name="donutchart",this.template='<div class="vzb-donutchart"><svg class="vzb-donutchart-svg"></svg></div>',this.model_expects=[{name:"time",type:"time"},{name:"marker",type:"model"}],this.model_binds={"change:time:value":function(t){i.time=i.model.time.value,i.yearEl.text(i.timeFormatter(i.time)),i.redraw()}},this._super(t,e),this.colorScale=null,this.arc=d3.svg.arc(),this.pie=d3.layout.pie().sort(null).value(function(t){return t.pop})},readyOnce:function(){var t=this;this.element=d3.select(this.element),this.svgEl=this.element.select("svg").append("g"),this.yearEl=this.svgEl.append("text").attr("class","year").style({"font-size":"4em"}),this.titleEl=this.svgEl.append("text").attr("class","title").style({"font-size":"2em"}),this.on("resize",function(){t.resize(),t.redraw()}),this.resize(),this.update(),this.redraw()},update:function(){this.timeFormatter=d3.time.format("%Y"),this.colorScale=this.model.marker.color.getScale(),this.titleEl.text("Population"),this.keys=this.model.marker.getKeys(),this.entities=this.svgEl.selectAll(".vzb-dc-entity").data(this.keys),this.entities.exit().remove(),this.entities.enter().append("g").attr("class","vzb-dc-entity").each(function(){d3.select(this).append("path"),d3.select(this).append("text").attr("class","label").style({"font-size":"1.2em"})})},redraw:function(){var t=this;this.values=this.model.marker.getValues({time:t.time},["geo"]);var e=this.keys.map(function(e){return{geo:e.geo,pop:t.values.axis[e.geo],color:t.values.color[e.geo],label:t.values.label[e.geo]}});e=this.pie(e),this.entities.data(e).select("path").attr("d",this.arc).style("fill",function(e){return t.colorScale(e.data.color)}).style("stroke","white"),this.entities.select("text").style({"text-transform":"capitalize"}).attr("transform",function(e){return"translate("+t.arc.centroid(e)+")"}).text(function(t){return t.data.geo})},resize:function(){var t=parseInt(this.element.style("height")),e=parseInt(this.element.style("width")),i=Math.min(t,e);this.svgEl.attr("transform","translate("+e/2+","+t/2+")"),this.titleEl.attr("y","-0.1em"),this.yearEl.attr("y","0.1em"),this.arc.outerRadius(i/2*.9).innerRadius(i/2-.1*i)}}),Ei.extend("DonutChart",{init:function(t,e){this.name="donutchart",this.components=[{component:"donut",placeholder:".vzb-tool-viz",model:["state.time","state.marker"]},{component:"timeslider",placeholder:".vzb-tool-timeslider",model:["state.time"]}],this._super(t,e)},default_model:{state:{}}})),wn={},kn={},Sn=de.extend({init:function(t){this._name="waffle",this._data=[],this._basepath=t.path,this._parsers=t.parsers,this._basepath||Tt("Missing base path for graph reader")},read:function(t,e){var i=this,a=new s,n=this._basepath;return n+="?"+i._encodeQuery(t),i._data=[],function(t,e){function a(t){return t?(t=_t(r(t.data||t),i._parsers),wn[n]=t,kn[n].resolve(),kn[n]=void 0,void l(t)):void Tt("Empty json: "+n,error)}function r(t){for(var e=t.rows,i=t.headers,a=new Array(e.length),n=0;n<e.length;n++){a[n]={};for(var s=0;s<i.length;s++)a[n][i[s]]=(e[n][s]||"").toString(),"geo.cat"===i[s]&&(a[n][i[s]]=[a[n][i[s]]])}return a}function l(a){var n=a;t.orderBy&&n[0]&&(n[0][t.orderBy]?n.sort(function(e,i){return e[t.orderBy]-i[t.orderBy]}):e.reject("Cannot sort by "+t.orderBy+". Column does not exist in result.")),i._data=n,e.resolve()}return wn.hasOwnProperty(n)?(l(wn[n]),e):kn.hasOwnProperty(n)?(kn[n].then(function(){l(wn[n])}),e):(kn[n]=new s,te(n,[],a,console.error.bind(console),!0),e)}(t,a),a},_encodeQuery:function(t){var e=ct({},t.where);e.select=t.select,e.gapfilling=t.gapfilling,e.geo&&1===e.geo.length&&"*"===e.geo[0]&&delete e.geo;var i=[];return Object.keys(e).map(function(t){var a=En.encodeQuery(e[t]);a&&i.push(t+"="+a)}),i.join("&")},getData:function(){return this._data}}),En=function(){function t(t){return e()(t)}function e(t){return t?a:i}function i(t,i){return t?t.toString()===t||n(t)?t:Array.isArray(t)?t.map(e(1)).join():"object"==typeof t?s(t).map(e(1)).join():t:t}function a(t){return encodeURI(t).replace(/,/g,":")}function n(t){return parseInt(t,10)==t}function s(t){return Object.keys(t).map(function(e){return t[e]===!0?[e]:[e,t[e]]})}return{encodeQuery:t}}(),Tn=function(t){return this.each(function(){Y(this,t)})},Ln=function(t){return this.each(function(){Y(this,null,t)})},On={},An={},Pn=de.extend({init:function(t){this._name="json",this._data=[],this._basepath=t.path,this._parsers=t.parsers,this._basepath||Tt("Missing base path for json reader")},read:function(t,e){var i=this,a=new s,n=this._basepath.replace("{{LANGUAGE}}",e);return i._data=[],function(t,e){function a(t){t=t[0].map(function(t){return t["geo.cat"]=[t["geo.cat"]],t["geo.region"]=t["geo.region"]||t.geo,t}),t=_t(t,i._parsers);var e=Object.keys(i._parsers),a=e[0];return t.sort(function(t,e){return t[a]-e[a]}),t}function r(a){var n=a,s=t.where;s["geo.category"]&&(s["geo.cat"]=dt(s["geo.category"]),s["geo.category"]=void 0),s=_t([s],i._parsers)[0];var r=[];return lt(s,function(t,e){for(var i=0,a=n.length;a>i;i++)if(n[i].hasOwnProperty(e))return r.push(e),!0}),s=dt(s,r),n=bt(n,s),0==n.length?void e.reject("data reader returns empty array, that's bad"):(n=n.map(function(e){return dt(e,t.select)}),i._data=n,void e.resolve())}On.hasOwnProperty(n)?r(On[n]):An.hasOwnProperty(n)?An[n].then(function(){r(On[n])}):(d3.json(n,function(t,e){return e?t?void Tt("Error Happened While Loading JSON File: "+n,t):(e=a(e),On[n]=e,An[n].resolve(),An[n]=void 0,void r(e)):void Tt("No permissions or empty file: "+n,t)}),An[n]=new s)}(t,a),a},getData:function(){return this._data}}),Dn=de.extend({init:function(t){this.name="inline",this._super(t)}}),Cn={},In={},qn=de.extend({init:function(t){this._name="graph",this._data=[],this._basepath=t.path,this._parsers=t.parsers,this._basepath||Tt("Missing base path for graph reader")},read:function(t,e){function i(t){return"string"==typeof t?t:t.getUTCFullYear()}var a=this,n=new s,r=this._basepath;if(t.where.time){var l=t.where.time[0],o="undefined"!=typeof l.join&&2===l.length?JSON.stringify({from:i(l[0]),to:i(l[1])}):i(l[0]);r+="?time="+o}return a._data=[],function(t,e){function i(t){return t?(t=l(n(t.data)),Cn[r]=t,In[r].resolve(),In[r]=void 0,void o(t)):void Tt("Empty json: "+r,error)}function n(t){for(var e=t.rows,i=t.headers,a=new Array(e.length),n=0;n<e.length;n++){a[n]={};for(var s=0;s<i.length;s++)a[n][i[s]]=(e[n][s]||"").toString(),"geo.cat"===i[s]&&(a[n][i[s]]=[a[n][i[s]]])}return a}function l(t){t=_t(t,a._parsers);var e=Object.keys(a._parsers),i=e[0];return t.sort(function(t,e){return t[i]-e[i]}),t}function o(i){var n=i,s=t.where;s["geo.category"]&&(s["geo.cat"]=dt(s["geo.category"]),delete s["geo.category"]),s=_t([s],a._parsers)[0];var r=[];lt(s,function(t,e){for(var i=0,a=n.length;a>i;i++)if(n[i].hasOwnProperty(e))return r.push(e),!0}),s=dt(s,r),n=bt(n,s),0===n.length&&kt("data reader returns empty array, that's bad"),n=n.map(function(e){return dt(e,t.select)}),a._data=n,e.resolve()}return Cn.hasOwnProperty(r)?(o(Cn[r]),e):In.hasOwnProperty(r)?(In[r].then(function(){o(Cn[r])}),e):(In[r]=new s,te(r,[],i,console.error.bind(console),!0),e)}(t,n),n},getData:function(){return this._data}}),Rn={},Bn={},Fn=de.extend({init:function(t){this._name="csv",this._data=[],this._basepath=t.path,this._parsers=t.parsers,this._basepath||Tt("Missing base path for csv reader")},read:function(t,e){var i=this,a=new s;this.path=this._basepath.replace("{{LANGUAGE}}",e),this.path=this.path.replace(/{{(.*?)}}/g,function(e,i){return i=i.toLowerCase(),W(t.where[i])?t.where[i].sort().join("-"):t.where[i]});var n=this.path;return t.where.time&&1===t.where.time[0].length&&(n=n.replace(".csv","-"+t.where.time[0][0]+".csv")),i._data=[],function(t,e){function a(a){var n=a,s=t.where;s["geo.category"]&&(s["geo.cat"]=dt(s["geo.category"]),s["geo.category"]=void 0);var r=i.loadProperties(n,t);r.then(function(){var a=[];return lt(s,function(t,e){for(var i=0,s=n.length;s>i;i++)if(n[i].hasOwnProperty(e))return a.push(e),!0}),s=dt(ut(s),a),s=_t([s],i._parsers)[0],n=bt(n,s),0==n.length?void e.reject("data reader returns empty array, that's bad"):(n=n.map(function(e){return dt(e,t.select)}),n=i.groupData(n,t),t.orderBy&&n[0]&&(n[0][t.orderBy]?n.sort(function(e,i){return e[t.orderBy]-i[t.orderBy]}):e.reject("Cannot sort by "+t.orderBy+". Column does not exist in result.")),i._data=n,void e.resolve())})}var s=i.load(n,a);s.then(function(){a(Rn[n])})}(t,a),a},getData:function(){return this._data},format:function(t){return t=t.map(function(t){return t["geo.cat"]&&(t["geo.cat"]=[t["geo.cat"]]),t}),t=_t(t,this._parsers)},load:function(t){var e=this;return Rn.hasOwnProperty(t)||Bn.hasOwnProperty(t)||(d3.csv(t,function(i,a){return a?i?void Tt("Error Happened While Loading CSV File: "+t,i):(a=e.format(a),Rn[t]=a,void Bn[t].resolve()):void Tt("No permissions or empty file: "+t,i)}),Bn[t]=new s),Bn[t]},loadProperties:function(t,e){function i(t){var e=t.split(".");2==e.length&&(l[e[0]]=l[e[0]]||[],l[e[0]].push(t))}function a(e,i){var a=n.path.replace(".csv","-"+i+"-properties.csv"),r=new s,l=n.load(a);return l.then(function(){var n={};lt(Rn[a],function(t){n[t[i]]=t}),lt(t,function(t,a){lt(e,function(e){n[t[i]]?t[e]=n[t[i]][e]:kt(t[i]+" is missing from GEO-PROPERTIES.CSV")})}),r.resolve()}),r}var n=this,r=[],l={};return lt(e.select,function(t){i(t)}),lt(e.where,function(t,e){i(e)}),lt(l,function(t,e){t[e]=!0,r.push(a(t,e))}),r.length?s.all(r):new s.resolve},groupData:function(t,e){var i={},a=t.filter(function(t,a){for(var n,s=i,r=Object.keys(e.grouping),l=r.length,o=0;l>o;o++){var c,h=e.grouping[r[o]],d=r[o];if("age"==d){var u=h,m=0,g=Math.floor((t[d]-m)/u),p=g*u+m;p<e.where[d][0][0]&&(p=e.where[d][0][0]),c=p,t[d]=c}l-1>o?(s[t[d]]||(s[t[d]]={}),s=s[t[d]]):s[t[d]]?(s=s[t[d]],lt(e.select,function(e,i){"pop"==e&&(s[e]=parseFloat(s[e])+parseFloat(t.pop))}),n=!1):(s[t[d]]=t,n=!0)}return n});return a}}),Hn={csv:Fn,graph:qn,inline:Dn,json:Pn,waffle:Sn},Nn={csv:Fn,graph:qn,inline:Dn,json:Pn,waffle:Sn,"default":Hn},jn=function(t,e,i){var a=Ei.get(t);if(a){var n=new a(e,i);return jn._instances[n._id]=n,n}Tt('Tool "'+t+'" was not found.')};jn._instances={},jn._globals=V,jn.clearInstances=function(t){if(t)jn._instances[t]=void 0;else{for(var e in jn._instances)jn._instances[e].clear();jn._instances={}}},lt(Nn,function(t,e){de.register(e,t)}),lt(Ga,function(t,e){Xe.register(e,t)}),d3.scale.genericLog=j,d3.selection.prototype.onTap=Tn,d3.selection.prototype.onLongTap=Ln,jn.Tool=Ei,jn.Component=Xe,jn.Model=Me,jn.Reader=de,jn.Events=be,jn.utils=le;var Yn={id:"en",strings:{}},Vn=window.location.href.split("/"),Xn=Vn.splice(0,Vn.indexOf("preview")).join("/")+"/preview/";return V.gapminder_paths={wsUrl:"undefined"==typeof WS_SERVER?"https://waffle-server-stage.gapminderdev.org":WS_SERVER,baseUrl:Xn},Za.define("default_model",{state:{time:{start:"1800",end:"2012",value:"2000",step:1},entities:{dim:"geo",show:{_defs_:{geo:["usa","swe","nor"],"geo.cat":["country","unstate"]}}},marker:{space:["entities","time"],label:{use:"property",which:"geo.name"},axis_y:{use:"indicator",which:"population",scaleType:"log",allow:{scales:["linear","log"]}},axis_x:{use:"property",which:"geo.name",allow:{scales:["ordinal"],names:["!geo","!_default"]}},color:{use:"property",which:"geo.region",scaleType:"ordinal"}}},data:{reader:"waffle",path:V.gapminder_paths.wsUrl+"/api/graphs/stats/vizabi-tools"},language:Yn,ui:{presentation:!1}}),tn.define("default_model",{state:{time:{start:"1950",end:"2015",value:"2000",step:1},entities:{dim:"geo",show:{_defs_:{"geo.cat":["country","unstate"]}},opacitySelectDim:.3,opacityRegular:1},entities_allpossible:{dim:"geo",show:{_defs_:{geo:["*"],"geo.cat":["country","unstate"]}}},marker_allpossible:{space:["entities_allpossible"],label:{use:"property",which:"geo.name"}},marker:{space:["entities","time"],label:{use:"property",which:"geo.name"},axis_x:{use:"indicator",which:"population",scaleType:"log",allow:{scales:["linear","log"]}},axis_y:{use:"property",which:"geo.name",scaleType:"log",allow:{scales:["ordinal"]}},color:{use:"property",which:"geo.region"}}},language:Yn,data:{reader:"waffle",path:V.gapminder_paths.wsUrl+"/api/graphs/stats/vizabi-tools",splash:!0},ui:{presentation:!1}}),nn.define("datawarning_content",{title:"",body:"Comparing the size of economy across countries and time is not trivial. The methods vary and the prices change. Gapminder has adjusted the picture for many such differences, but still we recommend you take these numbers with a large grain of salt.<br/><br/> Countries on a lower income levels have lower data quality in general, as less resources are available for compiling statistics. Historic estimates of GDP before 1950 are generally also more rough. <br/><br/> Data for child mortality is more reliable than GDP per capita, as the unit of comparison, dead children, is universally comparable across time and place. This is one of the reasons this indicator has become so useful to measure social progress. But the historic estimates of child mortality are still suffering from large uncertainties.<br/><br/> Learn more about the datasets and methods in this <a href='http://www.gapminder.org/news/data-sources-dont-panic-end-poverty' target='_blank'>blog post</a>",doubtDomain:[1800,1950,2015],doubtRange:[1,.3,.2]}),nn.define("default_model",{state:{time:{start:"1800",end:"2015",value:"2015",step:1,speed:300},entities:{dim:"geo",opacitySelectDim:.3,opacityRegular:1,show:{_defs_:{"geo.cat":["country","unstate"]}}},marker:{space:["entities","time"],label:{use:"property",which:"geo.name"},size:{use:"indicator",which:"population",scaleType:"linear",allow:{scales:["linear"]},extent:[.04,.9]},lat:{use:"property",which:"geo.latitude"},lng:{use:"property",which:"geo.longitude"},color:{use:"property",which:"geo.region",scaleType:"ordinal",allow:{names:["!geo.name"]}}}},data:{reader:"waffle",path:V.gapminder_paths.wsUrl+"/api/graphs/stats/vizabi-tools",splash:!0},language:Yn,ui:{chart:{labels:{dragging:!0}},presentation:!1}}),gn.define("datawarning_content",{title:"Income data has large uncertainty!",body:"There are many different ways to estimate and compare income. Different methods are used in different countries and years. Unfortunately no data source exists that would enable comparisons across all countries, not even for one single year. Gapminder has managed to adjust the picture for some differences in the data, but there are still large issues in comparing individual countries. The precise shape of a country should be taken with a large grain of salt.<br/><br/> Gapminder strongly agrees with <a href='https://twitter.com/brankomilan' target='_blank'>Branko Milanovic</a> about the urgent need for a comparable global income survey, especially for the purpose of monitoring the UN poverty-goal.<br/><br/> We are constantly improving our datasets and methods. Please expect revision of this graph within the coming months. <br/><br/> Learn more about the datasets and methods in this <a href='http://www.gapminder.org/news/data-sources-dont-panic-end-poverty' target='_blank'>blog post</a>",doubtDomain:[1800,1950,2015],doubtRange:[1,.8,.6]}),gn.define("default_model",{state:{time:{start:1800,end:2015,value:2015,step:1,delay:100,delayThresholdX2:50,delayThresholdX4:25},entities:{dim:"geo",opacitySelectDim:.3,opacityRegular:.7,show:{_defs_:{geo:["*"],"geo.cat":["unstate"]}}},entities_allpossible:{dim:"geo",show:{_defs_:{geo:["*"],"geo.cat":["unstate"]}}},marker_allpossible:{space:["entities_allpossible"],label:{use:"property",which:"geo.name"}},marker:{space:["entities","time"],label:{use:"property",which:"geo.name"},axis_y:{use:"indicator",which:"population",scaleType:"linear"},axis_x:{use:"indicator",which:"gdp_p_cap_const_ppp2011_dollar",scaleType:"log",domainMin:.11,domainMax:500,tailFatX:1.85,tailCutX:.2,tailFade:.7,xScaleFactor:1.039781626,xScaleShift:-1.127066411},axis_s:{use:"indicator",which:"gini",scaleType:"linear"},color:{use:"property",which:"geo.region",scaleType:"ordinal",allow:{names:["!geo.name"]}},stack:{use:"constant",which:"all"},group:{use:"property",which:"geo.region",manualSorting:["asia","africa","americas","europe"],merge:!1}}},language:Yn,data:{reader:"waffle",path:V.gapminder_paths.wsUrl+"/api/graphs/stats/vizabi-tools",splash:!0},ui:{chart:{yMaxMethod:"latest",probeX:1.85,xLogStops:[1,2,5],xPoints:50},presentation:!1}}),fn.define("default_model",{state:{time:{start:1800,end:2012,value:2012,step:1},entities:{dim:"geo",show:{_defs_:{geo:["usa","swe","chn"],"geo.cat":["country","unstate"]}}},marker:{space:["entities","time"],label:{use:"property",which:"geo.name"},axis_y:{use:"indicator",which:"gdp_p_cap_const_ppp2011_dollar",scaleType:"log"},axis_x:{use:"indicator",which:"time",scaleType:"time"},color:{use:"property",which:"geo.region",allow:{scales:["ordinal"],names:["!geo.name"]}}}},data:{reader:"waffle",path:V.gapminder_paths.wsUrl+"/api/graphs/stats/vizabi-tools",splash:!1},language:Yn,ui:{chart:{labels:{min_number_of_entities_when_values_hide:2},whenHovering:{hideVerticalNow:!1,showProjectionLineX:!0,showProjectionLineY:!0,higlightValueX:!0,higlightValueY:!0,showTooltip:!1}},presentation:!1}}),xn.define("datawarning_content",{title:"",body:"Comparing the size of economy across countries and time is not trivial. The methods vary and the prices change. Gapminder has adjusted the picture for many such differences, but still we recommend you take these numbers with a large grain of salt.<br/><br/> Countries on a lower income levels have lower data quality in general, as less resources are available for compiling statistics. Historic estimates of GDP before 1950 are generally also more rough. <br/><br/> Data for child mortality is more reliable than GDP per capita, as the unit of comparison, dead children, is universally comparable across time and place. This is one of the reasons this indicator has become so useful to measure social progress. But the historic estimates of child mortality are still suffering from large uncertainties.<br/><br/> Learn more about the datasets and methods in this <a href='http://www.gapminder.org/news/data-sources-dont-panic-end-poverty' target='_blank'>blog post</a>",doubtDomain:[1800,1950,2015],doubtRange:[1,.3,.2]}),xn.define("default_model",{state:{time:{start:"1800",end:"2015",value:"2015",step:1},entities:{dim:"geo",show:{_defs_:{"geo.cat":["country","unstate"]}}},marker:{space:["entities","time"],type:"geometry",shape:"circle",label:{use:"property",which:"geo.name"},size_label:{use:"constant"},axis_y:{use:"indicator",which:"life_expectancy",scaleType:"linear",allow:{scales:["linear","log"]}},axis_x:{use:"indicator",which:"gdp_p_cap_const_ppp2011_dollar",scaleType:"log",allow:{scales:["linear","log"]}},color:{use:"property",which:"geo.region",scaleType:"ordinal",allow:{names:["!geo.name"]}},size:{use:"indicator",which:"population",scaleType:"linear",allow:{scales:["linear"]},extent:[.04,.9]}}},data:{reader:"waffle",path:V.gapminder_paths.wsUrl+"/api/graphs/stats/vizabi-tools",splash:!0},language:Yn,ui:{chart:{whenHovering:{showProjectionLineX:!0,showProjectionLineY:!0,higlightValueX:!0,higlightValueY:!0},labels:{dragging:!0,removeLabelBox:!1},trails:!0,lockNonSelected:0,adaptMinMaxZoom:!1},presentation:!1,cursorMode:"arrow",noZoomOnScrolling:!0}}),Mn.define("default_model",{state:{time:{value:"2013",start:"1950",end:"2100"},entities:{dim:"geo",show:{_defs_:{geo:["usa"]}}},entities_age:{dim:"age",show:{_defs_:{age:[[0,95]]}},grouping:5},marker:{space:["entities","entities_age","time"],label:{use:"indicator",which:"age"},label_name:{use:"property",which:"geo"},axis_y:{use:"indicator",which:"age",domainMax:100,domainMin:0},axis_x:{use:"indicator",which:"population"},color:{use:"constant",which:"#ffb600",allow:{names:["!geo.name"]}}}},data:{reader:"csv",path:V.gapminder_paths.baseUrl+"data/waffles/{{geo}}.csv",splash:!1},language:Yn,ui:{presentation:!1}}),zn.define("default_model",{state:{time:{start:"1990",end:"2012",value:"2000"},entities:{dim:"geo",show:{_defs_:{geo:["*"],"geo.cat":["region"]}}},marker:{space:["entities","time"],label:{use:"property",which:"geo.name"},axis:{use:"indicator",which:"population"},color:{use:"property",which:"geo.name"}}},data:{reader:"csv",path:V.gapminder_paths.baseUrl+"data/waffles/basic-indicators.csv",splash:!1},language:Yn,ui:{presentation:!1}}),Sn.define("basepath",V.gapminder_paths.wsUrl+"/api/graphs/stats/vizabi-tools"),mn.define("preload",function(t){var e=V.gapminder_paths.wsUrl+"/api/vizabi/mc_precomputed_shapes.json";d3.json(e,function(i,a){return i?console.warn("Failed loading json "+e+". "+i):(mn.define("precomputedShapes",a),void t.resolve())})}),an.define("preload",function(t){var e=V.gapminder_paths.wsUrl+"/api/vizabi/world-50m.json";d3.json(e,function(i,a){return i?console.warn("Failed loading json "+e+". "+i):(an.define("world",a),void t.resolve())})}),Ei.define("preload",function(t){function e(t){if(a.default_model.state&&a.default_model.state.marker[t]){var e=a.default_model.state.marker[t],i=((s.metadata.indicatorsDB[e.which]||{}).color||{}).palette||{};console.log(e.palette),e.palette=ot({},e.palette,i),console.log(e.palette)}}function i(t){if(a.default_model.state&&a.default_model.state.marker[t]){var e=a.default_model.state.marker[t];if("indicator"===e.use&&s.metadata.indicatorsDB[e.which]&&s.metadata.indicatorsDB[e.which].domain){var i=s.metadata.indicatorsDB[e.which].domain;e.domainMin=e.domainMin||i[0],e.domainMax=e.domainMax||i[1],e.zoomedMin=e.zoomedMin||e.domainMin||i[0],e.zoomedMax=e.zoomedMax||e.domainMax||i[1]}}}var a=this,n=jn._globals.gapminder_paths.wsUrl+"/api/vizabi/metadata.json",s=jn._globals;jn._globals.version=jn._version,jn._globals.build=jn._build,this.preloadLanguage().then(function(){d3.json(n,function(a){s.metadata=a,i("axis_x"),i("axis_y"),i("size"),i("size_label"),e("color"),t.resolve()})})}),Ei.define("preloadLanguage",function(){var t=this,e=new s,i=this.model.language,a=jn._globals.gapminder_paths.wsUrl+"/api/vizabi/translation/"+i.id+".json";return i&&!i.strings[i.id]?d3.json(a,function(a){i.strings[i.id]=a,t.model.language.strings.trigger("change"),e.resolve()}):(this.model.language.strings.trigger("change"),e=e.resolve()),e}),jn}),function(t){t._version="0.13.3-3",t._build="1458169122911"}("undefined"!=typeof Vizabi?Vizabi:{}),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","bubblesize.html"),e.innerHTML='<div class="vzb-bs-holder"> <svg class="vzb-bs-svg"> <g class="vzb-bs-slider-wrap"> <g class="vzb-bs-slider"> </g> </g> </svg> </div> ',t.document.body.appendChild(e)}.call(this),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","about.html"),e.innerHTML='<div class="vzb-dialog-modal"> <div class="vzb-dialog-title"> <%=t ( "buttons/about") %> </div> <div class="vzb-dialog-content"> <p class="vzb-about-text0"></p> <p class="vzb-about-text1"></p> <br/> <p class="vzb-about-version"></p> <p class="vzb-about-updated"></p> <br/> <p class="vzb-about-text2"></p> <br/> <p class="vzb-about-credits"></p> </div> <div class="vzb-dialog-buttons"> <div data-click="closeDialog" class="vzb-dialog-button vzb-label-primary"> OK </div> </div> </div> ',t.document.body.appendChild(e)}.call(this),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","axes.html"),e.innerHTML='<div class="vzb-dialog-modal"> <span class="thumb-tack-class thumb-tack-class-ico-pin fa" data-dialogtype="axes" data-click="pinDialog"></span> <span class="thumb-tack-class thumb-tack-class-ico-drag fa" data-dialogtype="axes" data-click="dragDialog"></span> <div class="vzb-dialog-title"> <%=t ( "buttons/axes") %> </div> <div class="vzb-dialog-content"> <p class="vzb-dialog-sublabel"> <%=t ("buttons/axis_x") %> <span class="vzb-xaxis-selector"></span> </p> <div class="vzb-xaxis-minmax vzb-dialog-paragraph"></div> <p class="vzb-dialog-sublabel"> <%=t ("buttons/axis_y") %> <span class="vzb-yaxis-selector"></span> </p> <div class="vzb-yaxis-minmax vzb-dialog-paragraph"></div> <div class="vzb-axes-options"></div> </div> <div class="vzb-dialog-buttons"> <div data-click="closeDialog" class="vzb-dialog-button vzb-label-primary"> OK </div> </div> </div>',
t.document.body.appendChild(e)}.call(this),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","axesmc.html"),e.innerHTML='<div class="vzb-dialog-modal"> <span class="thumb-tack-class thumb-tack-class-ico-pin fa" data-dialogtype="axesmc" data-click="pinDialog"></span> <span class="thumb-tack-class thumb-tack-class-ico-drag fa" data-dialogtype="axesmc" data-click="dragDialog"></span> <div class="vzb-dialog-title"> <%=t ( "buttons/axes") %> </div> <div class="vzb-dialog-content"> <div class="vzb-yaxis-container"> <p class="vzb-dialog-sublabel"><%=t ( "hints/mount/maxYvalue") %></p> <form class="vzb-dialog-paragraph"> <label><input type="radio" name="ymax" value="immediate"><%=t ( "mount/maxYmode/immediate") %></label> <label><input type="radio" name="ymax" value="latest"><%=t ( "mount/maxYmode/latest") %></label> </form> </div> <div class="vzb-xaxis-container"> <p class="vzb-dialog-sublabel"> <%=t ( "hints/mount/logXstops") %> </p> <form class="vzb-dialog-paragraph"> <input type="checkbox" name="logstops" value="1">1 <input type="checkbox" name="logstops" value="2">2 <input type="checkbox" name="logstops" value="5">5 </form> </div> <p class="vzb-dialog-sublabel"> <%=t ( "hints/mount/xlimits") %> </p> <div class="vzb-xlimits-container vzb-dialog-paragraph"></div> <div class="vzb-probe-container"> <p class="vzb-dialog-sublabel"> <%=t ( "hints/mount/probe") %> </p> <input type="text" class="vzb-probe-field" name="probe"> </div> </div> <div class="vzb-dialog-buttons"> <div data-click="closeDialog" class="vzb-dialog-button vzb-label-primary"> OK </div> </div> </div>',t.document.body.appendChild(e)}.call(this),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","colors.html"),e.innerHTML='<div class="vzb-dialog-modal"> <span class="thumb-tack-class thumb-tack-class-ico-pin fa" data-dialogtype="colors" data-click="pinDialog"></span> <span class="thumb-tack-class thumb-tack-class-ico-drag fa" data-dialogtype="colors" data-click="dragDialog"></span> <div class="vzb-dialog-title"> <%=t ( "buttons/colors") %> <span class="vzb-caxis-selector"></span> </div> <div class="vzb-dialog-content"> <div class="vzb-clegend-container"></div> </div> <div class="vzb-dialog-buttons"> <div data-click="closeDialog" class="vzb-dialog-button vzb-label-primary"> OK </div> </div> </div> ',t.document.body.appendChild(e)}.call(this),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","find.html"),e.innerHTML='<div class="vzb-dialog-modal"> <span class="thumb-tack-class thumb-tack-class-ico-pin fa" data-dialogtype="find" data-click="pinDialog"></span> <span class="thumb-tack-class thumb-tack-class-ico-drag fa" data-dialogtype="find" data-click="dragDialog"></span> <div class="vzb-dialog-title"> <%=t ( "buttons/find") %> <span class="vzb-dialog-content vzb-find-filter"> <input id="vzb-find-search" type="search"/> </span> </div> <div class="vzb-dialog-content vzb-dialog-content-fixed vzb-dialog-scrollable"> <div class="vzb-find-list">  </div> </div> <div class="vzb-dialog-buttons"> <div class="vzb-dialog-bubbleopacity vzb-dialog-control"></div> <div id="vzb-find-deselect" class="vzb-dialog-button"> <%=t ( "buttons/deselect") %> </div> <div data-click="closeDialog" class="vzb-dialog-button vzb-label-primary"> <%=t ( "buttons/ok") %> </div> </div> </div> ',t.document.body.appendChild(e)}.call(this),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","label.html"),e.innerHTML='<div class="vzb-dialog-modal"> <span class="thumb-tack-class thumb-tack-class-ico-pin fa" data-dialogtype="label" data-click="pinDialog"></span> <span class="thumb-tack-class thumb-tack-class-ico-drag fa" data-dialogtype="label" data-click="dragDialog"></span> <div class="vzb-dialog-title"> <%=t ( "buttons/label") %> </div> <div class="vzb-dialog-content"> <span class="vzb-saxis-selector"></span> <div class="vzb-dialog-sizeslider"></div> <div class="vzb-removelabelbox-switch"></div> </div> <div class="vzb-dialog-buttons"> <div data-click="closeDialog" class="vzb-dialog-button vzb-label-primary"> OK </div> </div> </div> ',t.document.body.appendChild(e)}.call(this),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","moreoptions.html"),e.innerHTML='<div class="vzb-dialog-modal"> <span class="thumb-tack-class thumb-tack-class-ico-pin fa" data-dialogtype="moreoptions" data-click="pinDialog"></span> <span class="thumb-tack-class thumb-tack-class-ico-drag fa" data-dialogtype="moreoptions" data-click="dragDialog"></span> <div class="vzb-dialog-title"> <%=t ("buttons/more_options") %> </div> <div class="vzb-dialog-content vzb-dialog-scrollable"> <div class="vzb-dialog-options-buttonlist"> </div> <div class="vzb-accordion"> </div> </div> <div class="vzb-dialog-buttons"> <div data-click="closeDialog" class="vzb-dialog-button vzb-label-primary"> OK </div> </div> </div>',t.document.body.appendChild(e)}.call(this),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","opacity.html"),e.innerHTML='<div class="vzb-dialog-modal"> <div class="vzb-dialog-title"> <%=t ( "buttons/opacity") %> </div> <div class="vzb-dialog-content"> <p class="vzb-dialog-sublabel"> <%=t ("buttons/opacityRegular") %> </p> <div class="vzb-dialog-bubbleopacity-regular"></div> <p class="vzb-dialog-sublabel"> <%=t ("buttons/opacityNonselect") %> </p> <div class="vzb-dialog-bubbleopacity-selectdim"></div> </div> </div> </div> ',t.document.body.appendChild(e)}.call(this),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","presentation.html"),e.innerHTML='<div class="vzb-dialog-modal"> <div class="vzb-dialog-title"> <%=t ( "buttons/presentation") %> </div> <div class="vzb-dialog-content"> <div class="vzb-presentationmode-switch"></div> </div> </div> ',t.document.body.appendChild(e)}.call(this),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","show.html"),e.innerHTML='<div class="vzb-dialog-modal"> <span class="thumb-tack-class thumb-tack-class-ico-pin fa" data-dialogtype="show" data-click="pinDialog"></span> <span class="thumb-tack-class thumb-tack-class-ico-drag fa" data-dialogtype="show" data-click="dragDialog"></span> <div class="vzb-dialog-title"> <%=t ( "buttons/show") %> <span class="vzb-dialog-content vzb-show-filter"> <input id="vzb-show-search" type="search"/> </span> </div> <div class="vzb-dialog-content vzb-dialog-content-fixed vzb-dialog-scrollable"> <p class="vzb-dialog-sublabel"> <%=t ( "hints/mount/onlyshowthefollowing") %> </p> <div class="vzb-show-list">  </div> </div> <div class="vzb-dialog-buttons"> <div id="vzb-show-deselect" class="vzb-dialog-button"> <%=t ( "buttons/deselect") %> </div> <div data-click="closeDialog" class="vzb-dialog-button vzb-label-primary"> <%=t ( "buttons/ok") %> </div> </div> </div> ',t.document.body.appendChild(e)}.call(this),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","size.html"),e.innerHTML='<div class="vzb-dialog-modal"> <span class="thumb-tack-class thumb-tack-class-ico-pin fa" data-dialogtype="size" data-click="pinDialog"></span> <span class="thumb-tack-class thumb-tack-class-ico-drag fa" data-dialogtype="size" data-click="dragDialog"></span> <div class="vzb-dialog-title"> <%=t ( "buttons/size") %> <span class="vzb-saxis-selector"></span> </div> <div class="vzb-dialog-content"> <div class="vzb-dialog-bubblesize"></div> </div> <div class="vzb-dialog-buttons"> <div data-click="closeDialog" class="vzb-dialog-button vzb-label-primary"> OK </div> </div> </div> ',t.document.body.appendChild(e)}.call(this),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","speed.html"),e.innerHTML='<div class="vzb-dialog-modal"> <div class="vzb-dialog-title"> <%=t ( "buttons/speed") %> </div> <div class="vzb-dialog-content"> <div class="vzb-dialog-placeholder"></div> </div> </div> ',t.document.body.appendChild(e)}.call(this),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","stack.html"),e.innerHTML='<div class="vzb-dialog-modal"> <span class="thumb-tack-class thumb-tack-class-ico-pin fa" data-dialogtype="stack" data-click="pinDialog"></span> <span class="thumb-tack-class thumb-tack-class-ico-drag fa" data-dialogtype="stack" data-click="dragDialog"></span> <div class="vzb-dialog-title"> <%=t ( "buttons/stack") %> </div> <div class="vzb-dialog-content vzb-dialog-scrollable">  <form class="vzb-howtostack vzb-dialog-paragraph"> <label> <input type="radio" name="stack" value="none"> <%=t ( "mount/stacking/none") %> </label> <label> <input type="radio" name="stack" value="geo.region"> <%=t ( "mount/stacking/region") %> </label> <label> <input type="radio" name="stack" value="all"> <%=t ( "mount/stacking/world") %> </label> </form> <form class="vzb-howtomerge vzb-dialog-paragraph"> <p class="vzb-dialog-sublabel"> <%=t ( "hints/mount/howtomerge") %> </p> <label> <input type="radio" name="merge" value="none"> <%=t ( "mount/merging/none") %> </label> <label> <input type="radio" name="merge" value="grouped"> <%=t ( "mount/merging/region") %> </label> <label> <input type="radio" name="merge" value="stacked"> <%=t ( "mount/merging/world") %> </label> </form> <form class="vzb-manual-sorting"> <p class="vzb-dialog-sublabel"> <%=t ( "mount/manualSorting") %> </p> <div class="vzb-dialog-draggablelist vzb-dialog-control"></div> </form> </div> <div class="vzb-dialog-buttons"> <div data-click="closeDialog" class="vzb-dialog-button vzb-label-primary">OK</div> </div> </div>',t.document.body.appendChild(e)}.call(this),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","zoom.html"),e.innerHTML='<div class="vzb-dialog-modal"> <span class="thumb-tack-class thumb-tack-class-ico-pin fa" data-dialogtype="label" data-click="pinDialog"></span> <span class="thumb-tack-class thumb-tack-class-ico-drag fa" data-dialogtype="label" data-click="dragDialog"></span> <div class="vzb-dialog-title"> <%=t ( "buttons/zoom") %> <div class="vzb-dialog-zoom-buttonlist"></div> </div> <div class="vzb-dialog-content"> <div class="vzb-nozoomonscrolling-switch"></div> </div> <div class="vzb-dialog-buttons"> <div data-click="closeDialog" class="vzb-dialog-button vzb-label-primary"> OK </div> </div> </div> ',t.document.body.appendChild(e)}.call(this),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","minmaxinputs.html"),e.innerHTML='<div class="vzb-mmi-holder"> <span class="vzb-mmi-domainmin-label"></span> <input type="text" class="vzb-mmi-domainmin" name="min"> <span class="vzb-mmi-domainmax-label"></span> <input type="text" class="vzb-mmi-domainmax" name="max"> <br class="vzb-mmi-break"/> <span class="vzb-mmi-zoomedmin-label"></span> <input type="text" class="vzb-mmi-zoomedmin" name="min"> <span class="vzb-mmi-zoomedmax-label"></span> <input type="text" class="vzb-mmi-zoomedmax" name="max"> </div>',t.document.body.appendChild(e)}.call(this),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","sizeslider.html"),e.innerHTML='<div class="vzb-szs-holder"> <svg class="vzb-szs-svg"> <g class="vzb-szs-slider-wrap"> <g class="vzb-szs-slider"> </g> </g> </svg> </div> ',t.document.body.appendChild(e)}.call(this),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","timeslider.html"),e.innerHTML='<div class="vzb-timeslider vzb-ts-loading"> <div class="vzb-ts-slider-wrapper"> <svg class="vzb-ts-slider"> <g> <g class="vzb-ts-slider-axis"></g> <g class="vzb-ts-slider-slide"> <circle class="vzb-ts-slider-handle"></circle> <text class="vzb-ts-slider-value"></text> </g> </g> </svg> </div>  <div class="vzb-ts-btns"> <button class="vzb-ts-btn-loading vzb-ts-btn"> <div class="vzb-loader"></div> </button> <button class="vzb-ts-btn-play vzb-ts-btn"> <svg class="vzb-icon vzb-icon-play" viewBox="3 3 42 42" xmlns="http://www.w3.org/2000/svg"> <path xmlns="http://www.w3.org/2000/svg" d="M24 4C12.95 4 4 12.95 4 24s8.95 20 20 20 20-8.95 20-20S35.05 4 24 4zm-4 29V15l12 9-12 9z"/> </svg> </button> <button class="vzb-ts-btn-pause vzb-ts-btn"> <svg class="vzb-icon vzb-icon-pause" viewBox="3 3 42 42" xmlns="http://www.w3.org/2000/svg"> <path xmlns="http://www.w3.org/2000/svg" d="M24 4C12.95 4 4 12.95 4 24s8.95 20 20 20 20-8.95 20-20S35.05 4 24 4zm-2 28h-4V16h4v16zm8 0h-4V16h4v16z"/> </svg> </button> </div> </div> ',t.document.body.appendChild(e)}.call(this),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","barchart.html"),e.innerHTML=' <svg class="vzb-barchart"> <g class="vzb-bc-graph"> <g class="vzb-bc-bars"></g> <g class="vzb-bc-bar-labels"></g> <g class="vzb-bc-axis-y-title"></g> <text class="vzb-bc-year"></text> <g class="vzb-bc-axis-x-title"></g> <g class="vzb-bc-axis-x"></g> <g class="vzb-bc-axis-y"></g> <g class="vzb-bc-axis-labels">  </g> </g> </svg> ',t.document.body.appendChild(e)}.call(this),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","barrank.html"),e.innerHTML=' <div class="vzb-barrankchart"> <svg class="vzb-br-header"> <text class="vzb-br-title"></text> <text class="vzb-br-total"></text> </svg> <div class="barsviewport"> <svg class="vzb-br-bars-svg"> <g class="vzb-br-bars"></g> </svg> </div> </div> ',t.document.body.appendChild(e)}.call(this),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","bubblechart.html"),e.innerHTML=' <div class="vzb-bubblechart"> <svg class="vzb-bubblechart-svg"> <g class="vzb-bc-graph"> <g class="vzb-bc-year"></g> <svg class="vzb-bc-axis-x"> <g></g> </svg> <svg class="vzb-bc-axis-y"> <g></g> </svg> <line class="vzb-bc-projection-x"></line> <line class="vzb-bc-projection-y"></line> <svg class="vzb-bc-bubbles-crop"> <rect class="vzb-bc-eventarea"></rect> <g class="vzb-bc-lines"></g> <g class="vzb-bc-trails"></g> <g class="vzb-bc-bubbles"></g> <g class="vzb-bc-labels"></g> </svg> <g class="vzb-bc-axis-y-title"></g> <g class="vzb-bc-axis-x-title"></g> <g class="vzb-bc-axis-s-title"></g> <g class="vzb-bc-axis-c-title"></g> <g class="vzb-bc-axis-y-info"> </g> <g class="vzb-bc-axis-x-info"> </g> <g class="vzb-data-warning"> <svg></svg> <text></text> </g> <rect class="vzb-bc-zoom-rect"></rect> <g class="vzb-bc-tooltip vzb-hidden"> <rect class="vzb-bc-tooltip-border"></rect> <text class="vzb-bc-tooltip-text"></text> </g> </g> </svg>  <div class="vzb-tooltip vzb-hidden vzb-tooltip-mobile"></div> </div> ',t.document.body.appendChild(e)}.call(this),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","bubblemap.html"),e.innerHTML=' <div class="vzb-bubblemap"> <svg class="vzb-bmc-map-background"> <g class="vzb-bmc-map-graph"></g> </svg> <svg class="vzb-bubblemap-svg"> <g class="vzb-bmc-graph"> <g class="vzb-bmc-year"></g> <g class="vzb-bmc-lines"></g> <g class="vzb-bmc-bubbles"></g> <g class="vzb-bmc-labels"></g> <g class="vzb-bmc-bubble-labels"></g> <g class="vzb-bmc-axis-y-title"> <text></text> </g> <g class="vzb-bmc-axis-c-title"> <text></text> </g> <g class="vzb-bmc-axis-info"> </g> <g class="vzb-data-warning"> <svg></svg> <text></text> </g> <g class="vzb-bmc-tooltip vzb-hidden"> <rect class="vzb-bmc-tooltip-border"></rect> <text class="vzb-bmc-tooltip-text"></text> </g> </g> </svg> </div> ',t.document.body.appendChild(e)}.call(this),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","donutchart.html"),e.innerHTML=' <div class="vzb-donutchart"> <svg class="vzb-dc-graph">  </svg> <div class="vzb-tooltip vzb-hidden"></div> </div> ',t.document.body.appendChild(e)}.call(this),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","linechart.html"),e.innerHTML=' <div class="vzb-linechart"> <svg class="vzb-lc-graph"> <g> <g class="vzb-lc-axis-x"></g> <text class="vzb-lc-axis-x-value"></text> <text class="vzb-lc-axis-y-value"></text> <svg class="vzb-lc-lines"></svg> <g class="vzb-lc-axis-y"></g> <line class="vzb-lc-projection-x"></line> ; <line class="vzb-lc-projection-y"></line> ; <g class="vzb-lc-labels"> <line class="vzb-lc-vertical-now"></line> ; </g> <g class="vzb-lc-axis-y-title"></g> <g class="vzb-lc-axis-x-title"></g> </g>  </svg> <div class="vzb-tooltip vzb-hidden"></div> </div> ',t.document.body.appendChild(e)}.call(this),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","mountainchart.html"),e.innerHTML=' <div class="vzb-mountainchart"> <svg class="vzb-mountainchart-svg"> <g class="vzb-mc-graph"> <rect class="vzb-mc-eventarea"></rect> <g class="vzb-mc-year"></g> <g class="vzb-mc-mountains-mergestacked"></g> <g class="vzb-mc-mountains-mergegrouped"></g> <g class="vzb-mc-mountains"></g> <g class="vzb-mc-mountains-labels"></g> <g class="vzb-mc-axis-y-title"> <text></text> </g> <g class="vzb-mc-axis-x-title"> <text></text> </g> <g class="vzb-mc-axis-info"> </g> <g class="vzb-data-warning"> <svg></svg> <text></text> </g> <g class="vzb-mc-axis-x"></g> <g class="vzb-mc-axis-labels"></g> <g class="vzb-mc-probe"> <text class="vzb-shadow vzb-mc-probe-value-ul"></text> <text class="vzb-shadow vzb-mc-probe-value-ur"></text> <text class="vzb-shadow vzb-mc-probe-value-dl"></text> <text class="vzb-shadow vzb-mc-probe-value-dr"></text> <text class="vzb-mc-probe-value-ul"></text> <text class="vzb-mc-probe-value-ur"></text> <text class="vzb-mc-probe-value-dl"></text> <text class="vzb-mc-probe-value-dr"></text> <text class="vzb-mc-probe-extremepoverty"></text> <line></line> </g> <g class="vzb-mc-tooltip vzb-hidden"> <rect class="vzb-bc-tooltip-border"></rect> <text class="vzb-bc-tooltip-text"></text> </g> </g> </svg> </div> ',t.document.body.appendChild(e)}.call(this),function(){var t=this,e=t.document.createElement("script");e.type="text/template",e.setAttribute("id","popbyage.html"),e.innerHTML=' <svg class="vzb-popbyage"> <g class="vzb-bc-header"> <text class="vzb-bc-title"></text> <text class="vzb-bc-year"></text> </g> <g class="vzb-bc-graph"> <g class="vzb-bc-bars"></g> <g class="vzb-bc-labels"></g> <text class="vzb-bc-axis-y-title"></text> <g class="vzb-bc-axis-x"></g> <g class="vzb-bc-axis-y"></g> <g class="vzb-bc-axis-labels">  </g> </g> </svg> ',t.document.body.appendChild(e)}.call(this);